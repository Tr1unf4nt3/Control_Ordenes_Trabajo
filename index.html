<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Sistema de √ìrdenes de Trabajo | Firebase Cloud Edition (Seguro)</title>
    <!-- Librer√≠a para generar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
    
    <!-- LIBRER√çAS DE FIREBASE (Versi√≥n de Compatibilidad) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.9.0/firebase-firestore-compat.js"></script>
    
    <!-- NUEVA LIBRER√çA: Exportaci√≥n a Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        /* Paleta de colores Pastel Azul/Gris */
        :root {
            --color-bg: #F0F8FF;         /* Azul muy claro (Alice Blue) */
            --color-primary: #ADD8E6;    /* Azul claro (Light Blue) */
            --color-secondary: #B0C4DE;  /* Azul gris√°ceo (Light Steel Blue) */
            --color-accent: #87CEFA;     /* Azul cielo claro (Light Sky Blue) */
            --color-text: #36454F;       /* Gris carb√≥n (Charcoal) */
            --color-white: #ffffff;
            --color-error: #FF6961;      /* Rojo pastel para errores */
            --color-success: #77DD77;    /* Verde pastel para √©xito */
            --color-warning: #FFB347;    /* Naranja pastel para advertencias */
            --color-filter: #DDA0DD;     /* Color para elementos de filtro */
            --color-in-progress: #FFD700; /* Amarillo para "En curso" */
            --color-completed: #77DD77;  /* Verde para "Finalizada" */
            --color-excel: #28a745;      /* Verde para botones Excel */
            --color-excel-light: #17a2b8; /* Azul para botones Excel secundarios */
            --color-certification: #9C27B0; /* P√∫rpura para certificaciones finales */
        }

        /* Estilos Generales (Dise√±o Pastel) */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text);
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: var(--color-white);
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }

        h2, h3, h4 {
            color: var(--color-text);
            border-bottom: 2px solid var(--color-primary);
            padding-bottom: 5px;
            margin-top: 25px;
        }

        input[type="text"], input[type="password"], input[type="number"], input[type="date"], input[type="email"], select, textarea {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            display: inline-block;
            border: 1px solid var(--color-secondary);
            border-radius: 6px;
            box-sizing: border-box;
            background-color: var(--color-white);
        }

        /* Estilo para campos autollenados/deshabilitados */
        input:disabled {
            background-color: #f0f0f0; 
            border: 1px dashed var(--color-secondary);
        }

        /* Estilo de validaci√≥n (el navegador se encarga de lo b√°sico, pero esto ayuda) */
        input:invalid:not(:placeholder-shown), select:invalid:not(:placeholder-shown), textarea:invalid:not(:placeholder-shown) {
            border: 2px solid var(--color-error);
        }

        .form-section {
            border: 1px solid var(--color-secondary);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
            background-color: #f7fbff;
        }

        /* Contenedor Flex para Campos de C√°lculo */
        .calculation-group {
            display: flex;
            align-items: center;
            gap: 10px;
            /* Flex vertical para etiquetas y horizontal para inputs/resultados */
            flex-wrap: wrap; 
            border: 1px solid var(--color-secondary);
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            background-color: #e0f7fa; /* Fondo azul claro para destacar el c√°lculo */
        }

        /* Estilo para la etiqueta y el input del Total calculado */
        .calculation-total-section {
            display: flex;
            align-items: center;
            width: 100%;
            margin-top: 10px;
        }

        .calculation-total-section label {
            font-weight: bold;
            flex-basis: auto; 
            margin-right: 15px;
            white-space: nowrap;
        }

        .total-display {
            background-color: var(--color-white);
            font-weight: bold;
            text-align: right;
            border: 1px dashed var(--color-accent);
            padding: 10px;
            border-radius: 6px;
            flex-grow: 1;
        }

        .calculation-input { 
            flex-basis: calc(45% - 20px); 
        } 
        .calculation-group .formula-symbol {
            font-size: 1.5em; 
            font-weight: bold; 
            margin-left: 5px; 
            margin-right: 5px;
        }

        button {
            background-color: var(--color-accent);
            color: var(--color-text);
            padding: 10px 20px;
            margin: 8px 5px 8px 0;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s, transform: 0.1s;
        }

        button:hover {
            background-color: var(--color-primary);
        }
        
        /* Botones de Check Condicional */
        .conditional-check {
            background-color: var(--color-secondary);
            color: var(--color-white);
            font-weight: bold;
            padding: 15px;
            margin-bottom: 10px;
            display: block;
            text-align: left;
        }
        .conditional-check.active {
            background-color: var(--color-success);
        }


        /* Layout de Pesta√±as */
        .tab { overflow: hidden; border-bottom: 1px solid var(--color-secondary); margin-bottom: 20px; }
        .tablinks { background-color: var(--color-bg); color: var(--color-text); float: left; border: none; outline: none; cursor: pointer; padding: 14px 20px; transition: 0.3s; border-top-left-radius: 8px; border-top-right-radius: 8px; }
        .tablinks:hover { background-color: var(--color-primary); }
        .tablinks.active { background-color: var(--color-primary); border-bottom: 3px solid var(--color-accent); margin-bottom: -1px; }
        .tabcontent { display: none; padding: 30px 0; }

        /* Estilos de Edici√≥n */
        .field-editor-item { border: 1px dashed var(--color-secondary); border-radius: 6px; padding: 15px; margin-bottom: 10px; background-color: var(--color-white); }
        .required-fixed-field { padding: 10px; background-color: var(--color-secondary); color: var(--color-white); border-radius: 4px; margin-bottom: 10px; }
        
        /* Estilos para la tabla */
        #orders-table { width: 100%; border-collapse: collapse; }
        #orders-table th, #orders-table td { border: 1px solid var(--color-secondary); padding: 12px; text-align: left; }
        #orders-table th { background-color: var(--color-primary); color: var(--color-text); }
        #orders-table tr:nth-child(even) { background-color: var(--color-bg); }
        #orders-table tr:hover { background-color: var(--color-accent); color: var(--color-white); }

        /* Login View */
        #login-view { width: 350px; padding: 40px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: var(--color-white); border-radius: 10px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); text-align: center; }
        #login-error { color: var(--color-error); font-weight: bold; }
        
        /* Estilo para las firmas en el PDF */
        .pdf-signatures {
            margin-top: 60px; /* 1cm m√°s abajo */
            padding-top: 30px;
            border-top: 1px dashed #B0C4DE;
            display: flex;
            justify-content: space-between;
            width: 100%;
            font-size: 1.1em;
            font-weight: bold;
        }
        .pdf-signatures span {
            display: inline-block;
            width: 45%; /* Ajuste para espacio entre firmas */
        }
        .pdf-signatures hr {
            border: none;
            border-top: 1px solid #36454F;
            margin: 5px 0 0 0;
        }
        
        /* Estilos espec√≠ficos para el encabezado en p√°ginas > 1 del PDF */
        .pdf-header-secondary {
            position: fixed; /* Fijo en la parte superior */
            top: 10px; /* Posici√≥n ajustada para evitar margen */
            right: 20px; /* Posici√≥n ajustada para el lado derecho */
            font-size: 14px; /* Tama√±o similar al de las secciones */
            color: #555;
            font-weight: bold;
            z-index: 1000;
        }

        /* Estilos para las funciones de exportaci√≥n/importaci√≥n */
        .backup-section {
            border: 2px solid var(--color-warning);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            background-color: #fffaf0;
        }
        
        .backup-section h4 {
            color: var(--color-warning);
            border-bottom: 1px solid var(--color-warning);
        }
        
        .backup-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .backup-button {
            background-color: var(--color-warning);
            color: var(--color-text);
            font-weight: bold;
        }
        
        .backup-button:hover {
            background-color: #ffa726;
        }
        
        #import-file {
            margin: 10px 0;
        }

        /* NUEVOS ESTILOS PARA FILTROS */
        .filters-section {
            border: 2px solid var(--color-filter);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            background-color: #faf0ff;
        }
        
        .filters-section h4 {
            color: var(--color-filter);
            border-bottom: 1px solid var(--color-filter);
            margin-top: 0;
        }
        
        .filter-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
        
        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--color-text);
        }
        
        .filter-actions {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        
        .filter-button {
            background-color: var(--color-filter);
            color: var(--color-white);
            font-weight: bold;
            white-space: nowrap;
        }
        
        .filter-button:hover {
            background-color: #ba55d3;
        }
        
        .active-filters {
            margin-top: 15px;
            padding: 10px;
            background-color: var(--color-bg);
            border-radius: 6px;
            border-left: 4px solid var(--color-filter);
        }
        
        .active-filter-tag {
            display: inline-block;
            background-color: var(--color-filter);
            color: var(--color-white);
            padding: 5px 10px;
            margin: 5px;
            border-radius: 15px;
            font-size: 0.9em;
        }
        
        .active-filter-tag .remove-filter {
            margin-left: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .range-inputs {
            display: flex;
            gap: 10px;
        }
        
        .range-inputs input {
            flex: 1;
        }

        /* NUEVOS ESTILOS PARA ESTADOS DE √ìRDENES */
        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 0.85em;
            text-align: center;
        }
        
        .status-in-progress {
            background-color: var(--color-in-progress);
            color: #333;
        }
        
        .status-completed {
            background-color: var(--color-completed);
            color: white;
        }
        
        .complete-button {
            background-color: var(--color-success);
            color: white;
        }
        
        .complete-button:hover {
            background-color: #66bb6a;
        }
        
        /* Estilos para el modal de certificaci√≥n */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .modal-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        .modal-back-button {
            background-color: var(--color-secondary);
            color: white;
        }
        
        .modal-accept-button {
            background-color: var(--color-success);
            color: white;
        }

        /* NUEVOS ESTILOS PARA EXPORTACI√ìN EXCEL */
        .export-section {
            border: 2px solid var(--color-excel);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            background-color: #f0fff4;
        }
        
        .export-section h4 {
            color: var(--color-excel);
            border-bottom: 1px solid var(--color-excel);
            margin-top: 0;
        }
        
        .export-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .excel-button {
            background-color: var(--color-excel);
            color: white;
            font-weight: bold;
        }
        
        .excel-button:hover {
            background-color: #218838;
        }
        
        .excel-button-secondary {
            background-color: var(--color-excel-light);
            color: white;
            font-weight: bold;
        }
        
        .excel-button-secondary:hover {
            background-color: #138496;
        }

        /* NUEVOS ESTILOS PARA CERTIFICACI√ìN FINAL */
        .certification-section {
            border: 2px solid var(--color-certification);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            background-color: #faf4ff;
        }
        
        .certification-section h4 {
            color: var(--color-certification);
            border-bottom: 1px solid var(--color-certification);
            margin-top: 0;
        }
        
        .certification-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .certification-button {
            background-color: var(--color-certification);
            color: white;
            font-weight: bold;
        }
        
        .certification-button:hover {
            background-color: #7b1fa2;
        }
        
        .certification-total-section {
            background-color: #e1bee7;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            border: 1px solid var(--color-certification);
        }
        
        .certification-total-display {
            font-size: 1.2em;
            font-weight: bold;
            text-align: center;
            color: var(--color-certification);
        }
        
        /* Estilos para la lista de certificaciones finales */
        .certification-list {
            margin-top: 20px;
        }
        
        .certification-item {
            border: 2px solid var(--color-certification);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #f3e5f5;
        }
        
        .certification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .certification-title {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--color-certification);
        }
        
        .orders-list {
            margin-left: 20px;
            margin-top: 10px;
        }
        
        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #e1bee7;
        }
        
        .order-item:last-child {
            border-bottom: none;
        }
        
        .order-actions {
            display: flex;
            gap: 5px;
        }
        
        .order-pdf-button {
            background-color: #87CEFA;
            color: white;
            padding: 5px 10px;
            font-size: 0.8em;
        }
        
        .certification-pdf-button {
            background-color: var(--color-certification);
            color: white;
        }

        /* Estilos para checkboxes de √≥rdenes */
        .orders-checkbox-group {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--color-secondary);
            border-radius: 6px;
            padding: 10px;
            margin-top: 10px;
        }
        
        .order-checkbox-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .order-checkbox-item:last-child {
            border-bottom: none;
        }
        
        .order-amount {
            font-weight: bold;
            color: var(--color-certification);
        }

        /* Estilos para √≥rdenes ya certificadas */
        .order-certified {
            opacity: 0.6;
            background-color: #f5f5f5;
        }
        
        .certified-badge {
            background-color: var(--color-certification);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7em;
            margin-left: 10px;
        }

    </style>
</head>
<body>

    <div id="login-view">
        <h2>üîí Iniciar Sesi√≥n</h2>
        <input type="email" id="email" placeholder="Correo Electr√≥nico" required><br>
        <input type="password" id="password" placeholder="Contrase√±a" required><br>
        <button onclick="login()">Acceder</button>
        <p id="login-error"></p>
    </div>

    <div id="main-app" class="container" style="display: none;">
        
        <!-- Pesta√±as de Navegaci√≥n -->
        <div class="tab">
            <!-- ID A√ëADIDO: new-order-tab-button -->
            <button class="tablinks" id="new-order-tab-button" onclick="openTab(event, 'new-order')">üìã Nueva Orden de Trabajo</button>
            <button class="tablinks" onclick="openTab(event, 'view-orders')">üìÇ √ìrdenes en Curso</button>
            <button class="tablinks" onclick="openTab(event, 'completed-orders')">‚úÖ √ìrdenes Finalizadas</button>
            <button class="tablinks" onclick="openTab(event, 'final-certification')">üìú Certificaci√≥n Final</button>
            <button class="tablinks" onclick="openTab(event, 'view-certifications')">üìã Certificaciones Finales</button>
            <button class="tablinks" id="edit-tab-button" onclick="openTab(event, 'edit-form')" style="display: none;">‚öôÔ∏è Edici√≥n de Formulario</button>
            <button onclick="logout()" style="float: right;">üö™ Cerrar Sesi√≥n</button>
        </div>

        <!-- Contenido de las Pesta√±as -->

        <!-- Pesta√±a 1: Creaci√≥n de Orden de Trabajo -->
        <div id="new-order" class="tabcontent">
            <h3>Nueva Orden de Trabajo</h3>
            <form id="work-order-form"></form>
            <button onclick="generateWorkOrder()">‚úÖ Crear Orden y Generar PDF</button>
        </div>

        <!-- Pesta√±a 2: Visualizaci√≥n de √ìrdenes de Trabajo en Curso -->
        <div id="view-orders" class="tabcontent">
            <h3>√ìrdenes de Trabajo en Curso</h3>
            
            <!-- NUEVA SECCI√ìN: Exportaci√≥n a Excel -->
            <div class="export-section">
                <h4>üìä Exportaci√≥n a Excel</h4>
                <p>Exporte los datos de las √≥rdenes a formato Excel para an√°lisis y reportes.</p>
                <div class="export-buttons">
                    <button class="excel-button" onclick="exportToExcel('current')">
                        üìã Exportar Todas las √ìrdenes
                    </button>
                    <button class="excel-button-secondary" onclick="exportFilteredToExcel('current')">
                        üîç Exportar √ìrdenes Filtradas
                    </button>
                    <button class="excel-button-secondary" onclick="exportCurrentViewToExcel('current')">
                        üëÅÔ∏è Exportar Vista Actual
                    </button>
                </div>
                <p style="margin: 10px 0 0 0; font-size: 0.9em; color: #666;">
                    <strong>Tip:</strong> Use los filtros para refinar los datos antes de exportar.
                </p>
            </div>
            
            <!-- SECCI√ìN: Filtros de B√∫squeda -->
            <div class="filters-section">
                <h4>üîç Filtros de B√∫squeda</h4>
                <div class="filter-controls">
                    <div class="filter-group">
                        <label for="filter-field">Campo a filtrar:</label>
                        <select id="filter-field" onchange="updateFilterInput()">
                            <option value="">Seleccionar campo...</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="filter-operator">Tipo de filtro:</label>
                        <select id="filter-operator" onchange="updateFilterInput()">
                            <option value="contains">Contiene texto</option>
                            <option value="equals">Es igual a</option>
                            <option value="startsWith">Comienza con</option>
                            <option value="endsWith">Termina con</option>
                            <option value="range">Rango</option>
                            <option value="greater">Mayor que</option>
                            <option value="less">Menor que</option>
                        </select>
                    </div>
                    
                    <div class="filter-group" id="filter-value-container">
                        <label for="filter-value">Valor:</label>
                        <input type="text" id="filter-value" placeholder="Texto a buscar...">
                    </div>
                    
                    <div class="filter-actions">
                        <button class="filter-button" onclick="addFilter()">‚ûï Agregar Filtro</button>
                        <button class="filter-button" onclick="clearAllFilters()" style="background-color: var(--color-error);">üóëÔ∏è Limpiar Filtros</button>
                    </div>
                </div>
                
                <div id="active-filters" class="active-filters" style="display: none;">
                    <strong>Filtros activos:</strong>
                    <div id="active-filters-list"></div>
                </div>
            </div>
            
            <table id="orders-table">
                <thead>
                    <tr>
                        <th>Nro. OT</th>
                        <th>T√≠tulo</th>
                        <th>Fecha Creaci√≥n</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            
            <div id="no-results" style="display: none; text-align: center; padding: 20px; color: var(--color-error);">
                <p>No se encontraron √≥rdenes que coincidan con los filtros aplicados.</p>
            </div>
        </div>

        <!-- Pesta√±a 3: √ìrdenes Finalizadas -->
        <div id="completed-orders" class="tabcontent">
            <h3>√ìrdenes de Trabajo Finalizadas</h3>
            
            <!-- NUEVA SECCI√ìN: Exportaci√≥n a Excel -->
            <div class="export-section">
                <h4>üìä Exportaci√≥n a Excel</h4>
                <p>Exporte los datos de las √≥rdenes finalizadas a formato Excel para an√°lisis y reportes.</p>
                <div class="export-buttons">
                    <button class="excel-button" onclick="exportToExcel('completed')">
                        üìã Exportar Todas las √ìrdenes
                    </button>
                    <button class="excel-button-secondary" onclick="exportFilteredToExcel('completed')">
                        üîç Exportar √ìrdenes Filtradas
                    </button>
                    <button class="excel-button-secondary" onclick="exportCurrentViewToExcel('completed')">
                        üëÅÔ∏è Exportar Vista Actual
                    </button>
                </div>
                <p style="margin: 10px 0 0 0; font-size: 0.9em; color: #666;">
                    <strong>Tip:</strong> Los archivos incluyen todos los campos de las √≥rdenes.
                </p>
            </div>
            
            <!-- SECCI√ìN: Filtros para √ìrdenes Finalizadas -->
            <div class="filters-section">
                <h4>üîç Filtros de B√∫squeda</h4>
                <div class="filter-controls">
                    <div class="filter-group">
                        <label for="completed-filter-field">Campo a filtrar:</label>
                        <select id="completed-filter-field" onchange="updateCompletedFilterInput()">
                            <option value="">Seleccionar campo...</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="completed-filter-operator">Tipo de filtro:</label>
                        <select id="completed-filter-operator" onchange="updateCompletedFilterInput()">
                            <option value="contains">Contiene texto</option>
                            <option value="equals">Es igual a</option>
                            <option value="startsWith">Comienza con</option>
                            <option value="endsWith">Termina con</option>
                            <option value="range">Rango</option>
                            <option value="greater">Mayor que</option>
                            <option value="less">Menor que</option>
                        </select>
                    </div>
                    
                    <div class="filter-group" id="completed-filter-value-container">
                        <label for="completed-filter-value">Valor:</label>
                        <input type="text" id="completed-filter-value" placeholder="Texto a buscar...">
                    </div>
                    
                    <div class="filter-actions">
                        <button class="filter-button" onclick="addCompletedFilter()">‚ûï Agregar Filtro</button>
                        <button class="filter-button" onclick="clearAllCompletedFilters()" style="background-color: var(--color-error);">üóëÔ∏è Limpiar Filtros</button>
                    </div>
                </div>
                
                <div id="completed-active-filters" class="active-filters" style="display: none;">
                    <strong>Filtros activos:</strong>
                    <div id="completed-active-filters-list"></div>
                </div>
            </div>
            
            <table id="completed-orders-table">
                <thead>
                    <tr>
                        <th>Nro. OT</th>
                        <th>T√≠tulo</th>
                        <th>Fecha Creaci√≥n</th>
                        <th>Fecha Finalizaci√≥n</th>
                        <th>Estado Certificaci√≥n</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            
            <div id="no-completed-results" style="display: none; text-align: center; padding: 20px; color: var(--color-error);">
                <p>No se encontraron √≥rdenes finalizadas.</p>
            </div>
        </div>

        <!-- Pesta√±a 4: Certificaci√≥n Final -->
        <div id="final-certification" class="tabcontent">
            <h3>Certificaci√≥n Final</h3>
            
            <div class="certification-section">
                <h4>üìã Formulario de Certificaci√≥n Final</h4>
                <form id="final-certification-form">
                    <div class="form-section">
                        <h4>I. Informaci√≥n de la Certificaci√≥n</h4>
                        <p>
                            <label for="certification-title">T√≠tulo del Formulario:</label>
                            <input type="text" id="certification-title" value="Certificaci√≥n Final" disabled>
                        </p>
                        <p>
                            <label for="certification-number">N√∫mero de Certificaci√≥n Final:</label>
                            <input type="text" id="certification-number" disabled>
                        </p>
                        <p>
                            <label for="certification-year">A√±o:</label>
                            <input type="text" id="certification-year" disabled>
                        </p>
                    </div>
                    
                    <div class="form-section">
                        <h4>II. Informaci√≥n de la Empresa</h4>
                        <p>
                            <label for="certification-company">Empresa:</label>
                            <select id="certification-company" onchange="updateOrdersForCertification()" required>
                                <option value="">Seleccionar empresa...</option>
                            </select>
                        </p>
                    </div>
                    
                    <div class="form-section">
                        <h4>III. √ìrdenes Realizadas</h4>
                        <p>
                            <label for="certification-orders">√ìrdenes Realizadas:</label>
                            <div id="certification-orders-container" class="orders-checkbox-group" style="display: none;">
                                <!-- Las √≥rdenes se cargar√°n din√°micamente aqu√≠ -->
                            </div>
                            <div id="no-orders-message" style="display: none; color: var(--color-error); text-align: center; padding: 10px;">
                                No hay √≥rdenes finalizadas para esta empresa.
                            </div>
                            <div id="all-orders-certified-message" style="display: none; color: var(--color-warning); text-align: center; padding: 10px;">
                                Todas las √≥rdenes de esta empresa ya han sido certificadas en certificaciones finales anteriores.
                            </div>
                        </p>
                    </div>
                    
                    <div class="certification-total-section">
                        <h4>Total Certificaci√≥n</h4>
                        <div class="certification-total-display" id="certification-total">0.00</div>
                        <input type="hidden" id="certification-total-hidden" value="0.00">
                    </div>
                </form>
                
                <div class="certification-buttons">
                    <button class="certification-button" onclick="generateFinalCertification()">
                        ‚úÖ Aceptar Certificaci√≥n Final
                    </button>
                    <button onclick="clearCertificationForm()" style="background-color: var(--color-error); color: white;">
                        üóëÔ∏è Limpiar Formulario
                    </button>
                </div>
            </div>
        </div>

        <!-- Pesta√±a 5: Certificaciones Finales -->
        <div id="view-certifications" class="tabcontent">
            <h3>Certificaciones Finales</h3>
            
            <!-- SECCI√ìN: Exportaci√≥n a Excel -->
            <div class="export-section">
                <h4>üìä Exportaci√≥n a Excel</h4>
                <p>Exporte los datos de las certificaciones finales a formato Excel.</p>
                <div class="export-buttons">
                    <button class="excel-button" onclick="exportCertificationsToExcel()">
                        üìã Exportar Todas las Certificaciones
                    </button>
                </div>
            </div>
            
            <!-- SECCI√ìN: Filtros para Certificaciones Finales -->
            <div class="filters-section">
                <h4>üîç Filtros de B√∫squeda</h4>
                <div class="filter-controls">
                    <div class="filter-group">
                        <label for="certification-filter-field">Campo a filtrar:</label>
                        <select id="certification-filter-field" onchange="updateCertificationFilterInput()">
                            <option value="">Seleccionar campo...</option>
                            <option value="N√∫mero de Certificaci√≥n Final">N√∫mero de Certificaci√≥n</option>
                            <option value="Empresa">Empresa</option>
                            <option value="Total">Total</option>
                            <option value="Fecha de Creaci√≥n">Fecha de Creaci√≥n</option>
                            <option value="A√±o">A√±o</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="certification-filter-operator">Tipo de filtro:</label>
                        <select id="certification-filter-operator" onchange="updateCertificationFilterInput()">
                            <option value="contains">Contiene texto</option>
                            <option value="equals">Es igual a</option>
                            <option value="startsWith">Comienza con</option>
                            <option value="endsWith">Termina con</option>
                            <option value="range">Rango</option>
                            <option value="greater">Mayor que</option>
                            <option value="less">Menor que</option>
                        </select>
                    </div>
                    
                    <div class="filter-group" id="certification-filter-value-container">
                        <label for="certification-filter-value">Valor:</label>
                        <input type="text" id="certification-filter-value" placeholder="Texto a buscar...">
                    </div>
                    
                    <div class="filter-actions">
                        <button class="filter-button" onclick="addCertificationFilter()">‚ûï Agregar Filtro</button>
                        <button class="filter-button" onclick="clearAllCertificationFilters()" style="background-color: var(--color-error);">üóëÔ∏è Limpiar Filtros</button>
                    </div>
                </div>
                
                <div id="certification-active-filters" class="active-filters" style="display: none;">
                    <strong>Filtros activos:</strong>
                    <div id="certification-active-filters-list"></div>
                </div>
            </div>
            
            <div id="certifications-list" class="certification-list">
                <!-- Las certificaciones se cargar√°n din√°micamente aqu√≠ -->
            </div>
            
            <div id="no-certifications-results" style="display: none; text-align: center; padding: 20px; color: var(--color-error);">
                <p>No se encontraron certificaciones finales.</p>
            </div>
        </div>

        <!-- Pesta√±a 6: Edici√≥n de Formulario (Solo Administrador) -->
        <div id="edit-form" class="tabcontent">
            <h3>Edici√≥n de Formulario</h3>
            <div id="form-editor"></div>
            <button onclick="saveFormStructure(false)">üíæ Guardar Estructura del Formulario</button>
            <button onclick="cleanDuplicateOrders()" style="background-color: var(--color-error); color: white; margin-left: 10px;">üßπ Limpiar Duplicados</button>
            
            <!-- SECCI√ìN: Exportaci√≥n e Importaci√≥n de Base de Datos -->
            <div class="backup-section">
                <h4>üîÑ Respaldo y Restauraci√≥n de Base de Datos</h4>
                <p>Estas funciones permiten exportar e importar toda la informaci√≥n del sistema para realizar respaldos o migraciones.</p>
                
                <div class="backup-buttons">
                    <button class="backup-button" onclick="exportDatabase()">üì§ Exportar Base de Datos</button>
                    <button class="backup-button" onclick="document.getElementById('import-file').click()">üì• Importar Base de Datos</button>
                    <input type="file" id="import-file" accept=".json" style="display: none;" onchange="importDatabase(this.files[0])">
                </div>
                
                <p style="font-size: 0.9em; margin-top: 15px; color: var(--color-warning);">
                    <strong>Nota:</strong> La importaci√≥n reemplazar√° todos los datos actuales en la base de datos. 
                    Aseg√∫rese de tener un respaldo reciente antes de realizar esta operaci√≥n.
                </p>
            </div>
        </div>
    </div>

    <!-- Modal para Certificaci√≥n de Obras -->
    <div id="certification-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3 id="certification-title">Certificaci√≥n de Obras</h3>
            <form id="certification-form">
                <div class="form-section">
                    <h4>I. Datos de Certificaci√≥n</h4>
                    <p>
                        <label for="certification-number">N√∫mero de Certificaci√≥n:</label>
                        <input type="text" id="certification-number" disabled>
                    </p>
                    <p>
                        <label for="certification-date">Fecha de la Certificaci√≥n:</label>
                        <input type="text" id="certification-date" disabled>
                    </p>
                    <p>
                        <label for="certification-year">A√±o:</label>
                        <input type="text" id="certification-year" disabled>
                    </p>
                </div>
                
                <div class="form-section">
                    <h4>II. Identificaci√≥n</h4>
                    <p>
                        <label for="contractor-company">Empresa Contratista:</label>
                        <input type="text" id="contractor-company" disabled>
                    </p>
                    <p>
                        <label for="contractor-rif">Identificaci√≥n Fiscal RIF:</label>
                        <input type="text" id="contractor-rif" disabled>
                    </p>
                </div>
                
                <div class="form-section">
                    <h4>III. Informaci√≥n del Proyecto</h4>
                    <p>
                        <label for="work-order-reference">Corresponde Orden de trabajo N¬∞:</label>
                        <input type="text" id="work-order-reference" disabled>
                    </p>
                    <p>
                        <label for="start-date">Fechas de Inicio:</label>
                        <input type="date" id="start-date" required>
                    </p>
                    <p>
                        <label for="end-date">Fin de la Obra:</label>
                        <input type="date" id="end-date" required>
                    </p>
                </div>
                
                <div class="form-section">
                    <h4>IV. Detalle de los trabajos realizados</h4>
                    <p>
                        <textarea id="work-details" required style="min-height: 120px;" placeholder="Describa detalladamente los trabajos realizados..."></textarea>
                    </p>
                    <p>
                        <label for="total-amount">Importe total de la obra:</label>
                        <input type="number" id="total-amount" step="0.01" min="0" required placeholder="0.00">
                    </p>
                </div>
                
                <div class="form-section">
                    <h4>V. Desviaciones y Justificaci√≥n</h4>
                    <p>
                        <textarea id="deviations" style="min-height: 100px;" placeholder="Detalle de desviaciones respecto al plan original (Justificar y valorar en caso de existir)..."></textarea>
                    </p>
                </div>
                
                <div class="form-section">
                    <h4>Firmas</h4>
                    <div style="display: flex; justify-content: space-between;">
                        <div style="width: 45%;">
                            <p><strong>Firma Jefe T√©cnico (Firma/Sello)</strong></p>
                            <div style="border-bottom: 1px solid #36454F; margin-top: 40px;"></div>
                        </div>
                        <div style="width: 45%;">
                            <p><strong>Firma Gerente T√©cnico (Firma/Sello)</strong></p>
                            <div style="border-bottom: 1px solid #36454F; margin-top: 40px;"></div>
                        </div>
                    </div>
                </div>
            </form>
            
            <div class="modal-actions">
                <button class="modal-back-button" onclick="closeCertificationModal()">‚Üê Atr√°s</button>
                <button class="modal-accept-button" onclick="completeWorkOrder()">‚úÖ Aceptar y Finalizar Orden</button>
            </div>
        </div>
    </div>

    <script>
        // *** 1. CONFIGURACI√ìN FIREBASE Y VARIABLES GLOBALES ***
        
        // ** CONFIGURACI√ìN DE FIREBASE ACTUALIZADA **
		const firebaseConfig = {
			apiKey: "AIzaSyBHgF18eLwdZbl1g4OkDu-_NWkBnfLh3EA",
			authDomain: "ordenestrabajo-39eab.firebaseapp.com",
			projectId: "ordenestrabajo-39eab",
			storageBucket: "ordenestrabajo-39eab.firebasestorage.app",
			messagingSenderId: "561184772303",
			appId: "1:561184772303:web:765f5859b4b3a332e827ba"
		};
        
        // Verificar si Firebase ya est√° inicializado
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        
        // Referencias a las "colecciones" de la base de datos
        const ORDERS_COLLECTION = db.collection("workOrders");
        const COMPLETED_ORDERS_COLLECTION = db.collection("completedWorkOrders");
        const CONFIG_COLLECTION = db.collection("config"); 
        const FINAL_CERTIFICATIONS_COLLECTION = db.collection("finalCertifications");
        
        // Variables de estado
        let formStructure = null; 
        let workOrders = []; 
        let completedOrders = [];
        let finalCertifications = [];
        let otCounter = 1; 
        let finalCertificationCounter = 1;
        let currentRole = null; 
        let activeFilters = [];
        let completedActiveFilters = [];
        let certificationActiveFilters = [];
        let currentOrderForCertification = null;

        // ----------------------------------------------------------------------------------
        // *** CONFIGURACI√ìN DE ROLES CON M√öLTIPLES CORREOS (LISTAS/ARRAYS) ***
        // ----------------------------------------------------------------------------------

        // Coloque aqu√≠ todos los correos electr√≥nicos con acceso de administrador
        const ADMIN_EMAILS = [
            'labortradingsg@gmail.com',
            '' // Otro administrador de ejemplo
        ]; 

        // Coloque aqu√≠ todos los correos electr√≥nicos con acceso de solo visualizaci√≥n
        const VIEWER_EMAILS = [
            'visualizador1@empresa.com',
            'visualizador2@empresa.com',
            'solo.ver@tudominio.com'
        ]; 

        // ----------------------------------------------------------------------------------
        // *** FIN CONFIGURACI√ìN DE ROLES ***
        // ----------------------------------------------------------------------------------
        
        // *** DATOS FIJOS PARA AUTOLENADO DE CONTRATISTAS ***
        const CONTRATISTAS_DATA = {
            "Seleccione una Empresa": {
                "Apellido y Nombre del Responsable": "",
                "Rif": ""
            },
            " JERM TELECOMTRONICS TECHNOLOGY MULTISERVICES  C.A": {
                "Apellido y Nombre del Responsable": "JOHN RIVAS",
                "Rif": "J-50507058-4"
            },
            "CHASSERAL  C.A": {
                "Apellido y Nombre del Responsable": "YORKFRAN PERAZA",
                "Rif": "J-29510646-7"
            },
            "CONSERVI AJ C.A": {
                "Apellido y Nombre del Responsable": "ALFONZO BASTARDO",
                "Rif": "J-29548400-3"
            },
            "CORPORACION ACEL  C.A": {
                "Apellido y Nombre del Responsable": "DANIEL GONCALVES",
                "Rif": "J-30860621-9"
            },
            "CORPORACI√ìN TORRA NET 2022  C.A": {
                "Apellido y Nombre del Responsable": "JESUS TORRADO",
                "Rif": "J-50308479-0"
            },
            "DISTRIBUIDORA TODO EN REDES G.S.R  C.A": {
                "Apellido y Nombre del Responsable": "GASTON BUIZA",
                "Rif": "J-40424835-8"
            },
            "FIBRA INTEGRA  C.A": {
                "Apellido y Nombre del Responsable": "MARIE ANTONIETTE DAHDAH",
                "Rif": "J-50265450-0"
            },
            "G&D INTEGRAL RED 2023": {
                "Apellido y Nombre del Responsable": "RAFAEL GOMEZ",
                "Rif": "J-50298686-3"
            },
            "GLOBAL FIX C.A": {
                "Apellido y Nombre del Responsable": "CECILIA CASTRO - JEAN PIERRE LAPARROUSAZ",
                "Rif": "J-31189038-6"
            },
            "INT.TV  C.A": {
                "Apellido y Nombre del Responsable": "RAFAEL BERNAEZ",
                "Rif": "J-50301107-6"
            },
            "INVERSIONES ELECTROMTEC 2020  C.A": {
                "Apellido y Nombre del Responsable": "IGOR REGALADO",
                "Rif": "J-50082533-1"
            },
            "INVERSIONES PROYECTOS LG 721  C.A": {
                "Apellido y Nombre del Responsable": "DOMENICO LOLLI",
                "Rif": "J-29831930-5"
            },
            "INVERSIONES TELE MATIK 321 C.A": {
                "Apellido y Nombre del Responsable": "EDICSON TORRES - KATIUSKA",
                "Rif": "J-29867936-0"
            },
            "JR TECH SUPPORT  C.A": {
                "Apellido y Nombre del Responsable": "YENSY MARTINEZ",
                "Rif": "J-50032575-4"
            },
            "LG ALPHA SOLUCIONES  C.A": {
                "Apellido y Nombre del Responsable": "GILBERTO BERNAEZ",
                "Rif": "J-50319061-2"
            },
            "MULTI INVERSIONES LA LOVERE√ëA C.A": {
                "Apellido y Nombre del Responsable": "CARLOS TOLEDO",
                "Rif": "J-40492572-4"
            },
            "MULTISERVICIOS DAYRA-TEC  C.A": {
                "Apellido y Nombre del Responsable": "MARINES GOMEZ",
                "Rif": "J-50331914-3"
            },
            "PHONE MARKET STAR C.A": {
                "Apellido y Nombre del Responsable": "NELSON MORA",
                "Rif": "J-30919375-9"
            },
            "PROMOCIONES Y MERCADEO J FRANCHI C.A": {
                "Apellido y Nombre del Responsable": "JOSE FRANCHI",
                "Rif": "J-31574714-6"
            },
            "ROM-AR SERVICIOS Y MANTENIMIENTO  C.A": {
                "Apellido y Nombre del Responsable": "ELENA RUIZ",
                "Rif": "J-31128189-4"
            },
            "SERVICIOS DE TECNOLOGIA E INNOVACION (SERVITECH)  C.A": {
                "Apellido y Nombre del Responsable": "JHOAN CELIS",
                "Rif": "J-50028078-5"
            },
            "SERVICIOS INTEGRALES RFCF  C.A": {
                "Apellido y Nombre del Responsable": "CESAR",
                "Rif": "J-40387720-3"
            },
            "SERVICIOS J&G SOLUTION  C.A": {
                "Apellido y Nombre del Responsable": "JESUS BERNAEZ",
                "Rif": "J-50201745-3"
            },
            "SERVICIOS R G C.A": {
                "Apellido y Nombre del Responsable": "NELSON PORRA",
                "Rif": "J-29624230-5"
            },
            "SERVICIOS TEALCA C.A": {
                "Apellido y Nombre del Responsable": "FRANKLYN MENDOZA",
                "Rif": "J-31521527-6"
            },
            "SERVINDRECO C.A": {
                "Apellido y Nombre del Responsable": "OSCAR GUERRERO",
                "Rif": "J-31347293-0"
            },
            "SUMINISTROS INDUSTRIALES JAMIG C.A": {
                "Apellido y Nombre del Responsable": "MIGUEL PEREZ",
                "Rif": "J-40990643-4"
            },
            "SYCO 73  C.A": {
                "Apellido y Nombre del Responsable": "JUAN SIVIRA",
                "Rif": "J-31762306-1"
            },
            "TELECOMUNICACIONES JD SISTEM  C.A": {
                "Apellido y Nombre del Responsable": "FLAVIA GOMEZ",
                "Rif": "J-50126527-5"
            },
            "TELEIBARRA CA&EC  C.A": {
                "Apellido y Nombre del Responsable": "CARLOS IBARRA",
                "Rif": "J-50481799-6"
            },
            "W&S TECNOMARKET C.A": {
                "Apellido y Nombre del Responsable": "YERWILL SILVA",
                "Rif": "J-30993225-0"
            },
            "WV SOLUCIONES TECNO-EMPRESARIALES  C.A": {
                "Apellido y Nombre del Responsable": "WILLIAN VALERO",
                "Rif": "J-40973178-2"
            },
            "F√âNIX FIBER NETWORK  C.A": {
                "Apellido y Nombre del Responsable": "JHONY RIBERO",
                "Rif": "J-50716628-7"
            }
        };

        // Estructura inicial por defecto CON EL NUEVO CAMPO DE A√ëO
        const DEFAULT_FORM_STRUCTURE = [
            { title: "I. Informaci√≥n General", fields: [
                { id: "form_title", label: "T√≠tulo del Formulario", type: "static", value: "Orden de Trabajo", required: true },
                { id: "ot_number", label: "Orden de Trabajo", type: "ot_counter", required: true },
                { id: "user_auto_fill", label: "Usuario que Crea la Orden", type: "user-auto-fill", required: true },
                { id: "current_date", label: "Fecha Actual", type: "date-auto", required: true },
                { id: "current_year", label: "A√±o", type: "year-auto", required: true } // NUEVO CAMPO A√ëO
            ]},
            { title: "II. Informaci√≥n de la Contratista", fields: []},
            { title: "III. Informaci√≥n del Trabajo/Obra", fields: [
                { id: "presupuesto_total", label: "Presupuesto Total de la Obra", type: "number", required: true }
            ]}
        ];

        // *** FUNCI√ìN AUXILIAR MEJORADA PARA EXTRAER A√ëO DE FECHA ***
        function extractYearFromDate(dateString) {
            if (!dateString) return getCurrentCaracasYear();
            
            // Formato DD/MM/YYYY
            if (dateString.includes('/')) {
                const parts = dateString.split('/');
                if (parts.length === 3) {
                    const year = parseInt(parts[2]);
                    if (!isNaN(year) && year > 2000 && year < 2100) {
                        return year;
                    }
                }
            }
            
            // Formato YYYY-MM-DD
            if (dateString.includes('-')) {
                const parts = dateString.split('-');
                if (parts.length === 3) {
                    const year = parseInt(parts[0]);
                    if (!isNaN(year) && year > 2000 && year < 2100) {
                        return year;
                    }
                }
            }
            
            // Por defecto, a√±o actual
            return getCurrentCaracasYear();
        }

        // *** FUNCI√ìN DE VERIFICACI√ìN DE ESTRUCTURA ***
        function verifyFormStructurePreservation() {
            const yearFieldExists = formStructure.some(section => 
                section.fields.some(field => 
                    field.type === 'year-auto' || field.label === 'A√±o'
                )
            );
            
            if (!yearFieldExists) {
                console.warn('‚ö†Ô∏è El campo "A√±o" no se encontr√≥ en la estructura del formulario');
                // Restaurar la estructura por defecto si es necesario
                formStructure = DEFAULT_FORM_STRUCTURE;
                saveFormStructure(true);
                console.log('‚úÖ Estructura del formulario restaurada a la versi√≥n por defecto');
            } else {
                console.log('‚úÖ Estructura del formulario verificada correctamente - Campo "A√±o" presente');
            }
        }
        
        // *** NUEVA FUNCI√ìN: Obtener el mes actual en zona horaria de Caracas ***
        function getCurrentCaracasMonth() {
            const now = new Date();
            const caracasOffset = -4 * 60;
            const localOffset = now.getTimezoneOffset();
            const caracasTime = new Date(now.getTime() + (localOffset - caracasOffset) * 60000);
            
            return String(caracasTime.getMonth() + 1).padStart(2, '0'); // Mes en formato 01-12
        }
        
        // *** 2. L√ìGICA DE FIREBASE: CARGA Y GUARDADO ***

        async function loadInitialData() {
            try {
                console.log("üîç Iniciando carga de datos...");
                
                // Verificar autenticaci√≥n primero
                const user = firebase.auth().currentUser;
                if (!user) {
                    throw new Error("Usuario no autenticado");
                }
                
                console.log("‚úÖ Usuario autenticado:", user.email);

                // Cargar Estructura del Formulario y Contador
                console.log("üìã Cargando configuraci√≥n...");
                const configDoc = await CONFIG_COLLECTION.doc("systemConfig").get();
                
                if (configDoc.exists) {
                    console.log("‚úÖ Configuraci√≥n encontrada");
                    const data = configDoc.data();
                    formStructure = data.formStructure || DEFAULT_FORM_STRUCTURE;
                    otCounter = data.otCounter || 1;
                    finalCertificationCounter = data.finalCertificationCounter || 1;
                } else {
                    console.log("‚ö†Ô∏è Configuraci√≥n no encontrada, usando valores por defecto");
                    formStructure = DEFAULT_FORM_STRUCTURE;
                    await saveFormStructure(true); 
                }
                
                // Cargar √ìrdenes de Trabajo EN CURSO
                console.log("üìÇ Cargando √≥rdenes en curso...");
                const ordersSnapshot = await ORDERS_COLLECTION.orderBy('Fecha Actual', 'desc').get();
                workOrders = ordersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log(`‚úÖ ${workOrders.length} √≥rdenes en curso cargadas`);

                // Cargar √ìrdenes de Trabajo FINALIZADAS
                console.log("‚úÖ Cargando √≥rdenes finalizadas...");
                const completedSnapshot = await COMPLETED_ORDERS_COLLECTION.orderBy('Fecha Actual', 'desc').get();
                completedOrders = completedSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log(`‚úÖ ${completedOrders.length} √≥rdenes finalizadas cargadas`);

                // Cargar Certificaciones Finales
                console.log("üìú Cargando certificaciones finales...");
                const certificationsSnapshot = await FINAL_CERTIFICATIONS_COLLECTION.orderBy('N√∫mero de Certificaci√≥n Final', 'desc').get();
                finalCertifications = certificationsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log(`‚úÖ ${finalCertifications.length} certificaciones finales cargadas`);

                // Asegurar que los contadores est√©n correctos al inicio
                recalculateOtCounter();
                recalculateFinalCertificationCounter(); // NUEVO: Recalcular certificaciones finales
                console.log("üéØ Contador actualizado:", otCounter);
                console.log("üéØ Contador certificaciones finales:", finalCertificationCounter);

                // Verificar la preservaci√≥n de la estructura
                verifyFormStructurePreservation();

                console.log("üöÄ Carga de datos completada exitosamente");

            } catch (error) {
                console.error("‚ùå Error cargando datos iniciales: ", error);
                console.error("C√≥digo del error:", error.code);
                console.error("Mensaje del error:", error.message);
                
                let errorMessage = "Error al conectar con la base de datos. ";
                
                if (error.code === 'permission-denied') {
                    errorMessage += "ERROR DE PERMISOS: Configure las reglas de seguridad de Firestore para permitir acceso a usuarios autenticados.";
                } else if (error.code === 'unavailable') {
                    errorMessage += "Error de conexi√≥n a internet.";
                } else if (error.message.includes("no autenticado")) {
                    errorMessage += "Usuario no autenticado correctamente.";
                } else {
                    errorMessage += `Detalles: ${error.message}`;
                }
                
                alert(errorMessage);
                throw error;
            }
        }
        
        async function saveFormStructure(initial = false) {
            try {
                await CONFIG_COLLECTION.doc("systemConfig").set({
                    formStructure: formStructure,
                    otCounter: otCounter,
                    finalCertificationCounter: finalCertificationCounter
                }, { merge: true });

                if (!initial) {
                     alert('üéâ Estructura del formulario y contador guardados exitosamente en la nube.');
                     renderWorkOrderForm();
                }
            } catch (e) {
                console.error("Error al guardar la estructura:", e);
                alert("Error al guardar la estructura en Firebase.");
            }
        }
        
        // MODIFICADA: L√≥gica de Roles
        function getRoleFromEmail(email) {
            if (ADMIN_EMAILS.includes(email)) {
                return 'admin';
            } 
            else if (VIEWER_EMAILS.includes(email)) { 
                return 'viewer'; 
            } 
            else {
                return 'normal'; 
            }
        }

        async function login() {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            const errorElement = document.getElementById('login-error');
            errorElement.textContent = '';
            
            try {
                const userCredential = await firebase.auth().signInWithEmailAndPassword(email, pass);
                const user = userCredential.user;
                
                let role = getRoleFromEmail(user.email); 
                
                currentRole = role;
                
                document.getElementById('login-view').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                initializeApp(role);
                
            } catch (error) {
                console.error("Error de autenticaci√≥n:", error.code, error.message);
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    errorElement.textContent = 'Credenciales incorrectas o usuario no encontrado.';
                } else if (error.code === 'auth/invalid-email') {
                    errorElement.textContent = 'El formato del correo es inv√°lido.';
                } else if (error.code === 'auth/api-key-not-valid') {
                    errorElement.textContent = 'ERROR DE CONFIGURACI√ìN: La Clave API de Firebase no es v√°lida. Por favor, verifique la configuraci√≥n de Firebase en el c√≥digo.';
                } else {
                    errorElement.textContent = 'Error de conexi√≥n. Intente de nuevo.';
                }
            }
        }

        function logout() {
            firebase.auth().signOut().then(() => {
                document.getElementById('email').value = '';
                document.getElementById('password').value = '';
                alert('Sesi√≥n cerrada correctamente.');
            }).catch((error) => {
                console.error("Error al cerrar sesi√≥n:", error);
                alert('Error al cerrar sesi√≥n.');
            });
        }

        async function initializeApp(role) {
            try {
                console.log("üîê Inicializando app para rol:", role);
                
                // Verificar que el usuario est√© autenticado
                const user = firebase.auth().currentUser;
                if (!user) {
                    throw new Error("Usuario no autenticado durante inicializaci√≥n");
                }
                
                const isCreator = (role === 'admin' || role === 'normal');

                document.getElementById('edit-tab-button').style.display = (role === 'admin') ? 'inline-block' : 'none';
                document.getElementById('new-order-tab-button').style.display = isCreator ? 'inline-block' : 'none';
                
                // Cargar datos despu√©s de verificar autenticaci√≥n
                await loadInitialData(); 
                
                if (role === 'admin') {
                    renderFormEditor();
                    openTab(null, 'edit-form');
                } else if (role === 'normal') {
                    openTab(null, 'new-order');
                } else if (role === 'viewer') {
                    openTab(null, 'view-orders'); 
                }
                
                renderWorkOrderForm();
                renderOrdersTable();
                renderCompletedOrdersTable();
                renderFinalCertificationForm();
                renderFinalCertificationsList();
                
                console.log("‚úÖ App inicializada correctamente");
                
            } catch (error) {
                console.error("‚ùå Error en initializeApp:", error);
                alert("Error al inicializar la aplicaci√≥n: " + error.message);
                logout();
            }
        }

        window.onload = function() {
            firebase.auth().onAuthStateChanged(user => {
                if (user) {
                    let role = getRoleFromEmail(user.email); 
                    currentRole = role;
                    
                    document.getElementById('login-view').style.display = 'none';
                    document.getElementById('main-app').style.display = 'block';
                    initializeApp(role);
                } else {
                    currentRole = null;
                    document.getElementById('main-app').style.display = 'none';
                    document.getElementById('login-view').style.display = 'block';
                }
            });
        }
        
        function openTab(evt, tabName) {
            let i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            if (evt) evt.currentTarget.className += " active";

            if (tabName === 'new-order' && formStructure) renderWorkOrderForm();
            else if (tabName === 'view-orders') {
                renderOrdersTable();
                initializeFilters();
            }
            else if (tabName === 'completed-orders') {
                renderCompletedOrdersTable();
                initializeCompletedFilters();
            }
            else if (tabName === 'final-certification') {
                renderFinalCertificationForm();
            }
            else if (tabName === 'view-certifications') {
                renderFinalCertificationsList();
                initializeCertificationFilters();
            }
            else if (tabName === 'edit-form' && currentRole === 'admin' && formStructure) renderFormEditor();
        }
        
        // *** 4. L√ìGICA DE EDICI√ìN DE FORMULARIO (ADMIN) ***

        function renderFormEditor() {
            const editorDiv = document.getElementById('form-editor');
            editorDiv.innerHTML = '';

            formStructure.forEach((section, secIndex) => {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'form-section';
                sectionDiv.innerHTML = `
                    <h4>Secci√≥n ${secIndex + 1}: <input type="text" value="${section.title}" oninput="updateSectionTitle(${secIndex}, this.value)" style="width: 70%; display: inline;"></h4>
                    <button onclick="addField(${secIndex}, 'text')">‚ûï Agregar Campo de Texto</button>
                    <button onclick="addField(${secIndex}, 'select')">‚ûï Agregar Lista (Select)</button>
                    <button onclick="addField(${secIndex}, 'date-input')">üìÖ Agregar Campo de Fecha</button>
                    <button onclick="addField(${secIndex}, 'textarea')">üìù Agregar √Årea de Texto</button>
                    <hr>
                    <div id="fields-container-${secIndex}"></div>
                `;
                editorDiv.appendChild(sectionDiv);

                const fieldsContainer = document.getElementById(`fields-container-${secIndex}`);
                section.fields.forEach((field, fieldIndex) => {
                    if (field.type === 'static' || field.type === 'ot_counter' || field.type === 'date-auto' || field.type === 'user-auto-fill' || field.type === 'year-auto' ||
                        (secIndex === 2 && fieldIndex === 0 && field.label === 'Presupuesto Total de la Obra')) {
                        fieldsContainer.innerHTML += `<p class="required-fixed-field"><strong>${field.label}</strong> (Campo fijo obligatorio)</p>`;
                        return;
                    }

                    const fieldDiv = document.createElement('div');
                    fieldDiv.className = 'field-editor-item';
                    fieldDiv.innerHTML = `
                        <label>Etiqueta:</label>
                        <input type="text" value="${field.label}" oninput="updateFieldProperty(${secIndex}, ${fieldIndex}, 'label', this.value)">
                        <label>Tipo:</label>
                        <select onchange="updateFieldProperty(${secIndex}, ${fieldIndex}, 'type', this.value)">
                            <option value="text" ${field.type === 'text' ? 'selected' : ''}>Texto (Corto)</option>
                            <option value="number" ${field.type === 'number' ? 'selected' : ''}>N√∫mero</option>
                            <option value="textarea" ${field.type === 'textarea' ? 'selected' : ''}>√Årea de Texto (Largo)</option>
                            <option value="select" ${field.type === 'select' ? 'selected' : ''}>Lista Desplegable (Simple)</option>
                            <option value="autofill-select" ${field.type === 'autofill-select' ? 'selected' : ''}>Lista (Autollenado Contratista) üìù</option>
                            <option value="date-input" ${field.type === 'date-input' ? 'selected' : ''}>Fecha (Calendario) üìÖ</option>
                            <option value="year-auto" ${field.type === 'year-auto' ? 'selected' : ''}>A√±o (Autom√°tico) üìÖ</option>
                        </select>
                        <label>Clasificaci√≥n:</label>
                        <input type="checkbox" id="req-${secIndex}-${fieldIndex}" ${field.required ? 'checked' : ''} onchange="updateFieldProperty(${secIndex}, ${fieldIndex}, 'required', this.checked)"> 
                        <label for="req-${secIndex}-${fieldIndex}" style="display: inline-block; font-weight: normal;">Obligatorio</label>
                        
                        <div id="select-options-${secIndex}-${fieldIndex}" style="margin-top: 10px; ${field.type !== 'select' && field.type !== 'autofill-select' ? 'display: none;' : ''}">
                            <strong>Opciones de Lista (solo visible si es 'Select' o 'Autofill-Select'). </strong>
                            ${field.type === 'autofill-select' ? 
                                '<p style="color: var(--color-error);">‚ö†Ô∏è **Autollenado:** Las opciones se toman de `CONTRATISTAS_DATA` y anulan esta lista.</p>' : ''
                            }
                            <input type="text" value="${(field.options || []).join(', ')}" oninput="updateSelectOptions(${secIndex}, ${fieldIndex}, this.value)">
                        </div>
                        <button onclick="removeField(${secIndex}, ${fieldIndex})" style="background-color: var(--color-error); color: var(--color-white);">üóëÔ∏è Eliminar Campo</button>
                    `;
                    fieldsContainer.appendChild(fieldDiv);
                });
            });
        }
        
        function updateSectionTitle(secIndex, newTitle) { formStructure[secIndex].title = newTitle; }

        function updateFieldProperty(secIndex, fieldIndex, prop, value) {
            formStructure[secIndex].fields[fieldIndex][prop] = value;
            if (prop === 'type') {
                if ((value === 'select' || value === 'autofill-select') && !formStructure[secIndex].fields[fieldIndex].options) {
                    formStructure[secIndex].fields[fieldIndex].options = ['Opci√≥n A', 'Opci√≥n B'];
                }
                renderFormEditor();
            }
        }

        function updateSelectOptions(secIndex, fieldIndex, value) {
            formStructure[secIndex].fields[fieldIndex].options = value.split(',').map(s => s.trim()).filter(s => s.length > 0);
        }

        function addField(secIndex, type) {
            const newField = {
                id: `dynamic_field_${Date.now()}`,
                label: `Nuevo Campo ${type === 'select' || type === 'autofill-select' ? 'Lista' : (type === 'date-input' ? 'Fecha' : (type === 'textarea' ? 'Texto Largo' : (type === 'year-auto' ? 'A√±o' : 'Texto')))}`,
                type: type,
                required: false
            };
            if (type === 'select' || type === 'autofill-select') newField.options = ['Opci√≥n A', 'Opci√≥n B'];
            formStructure[secIndex].fields.push(newField);
            renderFormEditor();
        }

        function removeField(secIndex, fieldIndex) {
            const isFixed = formStructure[secIndex].fields[fieldIndex].type === 'static' || 
                            formStructure[secIndex].fields[fieldIndex].type === 'ot_counter' ||
                            formStructure[secIndex].fields[fieldIndex].type === 'date-auto' ||
                            formStructure[secIndex].fields[fieldIndex].type === 'user-auto-fill' ||
                            formStructure[secIndex].fields[fieldIndex].type === 'year-auto' ||
                            (secIndex === 2 && fieldIndex === 0 && formStructure[secIndex].fields[fieldIndex].label === 'Presupuesto Total de la Obra');
            
            if ((secIndex === 0 && isFixed) || (secIndex === 2 && isFixed)) {
                alert("üö´ No se pueden eliminar los campos fijos y obligatorios de las secciones principales.");
                return;
            }
            if (confirm('¬øEst√°s seguro de que quieres eliminar este campo?')) {
                formStructure[secIndex].fields.splice(fieldIndex, 1);
                renderFormEditor();
            }
        }

        // *** 5. L√ìGICA DE CREACI√ìN DE ORDEN DE TRABAJO ***
        
        function formatDateToDDMMYYYY(dateString) {
            if (!dateString) return 'N/A';
            
            if (dateString.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                return dateString;
            }

            const parts = dateString.split('-');
            if (parts.length === 3) {
                const [year, month, day] = parts;
                return `${day}/${month}/${year}`;
            }

            return dateString;
        }

        function getCurrentCaracasDate() {
            const now = new Date();
            const caracasOffset = -4 * 60;
            const localOffset = now.getTimezoneOffset();
            const caracasTime = new Date(now.getTime() + (localOffset - caracasOffset) * 60000);
            
            const day = String(caracasTime.getDate()).padStart(2, '0');
            const month = String(caracasTime.getMonth() + 1).padStart(2, '0');
            const year = caracasTime.getFullYear();
            
            return `${day}/${month}/${year}`;
        }
        
        // NUEVA FUNCI√ìN: Obtener el a√±o actual en zona horaria de Caracas
        function getCurrentCaracasYear() {
            const now = new Date();
            const caracasOffset = -4 * 60;
            const localOffset = now.getTimezoneOffset();
            const caracasTime = new Date(now.getTime() + (localOffset - caracasOffset) * 60000);
            
            return caracasTime.getFullYear();
        }
        
        function autofillContratistaData(selectElement) {
            const selectedCompanyName = selectElement.value;
            const data = CONTRATISTAS_DATA[selectedCompanyName];
            
            if (!data) {
                document.getElementById('Apellido y Nombre del Responsable').value = '';
                document.getElementById('Rif').value = '';
                return;
            }

            const responsibleField = document.getElementById('Apellido y Nombre del Responsable');
            const rifField = document.getElementById('Rif');

            if (responsibleField && data["Apellido y Nombre del Responsable"] !== undefined) {
                responsibleField.value = data["Apellido y Nombre del Responsable"];
            }
            if (rifField && data["Rif"] !== undefined) {
                rifField.value = data["Rif"];
            }
        }

        function calculateNewTotal(prefix) {
            try {
                const precioUnitario = parseFloat(
                    (document.getElementById(`${prefix}_precio_unitario`).value || '0')
                    .replace(',', '.')
                ) || 0;
                
                const puntos = parseFloat(
                    (document.getElementById(`${prefix}_puntos`).value || '0')
                    .replace(',', '.')
                ) || 0;
                
                const total = precioUnitario * puntos;
                
                const totalDisplay = document.getElementById(`${prefix}_total_display`);
                const totalHidden = document.getElementById(`${prefix}_total_hidden`);
                
                if (totalDisplay) totalDisplay.textContent = total.toFixed(2);
                if (totalHidden) totalHidden.value = total.toFixed(2);
                
                const precioUnitario1 = parseFloat(
                    (document.getElementById(`${prefix}_precio_unitario1`).value || '0')
                    .replace(',', '.')
                ) || 0;
                
                const puntos1 = parseFloat(
                    (document.getElementById(`${prefix}_puntos1`).value || '0')
                    .replace(',', '.')
                ) || 0;
                
                const total1 = precioUnitario1 * puntos1;
                
                const totalDisplay1 = document.getElementById(`${prefix}_total_display1`);
                const totalHidden1 = document.getElementById(`${prefix}_total_hidden1`);
                
                if (totalDisplay1) totalDisplay1.textContent = total1.toFixed(2);
                if (totalHidden1) totalHidden1.value = total1.toFixed(2);
                
            } catch (error) {
                console.error('Error en calculateNewTotal:', error);
            }
        }

        function toggleConditionalSection(type) {
            try {
                const nodeAccessSection = document.getElementById('conditional_node_acceso_section');
                const ispSection = document.getElementById('conditional_isp_section');
                const nodeAccessButton = document.getElementById('check_node_acceso');
                const ispButton = document.getElementById('check_isp');

                if (!nodeAccessSection || !ispSection || !nodeAccessButton || !ispButton) {
                    console.error('Elementos de secci√≥n condicional no encontrados');
                    return;
                }

                nodeAccessSection.style.display = 'none';
                ispSection.style.display = 'none';
                nodeAccessButton.classList.remove('active');
                ispButton.classList.remove('active');
                
                const fieldsToReset = ['costo_proyectado', 'precio_unitario', 'puntos', 'precio_unitario1', 'puntos1', 'descripcion', 'abono_mensual'];
                const selectsToReset = ['pago_por_realizado'];

                ['node_acceso', 'isp'].forEach(prefix => {
                    fieldsToReset.forEach(field => {
                        const el = document.getElementById(`${prefix}_${field}`);
                        if (el) el.value = '';
                    });
                    selectsToReset.forEach(field => {
                        const el = document.getElementById(`${prefix}_${field}`);
                        if (el) el.value = 'Inter';
                    });
                    
                    const totalDisplay = document.getElementById(`${prefix}_total_display`);
                    const totalDisplay1 = document.getElementById(`${prefix}_total_display1`);
                    const totalHidden = document.getElementById(`${prefix}_total_hidden`);
                    const totalHidden1 = document.getElementById(`${prefix}_total_hidden1`);
                    
                    if (totalDisplay) totalDisplay.textContent = '0.00';
                    if (totalDisplay1) totalDisplay1.textContent = '0.00';
                    if (totalHidden) totalHidden.value = '0.00';
                    if (totalHidden1) totalHidden1.value = '0.00';
                });

                if (type === 'node_acceso') {
                    nodeAccessSection.style.display = 'block';
                    nodeAccessButton.classList.add('active');
                } else if (type === 'isp') {
                    ispSection.style.display = 'block';
                    ispButton.classList.add('active');
                }
            } catch (error) {
                console.error('Error en toggleConditionalSection:', error);
            }
        }

        function renderWorkOrderForm() {
            const formElement = document.getElementById('work-order-form');
            formElement.innerHTML = '';
            const todayCaracas = getCurrentCaracasDate(); 
            const currentYear = getCurrentCaracasYear();
            const currentMonth = getCurrentCaracasMonth(); // NUEVO: Obtener mes actual
            const currentUserEmail = firebase.auth().currentUser ? firebase.auth().currentUser.email : 'USUARIO NO LOGUEADO';

            if (!formStructure) {
                 formElement.innerHTML = '<p>Cargando estructura del formulario...</p>';
                 return;
            }
            
            formStructure.forEach(section => {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'form-section';
                sectionDiv.innerHTML = `<h4>${section.title}</h4>`;

                section.fields.forEach(field => {
                    const requiredStar = field.required ? '<span style="color: var(--color-error); margin-left: 5px;">*</span>' : '';
                    let inputHTML = '';
                    let value = '';
                    let isDisabled = '';
                    let onChangeEvent = '';
                    let isAutofillField = false;

                    if (section.title.includes('II. Informaci√≥n de la Contratista')) {
                        const autofillKeys = ["Apellido y Nombre del Responsable", "Rif"];
                        if (autofillKeys.includes(field.label)) {
                            isDisabled = 'disabled';
                            isAutofillField = true;
                        } else if (field.type === 'autofill-select') {
                            onChangeEvent = `onchange="autofillContratistaData(this)"`;
                        }
                    }

                    const fieldId = isAutofillField ? field.label : field.id; 
                    
                    const isFixedField = field.type === 'static' || field.type === 'ot_counter' || field.type === 'date-auto' || field.type === 'user-auto-fill' || field.type === 'year-auto';
                    const requiredAttribute = field.required && !isFixedField ? 'required' : '';

                    switch (field.type) {
                        case 'static':
                            value = field.value;
                            inputHTML = `<input type="text" value="${value}" disabled>`;
                            break;
                        case 'ot_counter':
                            // NUEVO FORMATO: (mes-n√∫mero)
                            value = `(${currentMonth}-${otCounter})`;
                            inputHTML = `<input type="text" value="${value}" disabled>`;
                            break;
                        case 'user-auto-fill':
                            value = currentUserEmail;
                            inputHTML = `<input type="text" value="${value}" disabled>`;
                            break;
                        case 'date-auto':
                            value = todayCaracas;
                            inputHTML = `<input type="text" value="${value}" disabled>`; 
                            break;
                        case 'year-auto':
                            value = currentYear;
                            inputHTML = `<input type="text" value="${value}" disabled>`;
                            break;
                        case 'date-input':
                            inputHTML = `<input type="date" id="${fieldId}" name="${fieldId}" ${requiredAttribute} ${isDisabled}>`;
                            break;
                        case 'text':
                        case 'number':
                            if (field.label === 'Presupuesto Total de la Obra') {
                                inputHTML = `<input type="number" id="${fieldId}" name="${fieldId}" step="0.01" min="0" max="9999999999.99" placeholder="0.00" ${requiredAttribute} ${isDisabled} oninput="validatePresupuestoTotal(this)">`;
                            } else {
                                inputHTML = `<input type="${field.type}" id="${fieldId}" name="${fieldId}" ${requiredAttribute} ${isDisabled}>`;
                            }
                            break;
                        case 'textarea':
                            inputHTML = `<textarea id="${fieldId}" name="${fieldId}" ${requiredAttribute} ${isDisabled} style="min-height: 100px;"></textarea>`;
                            break;
                        case 'select':
                            inputHTML = `<select id="${fieldId}" name="${fieldId}" ${requiredAttribute} ${isDisabled} ${onChangeEvent}>
                                ${field.options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                            </select>`;
                            break;
                        case 'autofill-select': 
                            const optionsHTML = Object.keys(CONTRATISTAS_DATA).map(key => `<option value="${key}">${key}</option>`).join('');
                            inputHTML = `<select id="${fieldId}" name="${fieldId}" ${requiredAttribute} ${isDisabled} ${onChangeEvent}>
                                ${optionsHTML}
                            </select>`;
                            break;
                    }

                    sectionDiv.innerHTML += `<p><label for="${fieldId}">${field.label}${requiredStar}:</label>${inputHTML}</p>`;
                });
                formElement.appendChild(sectionDiv);
            });
            
            formElement.innerHTML += `
                <h4>Tipo de Construcci√≥n (Selecci√≥n √önica)</h4>
                <button type="button" class="conditional-check" id="check_node_acceso" onclick="toggleConditionalSection('node_acceso')">
                    La Construcci√≥n es de un Nodo de Acceso
                </button>
                <button type="button" class="conditional-check" id="check_isp" onclick="toggleConditionalSection('isp')">
                    La Construcci√≥n es de un ISP
                </button>
                <button type="button" style="background-color: var(--color-error); color: var(--color-white); margin-top: 15px;" onclick="toggleConditionalSection(null)">
                    ‚ùå Eliminar / Desmarcar Selecci√≥n
                </button>
            `;
            
            formElement.innerHTML += renderConditionalSection('node_acceso', 'Datos Condicionales: La Construcci√≥n es de Nodo de Acceso');
            formElement.innerHTML += renderConditionalSection('isp', 'Datos Condicionales: La Construcci√≥n es de un ISP');
            
            toggleConditionalSection(null);
            
            const autofillSelects = document.querySelectorAll('select[onchange="autofillContratistaData(this)"]');
            autofillSelects.forEach(select => autofillContratistaData(select));
        }

        function validatePresupuestoTotal(input) {
            const value = parseFloat(input.value);
            const maxValue = 9999999999.99;
            
            if (value > maxValue) {
                input.setCustomValidity(`El valor m√°ximo permitido es ${maxValue.toLocaleString('es-VE', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`);
                input.reportValidity();
            } else {
                input.setCustomValidity('');
            }
        }

        function renderConditionalSection(prefix, title) {
            const onChangeFunc = `calculateNewTotal('${prefix}')`;
            
            return `
                <div class="form-section" id="conditional_${prefix}_section" style="display: none;">
                    <h4>${title}</h4>
                    
                    <p><label for="${prefix}_costo_proyectado">Costo Proyectado de la Obra (*):</label>
                        <input type="text" id="${prefix}_costo_proyectado" name="${prefix}_costo_proyectado" required></p>
                    
                    <p><label for="${prefix}_pago_por_realizado">Pago realizado por (*):</label>
                        <select id="${prefix}_pago_por_realizado" name="${prefix}_pago_por_realizado" required>
                            <option value="Inter">Inter</option>
                            <option value="Cliente">Cliente</option>
                        </select></p>
                        
                    <hr>
                    
                    <!-- SECCI√ìN CANTV -->
                    <h5>Pago x VGT CANTV</h5>
                    <div class="calculation-group">
                        <label for="${prefix}_precio_unitario">Precio Unitario (*):</label>
                        <input type="number" step="0.01" min="0" id="${prefix}_precio_unitario" name="${prefix}_precio_unitario" placeholder="0.00" oninput="${onChangeFunc}" class="calculation-input" required>
                        
                        <span class="formula-symbol">X</span>
                        
                        <label for="${prefix}_puntos">Puntos (*):</label>
                        <input type="number" step="1" min="0" id="${prefix}_puntos" name="${prefix}_puntos" placeholder="0" oninput="${onChangeFunc}" class="calculation-input" required>
                        
                        <span class="formula-symbol">=</span>
                        
                        <div class="calculation-total-section">
                            <label style="flex-basis: auto;">Pago x VGT CANTV a cargo de Inter (*):</label>
                            <div id="${prefix}_total_display" class="total-display">0.00</div>
                            <input type="hidden" id="${prefix}_total_hidden" name="${prefix}_total_hidden" value="0.00">
                        </div>
                    </div>
                    
                    <hr>
                    
                    <!-- SECCI√ìN EDC -->
                    <h5>Pago x VGT EDC</h5>
                    <div class="calculation-group">
                        <label for="${prefix}_precio_unitario1">Precio Unitario (*):</label>
                        <input type="number" step="0.01" min="0" id="${prefix}_precio_unitario1" name="${prefix}_precio_unitario1" placeholder="0.00" oninput="${onChangeFunc}" class="calculation-input" required>
                        
                        <span class="formula-symbol">X</span>
                        
                        <label for="${prefix}_puntos1">Puntos (*):</label>
                        <input type="number" step="1" min="0" id="${prefix}_puntos1" name="${prefix}_puntos1" placeholder="0" oninput="${onChangeFunc}" class="calculation-input" required>
                        
                        <span class="formula-symbol">=</span>
                        
                        <div class="calculation-total-section">
                            <label style="flex-basis: auto;">Pago x VGT EDC a cargo de Inter (*):</label>
                            <div id="${prefix}_total_display1" class="total-display">0.00</div>
                            <input type="hidden" id="${prefix}_total_hidden1" name="${prefix}_total_hidden1" value="0.00">
                        </div>
                    </div>

                    <hr>

                    <p><label for="${prefix}_descripcion">Descripci√≥n (*):</label>
                        <textarea id="${prefix}_descripcion" name="${prefix}_descripcion" required style="min-height: 120px;"></textarea></p>
                    
                    <p><label for="${prefix}_abono_mensual">Abono Mensual a Recibir por el cliente (*):</label>
                        <input type="text" id="${prefix}_abono_mensual" name="${prefix}_abono_mensual" required></p>
                        
                </div>
            `;
        }

        function sanitizeInput(str) {
            if (typeof str !== 'string' || !str) return str;
            return str.replace(/&/g, '&amp;')
                      .replace(/</g, '&lt;')
                      .replace(/>/g, '&gt;')
                      .replace(/"/g, '&quot;')
                      .replace(/'/g, '&#039;');
        }

        async function generateWorkOrder() {
            const form = document.getElementById('work-order-form');
            const selectedType = document.querySelector('.conditional-check.active');
            let firstInvalidField = null;

            for (const section of formStructure) {
                for (const field of section.fields) {
                    const isFixed = field.type === 'static' || field.type === 'ot_counter' || field.type === 'date-auto' || field.type === 'user-auto-fill' || field.type === 'year-auto';
                    
                    if (!field.required || isFixed) continue;

                    let fieldId = (section.title.includes('II. Informaci√≥n de la Contratista') && (field.label === 'Apellido y Nombre del Responsable' || field.label === 'Rif')) 
                                ? field.label 
                                : field.id;
                    
                    const inputElement = document.getElementById(fieldId);

                    if (inputElement && !inputElement.disabled && !inputElement.checkValidity()) {
                        firstInvalidField = inputElement;
                        break; 
                    }
                }
                if (firstInvalidField) break; 
            }

            if (!firstInvalidField && selectedType) {
                const prefix = selectedType.id.replace('check_', '');
                const camposCondicionales = [
                    document.getElementById(`${prefix}_costo_proyectado`),
                    document.getElementById(`${prefix}_pago_por_realizado`),
                    document.getElementById(`${prefix}_precio_unitario`),
                    document.getElementById(`${prefix}_puntos`),
                    document.getElementById(`${prefix}_precio_unitario1`),
                    document.getElementById(`${prefix}_puntos1`),
                    document.getElementById(`${prefix}_descripcion`),
                    document.getElementById(`${prefix}_abono_mensual`)
                ];

                for (const campo of camposCondicionales) {
                    if (!campo) {
                        console.error(`Campo condicional no encontrado: ${prefix}`);
                        firstInvalidField = document.getElementById(`check_${prefix}`);
                        break;
                    }
                    
                    if (campo.type === 'text' || campo.type === 'select' || campo.tagName === 'TEXTAREA' || campo.type === 'date') {
                        if (!campo.value.trim()) {
                            firstInvalidField = campo;
                            break;
                        }
                    } 
                    else if (campo.type === 'number') {
                        const numericValue = parseFloat(campo.value.replace(',', '.'));
                        if (isNaN(numericValue) || numericValue < 0) {
                            firstInvalidField = campo;
                            break;
                        }
                    }
                }
            }

            if (firstInvalidField) {
                alert('‚ö†Ô∏è Atenci√≥n: Debe completar los campos obligatorios faltantes marcados con (*). El sistema lo llevar√° al primer error.');
                
                firstInvalidField.reportValidity();
                firstInvalidField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                firstInvalidField.focus();
                return;
            }

            const formData = new FormData(form);
            const orderData = {};
            
            const caracasDate = getCurrentCaracasDate(); 
            const currentYear = getCurrentCaracasYear();
            const currentMonth = getCurrentCaracasMonth(); // NUEVO: Obtener mes actual
            const currentUserEmail = firebase.auth().currentUser ? firebase.auth().currentUser.email : 'ERROR';

            formStructure.forEach(section => {
                section.fields.forEach(field => {
                    let value;
                    let fieldId = (section.title.includes('II. Informaci√≥n de la Contratista') && (field.label === 'Apellido y Nombre del Responsable' || field.label === 'Rif')) 
                                ? field.label 
                                : field.id;

                    if (field.type === 'ot_counter') {
                        // NUEVO FORMATO: (mes-n√∫mero)
                        value = `(${currentMonth}-${otCounter})`;
                    }
                    else if (field.type === 'user-auto-fill') value = currentUserEmail; 
                    else if (field.type === 'date-auto') value = caracasDate;
                    else if (field.type === 'year-auto') value = currentYear.toString();
                    else if (field.type === 'static') value = field.value;
                    else {
                        const inputElement = document.getElementById(fieldId);
                        value = inputElement ? inputElement.value : formData.get(fieldId);
                    }
                    
                    if (field.type === 'date-input' && value && value.trim() !== '') {
                        orderData[field.label] = formatDateToDDMMYYYY(value);
                    } else {
                        const sanitizedValue = sanitizeInput(value);
                        orderData[field.label] = (sanitizedValue && sanitizedValue.trim() !== '') ? sanitizedValue : 'N/A';
                    }
                });
            });
            
            orderData['Tipo de Construcci√≥n Seleccionada'] = selectedType ? selectedType.textContent.trim() : 'Ninguno';

            if (selectedType) {
                const prefix = selectedType.id.replace('check_', '');
                
                calculateNewTotal(prefix); 

                orderData[`${prefix} | Costo Proyectado de la Obra`] = sanitizeInput(document.getElementById(`${prefix}_costo_proyectado`).value) || 'N/A';
                orderData[`${prefix} | Pago realizado por`] = sanitizeInput(document.getElementById(`${prefix}_pago_por_realizado`).value) || 'N/A';
                
                orderData[`${prefix} | Pago x VGT CANTV a cargo de Inter`] = formData.get(`${prefix}_total_hidden`) || '0.00';
                orderData[`${prefix} | Pago x VGT EDC a cargo de Inter`] = formData.get(`${prefix}_total_hidden1`) || '0.00';

                orderData[`${prefix} | Precio Unitario CANTV`] = parseFloat(document.getElementById(`${prefix}_precio_unitario`).value.replace(',', '.')).toFixed(2) || '0.00';
                orderData[`${prefix} | Puntos CANTV`] = parseFloat(document.getElementById(`${prefix}_puntos`).value.replace(',', '.')).toFixed(0) || '0'; 
                
                orderData[`${prefix} | Precio Unitario EDC`] = parseFloat(document.getElementById(`${prefix}_precio_unitario1`).value.replace(',', '.')).toFixed(2) || '0.00';
                orderData[`${prefix} | Puntos EDC`] = parseFloat(document.getElementById(`${prefix}_puntos1`).value.replace(',', '.')).toFixed(0) || '0'; 

                orderData[`${prefix} | Descripci√≥n`] = sanitizeInput(document.getElementById(`${prefix}_descripcion`).value) || 'N/A';
                orderData[`${prefix} | Abono Mensual a Recibir por el cliente`] = sanitizeInput(document.getElementById(`${prefix}_abono_mensual`).value) || 'N/A';
            }

            orderData['Estado'] = 'En curso';
            orderData['Fecha de Creaci√≥n'] = caracasDate;

            console.log("Datos a guardar en Firebase:", orderData);
            
            try {
                const docRef = await ORDERS_COLLECTION.add(orderData); 
                
                orderData.id = docRef.id; 
                workOrders.push(orderData);
                otCounter++;
                
                await saveFormStructure(true); 

                console.log('Generando PDF para nueva orden...');
                await generatePDF(orderData);
                console.log('PDF generado exitosamente');

                form.reset();
                renderWorkOrderForm(); 
                renderOrdersTable(); 
                
                alert('‚úÖ Orden de Trabajo creada exitosamente y PDF generado.');
                
            } catch (e) {
                console.error("Error al crear la orden:", e);
                console.error("Detalles completos del error:", e.message, e.stack);
                
                let errorMessage = "Error al guardar la orden de trabajo en Firebase. ";
                
                if (e.code === 'permission-denied') {
                    errorMessage += "Error de permisos. Verifique las reglas de seguridad de Firestore.";
                } else if (e.code === 'unavailable') {
                    errorMessage += "Error de conexi√≥n. Verifique su conexi√≥n a internet.";
                } else {
                    errorMessage += `Detalles: ${e.message}`;
                }
                
                alert(errorMessage);
            }
        }

        // *** 6. GENERACI√ìN DE PDF MEJORADA ***

        function formatLongTextForPDF(text, maxLineLength = 70) {
            if (!text || text === 'N/A') return 'N/A';
            
            let formattedText = text.replace(/<br\s*\/?>/gi, '\n');
            
            if (formattedText.length <= maxLineLength && !formattedText.includes('\n')) {
                return formattedText;
            }
            
            const lines = formattedText.split('\n');
            let resultLines = [];
            
            lines.forEach(line => {
                if (line.length <= maxLineLength) {
                    resultLines.push(line);
                } else {
                    const words = line.split(' ');
                    let currentLine = '';
                    
                    words.forEach(word => {
                        if ((currentLine + ' ' + word).length <= maxLineLength) {
                            currentLine += (currentLine ? ' ' : '') + word;
                        } else {
                            if (currentLine) resultLines.push(currentLine);
                            currentLine = word;
                        }
                    });
                    
                    if (currentLine) resultLines.push(currentLine);
                }
            });
            
            return resultLines.join('\n');
        }

        function generatePDF(data) {
            return new Promise((resolve, reject) => {
                try {
                    const otNumber = data['Orden de Trabajo'];
                    const creationDate = data['Fecha Actual'] || 'N/A';
                    const fileName = `Orden_Trabajo_${otNumber}_${creationDate.replace(/\//g, '-')}.pdf`;
                    
                    console.log('Iniciando generaci√≥n de PDF para orden:', otNumber);

                    const printContainer = document.createElement('div');
                    printContainer.id = 'pdf-print-container';
                    printContainer.style.cssText = `
                        position: absolute;
                        left: -9999px;
                        top: 0;
                        width: 190mm;
                        min-height: 277mm;
                        background: white;
                        padding: 10mm;
                        font-family: Arial, sans-serif;
                        box-sizing: border-box;
                        line-height: 1.4;
                        font-size: 12px;
                    `;

                    let formContentHTML = `
                        <div style="font-family: 'Arial', sans-serif; color: #36454F; line-height: 1.4; width: 100%;">
                            <div class="pdf-main-header">
                                <h1 style="color: #4682B4; text-align: center; border-bottom: 2px solid #4682B4; padding-bottom: 10px; margin-bottom: 20px; font-size: 18px;">
                                    ${data['T√≠tulo del Formulario']} Nro. ${otNumber}
                                </h1>
                                
                                <div style="text-align: right; margin-bottom: 25px; font-weight: bold; color: #555; font-size: 12px;">
                                    Fecha de Emisi√≥n: ${data['Fecha Actual']} | A√±o: ${data['A√±o'] || getCurrentCaracasYear()}
                                </div>
                            </div>
                            
                            <div class="pdf-secondary-header" style="display: none;">
                                <div style="text-align: right; font-weight: bold; color: #555; font-size: 11px; margin-bottom: 15px;">
                                    ${data['T√≠tulo del Formulario']} Nro. ${otNumber} - Fecha: ${data['Fecha Actual']} - A√±o: ${data['A√±o'] || getCurrentCaracasYear()} - P√°gina <span class="page-number"></span>
                                </div>
                            </div>
                    `;

                    formStructure.forEach((section, secIndex) => {
                        
                        formContentHTML += `<div class="pdf-section" style="margin-bottom: 20px; width: 100%; page-break-inside: avoid;">`;
                        formContentHTML += `<h3 style="color: #4682B4; margin-top: 0; margin-bottom: 12px; border-left: 4px solid #4682B4; padding-left: 8px; font-size: 14px; page-break-after: avoid;">${section.title}</h3>`;
                        formContentHTML += `<table style="width: 100%; border-collapse: collapse; table-layout: fixed; font-size: 11px;">`;
                        
                        section.fields.forEach(field => {
                            const label = field.label;
                            let value = data[label] || 'N/A';
                            
                            if (label === 'T√≠tulo del Formulario' || label === 'Orden de Trabajo' || label === 'Fecha Actual') return;
                            
                            const fieldDefinition = section.fields.find(f => f.label === label);
                            if (fieldDefinition && fieldDefinition.type === 'date-input' && value !== 'N/A') {
                                value = formatDateToDDMMYYYY(value);
                            }
                            
                            const isLongText = field.type === 'textarea' || 
                                              /descripci√≥n|descripcion|detallada|detallado|observaci√≥n|observacion|comentario|notas|detalle/i.test(label);
                            
                            let valueCellStyle = "padding: 8px 6px; vertical-align: top; border: 1px solid #B0C4DE; font-size: 11px;";
                            let labelCellStyle = "padding: 8px 6px; font-weight: bold; background-color: #F0F8FF; vertical-align: top; width: 35%; border: 1px solid #B0C4DE; font-size: 11px;";
                            
                            if (isLongText) {
                                valueCellStyle += " word-wrap: break-word; word-break: break-word; white-space: pre-wrap; line-height: 1.4; min-height: 40px; page-break-inside: avoid;";
                                value = formatLongTextForPDF(value, 70);
                            } else {
                                valueCellStyle += " page-break-inside: avoid;";
                            }

                            formContentHTML += `
                                <tr style="page-break-inside: avoid;">
                                    <td style="${labelCellStyle}">${label}:</td>
                                    <td style="${valueCellStyle} width: 65%;">${value}</td>
                                </tr>
                            `;
                        });
                        
                        formContentHTML += '</table></div>';
                    });
                    
                    const type = data['Tipo de Construcci√≥n Seleccionada'];
                    if (type && type !== 'Ninguno') {
                        const prefix = type.includes('Nodo') ? 'node_acceso' : 'isp';
                        
                        const pagoVgtCANTV = data[`${prefix} | Pago x VGT CANTV a cargo de Inter`] || '0.00';
                        const pagoVgtEDC = data[`${prefix} | Pago x VGT EDC a cargo de Inter`] || '0.00'; 
                        
                        const descripcionFormateada = formatLongTextForPDF(data[`${prefix} | Descripci√≥n`], 70);

                        formContentHTML += `<div class="pdf-section" style="margin-bottom: 20px; width: 100%; page-break-inside: avoid;">`;
                        formContentHTML += `<h3 style="color: #4682B4; margin-top: 0; margin-bottom: 12px; border-left: 4px solid #4682B4; padding-left: 8px; font-size: 14px; page-break-after: avoid;">${type}</h3>`;
                        formContentHTML += `<table style="width: 100%; border-collapse: collapse; table-layout: fixed; font-size: 11px;">`;

                        formContentHTML += `
                            <tr style="page-break-inside: avoid;">
                                <td style="padding: 8px 6px; font-weight: bold; background-color: #F0F8FF; vertical-align: top; width: 35%; border: 1px solid #B0C4DE;">Costo Proyectado de la Obra:</td>
                                <td style="padding: 8px 6px; width: 65%; border: 1px solid #B0C4DE;">${data[`${prefix} | Costo Proyectado de la Obra`]}</td>
                            </tr>
                            <tr style="page-break-inside: avoid;">
                                <td style="padding: 8px 6px; font-weight: bold; background-color: #F0F8FF; vertical-align: top; border: 1px solid #B0C4DE;">Pago realizado por:</td>
                                <td style="padding: 8px 6px; border: 1px solid #B0C4DE;">${data[`${prefix} | Pago realizado por`]}</td>
                            </tr>
                            
                            <tr style="background-color: #e0f7fa; page-break-inside: avoid;">
                                <td style="padding: 10px 6px; font-weight: bold; border: 1px solid #B0C4DE;">Pago x VGT CANTV a cargo de Inter:</td>
                                <td style="padding: 10px 6px; font-weight: bold; background-color: #ADD8E6; border: 1px solid #B0C4DE;">${pagoVgtCANTV}</td>
                            </tr>
                            
                            <tr style="background-color: #e0f7fa; page-break-inside: avoid;">
                                <td style="padding: 10px 6px; font-weight: bold; border: 1px solid #B0C4DE;">Pago x VGT EDC a cargo de Inter:</td>
                                <td style="padding: 10px 6px; font-weight: bold; background-color: #ADD8E6; border: 1px solid #B0C4DE;">${pagoVgtEDC}</td>
                            </tr>
                            
                            <tr style="page-break-inside: avoid;">
                                <td style="padding: 8px 6px; font-weight: bold; background-color: #F0F8FF; vertical-align: top; border: 1px solid #B0C4DE;">Descripci√≥n:</td>
                                <td style="padding: 8px 6px; word-wrap: break-word; word-break: break-word; white-space: pre-wrap; line-height: 1.4; min-height: 60px; border: 1px solid #B0C4DE; page-break-inside: avoid;">${descripcionFormateada}</td>
                            </tr>
                            
                            <tr style="page-break-inside: avoid;">
                                <td style="padding: 8px 6px; font-weight: bold; background-color: #F0F8FF; vertical-align: top; border: 1px solid #B0C4DE;">Abono Mensual a Recibir por el cliente:</td>
                                <td style="padding: 8px 6px; border: 1px solid #B0C4DE;">${data[`${prefix} | Abono Mensual a Recibir por el cliente`]}</td>
                            </tr>
                        `;

                        formContentHTML += '</table></div>';
                    }

                    formContentHTML += `
                        <div style="margin-top: 40px; padding-top: 20px; border-top: 2px dashed #B0C4DE; width: 100%; page-break-inside: avoid;">
                            <div style="display: flex; justify-content: space-between; font-size: 12px; font-weight: bold; width: 100%;">
                                <div style="width: 45%;">
                                    Firma Contratista:
                                    <div style="border-top: 1px solid #36454F; margin-top: 5px; padding-top: 40px;"></div>
                                </div>
                                <div style="width: 45%;">
                                    Firma Responsable:
                                    <div style="border-top: 1px solid #36454F; margin-top: 5px; padding-top: 40px;"></div>
                                </div>
                            </div>
                        </div>
                    `;

                    formContentHTML += '</div>';

                    const pageBreakCSS = `
                        <style>
                            @media print {
                                @page {
                                    margin: 10mm;
                                    size: A4;
                                }
                                
                                .pdf-main-header {
                                    display: block;
                                }
                                
                                .pdf-secondary-header {
                                    display: block !important;
                                    margin-bottom: 15px;
                                    padding-bottom: 10px;
                                    border-bottom: 1px solid #B0C4DE;
                                }
                                
                                .pdf-section {
                                    page-break-inside: avoid;
                                    break-inside: avoid;
                                }
                                
                                table {
                                    page-break-inside: auto;
                                }
                                
                                tr {
                                    page-break-inside: avoid;
                                    page-break-after: auto;
                                }
                                
                                .keep-together {
                                    page-break-inside: avoid;
                                }
                                
                                .page-break {
                                    page-break-before: always;
                                }
                                
                                .signature-section {
                                    page-break-before: avoid;
                                    page-break-inside: avoid;
                                }
                            }
                            
                            body {
                                margin: 0;
                                padding: 0;
                                font-family: Arial, sans-serif;
                                line-height: 1.4;
                            }
                        </style>
                    `;

                    printContainer.innerHTML = pageBreakCSS + formContentHTML;
                    document.body.appendChild(printContainer);

                    console.log('Contenedor PDF creado y agregado al DOM');

                    const opt = {
                        margin:       10,
                        filename:     fileName,
                        image:        { 
                            type: 'jpeg', 
                            quality: 0.98 
                        },
                        html2canvas:  { 
                            scale: 2,
                            useCORS: true,
                            logging: false,
                            scrollX: 0,
                            scrollY: 0,
                            onclone: function(clonedDoc) {
                                const clonedContainer = clonedDoc.getElementById('pdf-print-container');
                                if (clonedContainer) {
                                    clonedContainer.style.position = 'relative';
                                    clonedContainer.style.left = '0';
                                    clonedContainer.style.top = '0';
                                    
                                    const pageNumbers = clonedDoc.querySelectorAll('.page-number');
                                    pageNumbers.forEach((span, index) => {
                                        span.textContent = (index + 2);
                                    });
                                }
                            }
                        },
                        jsPDF:        { 
                            unit: 'mm', 
                            format: 'a4', 
                            orientation: 'portrait',
                            compress: true,
                            hotfixes: ["px_scaling"]
                        }
                    };

                    setTimeout(() => {
                        console.log('Generando PDF desde elemento...');
                        
                        const tempContainer = document.getElementById('pdf-print-container');
                        if (tempContainer) {
                            tempContainer.style.position = 'relative';
                            tempContainer.style.left = '0';
                            tempContainer.style.top = '0';
                        }
                        
                        html2pdf()
                            .set(opt)
                            .from(printContainer)
                            .save()
                            .then(() => {
                                console.log('PDF generado y descargado exitosamente:', fileName);
                                if (document.body.contains(printContainer)) {
                                    document.body.removeChild(printContainer);
                                }
                                resolve();
                            })
                            .catch(error => {
                                console.error('Error al generar PDF:', error);
                                if (document.body.contains(printContainer)) {
                                    document.body.removeChild(printContainer);
                                }
                                reject(error);
                            });
                    }, 1000);

                } catch (error) {
                    console.error('Error en generatePDF:', error);
                    const printContainer = document.getElementById('pdf-print-container');
                    if (printContainer && document.body.contains(printContainer)) {
                        document.body.removeChild(printContainer);
                    }
                    reject(error);
                }
            });
        }
        
        function downloadOrder(orderId) {
            console.log('Intentando descargar orden ID:', orderId);
            
            const order = workOrders.find(o => o.id === orderId);
            if (order) {
                console.log('Orden encontrada, generando PDF...');
                generatePDF(order).then(() => {
                    console.log('PDF descargado exitosamente');
                }).catch(error => {
                    console.error('Error al generar PDF:', error);
                    alert('Error al generar el PDF. Por favor, intente nuevamente.');
                });
            } else {
                console.error('Orden no encontrada con ID:', orderId);
                alert('No se encontr√≥ la Orden de Trabajo para descargar.');
            }
        }
        
        // *** 7. L√ìGICA DE ELIMINACI√ìN Y CONTADOR ***

        function recalculateOtCounter() {
            if (workOrders.length === 0) {
                otCounter = 1;
                return;
            }

            const currentMonth = getCurrentCaracasMonth(); // NUEVO: Obtener mes actual
            
            // Filtrar √≥rdenes del mes actual y extraer n√∫meros
            const currentMonthOrders = workOrders.filter(order => {
                const otNumber = order['Orden de Trabajo'];
                if (typeof otNumber === 'string' && otNumber.startsWith(`(${currentMonth}-`)) {
                    return true;
                }
                return false;
            });

            const allOtNumbers = currentMonthOrders.map(order => {
                const otNumber = order['Orden de Trabajo'];
                if (typeof otNumber === 'string' && otNumber.startsWith(`(${currentMonth}-`)) {
                    // Extraer el n√∫mero despu√©s del gui√≥n: (11-15) -> 15
                    const match = otNumber.match(/\((\d+)-(\d+)\)/);
                    if (match && match[2]) {
                        return parseInt(match[2], 10);
                    }
                }
                return 0;
            }).filter(ot => !isNaN(ot) && ot > 0);

            if (allOtNumbers.length === 0) {
                otCounter = 1;
                return;
            }

            const maxOt = Math.max(...allOtNumbers);
            const uniqueOtNumbers = [...new Set(allOtNumbers)];
            
            if (uniqueOtNumbers.length !== allOtNumbers.length) {
                console.warn('‚ö†Ô∏è Se detectaron n√∫meros de orden duplicados en el mes actual');
                
                let nextAvailable = maxOt + 1;
                while (allOtNumbers.includes(nextAvailable)) {
                    nextAvailable++;
                }
                otCounter = nextAvailable;
            } else {
                otCounter = maxOt + 1;
            }
            
            console.log(`Contador recalculado para mes ${currentMonth}: ${otCounter} (M√°ximo encontrado: ${maxOt})`);
        }

        // *** FUNCI√ìN NUEVA: Recalcular contador de certificaciones finales ***
        function recalculateFinalCertificationCounter() {
            if (finalCertifications.length === 0) {
                finalCertificationCounter = 1;
                return;
            }

            const currentMonth = getCurrentCaracasMonth();
            
            // Filtrar certificaciones del mes actual
            const currentMonthCertifications = finalCertifications.filter(cert => {
                const certNumber = cert['N√∫mero de Certificaci√≥n Final'];
                if (typeof certNumber === 'string' && certNumber.startsWith(`(${currentMonth}-`)) {
                    return true;
                }
                return false;
            });

            const allCertNumbers = currentMonthCertifications.map(cert => {
                const certNumber = cert['N√∫mero de Certificaci√≥n Final'];
                if (typeof certNumber === 'string' && certNumber.startsWith(`(${currentMonth}-`)) {
                    const match = certNumber.match(/\((\d+)-(\d+)\)/);
                    if (match && match[2]) {
                        return parseInt(match[2], 10);
                    }
                }
                return 0;
            }).filter(cert => !isNaN(cert) && cert > 0);

            if (allCertNumbers.length === 0) {
                finalCertificationCounter = 1;
                return;
            }

            const maxCert = Math.max(...allCertNumbers);
            finalCertificationCounter = maxCert + 1;
            
            console.log(`Contador de certificaciones finales recalculado para mes ${currentMonth}: ${finalCertificationCounter}`);
        }

        async function deleteWorkOrder(orderId, otNumber) {
            if (currentRole !== 'admin') {
                alert('üö´ Permiso denegado. Solo un administrador puede eliminar √≥rdenes. Refuerce las reglas de seguridad de Firestore.');
                return;
            }

            if (!confirm(`¬øEst√° seguro de que desea eliminar la Orden de Trabajo Nro. ${otNumber}? Esta acci√≥n es irreversible y ajustar√° el contador.`)) {
                return;
            }
            
            try {
                await ORDERS_COLLECTION.doc(orderId).delete();
                workOrders = workOrders.filter(order => order.id !== orderId);
                recalculateOtCounter();
                await saveFormStructure(true);
                renderOrdersTable();
                renderWorkOrderForm(); 

                alert(`‚úÖ Orden de Trabajo Nro. ${otNumber} eliminada y contador actualizado a ${otCounter}.`);

            } catch (e) {
                console.error("Error al eliminar la orden:", e);
                alert("Error al eliminar la Orden de Trabajo de Firebase. Detalles: " + e.message);
            }
        }

        async function deleteCompletedOrder(orderId, otNumber) {
            if (currentRole !== 'admin') {
                alert('üö´ Permiso denegado. Solo un administrador puede eliminar √≥rdenes finalizadas.');
                return;
            }

            if (!confirm(`¬øEst√° seguro de que desea eliminar permanentemente la Orden Finalizada Nro. ${otNumber}? Esta acci√≥n es irreversible.`)) {
                return;
            }
            
            try {
                await COMPLETED_ORDERS_COLLECTION.doc(orderId).delete();
                completedOrders = completedOrders.filter(order => order.id !== orderId);
                renderCompletedOrdersTable();
                
                alert(`‚úÖ Orden Finalizada Nro. ${otNumber} eliminada permanentemente.`);

            } catch (e) {
                console.error("Error al eliminar la orden finalizada:", e);
                alert("Error al eliminar la Orden Finalizada de Firebase. Detalles: " + e.message);
            }
        }

        function renderOrdersTable() {
            const tbody = document.getElementById('orders-table').querySelector('tbody');
            const noResultsDiv = document.getElementById('no-results');
            tbody.innerHTML = '';

            let filteredOrders = workOrders;
            if (activeFilters.length > 0) {
                filteredOrders = workOrders.filter(order => {
                    return activeFilters.every(filter => {
                        const fieldValue = order[filter.field] || '';
                        const filterValue = filter.value;
                        
                        switch (filter.operator) {
                            case 'contains':
                                return fieldValue.toString().toLowerCase().includes(filterValue.toLowerCase());
                            case 'equals':
                                return fieldValue.toString().toLowerCase() === filterValue.toLowerCase();
                            case 'startsWith':
                                return fieldValue.toString().toLowerCase().startsWith(filterValue.toLowerCase());
                            case 'endsWith':
                                return fieldValue.toString().toLowerCase().endsWith(filterValue.toLowerCase());
                            case 'range':
                                const [min, max] = filterValue.split('-').map(v => parseFloat(v.trim()));
                                const numValue = parseFloat(fieldValue);
                                return !isNaN(numValue) && numValue >= min && numValue <= max;
                            case 'greater':
                                const greaterValue = parseFloat(fieldValue);
                                const greaterFilter = parseFloat(filterValue);
                                return !isNaN(greaterValue) && greaterValue > greaterFilter;
                            case 'less':
                                const lessValue = parseFloat(fieldValue);
                                const lessFilter = parseFloat(filterValue);
                                return !isNaN(lessValue) && lessValue < lessFilter;
                            default:
                                return true;
                        }
                    });
                });
            }

            const sortedOrders = [...filteredOrders].sort((a, b) => {
                const otA = parseInt(a['Orden de Trabajo'], 10) || 0;
                const otB = parseInt(b['Orden de Trabajo'], 10) || 0;
                return otA - otB;
            });

            if (sortedOrders.length === 0) {
                noResultsDiv.style.display = 'block';
            } else {
                noResultsDiv.style.display = 'none';
            }

            sortedOrders.forEach(order => {
                const row = tbody.insertRow();
                row.insertCell().textContent = order['Orden de Trabajo'];
                row.insertCell().textContent = order['T√≠tulo del Formulario'];
                const creationDate = order['Fecha Actual'] || 'N/A';
                row.insertCell().textContent = creationDate;
                
                const statusCell = row.insertCell();
                const statusBadge = document.createElement('span');
                statusBadge.className = 'status-badge status-in-progress';
                statusBadge.textContent = 'En curso';
                statusCell.appendChild(statusBadge);
                
                const actionCell = row.insertCell();
                
                const downloadBtn = document.createElement('button');
                downloadBtn.textContent = '‚¨áÔ∏è PDF';
                downloadBtn.style.backgroundColor = '#77DD77'; 
                downloadBtn.style.color = 'white';
                downloadBtn.onclick = () => {
                    console.log('Bot√≥n PDF clickeado para orden:', order.id);
                    downloadOrder(order.id);
                };
                actionCell.appendChild(downloadBtn);
                
                const completeBtn = document.createElement('button');
                completeBtn.textContent = '‚úÖ Finalizar';
                completeBtn.className = 'complete-button';
                completeBtn.style.marginLeft = '5px';
                completeBtn.onclick = () => openCertificationModal(order);
                actionCell.appendChild(completeBtn);
                
                if (currentRole === 'admin') {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'üóëÔ∏è Eliminar';
                    deleteBtn.style.backgroundColor = 'var(--color-error)';
                    deleteBtn.style.color = 'white';
                    deleteBtn.style.marginLeft = '5px';
                    deleteBtn.onclick = () => deleteWorkOrder(order.id, order['Orden de Trabajo']);
                    actionCell.appendChild(deleteBtn);
                }
            });
        }

        // *** 8. NUEVAS FUNCIONES PARA CERTIFICACI√ìN Y FINALIZACI√ìN ***

        function openCertificationModal(order) {
            currentOrderForCertification = order;
            
            // NUEVO: Usar el mismo formato en la certificaci√≥n
            document.getElementById('certification-title').textContent = 
                `Certificaci√≥n de Obras Nro. ${order['Orden de Trabajo']}`;
            document.getElementById('certification-number').value = order['Orden de Trabajo'];
            document.getElementById('certification-date').value = getCurrentCaracasDate();
            document.getElementById('certification-year').value = getCurrentCaracasYear();
            document.getElementById('work-order-reference').value = order['Orden de Trabajo'];
            
            let companyName = '';
            let companyRif = '';
            
            for (const key in order) {
                if (key.includes('Empresa') && order[key] && order[key] !== 'N/A' && order[key] !== 'Seleccione una Empresa') {
                    companyName = order[key];
                    break;
                }
            }
            
            for (const key in order) {
                if (key.includes('Rif') && order[key] && order[key] !== 'N/A') {
                    companyRif = order[key];
                    break;
                }
            }
            
            document.getElementById('contractor-company').value = companyName || 'No especificada';
            document.getElementById('contractor-rif').value = companyRif || 'No especificado';
            
            document.getElementById('start-date').value = '';
            document.getElementById('end-date').value = '';
            document.getElementById('work-details').value = '';
            document.getElementById('total-amount').value = '';
            document.getElementById('deviations').value = '';
            
            document.getElementById('certification-modal').style.display = 'flex';
        }

        function closeCertificationModal() {
            document.getElementById('certification-modal').style.display = 'none';
            currentOrderForCertification = null;
        }

        async function completeWorkOrder() {
            if (!currentOrderForCertification) {
                alert('Error: No hay orden seleccionada para finalizar.');
                return;
            }

            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            const workDetails = document.getElementById('work-details').value;
            const totalAmount = document.getElementById('total-amount').value;

            if (!startDate || !endDate || !workDetails || !totalAmount) {
                alert('Por favor, complete todos los campos obligatorios del formulario de certificaci√≥n.');
                return;
            }

            try {
                const certificationData = {
                    ...currentOrderForCertification,
                    'Estado': 'Finalizada',
                    'Fecha de Finalizaci√≥n': getCurrentCaracasDate(),
                    'Certificaci√≥n': {
                        'N√∫mero de Certificaci√≥n': currentOrderForCertification['Orden de Trabajo'],
                        'Fecha de Certificaci√≥n': getCurrentCaracasDate(),
                        'A√±o': getCurrentCaracasYear(),
                        'Empresa Contratista': document.getElementById('contractor-company').value,
                        'Identificaci√≥n Fiscal RIF': document.getElementById('contractor-rif').value,
                        'Fecha de Inicio': formatDateToDDMMYYYY(startDate),
                        'Fecha de Fin': formatDateToDDMMYYYY(endDate),
                        'Detalle de Trabajos Realizados': workDetails,
                        'Importe Total de la Obra': totalAmount,
                        'Desviaciones y Justificaci√≥n': document.getElementById('deviations').value
                    }
                };

                await COMPLETED_ORDERS_COLLECTION.add(certificationData);
                await ORDERS_COLLECTION.doc(currentOrderForCertification.id).delete();
                
                workOrders = workOrders.filter(order => order.id !== currentOrderForCertification.id);
                completedOrders.push(certificationData);
                
                await generateCertificationPDF(certificationData);
                
                closeCertificationModal();
                renderOrdersTable();
                renderCompletedOrdersTable();
                
                alert('‚úÖ Orden finalizada exitosamente. Se ha generado la certificaci√≥n en PDF.');
                
            } catch (error) {
                console.error('Error al finalizar la orden:', error);
                alert('Error al finalizar la orden: ' + error.message);
            }
        }

        function generateCertificationPDF(data) {
            return new Promise((resolve, reject) => {
                try {
                    const certificationNumber = data['Orden de Trabajo'];
                    const fileName = `Certificacion_Obra_${certificationNumber}.pdf`;
                    
                    console.log('Generando PDF de certificaci√≥n para orden:', certificationNumber);

                    const certificationContent = `
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <meta charset="UTF-8">
                            <style>
                                body { 
                                    font-family: Arial, sans-serif; 
                                    margin: 20px; 
                                    color: #36454F; 
                                    line-height: 1.4;
                                    background: white;
                                }
                                h1 { 
                                    color: #4682B4; 
                                    text-align: center; 
                                    border-bottom: 2px solid #4682B4; 
                                    padding-bottom: 10px; 
                                    margin-bottom: 20px; 
                                }
                                .section { 
                                    margin-bottom: 25px; 
                                    page-break-inside: avoid;
                                }
                                .section h3 { 
                                    color: #4682B4; 
                                    border-left: 4px solid #4682B4; 
                                    padding-left: 8px; 
                                    margin-top: 0;
                                }
                                table { 
                                    width: 100%; 
                                    border-collapse: collapse; 
                                    margin-top: 10px;
                                }
                                td { 
                                    padding: 10px; 
                                    border: 1px solid #B0C4DE; 
                                    vertical-align: top;
                                }
                                .label { 
                                    font-weight: bold; 
                                    background-color: #F0F8FF; 
                                    width: 35%; 
                                }
                                .signature-section {
                                    margin-top: 50px;
                                    padding-top: 20px;
                                    border-top: 2px dashed #B0C4DE;
                                    width: 100%;
                                }
                                .signatures-container {
                                    display: flex;
                                    justify-content: space-between;
                                    width: 100%;
                                }
                                .signature-box {
                                    width: 45%;
                                    text-align: center;
                                }
                                .signature-line {
                                    border-bottom: 1px solid #000;
                                    margin-top: 60px;
                                    height: 1px;
                                    width: 100%;
                                }
                                @media print {
                                    body { margin: 15mm; }
                                    .section { page-break-inside: avoid; }
                                    .signatures-container { display: flex; justify-content: space-between; }
                                }
                            </style>
                        </head>
                        <body>
                            <h1>Certificaci√≥n de Obras Nro. ${certificationNumber}</h1>
                            
                            <div class="section">
                                <h3>I. Datos de Certificaci√≥n</h3>
                                <table>
                                    <tr>
                                        <td class="label">N√∫mero de Certificaci√≥n:</td>
                                        <td>${certificationNumber}</td>
                                    </tr>
                                    <tr>
                                        <td class="label">Fecha de la Certificaci√≥n:</td>
                                        <td>${data['Certificaci√≥n']?.['Fecha de Certificaci√≥n'] || data['Fecha de Finalizaci√≥n'] || getCurrentCaracasDate()}</td>
                                    </tr>
                                    <tr>
                                        <td class="label">A√±o:</td>
                                        <td>${data['Certificaci√≥n']?.['A√±o'] || getCurrentCaracasYear()}</td>
                                    </tr>
                                </table>
                            </div>
                            
                            <div class="section">
                                <h3>II. Identificaci√≥n</h3>
                                <table>
                                    <tr>
                                        <td class="label">Empresa Contratista:</td>
                                        <td>${data['Certificaci√≥n']?.['Empresa Contratista'] || 'No especificada'}</td>
                                    </tr>
                                    <tr>
                                        <td class="label">Identificaci√≥n Fiscal RIF:</td>
                                        <td>${data['Certificaci√≥n']?.['Identificaci√≥n Fiscal RIF'] || 'No especificado'}</td>
                                    </tr>
                                </table>
                            </div>
                            
                            <div class="section">
                                <h3>III. Informaci√≥n del Proyecto</h3>
                                <table>
                                    <tr>
                                        <td class="label">Corresponde Orden de trabajo N¬∞:</td>
                                        <td>${certificationNumber}</td>
                                    </tr>
                                    <tr>
                                        <td class="label">Fechas de Inicio:</td>
                                        <td>${data['Certificaci√≥n']?.['Fecha de Inicio'] || 'No especificada'}</td>
                                    </tr>
                                    <tr>
                                        <td class="label">Fin de la Obra:</td>
                                        <td>${data['Certificaci√≥n']?.['Fecha de Fin'] || 'No especificada'}</td>
                                    </tr>
                                </table>
                            </div>
                            
                            <div class="section">
                                <h3>IV. Detalle de los trabajos realizados</h3>
                                <table>
                                    <tr>
                                        <td class="label">Detalle:</td>
                                        <td style="white-space: pre-wrap; min-height: 100px;">${data['Certificaci√≥n']?.['Detalle de Trabajos Realizados'] || 'No se especificaron detalles'}</td>
                                    </tr>
                                    <tr>
                                        <td class="label">Importe total de la obra:</td>
                                        <td>${data['Certificaci√≥n']?.['Importe Total de la Obra'] || 'No especificado'}</td>
                                    </tr>
                                </table>
                            </div>
                            
                            <div class="section">
                                <h3>V. Desviaciones y Justificaci√≥n</h3>
                                <table>
                                    <tr>
                                        <td class="label">Detalle de desviaciones:</td>
                                        <td style="white-space: pre-wrap; min-height: 80px;">${data['Certificaci√≥n']?.['Desviaciones y Justificaci√≥n'] || 'No se registraron desviaciones'}</td>
                                    </tr>
                                </table>
                            </div>
                            
                            <div class="signature-section">
                                <div class="signatures-container">
                                    <div class="signature-box">
                                        <strong>Firma Jefe T√©cnico (Firma/Sello)</strong>
                                        <div class="signature-line"></div>
                                    </div>
                                    <div class="signature-box">
                                        <strong>Firma Gerente T√©cnico (Firma/Sello)</strong>
                                        <div class="signature-line"></div>
                                    </div>
                                </div>
                            </div>
                        </body>
                        </html>
                    `;

                    const printContainer = document.createElement('div');
                    printContainer.innerHTML = certificationContent;
                    document.body.appendChild(printContainer);

                    const opt = {
                        margin: 10,
                        filename: fileName,
                        image: { 
                            type: 'jpeg', 
                            quality: 0.98 
                        },
                        html2canvas: { 
                            scale: 2,
                            useCORS: true,
                            logging: true,
                            backgroundColor: '#FFFFFF',
                            onclone: function(clonedDoc) {
                                console.log('Documento clonado para PDF de certificaci√≥n');
                            }
                        },
                        jsPDF: { 
                            unit: 'mm', 
                            format: 'a4', 
                            orientation: 'portrait',
                            compress: true
                        }
                    };

                    setTimeout(() => {
                        html2pdf()
                            .set(opt)
                            .from(printContainer)
                            .save()
                            .then(() => {
                                console.log('PDF de certificaci√≥n generado exitosamente:', fileName);
                                if (document.body.contains(printContainer)) {
                                    document.body.removeChild(printContainer);
                                }
                                resolve();
                            })
                            .catch(error => {
                                console.error('Error al generar PDF de certificaci√≥n:', error);
                                if (document.body.contains(printContainer)) {
                                    document.body.removeChild(printContainer);
                                }
                                reject(error);
                            });
                    }, 1000);

                } catch (error) {
                    console.error('Error en generateCertificationPDF:', error);
                    reject(error);
                }
            });
        }

        // *** MEJORA: Funciones para prevenir reutilizaci√≥n de √≥rdenes en certificaciones finales ***

        /**
         * Obtiene las √≥rdenes que ya han sido certificadas (incluidas en certificaciones finales)
         */
        function getCertifiedOrderIds() {
            const certifiedOrderIds = new Set();
            
            finalCertifications.forEach(certification => {
                if (certification['√ìrdenes Realizadas'] && Array.isArray(certification['√ìrdenes Realizadas'])) {
                    certification['√ìrdenes Realizadas'].forEach(order => {
                        if (order.id) {
                            certifiedOrderIds.add(order.id);
                        }
                    });
                }
            });
            
            return certifiedOrderIds;
        }

        /**
         * Verifica si una orden espec√≠fica ya est√° incluida en alguna certificaci√≥n final
         */
        function getOrderCertificationStatus(orderId) {
            for (const certification of finalCertifications) {
                if (certification['√ìrdenes Realizadas'] && Array.isArray(certification['√ìrdenes Realizadas'])) {
                    const foundOrder = certification['√ìrdenes Realizadas'].find(order => order.id === orderId);
                    if (foundOrder) {
                        return {
                            certificationNumber: certification['N√∫mero de Certificaci√≥n Final'],
                            certificationDate: certification['Fecha de Creaci√≥n'],
                            empresa: certification['Empresa']
                        };
                    }
                }
            }
            return null;
        }

        /**
         * Renderiza la tabla de √≥rdenes finalizadas CON INFORMACI√ìN DE CERTIFICACI√ìN
         */
        function renderCompletedOrdersTable() {
            const tbody = document.getElementById('completed-orders-table').querySelector('tbody');
            const noResultsDiv = document.getElementById('no-completed-results');
            tbody.innerHTML = '';

            let filteredOrders = completedOrders;
            if (completedActiveFilters.length > 0) {
                filteredOrders = completedOrders.filter(order => {
                    return completedActiveFilters.every(filter => {
                        const fieldValue = order[filter.field] || '';
                        const filterValue = filter.value;
                        
                        switch (filter.operator) {
                            case 'contains':
                                return fieldValue.toString().toLowerCase().includes(filterValue.toLowerCase());
                            case 'equals':
                                return fieldValue.toString().toLowerCase() === filterValue.toLowerCase();
                            case 'startsWith':
                                return fieldValue.toString().toLowerCase().startsWith(filterValue.toLowerCase());
                            case 'endsWith':
                                return fieldValue.toString().toLowerCase().endsWith(filterValue.toLowerCase());
                            case 'range':
                                const [min, max] = filterValue.split('-').map(v => parseFloat(v.trim()));
                                const numValue = parseFloat(fieldValue);
                                return !isNaN(numValue) && numValue >= min && numValue <= max;
                            case 'greater':
                                const greaterValue = parseFloat(fieldValue);
                                const greaterFilter = parseFloat(filterValue);
                                return !isNaN(greaterValue) && greaterValue > greaterFilter;
                            case 'less':
                                const lessValue = parseFloat(fieldValue);
                                const lessFilter = parseFloat(filterValue);
                                return !isNaN(lessValue) && lessValue < lessFilter;
                            default:
                                return true;
                        }
                    });
                });
            }

            const sortedOrders = [...filteredOrders].sort((a, b) => {
                const otA = parseInt(a['Orden de Trabajo'], 10) || 0;
                const otB = parseInt(b['Orden de Trabajo'], 10) || 0;
                return otA - otB;
            });

            if (sortedOrders.length === 0) {
                noResultsDiv.style.display = 'block';
            } else {
                noResultsDiv.style.display = 'none';
            }

            sortedOrders.forEach(order => {
                const row = tbody.insertRow();
                row.insertCell().textContent = order['Orden de Trabajo'];
                row.insertCell().textContent = order['T√≠tulo del Formulario'];
                row.insertCell().textContent = order['Fecha Actual'] || 'N/A';
                row.insertCell().textContent = order['Fecha de Finalizaci√≥n'] || 'N/A';
                
                // MEJORA: Celda para estado de certificaci√≥n
                const certificationCell = row.insertCell();
                const certificationStatus = getOrderCertificationStatus(order.id);
                if (certificationStatus) {
                    certificationCell.innerHTML = `
                        <span class="certified-badge" title="Certificada en CF N¬∞ ${certificationStatus.certificationNumber} (${certificationStatus.certificationDate})">
                            ‚úÖ Certificada
                        </span>
                    `;
                } else {
                    certificationCell.innerHTML = '<span style="color: #666;">No certificada</span>';
                }
                
                const actionCell = row.insertCell();
                
                const orderPdfBtn = document.createElement('button');
                orderPdfBtn.textContent = 'üìã Orden';
                orderPdfBtn.style.backgroundColor = '#87CEFA';
                orderPdfBtn.style.color = 'white';
                orderPdfBtn.onclick = () => generatePDF(order);
                actionCell.appendChild(orderPdfBtn);
                
                const certPdfBtn = document.createElement('button');
                certPdfBtn.textContent = 'üìÑ Certificaci√≥n';
                certPdfBtn.style.backgroundColor = '#77DD77';
                certPdfBtn.style.color = 'white';
                certPdfBtn.style.marginLeft = '5px';
                certPdfBtn.onclick = () => generateCertificationPDF(order);
                actionCell.appendChild(certPdfBtn);
                
                if (currentRole === 'admin') {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'üóëÔ∏è Eliminar';
                    deleteBtn.style.backgroundColor = 'var(--color-error)';
                    deleteBtn.style.color = 'white';
                    deleteBtn.style.marginLeft = '5px';
                    deleteBtn.onclick = () => deleteCompletedOrder(order.id, order['Orden de Trabajo']);
                    actionCell.appendChild(deleteBtn);
                }
            });
        }

        // *** 9. NUEVAS FUNCIONES PARA CERTIFICACI√ìN FINAL ***

        /**
         * Renderiza el formulario de Certificaci√≥n Final
         */
        function renderFinalCertificationForm() {
            const certificationNumber = document.getElementById('certification-number');
            if (certificationNumber) {
                // NUEVO FORMATO: (mes-n√∫mero) para certificaciones finales
                const currentMonth = getCurrentCaracasMonth();
                certificationNumber.value = `(${currentMonth}-${finalCertificationCounter})`;
            }
            
            const certificationYear = document.getElementById('certification-year');
            if (certificationYear) {
                certificationYear.value = getCurrentCaracasYear();
            }
            
            const companySelect = document.getElementById('certification-company');
            if (companySelect) {
                companySelect.innerHTML = '<option value="">Seleccionar empresa...</option>';
                
                const empresasUnicas = Object.keys(CONTRATISTAS_DATA).filter(empresa => empresa !== "Seleccione una Empresa");
                
                empresasUnicas.forEach(empresa => {
                    const option = document.createElement('option');
                    option.value = empresa;
                    option.textContent = empresa;
                    companySelect.appendChild(option);
                });
            }
        }

        /**
         * Actualiza las √≥rdenes disponibles cuando se selecciona una empresa
         */
        function updateOrdersForCertification() {
            const companySelect = document.getElementById('certification-company');
            const ordersContainer = document.getElementById('certification-orders-container');
            const noOrdersMessage = document.getElementById('no-orders-message');
            const allOrdersCertifiedMessage = document.getElementById('all-orders-certified-message');
            const selectedCompany = companySelect.value;
            
            if (!selectedCompany) {
                ordersContainer.style.display = 'none';
                noOrdersMessage.style.display = 'none';
                allOrdersCertifiedMessage.style.display = 'none';
                updateCertificationTotal();
                return;
            }
            
            // Obtener IDs de √≥rdenes ya certificadas
            const certifiedOrderIds = getCertifiedOrderIds();
            
            // Filtrar √≥rdenes finalizadas para la empresa seleccionada
            const ordersForCompany = completedOrders.filter(order => {
                // Verificar si la orden ya est√° en una certificaci√≥n final
                if (certifiedOrderIds.has(order.id)) {
                    return false;
                }
                
                // Buscar en todos los campos que puedan contener el nombre de la empresa
                for (const key in order) {
                    if (order[key] === selectedCompany) {
                        return true;
                    }
                }
                return false;
            });
            
            if (ordersForCompany.length === 0) {
                ordersContainer.style.display = 'none';
                noOrdersMessage.style.display = 'none';
                allOrdersCertifiedMessage.style.display = 'block';
                updateCertificationTotal();
                return;
            }
            
            ordersContainer.style.display = 'block';
            noOrdersMessage.style.display = 'none';
            allOrdersCertifiedMessage.style.display = 'none';
            
            // Limpiar contenedor
            ordersContainer.innerHTML = '';
            
            // Agregar √≥rdenes como checkboxes
            ordersForCompany.forEach(order => {
                const orderDiv = document.createElement('div');
                orderDiv.className = 'order-checkbox-item';
                
                const orderNumber = order['Orden de Trabajo'];
                const importeTotal = order['Certificaci√≥n']?.['Importe Total de la Obra'] || '0.00';
                
                orderDiv.innerHTML = `
                    <div>
                        <input type="checkbox" id="order-${order.id}" value="${order.id}" data-amount="${importeTotal}" onchange="updateCertificationTotal()">
                        <label for="order-${order.id}">Orden de Trabajo ${orderNumber}</label>
                    </div>
                    <div class="order-amount">${parseFloat(importeTotal).toLocaleString('es-VE', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                `;
                
                ordersContainer.appendChild(orderDiv);
            });
            
            updateCertificationTotal();
        }

        /**
         * Actualiza el total de la certificaci√≥n final
         */
        function updateCertificationTotal() {
            const checkboxes = document.querySelectorAll('#certification-orders-container input[type="checkbox"]');
            let total = 0;
            
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    const amount = parseFloat(checkbox.getAttribute('data-amount')) || 0;
                    total += amount;
                }
            });
            
            const totalDisplay = document.getElementById('certification-total');
            const totalHidden = document.getElementById('certification-total-hidden');
            
            if (totalDisplay) {
                totalDisplay.textContent = total.toLocaleString('es-VE', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            }
            
            if (totalHidden) {
                totalHidden.value = total.toFixed(2);
            }
        }

        /**
         * Genera una Certificaci√≥n Final
         */
        async function generateFinalCertification() {
            const companySelect = document.getElementById('certification-company');
            const selectedCompany = companySelect.value;
            
            if (!selectedCompany) {
                alert('Por favor, seleccione una empresa.');
                return;
            }
            
            const checkboxes = document.querySelectorAll('#certification-orders-container input[type="checkbox"]:checked');
            
            if (checkboxes.length === 0) {
                alert('Por favor, seleccione al menos una orden finalizada.');
                return;
            }
            
            // Verificar que ninguna orden ya est√© certificada (protecci√≥n adicional)
            const certifiedOrderIds = getCertifiedOrderIds();
            const selectedOrders = [];
            let totalAmount = 0;
            let hasAlreadyCertified = false;
            
            checkboxes.forEach(checkbox => {
                const orderId = checkbox.value;
                
                // Verificaci√≥n adicional de seguridad
                if (certifiedOrderIds.has(orderId)) {
                    hasAlreadyCertified = true;
                    const order = completedOrders.find(o => o.id === orderId);
                    if (order) {
                        alert(`‚ö†Ô∏è La Orden de Trabajo ${order['Orden de Trabajo']} ya est√° incluida en otra certificaci√≥n final y no puede ser seleccionada nuevamente.`);
                    }
                    return;
                }
                
                const order = completedOrders.find(o => o.id === orderId);
                
                if (order) {
                    selectedOrders.push({
                        id: order.id,
                        numero: order['Orden de Trabajo'],
                        importe: order['Certificaci√≥n']?.['Importe Total de la Obra'] || '0.00',
                        fechaFinalizacion: order['Fecha de Finalizaci√≥n'] || 'N/A'
                    });
                    
                    totalAmount += parseFloat(order['Certificaci√≥n']?.['Importe Total de la Obra'] || '0.00');
                }
            });
            
            // Si se detectaron √≥rdenes ya certificadas, detener el proceso
            if (hasAlreadyCertified) {
                alert('No se puede crear la certificaci√≥n final porque algunas √≥rdenes seleccionadas ya est√°n certificadas.');
                return;
            }
            
            if (selectedOrders.length === 0) {
                alert('No hay √≥rdenes v√°lidas para certificar.');
                return;
            }
            
            try {
                const currentMonth = getCurrentCaracasMonth(); // NUEVO: Obtener mes actual
                
                const certificationData = {
                    'T√≠tulo del Formulario': 'Certificaci√≥n Final',
                    // NUEVO FORMATO: (mes-n√∫mero)
                    'N√∫mero de Certificaci√≥n Final': `(${currentMonth}-${finalCertificationCounter})`,
                    'A√±o': getCurrentCaracasYear(),
                    'Empresa': selectedCompany,
                    '√ìrdenes Realizadas': selectedOrders,
                    'Total': totalAmount.toFixed(2),
                    'Fecha de Creaci√≥n': getCurrentCaracasDate(),
                    'Creado por': firebase.auth().currentUser.email
                };
                
                // Guardar en Firebase
                const docRef = await FINAL_CERTIFICATIONS_COLLECTION.add(certificationData);
                
                // Actualizar array local
                certificationData.id = docRef.id;
                finalCertifications.push(certificationData);
                
                // Incrementar contador
                finalCertificationCounter++;
                await saveFormStructure(true);
                
                // CORRECCI√ìN: Actualizar visualmente el n√∫mero de certificaci√≥n en el formulario
                updateCertificationNumberDisplay();
                
                // Generar PDF
                await generateFinalCertificationPDF(certificationData);
                
                // Limpiar formulario
                clearCertificationForm();
                
                // Actualizar lista de certificaciones
                renderFinalCertificationsList();
                
                alert('‚úÖ Certificaci√≥n Final creada exitosamente y PDF generado.');
                
            } catch (error) {
                console.error('Error al crear certificaci√≥n final:', error);
                alert('Error al crear la certificaci√≥n final: ' + error.message);
            }
        }

        /**
         * CORRECCI√ìN: Actualiza visualmente el n√∫mero de certificaci√≥n en el formulario
         */
        function updateCertificationNumberDisplay() {
            const certificationNumber = document.getElementById('certification-number');
            if (certificationNumber) {
                const currentMonth = getCurrentCaracasMonth();
                certificationNumber.value = `(${currentMonth}-${finalCertificationCounter})`;
            }
        }

        /**
         * Limpia el formulario de Certificaci√≥n Final
         */
        function clearCertificationForm() {
            document.getElementById('certification-company').value = '';
            document.getElementById('certification-orders-container').style.display = 'none';
            document.getElementById('no-orders-message').style.display = 'none';
            document.getElementById('all-orders-certified-message').style.display = 'none';
            document.getElementById('certification-total').textContent = '0.00';
            document.getElementById('certification-total-hidden').value = '0.00';
            
            // CORRECCI√ìN: Actualizar visualmente el n√∫mero de certificaci√≥n despu√©s de limpiar
            updateCertificationNumberDisplay();
        }

        /**
         * Genera el PDF de Certificaci√≥n Final
         */
        function generateFinalCertificationPDF(data) {
            return new Promise((resolve, reject) => {
                try {
                    const certificationNumber = data['N√∫mero de Certificaci√≥n Final'];
                    const fileName = `Certificacion_Final_${certificationNumber}.pdf`;
                    
                    console.log('Generando PDF de certificaci√≥n final:', certificationNumber);

                    const certificationContent = `
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <meta charset="UTF-8">
                            <style>
                                body { 
                                    font-family: Arial, sans-serif; 
                                    margin: 10mm;
                                    color: #36454F; 
                                    line-height: 1.4;
                                    background: white;
                                }
                                h1 { 
                                    color: #9C27B0; 
                                    text-align: center; 
                                    border-bottom: 2px solid #9C27B0; 
                                    padding-bottom: 10px; 
                                    margin-bottom: 20px; 
                                    font-size: 20px;
                                }
                                .section { 
                                    margin-bottom: 20px; 
                                    page-break-inside: avoid;
                                }
                                .section h3 { 
                                    color: #9C27B0; 
                                    border-left: 4px solid #9C27B0; 
                                    padding-left: 8px; 
                                    margin-top: 0;
                                    font-size: 16px;
                                }
                                table { 
                                    width: 100%; 
                                    border-collapse: collapse; 
                                    margin-top: 10px;
                                    font-size: 12px;
                                }
                                td { 
                                    padding: 8px; 
                                    border: 1px solid #B0C4DE; 
                                    vertical-align: top;
                                }
                                .label { 
                                    font-weight: bold; 
                                    background-color: #F3E5F5; 
                                    width: 35%; 
                                }
                                .orders-table {
                                    margin-top: 15px;
                                }
                                .orders-table th {
                                    background-color: #E1BEE7;
                                    font-weight: bold;
                                    text-align: left;
                                }
                                .total-section {
                                    margin-top: 20px;
                                    padding: 15px;
                                    background-color: #F3E5F5;
                                    border: 1px solid #9C27B0;
                                    border-radius: 5px;
                                    text-align: center;
                                    font-weight: bold;
                                    font-size: 14px;
                                }
                                .footer-text {
                                    margin-top: 40px;
                                    padding-top: 20px;
                                    border-top: 2px dashed #9C27B0;
                                    font-style: italic;
                                    text-align: center;
                                    font-size: 12px;
                                }
                                @media print {
                                    body { margin: 10mm; }
                                    .section { page-break-inside: avoid; }
                                    .page-break { page-break-before: always; }
                                }
                            </style>
                        </head>
                        <body>
                            <h1>Certificaci√≥n Final N¬∞ ${certificationNumber}</h1>
                            
                            <div class="section">
                                <h3>I. Informaci√≥n de la Certificaci√≥n</h3>
                                <table>
                                    <tr>
                                        <td class="label">N√∫mero de Certificaci√≥n Final:</td>
                                        <td>${certificationNumber}</td>
                                    </tr>
                                    <tr>
                                        <td class="label">A√±o:</td>
                                        <td>${data['A√±o'] || getCurrentCaracasYear()}</td>
                                    </tr>
                                </table>
                            </div>
                            
                            <div class="section">
                                <h3>II. Informaci√≥n de la Empresa</h3>
                                <table>
                                    <tr>
                                        <td class="label">Empresa:</td>
                                        <td>${data['Empresa']}</td>
                                    </tr>
                                </table>
                            </div>
                            
                            <div class="section">
                                <h3>III. √ìrdenes Realizadas</h3>
                                <table class="orders-table">
                                    <thead>
                                        <tr>
                                            <th>N√∫mero de Orden</th>
                                            <th>Importe Total</th>
                                            <th>Fecha Finalizaci√≥n</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${data['√ìrdenes Realizadas'].map(order => `
                                            <tr>
                                                <td>${order.numero}</td>
                                                <td>${parseFloat(order.importe).toLocaleString('es-VE', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                                <td>${getCurrentCaracasDate()}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="total-section">
                                <h3>Total Certificaci√≥n Final</h3>
                                <div style="font-size: 16px; color: #9C27B0;">
                                    ${parseFloat(data['Total']).toLocaleString('es-VE', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                                </div>
                            </div>
                            
                            <div class="footer-text">
                                Quedan archivadas cada una de las Ordenes de Trabajo finalizadas indicadas en la presente Certificaci√≥n Final.
                            </div>
                        </body>
                        </html>
                    `;

                    const printContainer = document.createElement('div');
                    printContainer.innerHTML = certificationContent;
                    document.body.appendChild(printContainer);

                    const opt = {
                        margin: 10,
                        filename: fileName,
                        image: { 
                            type: 'jpeg', 
                            quality: 0.98 
                        },
                        html2canvas: { 
                            scale: 2,
                            useCORS: true,
                            logging: false,
                            backgroundColor: '#FFFFFF'
                        },
                        jsPDF: { 
                            unit: 'mm', 
                            format: 'a4', 
                            orientation: 'portrait',
                            compress: true
                        }
                    };

                    setTimeout(() => {
                        html2pdf()
                            .set(opt)
                            .from(printContainer)
                            .save()
                            .then(() => {
                                console.log('PDF de certificaci√≥n final generado exitosamente:', fileName);
                                if (document.body.contains(printContainer)) {
                                    document.body.removeChild(printContainer);
                                }
                                resolve();
                            })
                            .catch(error => {
                                console.error('Error al generar PDF de certificaci√≥n final:', error);
                                if (document.body.contains(printContainer)) {
                                    document.body.removeChild(printContainer);
                                }
                                reject(error);
                            });
                    }, 1000);

                } catch (error) {
                    console.error('Error en generateFinalCertificationPDF:', error);
                    reject(error);
                }
            });
        }

        /**
         * Renderiza la lista de Certificaciones Finales
         */
        function renderFinalCertificationsList() {
            const certificationsList = document.getElementById('certifications-list');
            const noResultsDiv = document.getElementById('no-certifications-results');
            
            if (!certificationsList) return;
            
            certificationsList.innerHTML = '';
            
            let filteredCertifications = finalCertifications;
            if (certificationActiveFilters.length > 0) {
                filteredCertifications = finalCertifications.filter(certification => {
                    return certificationActiveFilters.every(filter => {
                        const fieldValue = certification[filter.field] || '';
                        const filterValue = filter.value;
                        
                        switch (filter.operator) {
                            case 'contains':
                                return fieldValue.toString().toLowerCase().includes(filterValue.toLowerCase());
                            case 'equals':
                                return fieldValue.toString().toLowerCase() === filterValue.toLowerCase();
                            case 'startsWith':
                                return fieldValue.toString().toLowerCase().startsWith(filterValue.toLowerCase());
                            case 'endsWith':
                                return fieldValue.toString().toLowerCase().endsWith(filterValue.toLowerCase());
                            case 'range':
                                const [min, max] = filterValue.split('-').map(v => parseFloat(v.trim()));
                                const numValue = parseFloat(fieldValue);
                                return !isNaN(numValue) && numValue >= min && numValue <= max;
                            case 'greater':
                                const greaterValue = parseFloat(fieldValue);
                                const greaterFilter = parseFloat(filterValue);
                                return !isNaN(greaterValue) && greaterValue > greaterFilter;
                            case 'less':
                                const lessValue = parseFloat(fieldValue);
                                const lessFilter = parseFloat(filterValue);
                                return !isNaN(lessValue) && lessValue < lessFilter;
                            default:
                                return true;
                        }
                    });
                });
            }
            
            if (filteredCertifications.length === 0) {
                noResultsDiv.style.display = 'block';
                certificationsList.style.display = 'none';
                return;
            }
            
            noResultsDiv.style.display = 'none';
            certificationsList.style.display = 'block';
            
            const sortedCertifications = [...filteredCertifications].sort((a, b) => {
                return b['N√∫mero de Certificaci√≥n Final'] - a['N√∫mero de Certificaci√≥n Final'];
            });
            
            sortedCertifications.forEach(certification => {
                const certificationItem = document.createElement('div');
                certificationItem.className = 'certification-item';
                
                const certificationHeader = document.createElement('div');
                certificationHeader.className = 'certification-header';
                
                const certificationTitle = document.createElement('div');
                certificationTitle.className = 'certification-title';
                certificationTitle.textContent = `Certificaci√≥n Final N¬∞ ${certification['N√∫mero de Certificaci√≥n Final']} - ${certification['Empresa']}`;
                
                const certificationInfo = document.createElement('div');
                certificationInfo.className = 'certification-info';
                certificationInfo.innerHTML = `
                    <div style="font-size: 0.9em; color: #666;">
                        <strong>Total:</strong> ${parseFloat(certification['Total']).toLocaleString('es-VE', {minimumFractionDigits: 2, maximumFractionDigits: 2})} | 
                        <strong>Fecha:</strong> ${certification['Fecha de Creaci√≥n']} | 
                        <strong>A√±o:</strong> ${certification['A√±o'] || getCurrentCaracasYear()} | 
                        <strong>√ìrdenes:</strong> ${certification['√ìrdenes Realizadas'].length}
                    </div>
                `;
                
                const certificationActions = document.createElement('div');
                certificationActions.className = 'certification-actions';
                
                const pdfButton = document.createElement('button');
                pdfButton.textContent = 'üìÑ Descargar PDF';
                pdfButton.className = 'certification-pdf-button';
                pdfButton.onclick = () => generateFinalCertificationPDF(certification);
                
                certificationActions.appendChild(pdfButton);
                certificationHeader.appendChild(certificationTitle);
                certificationHeader.appendChild(certificationInfo);
                certificationHeader.appendChild(certificationActions);
                
                certificationItem.appendChild(certificationHeader);
                
                const ordersList = document.createElement('div');
                ordersList.className = 'orders-list';
                
                certification['√ìrdenes Realizadas'].forEach(order => {
                    const orderItem = document.createElement('div');
                    orderItem.className = 'order-item';
                    
                    const orderInfo = document.createElement('div');
                    orderInfo.innerHTML = `
                        <strong>Orden Finalizada ${order.numero}</strong>
                        <div style="font-size: 0.85em; color: #666;">
                            Importe: ${parseFloat(order.importe).toLocaleString('es-VE', {minimumFractionDigits: 2, maximumFractionDigits: 2})} | 
                            Fecha Finalizaci√≥n: ${order.fechaFinalizacion}
                        </div>
                    `;
                    
                    const orderActions = document.createElement('div');
                    orderActions.className = 'order-actions';
                    
                    const completeOrder = completedOrders.find(o => o.id === order.id);
                    
                    if (completeOrder) {
                        const certificationPdfButton = document.createElement('button');
                        certificationPdfButton.textContent = 'üìÑ Certificaci√≥n';
                        certificationPdfButton.className = 'order-pdf-button';
                        certificationPdfButton.onclick = () => generateCertificationPDF(completeOrder);
                        
                        const orderPdfButton = document.createElement('button');
                        orderPdfButton.textContent = 'üìã Orden';
                        orderPdfButton.className = 'order-pdf-button';
                        orderPdfButton.onclick = () => generatePDF(completeOrder);
                        
                        orderActions.appendChild(certificationPdfButton);
                        orderActions.appendChild(orderPdfButton);
                    }
                    
                    orderItem.appendChild(orderInfo);
                    orderItem.appendChild(orderActions);
                    ordersList.appendChild(orderItem);
                });
                
                certificationItem.appendChild(ordersList);
                certificationsList.appendChild(certificationItem);
            });
        }

        // *** 10. FUNCIONES DE FILTRADO PARA CERTIFICACIONES FINALES ***

        function initializeCertificationFilters() {
            updateCertificationFilterInput();
        }

        function updateCertificationFilterInput() {
            const fieldSelect = document.getElementById('certification-filter-field');
            const operatorSelect = document.getElementById('certification-filter-operator');
            const valueContainer = document.getElementById('certification-filter-value-container');
            
            const selectedField = fieldSelect.value;
            const selectedOperator = operatorSelect.value;
            
            valueContainer.innerHTML = '';
            
            if (!selectedField) {
                valueContainer.innerHTML = '<label for="certification-filter-value">Valor:</label><input type="text" id="certification-filter-value" placeholder="Seleccione un campo primero...">';
                return;
            }
            
            const label = document.createElement('label');
            label.htmlFor = 'certification-filter-value';
            label.textContent = 'Valor:';
            valueContainer.appendChild(label);
            
            let fieldType = 'text';
            if (selectedField === 'Total') fieldType = 'number';
            if (selectedField === 'Fecha de Creaci√≥n') fieldType = 'date';
            if (selectedField === 'A√±o') fieldType = 'number';
            
            if (selectedOperator === 'range' && (fieldType === 'number' || fieldType === 'date')) {
                const rangeDiv = document.createElement('div');
                rangeDiv.className = 'range-inputs';
                rangeDiv.innerHTML = `
                    <input type="${fieldType === 'date' ? 'date' : 'number'}" id="certification-filter-value-min" placeholder="M√≠nimo">
                    <span style="align-self: center;">a</span>
                    <input type="${fieldType === 'date' ? 'date' : 'number'}" id="certification-filter-value-max" placeholder="M√°ximo">
                `;
                valueContainer.appendChild(rangeDiv);
            } else {
                let inputType = 'text';
                if (fieldType === 'number') inputType = 'number';
                if (fieldType === 'date') inputType = 'date';
                
                const input = document.createElement('input');
                input.type = inputType;
                input.id = 'certification-filter-value';
                
                if (inputType === 'text') {
                    input.placeholder = 'Texto a buscar...';
                } else if (inputType === 'number') {
                    input.placeholder = '0';
                    input.step = '0.01';
                }
                
                valueContainer.appendChild(input);
            }
        }

        function addCertificationFilter() {
            const fieldSelect = document.getElementById('certification-filter-field');
            const operatorSelect = document.getElementById('certification-filter-operator');
            const selectedField = fieldSelect.value;
            const selectedOperator = operatorSelect.value;
            
            if (!selectedField) {
                alert('Por favor, seleccione un campo para filtrar.');
                return;
            }
            
            let filterValue = '';
            
            if (selectedOperator === 'range') {
                const minValue = document.getElementById('certification-filter-value-min').value;
                const maxValue = document.getElementById('certification-filter-value-max').value;
                
                if (!minValue || !maxValue) {
                    alert('Por favor, complete ambos valores para el rango.');
                    return;
                }
                
                filterValue = `${minValue}-${maxValue}`;
            } else {
                const valueInput = document.getElementById('certification-filter-value');
                filterValue = valueInput.value.trim();
                
                if (!filterValue) {
                    alert('Por favor, ingrese un valor para el filtro.');
                    return;
                }
            }
            
            const existingFilter = certificationActiveFilters.find(f => 
                f.field === selectedField && f.operator === selectedOperator && f.value === filterValue
            );
            
            if (existingFilter) {
                alert('Este filtro ya est√° activo.');
                return;
            }
            
            certificationActiveFilters.push({
                field: selectedField,
                operator: selectedOperator,
                value: filterValue
            });
            
            updateCertificationActiveFiltersDisplay();
            renderFinalCertificationsList();
            
            fieldSelect.value = '';
            operatorSelect.value = 'contains';
            updateCertificationFilterInput();
        }

        function removeCertificationFilter(index) {
            certificationActiveFilters.splice(index, 1);
            updateCertificationActiveFiltersDisplay();
            renderFinalCertificationsList();
        }

        function clearAllCertificationFilters() {
            certificationActiveFilters = [];
            updateCertificationActiveFiltersDisplay();
            renderFinalCertificationsList();
        }

        function updateCertificationActiveFiltersDisplay() {
            const activeFiltersDiv = document.getElementById('certification-active-filters');
            const activeFiltersList = document.getElementById('certification-active-filters-list');
            
            if (certificationActiveFilters.length === 0) {
                activeFiltersDiv.style.display = 'none';
                return;
            }
            
            activeFiltersDiv.style.display = 'block';
            activeFiltersList.innerHTML = '';
            
            certificationActiveFilters.forEach((filter, index) => {
                const filterTag = document.createElement('span');
                filterTag.className = 'active-filter-tag';
                
                let operatorText = '';
                switch (filter.operator) {
                    case 'contains': operatorText = 'contiene'; break;
                    case 'equals': operatorText = 'es igual a'; break;
                    case 'startsWith': operatorText = 'comienza con'; break;
                    case 'endsWith': operatorText = 'termina con'; break;
                    case 'range': operatorText = 'est√° entre'; break;
                    case 'greater': operatorText = 'es mayor que'; break;
                    case 'less': operatorText = 'es menor que'; break;
                }
                
                filterTag.innerHTML = `
                    <strong>${filter.field}</strong> ${operatorText} "${filter.value}"
                    <span class="remove-filter" onclick="removeCertificationFilter(${index})">√ó</span>
                `;
                
                activeFiltersList.appendChild(filterTag);
            });
        }

        // *** 11. FUNCI√ìN PARA EXPORTAR CERTIFICACIONES A EXCEL ***

        function exportCertificationsToExcel() {
            try {
                if (finalCertifications.length === 0) {
                    alert('No hay certificaciones finales para exportar.');
                    return;
                }

                const excelData = finalCertifications.map(certification => {
                    const row = {
                        'N√∫mero de Certificaci√≥n Final': certification['N√∫mero de Certificaci√≥n Final'],
                        'A√±o': certification['A√±o'] || getCurrentCaracasYear(),
                        'Empresa': certification['Empresa'],
                        'Total': parseFloat(certification['Total']).toFixed(2),
                        'Fecha de Creaci√≥n': certification['Fecha de Creaci√≥n'],
                        'Creado por': certification['Creado por']
                    };
                    
                    const ordenes = certification['√ìrdenes Realizadas'].map(order => 
                        `Orden ${order.numero} (${parseFloat(order.importe).toFixed(2)})`
                    ).join('; ');
                    
                    row['√ìrdenes Realizadas'] = ordenes;
                    
                    return row;
                });

                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(excelData);
                XLSX.utils.book_append_sheet(wb, ws, 'Certificaciones Finales');
                
                const currentDate = new Date().toISOString().split('T')[0];
                XLSX.writeFile(wb, `Certificaciones_Finales_${currentDate}.xlsx`);
                
                alert(`‚úÖ ${finalCertifications.length} certificaciones finales exportadas exitosamente a Excel.`);
                
            } catch (error) {
                console.error('Error al exportar certificaciones a Excel:', error);
                alert('Error al exportar certificaciones a Excel: ' + error.message);
            }
        }

        // *** 12. FUNCI√ìN PARA LIMPIAR DUPLICADOS ***
        async function cleanDuplicateOrders() {
            if (currentRole !== 'admin') {
                alert('Solo administradores pueden ejecutar esta funci√≥n');
                return;
            }
            
            if (!confirm('¬øEst√° seguro de que desea limpiar √≥rdenes duplicadas? Esta acci√≥n eliminar√° todas las √≥rdenes con n√∫meros duplicados, manteniendo solo la m√°s reciente de cada n√∫mero.')) {
                return;
            }
            
            try {
                const ordersSnapshot = await ORDERS_COLLECTION.get();
                const allOrders = ordersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                const currentMonth = getCurrentCaracasMonth();
                const otCounts = {};
                
                allOrders.forEach(order => {
                    const otNumber = order['Orden de Trabajo'];
                    // Solo considerar √≥rdenes del mes actual para limpieza
                    if (typeof otNumber === 'string' && otNumber.startsWith(`(${currentMonth}-`)) {
                        if (!otCounts[otNumber]) {
                            otCounts[otNumber] = [];
                        }
                        otCounts[otNumber].push(order);
                    }
                });
                
                const duplicates = Object.entries(otCounts).filter(([ot, orders]) => orders.length > 1);
                
                if (duplicates.length === 0) {
                    alert('No se encontraron √≥rdenes duplicadas');
                    return;
                }
                
                console.log('Duplicados encontrados:', duplicates);
                
                let deletedCount = 0;
                for (const [otNumber, orders] of duplicates) {
                    const sorted = orders.sort((a, b) => {
                        const dateA = new Date(a['Fecha Actual'] || 0);
                        const dateB = new Date(b['Fecha Actual'] || 0);
                        return dateB - dateA;
                    });
                    
                    for (let i = 1; i < sorted.length; i++) {
                        await ORDERS_COLLECTION.doc(sorted[i].id).delete();
                        deletedCount++;
                        console.log(`Eliminada orden duplicada: ${otNumber} - ID: ${sorted[i].id}`);
                    }
                }
                
                alert(`Se eliminaron ${deletedCount} √≥rdenes duplicadas. Recargue la p√°gina para ver los cambios.`);
                
                await loadInitialData();
                renderOrdersTable();
                renderWorkOrderForm();
                
            } catch (error) {
                console.error('Error limpiando duplicados:', error);
                alert('Error al limpiar duplicados: ' + error.message);
            }
        }

        // *** 13. FUNCIONES DE EXPORTACI√ìN E IMPORTACI√ìN ***

        async function exportDatabase() {
            if (currentRole !== 'admin') {
                alert('üö´ Permiso denegado. Solo un administrador puede exportar la base de datos.');
                return;
            }

            try {
                const ordersSnapshot = await ORDERS_COLLECTION.get();
                const ordersData = ordersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const completedSnapshot = await COMPLETED_ORDERS_COLLECTION.get();
                const completedData = completedSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const certificationsSnapshot = await FINAL_CERTIFICATIONS_COLLECTION.get();
                const certificationsData = certificationsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const configDoc = await CONFIG_COLLECTION.doc("systemConfig").get();
                const configData = configDoc.exists ? configDoc.data() : {};

                const exportData = {
                    timestamp: new Date().toISOString(),
                    exportedBy: firebase.auth().currentUser.email,
                    orders: ordersData,
                    completedOrders: completedData,
                    finalCertifications: certificationsData,
                    config: configData
                };

                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `respaldo_ordenes_trabajo_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                setTimeout(() => URL.revokeObjectURL(url), 100);
                
                alert(`‚úÖ Base de datos exportada exitosamente. Se descargaron ${ordersData.length} √≥rdenes en curso, ${completedData.length} √≥rdenes finalizadas y ${certificationsData.length} certificaciones finales.`);
                
            } catch (error) {
                console.error('Error al exportar la base de datos:', error);
                alert('Error al exportar la base de datos: ' + error.message);
            }
        }

        // *** FUNCI√ìN IMPORTDATABASE MEJORADA - PRESERVA ESTRUCTURA COMPLETA ***
        async function importDatabase(file) {
            if (currentRole !== 'admin') {
                alert('üö´ Permiso denegado. Solo un administrador puede importar la base de datos.');
                return;
            }

            if (!file) {
                return;
            }

            if (!confirm('‚ö†Ô∏è ADVERTENCIA: Esta acci√≥n reemplazar√° TODOS los datos actuales en la base de datos. ¬øEst√° seguro de que desea continuar?')) {
                return;
            }

            try {
                const fileText = await readFileAsText(file);
                const importData = JSON.parse(fileText);

                if (!importData.orders || !importData.config) {
                    alert('El archivo seleccionado no tiene el formato correcto para importar.');
                    return;
                }

                if (!confirm(`Se importar√°n ${importData.orders.length} √≥rdenes en curso, ${importData.completedOrders?.length || 0} √≥rdenes finalizadas, ${importData.finalCertifications?.length || 0} certificaciones finales y la configuraci√≥n del sistema. ¬øContinuar?`)) {
                    return;
                }

                // üîÑ PRESERVAR LA ESTRUCTURA COMPLETA DEL FORMULARIO DEL ARCHIVO DE IMPORTACI√ìN
                const importedFormStructure = importData.config.formStructure;
                
                if (!importedFormStructure || !Array.isArray(importedFormStructure)) {
                    alert('El archivo de importaci√≥n no contiene una estructura de formulario v√°lida. Se usar√° la estructura actual.');
                } else {
                    console.log('‚úÖ Importando estructura completa del formulario desde el archivo de respaldo');
                }

                await clearDatabase();

                // üéØ IMPORTAR DATOS COMPLETOS INCLUYENDO LA ESTRUCTURA DEL FORMULARIO
                const updatedConfig = {
                    ...importData.config,
                    formStructure: importedFormStructure || formStructure, // Usar estructura importada o mantener la actual
                    otCounter: importData.config.otCounter || otCounter,
                    finalCertificationCounter: importData.config.finalCertificationCounter || finalCertificationCounter
                };

                await CONFIG_COLLECTION.doc("systemConfig").set(updatedConfig);

                // üîÑ ACTUALIZAR ESTRUCTURA LOCAL CON LA IMPORTADA
                if (importedFormStructure) {
                    formStructure = importedFormStructure;
                }

                // üîÑ ACTUALIZAR √ìRDENES CON EL CAMPO "A√ëO" SI NO EXISTE
                let importedCount = 0;
                for (const order of importData.orders) {
                    const { id, ...orderData } = order;
                    
                    // Agregar campo "A√±o" si no existe en la orden importada
                    if (!orderData.hasOwnProperty('A√±o')) {
                        // Intentar extraer el a√±o de la fecha de creaci√≥n
                        const creationDate = orderData['Fecha Actual'];
                        let year = extractYearFromDate(creationDate);
                        
                        orderData['A√±o'] = year.toString();
                    }
                    
                    await ORDERS_COLLECTION.add(orderData);
                    importedCount++;
                }

                let importedCompletedCount = 0;
                if (importData.completedOrders) {
                    for (const order of importData.completedOrders) {
                        const { id, ...orderData } = order;
                        
                        // Agregar campo "A√±o" si no existe en la orden finalizada importada
                        if (!orderData.hasOwnProperty('A√±o')) {
                            const creationDate = orderData['Fecha Actual'];
                            let year = extractYearFromDate(creationDate);
                            
                            orderData['A√±o'] = year.toString();
                        }
                        
                        // Tambi√©n actualizar el a√±o en la certificaci√≥n si existe
                        if (orderData.Certificaci√≥n && !orderData.Certificaci√≥n.hasOwnProperty('A√±o')) {
                            orderData.Certificaci√≥n['A√±o'] = getCurrentCaracasYear().toString();
                        }
                        
                        await COMPLETED_ORDERS_COLLECTION.add(orderData);
                        importedCompletedCount++;
                    }
                }

                let importedCertificationCount = 0;
                if (importData.finalCertifications) {
                    for (const certification of importData.finalCertifications) {
                        const { id, ...certificationData } = certification;
                        
                        // Agregar campo "A√±o" si no existe en la certificaci√≥n final importada
                        if (!certificationData.hasOwnProperty('A√±o')) {
                            certificationData['A√±o'] = getCurrentCaracasYear().toString();
                        }
                        
                        await FINAL_CERTIFICATIONS_COLLECTION.add(certificationData);
                        importedCertificationCount++;
                    }
                }

                // üéâ RECARGAR DATOS CON LA ESTRUCTURA COMPLETA IMPORTADA
                await loadInitialData();
                renderOrdersTable();
                renderCompletedOrdersTable();
                renderFinalCertificationsList();
                renderWorkOrderForm();
                
                // Si el usuario es admin, actualizar tambi√©n el editor de formularios
                if (currentRole === 'admin') {
                    renderFormEditor();
                }

                alert(`‚úÖ Base de datos importada exitosamente. Se importaron ${importedCount} √≥rdenes en curso, ${importedCompletedCount} √≥rdenes finalizadas y ${importedCertificationCount} certificaciones finales.\n\nüìù Se import√≥ la estructura completa del formulario desde el archivo de respaldo.`);

            } catch (error) {
                console.error('Error al importar la base de datos:', error);
                alert('Error al importar la base de datos: ' + error.message);
            }
        }

        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = e => reject(e);
                reader.readAsText(file);
            });
        }

        async function clearDatabase() {
            try {
                const ordersSnapshot = await ORDERS_COLLECTION.get();
                const deletePromises = ordersSnapshot.docs.map(doc => ORDERS_COLLECTION.doc(doc.id).delete());
                await Promise.all(deletePromises);

                const completedSnapshot = await COMPLETED_ORDERS_COLLECTION.get();
                const completedDeletePromises = completedSnapshot.docs.map(doc => COMPLETED_ORDERS_COLLECTION.doc(doc.id).delete());
                await Promise.all(completedDeletePromises);

                const certificationsSnapshot = await FINAL_CERTIFICATIONS_COLLECTION.get();
                const certificationsDeletePromises = certificationsSnapshot.docs.map(doc => FINAL_CERTIFICATIONS_COLLECTION.doc(doc.id).delete());
                await Promise.all(certificationsDeletePromises);

                await CONFIG_COLLECTION.doc("systemConfig").delete();

                console.log('Base de datos limpiada exitosamente');
            } catch (error) {
                console.error('Error al limpiar la base de datos:', error);
                throw error;
            }
        }

        // *** 14. FUNCIONES DE FILTRADO DIN√ÅMICO ***

        function initializeFilters() {
            const filterFieldSelect = document.getElementById('filter-field');
            filterFieldSelect.innerHTML = '<option value="">Seleccionar campo...</option>';
            
            const availableFields = new Set();
            
            availableFields.add('Orden de Trabajo');
            availableFields.add('T√≠tulo del Formulario');
            availableFields.add('Fecha Actual');
            availableFields.add('A√±o'); // NUEVO: Campo a√±o
            availableFields.add('Usuario que Crea la Orden');
            availableFields.add('Tipo de Construcci√≥n Seleccionada');
            availableFields.add('Estado');
            availableFields.add('Presupuesto Total de la Obra');
            
            formStructure.forEach(section => {
                section.fields.forEach(field => {
                    if (field.type !== 'static' && field.type !== 'ot_counter' && field.type !== 'date-auto' && field.type !== 'user-auto-fill' && field.type !== 'year-auto') {
                        availableFields.add(field.label);
                    }
                });
            });
            
            availableFields.add('node_acceso | Costo Proyectado de la Obra');
            availableFields.add('node_acceso | Pago realizado por');
            availableFields.add('node_acceso | Pago x VGT CANTV a cargo de Inter');
            availableFields.add('node_acceso | Pago x VGT EDC a cargo de Inter');
            availableFields.add('node_acceso | Descripci√≥n');
            availableFields.add('node_acceso | Abono Mensual a Recibir por el cliente');
            availableFields.add('isp | Costo Proyectado de la Obra');
            availableFields.add('isp | Pago realizado por');
            availableFields.add('isp | Pago x VGT CANTV a cargo de Inter');
            availableFields.add('isp | Pago x VGT EDC a cargo de Inter');
            availableFields.add('isp | Descripci√≥n');
            availableFields.add('isp | Abono Mensual a Recibir por el cliente');
            
            Array.from(availableFields).sort().forEach(field => {
                const option = document.createElement('option');
                option.value = field;
                option.textContent = field;
                filterFieldSelect.appendChild(option);
            });
            
            updateActiveFiltersDisplay();
        }

        function updateFilterInput() {
            const fieldSelect = document.getElementById('filter-field');
            const operatorSelect = document.getElementById('filter-operator');
            const valueContainer = document.getElementById('filter-value-container');
            
            const selectedField = fieldSelect.value;
            const selectedOperator = operatorSelect.value;
            
            valueContainer.innerHTML = '';
            
            if (!selectedField) {
                valueContainer.innerHTML = '<label for="filter-value">Valor:</label><input type="text" id="filter-value" placeholder="Seleccione un campo primero...">';
                return;
            }
            
            let fieldType = 'text';
            
            formStructure.forEach(section => {
                section.fields.forEach(field => {
                    if (field.label === selectedField) {
                        fieldType = field.type;
                    }
                });
            });
            
            if (selectedField.includes('Pago x VGT') || selectedField.includes('Costo Proyectado') || selectedField === 'Presupuesto Total de la Obra' || selectedField === 'A√±o') {
                fieldType = 'number';
            }
            
            if (selectedField === 'Fecha Actual') {
                fieldType = 'date';
            }
            
            const label = document.createElement('label');
            label.htmlFor = 'filter-value';
            label.textContent = 'Valor:';
            valueContainer.appendChild(label);
            
            if (selectedOperator === 'range' && (fieldType === 'number' || fieldType === 'date')) {
                const rangeDiv = document.createElement('div');
                rangeDiv.className = 'range-inputs';
                rangeDiv.innerHTML = `
                    <input type="${fieldType === 'date' ? 'date' : 'number'}" id="filter-value-min" placeholder="M√≠nimo">
                    <span style="align-self: center;">a</span>
                    <input type="${fieldType === 'date' ? 'date' : 'number'}" id="filter-value-max" placeholder="M√°ximo">
                `;
                valueContainer.appendChild(rangeDiv);
            } else {
                let inputType = 'text';
                if (fieldType === 'number') inputType = 'number';
                if (fieldType === 'date') inputType = 'date';
                
                const input = document.createElement('input');
                input.type = inputType;
                input.id = 'filter-value';
                
                if (inputType === 'text') {
                    input.placeholder = 'Texto a buscar...';
                } else if (inputType === 'number') {
                    input.placeholder = '0';
                    input.step = fieldType === 'number' ? '0.01' : '1';
                }
                
                valueContainer.appendChild(input);
            }
        }

        function addFilter() {
            const fieldSelect = document.getElementById('filter-field');
            const operatorSelect = document.getElementById('filter-operator');
            const selectedField = fieldSelect.value;
            const selectedOperator = operatorSelect.value;
            
            if (!selectedField) {
                alert('Por favor, seleccione un campo para filtrar.');
                return;
            }
            
            let filterValue = '';
            
            if (selectedOperator === 'range') {
                const minValue = document.getElementById('filter-value-min').value;
                const maxValue = document.getElementById('filter-value-max').value;
                
                if (!minValue || !maxValue) {
                    alert('Por favor, complete ambos valores para el rango.');
                    return;
                }
                
                filterValue = `${minValue}-${maxValue}`;
            } else {
                const valueInput = document.getElementById('filter-value');
                filterValue = valueInput.value.trim();
                
                if (!filterValue) {
                    alert('Por favor, ingrese un valor para el filtro.');
                    return;
                }
            }
            
            const existingFilter = activeFilters.find(f => 
                f.field === selectedField && f.operator === selectedOperator && f.value === filterValue
            );
            
            if (existingFilter) {
                alert('Este filtro ya est√° activo.');
                return;
            }
            
            activeFilters.push({
                field: selectedField,
                operator: selectedOperator,
                value: filterValue
            });
            
            updateActiveFiltersDisplay();
            renderOrdersTable();
            
            fieldSelect.value = '';
            operatorSelect.value = 'contains';
            updateFilterInput();
        }

        function removeFilter(index) {
            activeFilters.splice(index, 1);
            updateActiveFiltersDisplay();
            renderOrdersTable();
        }

        function clearAllFilters() {
            activeFilters = [];
            updateActiveFiltersDisplay();
            renderOrdersTable();
        }

        function updateActiveFiltersDisplay() {
            const activeFiltersDiv = document.getElementById('active-filters');
            const activeFiltersList = document.getElementById('active-filters-list');
            
            if (activeFilters.length === 0) {
                activeFiltersDiv.style.display = 'none';
                return;
            }
            
            activeFiltersDiv.style.display = 'block';
            activeFiltersList.innerHTML = '';
            
            activeFilters.forEach((filter, index) => {
                const filterTag = document.createElement('span');
                filterTag.className = 'active-filter-tag';
                
                let operatorText = '';
                switch (filter.operator) {
                    case 'contains': operatorText = 'contiene'; break;
                    case 'equals': operatorText = 'es igual a'; break;
                    case 'startsWith': operatorText = 'comienza con'; break;
                    case 'endsWith': operatorText = 'termina con'; break;
                    case 'range': operatorText = 'est√° entre'; break;
                    case 'greater': operatorText = 'es mayor que'; break;
                    case 'less': operatorText = 'es menor que'; break;
                }
                
                filterTag.innerHTML = `
                    <strong>${filter.field}</strong> ${operatorText} "${filter.value}"
                    <span class="remove-filter" onclick="removeFilter(${index})">√ó</span>
                `;
                
                activeFiltersList.appendChild(filterTag);
            });
        }

        // *** 15. FUNCIONES DE FILTRADO PARA √ìRDENES FINALIZADAS ***

        function initializeCompletedFilters() {
            const filterFieldSelect = document.getElementById('completed-filter-field');
            filterFieldSelect.innerHTML = '<option value="">Seleccionar campo...</option>';
            
            const availableFields = new Set();
            
            availableFields.add('Orden de Trabajo');
            availableFields.add('T√≠tulo del Formulario');
            availableFields.add('Fecha Actual');
            availableFields.add('A√±o'); // NUEVO: Campo a√±o
            availableFields.add('Fecha de Finalizaci√≥n');
            availableFields.add('Usuario que Crea la Orden');
            availableFields.add('Tipo de Construcci√≥n Seleccionada');
            availableFields.add('Presupuesto Total de la Obra');
            availableFields.add('Estado de Certificaci√≥n Final');
            
            availableFields.add('Certificaci√≥n | Empresa Contratista');
            availableFields.add('Certificaci√≥n | Identificaci√≥n Fiscal RIF');
            availableFields.add('Certificaci√≥n | Importe Total de la Obra');
            
            formStructure.forEach(section => {
                section.fields.forEach(field => {
                    if (field.type !== 'static' && field.type !== 'ot_counter' && field.type !== 'date-auto' && field.type !== 'user-auto-fill' && field.type !== 'year-auto') {
                        availableFields.add(field.label);
                    }
                });
            });
            
            Array.from(availableFields).sort().forEach(field => {
                const option = document.createElement('option');
                option.value = field;
                option.textContent = field;
                filterFieldSelect.appendChild(option);
            });
            
            updateCompletedActiveFiltersDisplay();
        }

        function updateCompletedFilterInput() {
            const fieldSelect = document.getElementById('completed-filter-field');
            const operatorSelect = document.getElementById('completed-filter-operator');
            const valueContainer = document.getElementById('completed-filter-value-container');
            
            const selectedField = fieldSelect.value;
            const selectedOperator = operatorSelect.value;
            
            valueContainer.innerHTML = '';
            
            if (!selectedField) {
                valueContainer.innerHTML = '<label for="completed-filter-value">Valor:</label><input type="text" id="completed-filter-value" placeholder="Seleccione un campo primero...">';
                return;
            }
            
            let fieldType = 'text';
            
            formStructure.forEach(section => {
                section.fields.forEach(field => {
                    if (field.label === selectedField) {
                        fieldType = field.type;
                    }
                });
            });
            
            if (selectedField.includes('Importe Total') || selectedField.includes('Pago x VGT') || selectedField === 'Presupuesto Total de la Obra' || selectedField === 'A√±o') {
                fieldType = 'number';
            }
            
            if (selectedField === 'Fecha Actual' || selectedField === 'Fecha de Finalizaci√≥n') {
                fieldType = 'date';
            }
            
            const label = document.createElement('label');
            label.htmlFor = 'completed-filter-value';
            label.textContent = 'Valor:';
            valueContainer.appendChild(label);
            
            if (selectedOperator === 'range' && (fieldType === 'number' || fieldType === 'date')) {
                const rangeDiv = document.createElement('div');
                rangeDiv.className = 'range-inputs';
                rangeDiv.innerHTML = `
                    <input type="${fieldType === 'date' ? 'date' : 'number'}" id="completed-filter-value-min" placeholder="M√≠nimo">
                    <span style="align-self: center;">a</span>
                    <input type="${fieldType === 'date' ? 'date' : 'number'}" id="completed-filter-value-max" placeholder="M√°ximo">
                `;
                valueContainer.appendChild(rangeDiv);
            } else {
                let inputType = 'text';
                if (fieldType === 'number') inputType = 'number';
                if (fieldType === 'date') inputType = 'date';
                
                const input = document.createElement('input');
                input.type = inputType;
                input.id = 'completed-filter-value';
                
                if (inputType === 'text') {
                    input.placeholder = 'Texto a buscar...';
                } else if (inputType === 'number') {
                    input.placeholder = '0';
                    input.step = fieldType === 'number' ? '0.01' : '1';
                }
                
                valueContainer.appendChild(input);
            }
        }

        function addCompletedFilter() {
            const fieldSelect = document.getElementById('completed-filter-field');
            const operatorSelect = document.getElementById('completed-filter-operator');
            const selectedField = fieldSelect.value;
            const selectedOperator = operatorSelect.value;
            
            if (!selectedField) {
                alert('Por favor, seleccione un campo para filtrar.');
                return;
            }
            
            let filterValue = '';
            
            if (selectedOperator === 'range') {
                const minValue = document.getElementById('completed-filter-value-min').value;
                const maxValue = document.getElementById('completed-filter-value-max').value;
                
                if (!minValue || !maxValue) {
                    alert('Por favor, complete ambos valores para el rango.');
                    return;
                }
                
                filterValue = `${minValue}-${maxValue}`;
            } else {
                const valueInput = document.getElementById('completed-filter-value');
                filterValue = valueInput.value.trim();
                
                if (!filterValue) {
                    alert('Por favor, ingrese un valor para el filtro.');
                    return;
                }
            }
            
            const existingFilter = completedActiveFilters.find(f => 
                f.field === selectedField && f.operator === selectedOperator && f.value === filterValue
            );
            
            if (existingFilter) {
                alert('Este filtro ya est√° activo.');
                return;
            }
            
            completedActiveFilters.push({
                field: selectedField,
                operator: selectedOperator,
                value: filterValue
            });
            
            updateCompletedActiveFiltersDisplay();
            renderCompletedOrdersTable();
            
            fieldSelect.value = '';
            operatorSelect.value = 'contains';
            updateCompletedFilterInput();
        }

        function removeCompletedFilter(index) {
            completedActiveFilters.splice(index, 1);
            updateCompletedActiveFiltersDisplay();
            renderCompletedOrdersTable();
        }

        function clearAllCompletedFilters() {
            completedActiveFilters = [];
            updateCompletedActiveFiltersDisplay();
            renderCompletedOrdersTable();
        }

        function updateCompletedActiveFiltersDisplay() {
            const activeFiltersDiv = document.getElementById('completed-active-filters');
            const activeFiltersList = document.getElementById('completed-active-filters-list');
            
            if (completedActiveFilters.length === 0) {
                activeFiltersDiv.style.display = 'none';
                return;
            }
            
            activeFiltersDiv.style.display = 'block';
            activeFiltersList.innerHTML = '';
            
            completedActiveFilters.forEach((filter, index) => {
                const filterTag = document.createElement('span');
                filterTag.className = 'active-filter-tag';
                
                let operatorText = '';
                switch (filter.operator) {
                    case 'contains': operatorText = 'contiene'; break;
                    case 'equals': operatorText = 'es igual a'; break;
                    case 'startsWith': operatorText = 'comienza con'; break;
                    case 'endsWith': operatorText = 'termina con'; break;
                    case 'range': operatorText = 'est√° entre'; break;
                    case 'greater': operatorText = 'es mayor que'; break;
                    case 'less': operatorText = 'es menor que'; break;
                }
                
                filterTag.innerHTML = `
                    <strong>${filter.field}</strong> ${operatorText} "${filter.value}"
                    <span class="remove-filter" onclick="removeCompletedFilter(${index})">√ó</span>
                `;
                
                activeFiltersList.appendChild(filterTag);
            });
        }

        // *** 16. NUEVAS FUNCIONES DE EXPORTACI√ìN A EXCEL ***

        function exportToExcel(type) {
            try {
                const orders = type === 'current' ? workOrders : completedOrders;
                const fileName = type === 'current' ? 'Ordenes_En_Curso' : 'Ordenes_Finalizadas';
                
                if (orders.length === 0) {
                    alert(`No hay √≥rdenes ${type === 'current' ? 'en curso' : 'finalizadas'} para exportar.`);
                    return;
                }

                const excelData = prepareExcelData(orders, type);
                
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(excelData);
                XLSX.utils.book_append_sheet(wb, ws, '√ìrdenes de Trabajo');
                
                const currentDate = new Date().toISOString().split('T')[0];
                XLSX.writeFile(wb, `${fileName}_${currentDate}.xlsx`);
                
                alert(`‚úÖ ${orders.length} √≥rdenes exportadas exitosamente a Excel.`);
                
            } catch (error) {
                console.error('Error al exportar a Excel:', error);
                alert('Error al exportar a Excel: ' + error.message);
            }
        }

        function exportFilteredToExcel(type) {
            try {
                let filteredOrders = [];
                const fileName = type === 'current' ? 'Ordenes_Filtradas_En_Curso' : 'Ordenes_Filtradas_Finalizadas';
                
                if (type === 'current') {
                    filteredOrders = workOrders;
                    if (activeFilters.length > 0) {
                        filteredOrders = workOrders.filter(order => {
                            return activeFilters.every(filter => applyFilterLogic(order, filter));
                        });
                    }
                } else {
                    filteredOrders = completedOrders;
                    if (completedActiveFilters.length > 0) {
                        filteredOrders = completedOrders.filter(order => {
                            return completedActiveFilters.every(filter => applyFilterLogic(order, filter));
                        });
                    }
                }

                if (filteredOrders.length === 0) {
                    alert('No hay √≥rdenes que coincidan con los filtros actuales.');
                    return;
                }

                const excelData = prepareExcelData(filteredOrders, type);
                
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(excelData);
                XLSX.utils.book_append_sheet(wb, ws, '√ìrdenes Filtradas');
                
                const currentDate = new Date().toISOString().split('T')[0];
                XLSX.writeFile(wb, `${fileName}_${currentDate}.xlsx`);
                
                alert(`‚úÖ ${filteredOrders.length} √≥rdenes filtradas exportadas exitosamente.`);
                
            } catch (error) {
                console.error('Error al exportar √≥rdenes filtradas:', error);
                alert('Error al exportar √≥rdenes filtradas: ' + error.message);
            }
        }

        function exportCurrentViewToExcel(type) {
            try {
                const tableId = type === 'current' ? 'orders-table' : 'completed-orders-table';
                const table = document.getElementById(tableId);
                const rows = table.querySelectorAll('tbody tr');
                
                if (rows.length === 0) {
                    alert('No hay datos visibles en la tabla para exportar.');
                    return;
                }

                const excelData = [];
                const headers = [];
                
                const headerCells = table.querySelectorAll('thead th');
                headerCells.forEach(header => {
                    if (!header.textContent.includes('Acciones')) {
                        headers.push(header.textContent.trim());
                    }
                });

                rows.forEach(row => {
                    const rowData = {};
                    const cells = row.querySelectorAll('td');
                    
                    cells.forEach((cell, index) => {
                        if (index < headers.length) {
                            rowData[headers[index]] = cell.textContent.trim();
                        }
                    });
                    
                    if (Object.keys(rowData).length > 0) {
                        excelData.push(rowData);
                    }
                });

                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(excelData);
                XLSX.utils.book_append_sheet(wb, ws, 'Vista Actual');
                
                const currentDate = new Date().toISOString().split('T')[0];
                const fileName = type === 'current' ? 'Vista_Actual_En_Curso' : 'Vista_Actual_Finalizadas';
                XLSX.writeFile(wb, `${fileName}_${currentDate}.xlsx`);
                
                alert(`‚úÖ ${excelData.length} registros de la vista actual exportados exitosamente.`);
                
            } catch (error) {
                console.error('Error al exportar vista actual:', error);
                alert('Error al exportar vista actual: ' + error.message);
            }
        }

        function prepareExcelData(orders, type) {
            const allFields = new Set();
            
            orders.forEach(order => {
                Object.keys(order).forEach(key => {
                    if (key !== 'id' && !key.startsWith('_')) {
                        allFields.add(key);
                    }
                });
            });

            // MEJORA: Agregar campo de estado de certificaci√≥n para √≥rdenes finalizadas
            if (type === 'completed') {
                allFields.add('Estado de Certificaci√≥n Final');
            }
            
            const fieldNames = Array.from(allFields).sort();
            
            const excelData = orders.map(order => {
                const row = {};
                
                fieldNames.forEach(field => {
                    let value = order[field];
                    
                    // MEJORA: Campo especial para estado de certificaci√≥n
                    if (field === 'Estado de Certificaci√≥n Final') {
                        const certificationStatus = getOrderCertificationStatus(order.id);
                        if (certificationStatus) {
                            value = `Certificada en CF N¬∞ ${certificationStatus.certificationNumber} (${certificationStatus.certificationDate})`;
                        } else {
                            value = 'No certificada';
                        }
                    }
                    else if (value === null || value === undefined) {
                        value = '';
                    } else if (typeof value === 'object') {
                        if (field === 'Certificaci√≥n') {
                            value = Object.entries(value).map(([k, v]) => `${k}: ${v}`).join('; ');
                        } else {
                            value = JSON.stringify(value);
                        }
                    } else if (field.includes('Fecha')) {
                        value = String(value);
                    } else if (typeof value === 'number') {
                        value = value;
                    } else {
                        value = String(value).trim();
                    }
                    
                    row[field] = value;
                });
                
                return row;
            });

            return excelData;
        }

        function applyFilterLogic(order, filter) {
            const fieldValue = order[filter.field] || '';
            const filterValue = filter.value;
            
            switch (filter.operator) {
                case 'contains':
                    return fieldValue.toString().toLowerCase().includes(filterValue.toLowerCase());
                case 'equals':
                    return fieldValue.toString().toLowerCase() === filterValue.toLowerCase();
                case 'startsWith':
                    return fieldValue.toString().toLowerCase().startsWith(filterValue.toLowerCase());
                case 'endsWith':
                    return fieldValue.toString().toLowerCase().endsWith(filterValue.toLowerCase());
                case 'range':
                    const [min, max] = filterValue.split('-').map(v => parseFloat(v.trim()));
                    const numValue = parseFloat(fieldValue);
                    return !isNaN(numValue) && numValue >= min && numValue <= max;
                case 'greater':
                    const greaterValue = parseFloat(fieldValue);
                    const greaterFilter = parseFloat(filterValue);
                    return !isNaN(greaterValue) && greaterValue > greaterFilter;
                case 'less':
                    const lessValue = parseFloat(fieldValue);
                    const lessFilter = parseFloat(filterValue);
                    return !isNaN(lessValue) && lessValue < lessFilter;
                default:
                    return true;
            }
        }

    </script>

</body>
</html>
