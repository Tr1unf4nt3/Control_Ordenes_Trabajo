<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Sistema de √ìrdenes de Trabajo | Gesti√≥n de Estados</title>
    <!-- Librer√≠a para generar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
    
    <!-- LIBRER√çAS DE FIREBASE (Versi√≥n de Compatibilidad) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.9.0/firebase-firestore-compat.js"></script>
    
    <style>
        /* Paleta de colores Pastel Azul/Gris */
        :root {
            --color-bg: #F0F8FF;         /* Azul muy claro (Alice Blue) */
            --color-primary: #ADD8E6;    /* Azul claro (Light Blue) */
            --color-secondary: #B0C4DE;  /* Azul gris√°ceo (Light Steel Blue) */
            --color-accent: #87CEFA;     /* Azul cielo claro (Light Sky Blue) */
            --color-text: #36454F;       /* Gris carb√≥n (Charcoal) */
            --color-white: #ffffff;
            --color-error: #FF6961;      /* Rojo pastel para errores */
            --color-success: #77DD77;    /* Verde pastel para √©xito */
            --color-warning: #FFD700;    /* Amarillo/Oro para advertencias */
            --color-status-progress: #87CEFA;
            --color-status-completed: #77DD77;
            --color-status-cancelled: #FF6961;
        }

        /* Estilos Generales (Dise√±o Pastel) */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text);
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1300px; /* Aumentado para m√°s pesta√±as */
            margin: 0 auto;
            background-color: var(--color-white);
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }

        h2, h3, h4 {
            color: var(--color-text);
            border-bottom: 2px solid var(--color-primary);
            padding-bottom: 5px;
            margin-top: 25px;
        }

        input[type="text"], input[type="password"], input[type="number"], input[type="date"], input[type="email"], select, textarea {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            display: inline-block;
            border: 1px solid var(--color-secondary);
            border-radius: 6px;
            box-sizing: border-box;
            background-color: var(--color-white);
        }

        input:disabled { background-color: #f0f0f0; border: 1px dashed var(--color-secondary); }
        input:invalid:not(:placeholder-shown), select:invalid:not(:placeholder-shown), textarea:invalid:not(:placeholder-shown) { border: 2px solid var(--color-error); }
        .form-section { border: 1px solid var(--color-secondary); border-radius: 8px; padding: 20px; margin-bottom: 25px; background-color: #f7fbff; }
        .calculation-group { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; border: 1px solid var(--color-secondary); border-radius: 6px; padding: 15px; margin-top: 15px; background-color: #e0f7fa; }
        .calculation-total-section { display: flex; align-items: center; width: 100%; margin-top: 10px; }
        .calculation-total-section label { font-weight: bold; flex-basis: auto; margin-right: 15px; white-space: nowrap; }
        .total-display { background-color: var(--color-white); font-weight: bold; text-align: right; border: 1px dashed var(--color-accent); padding: 10px; border-radius: 6px; flex-grow: 1; }
        .calculation-input { flex-basis: calc(45% - 20px); } 
        .calculation-group .formula-symbol { font-size: 1.5em; font-weight: bold; margin-left: 5px; margin-right: 5px; }

        button {
            background-color: var(--color-accent);
            color: var(--color-text);
            padding: 10px 20px;
            margin: 8px 5px 8px 0;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
            white-space: nowrap; /* Evita que los botones del tab se rompan */
        }
        button:hover { background-color: var(--color-primary); }
        .conditional-check { background-color: var(--color-secondary); color: var(--color-white); font-weight: bold; padding: 15px; margin-bottom: 10px; display: block; text-align: left; }
        .conditional-check.active { background-color: var(--color-success); }


        /* Layout de Pesta√±as */
        .tab { overflow-x: auto; white-space: nowrap; border-bottom: 1px solid var(--color-secondary); margin-bottom: 20px; padding-bottom: 5px;}
        .tablinks { background-color: var(--color-bg); color: var(--color-text); display: inline-block; border: none; outline: none; cursor: pointer; padding: 14px 20px; transition: 0.3s; border-top-left-radius: 8px; border-top-right-radius: 8px; }
        .tablinks:hover { background-color: var(--color-primary); }
        .tablinks.active { background-color: var(--color-primary); border-bottom: 3px solid var(--color-accent); margin-bottom: -1px; }
        .tabcontent { display: none; padding: 30px 0; }
        .field-editor-item { border: 1px dashed var(--color-secondary); border-radius: 6px; padding: 15px; margin-bottom: 10px; background-color: var(--color-white); }
        .required-fixed-field { padding: 10px; background-color: var(--color-secondary); color: var(--color-white); border-radius: 4px; margin-bottom: 10px; }
        
        /* Estilos para la tabla */
        #orders-table, .status-table { width: 100%; border-collapse: collapse; }
        #orders-table th, #orders-table td, .status-table th, .status-table td { border: 1px solid var(--color-secondary); padding: 12px; text-align: left; }
        #orders-table th, .status-table th { background-color: var(--color-primary); color: var(--color-text); }
        #orders-table tr:nth-child(even), .status-table tr:nth-child(even) { background-color: var(--color-bg); }
        #orders-table tr:hover, .status-table tr:hover { background-color: var(--color-accent); color: var(--color-white); }

        /* Etiqueta de Estado */
        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 50px;
            font-weight: bold;
            color: var(--color-white);
            font-size: 0.85em;
        }
        .status-EnProgreso { background-color: var(--color-status-progress); }
        .status-Finalizada { background-color: var(--color-status-completed); }
        .status-Cancelada { background-color: var(--color-status-cancelled); }

        /* Login View */
        #login-view { width: 350px; padding: 40px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: var(--color-white); border-radius: 10px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); text-align: center; }
        #login-error { color: var(--color-error); font-weight: bold; }
        
        /* Estilos para Modales (Ventanas Flotantes NO transparentes) */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7); /* Oscurece el fondo */
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: var(--color-white);
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        .modal-content h3 {
            border-bottom: 2px solid var(--color-accent);
        }

        /* Estilos espec√≠ficos para el PDF de constancia */
        .pdf-signatures {
            margin-top: 60px;
            padding-top: 30px;
            border-top: 1px dashed #B0C4DE;
            display: flex;
            justify-content: space-between;
            width: 100%;
            font-size: 1.1em;
            font-weight: bold;
        }
        .pdf-signatures span {
            display: inline-block;
            width: 45%;
        }
        .pdf-signatures hr {
            border: none;
            border-top: 1px solid #36454F;
            margin: 5px 0 0 0;
        }
        .pdf-header-secondary {
            position: fixed;
            top: 10px;
            right: 20px;
            font-size: 14px;
            color: #555;
            font-weight: bold;
            z-index: 1000;
        }

    </style>
</head>
<body>

    <!-- MODAL DE INFORMACI√ìN DETALLADA (Finalizaci√≥n/Cancelaci√≥n) -->
    <div id="status-modal-overlay" class="modal-overlay" onclick="closeStatusModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 id="modal-title">Informaci√≥n Detallada</h3>
            <p id="modal-order-info"></p>
            
            <label for="detail-info">Informaci√≥n Detallada:</label>
            <textarea id="detail-info" rows="6" required placeholder="Escriba aqu√≠ los detalles de la finalizaci√≥n o cancelaci√≥n."></textarea>
            
            <div style="text-align: right; margin-top: 20px;">
                <button onclick="closeStatusModal()" style="background-color: var(--color-secondary);">Retroceder</button>
                <button id="modal-action-button" onclick="executeStatusAction()" style="background-color: var(--color-success);">Aceptar</button>
            </div>
        </div>
    </div>
    
    <div id="login-view">
        <h2>üîí Iniciar Sesi√≥n</h2>
        <input type="email" id="email" placeholder="Correo Electr√≥nico" required><br>
        <input type="password" id="password" placeholder="Contrase√±a" required><br>
        <button onclick="login()">Acceder</button>
        <p id="login-error"></p>
    </div>

    <div id="main-app" class="container" style="display: none;">
        
        <!-- Pesta√±as de Navegaci√≥n -->
        <div class="tab">
            <!-- Pesta√±as de Creaci√≥n y Visualizaci√≥n -->
            <button class="tablinks" id="new-order-tab-button" onclick="openTab(event, 'new-order')">üìã Nueva OT</button>
            <button class="tablinks" onclick="openTab(event, 'view-orders')">üìÇ √ìrdenes Creadas</button>
            
            <!-- Pesta√±as de Flujo de Estados (Comunes) -->
            <button class="tablinks" onclick="openTab(event, 'finalize-orders')">‚úÖ Finalizaci√≥n de √ìrdenes</button>
            <button class="tablinks" onclick="openTab(event, 'finished-orders')">üü¢ √ìrdenes Finalizadas</button>
            <button class="tablinks" onclick="openTab(event, 'cancel-orders')">‚ùå Cancelaci√≥n de √ìrdenes</button>
            <button class="tablinks" onclick="openTab(event, 'cancelled-orders')">üî¥ √ìrdenes Canceladas</button>

            <!-- Pesta√±as de Administraci√≥n (Solo Admin) -->
            <button class="tablinks" id="admin-status-tab-button" onclick="openTab(event, 'admin-status-change')" style="display: none;">üîÑ Cambio de Estado (Admin)</button>
            <button class="tablinks" id="edit-tab-button" onclick="openTab(event, 'edit-form')" style="display: none;">‚öôÔ∏è Edici√≥n de Formulario</button>
            
            <button onclick="logout()" style="float: right;">üö™ Cerrar Sesi√≥n</button>
        </div>

        <!-- Contenido de las Pesta√±as -->

        <!-- Pesta√±a 1: Creaci√≥n de Orden de Trabajo -->
        <div id="new-order" class="tabcontent">
            <h3>Nueva Orden de Trabajo</h3>
            <form id="work-order-form"></form>
            <button onclick="generateWorkOrder()">‚úÖ Crear Orden y Generar PDF</button>
        </div>

        <!-- Pesta√±a 2: Visualizaci√≥n de √ìrdenes de Trabajo (Todas las OT) -->
        <div id="view-orders" class="tabcontent">
            <h3>Registro Hist√≥rico de √ìrdenes (Todas)</h3>
            <table id="orders-table">
                <thead>
                    <tr><th>Nro. OT</th><th>T√≠tulo</th><th>Estado</th><th>Fecha Creaci√≥n</th><th>Acciones</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        
        <!-- Pesta√±a 3: Finalizaci√≥n de √ìrdenes (Solo En Progreso) -->
        <div id="finalize-orders" class="tabcontent">
            <h3>Finalizaci√≥n de √ìrdenes: <span class="status-badge status-EnProgreso">En Progreso</span></h3>
            <table class="status-table" id="finalize-table">
                <thead>
                    <tr><th>Nro. OT</th><th>T√≠tulo</th><th>Fecha Creaci√≥n</th><th>Acci√≥n</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        
        <!-- Pesta√±a 4: √ìrdenes Finalizadas -->
        <div id="finished-orders" class="tabcontent">
            <h3>Registro de √ìrdenes <span class="status-badge status-Finalizada">Finalizadas</span></h3>
            <table class="status-table" id="finished-table">
                <thead>
                    <tr><th>Nro. OT</th><th>T√≠tulo</th><th>Fecha Finalizaci√≥n</th><th>Usuario</th><th>Acciones</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        
        <!-- Pesta√±a 5: Cancelaci√≥n de √ìrdenes (Solo En Progreso) -->
        <div id="cancel-orders" class="tabcontent">
            <h3>Cancelaci√≥n de √ìrdenes: <span class="status-badge status-EnProgreso">En Progreso</span></h3>
            <table class="status-table" id="cancel-table">
                <thead>
                    <tr><th>Nro. OT</th><th>T√≠tulo</th><th>Fecha Creaci√≥n</th><th>Acci√≥n</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Pesta√±a 6: √ìrdenes Canceladas -->
        <div id="cancelled-orders" class="tabcontent">
            <h3>Registro de √ìrdenes <span class="status-badge status-Cancelada">Canceladas</span></h3>
            <table class="status-table" id="cancelled-table">
                <thead>
                    <tr><th>Nro. OT</th><th>T√≠tulo</th><th>Fecha Cancelaci√≥n</th><th>Usuario</th><th>Acciones</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        
        <!-- Pesta√±a 7: Cambio de Estado (Solo Admin) -->
        <div id="admin-status-change" class="tabcontent">
            <h3>Cambio de Estado <span class="status-badge status-Finalizada">Finalizada</span> / <span class="status-badge status-Cancelada">Cancelada</span> (Administrador)</h3>
            <p>Seleccione una orden para revertir su estado a <span class="status-badge status-EnProgreso">En Progreso</span>.</p>
            <table class="status-table" id="admin-status-table">
                <thead>
                    <tr><th>Nro. OT</th><th>T√≠tulo</th><th>Estado Actual</th><th>Acci√≥n</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        
        <!-- Pesta√±a 8: Edici√≥n de Formulario (Solo Administrador) -->
        <div id="edit-form" class="tabcontent">
            <h3>Edici√≥n de Formulario</h3>
            <div id="form-editor"></div>
            <button onclick="saveFormStructure(false)">üíæ Guardar Estructura del Formulario</button>
        </div>
    </div>
    
    <script>
        // *** 1. CONFIGURACI√ìN FIREBASE Y VARIABLES GLOBALES ***
        
        const firebaseConfig = {
          // *** CLAVE API ACTUALIZADA CON EL VALOR PROPORCIONADO POR EL USUARIO ***
          apiKey: "AIzaSyBHgF18eLwdZbl1g4OkDu-_NWkBnfLh3EA", 
          authDomain: "ordenestrabajo-39eab.firebaseapp.com",
          projectId: "ordenestrabajo-39eab",
          storageBucket: "ordenestrabajo-39eab.firebasestorage.app",
          messagingSenderId: "561184772303",
          appId: "1:561184772303:web:765f5859b4b3a332e827ba"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        const ORDERS_COLLECTION = db.collection("workOrders");
        const CONFIG_COLLECTION = db.collection("config"); 
        
        let formStructure = null; 
        let workOrders = []; 
        let otCounter = 1; 
        let currentRole = null; 
        let currentOrderToModify = null; // Para guardar la OT seleccionada en el modal

        // Roles
        const ADMIN_EMAILS = ['labortradingsg@gmail.com', 'admin.secundario@tudominio.com']; 
        const VIEWER_EMAILS = ['visualizador1@empresa.com', 'visualizador2@empresa.com', 'solo.ver@tudominio.com']; 
        
        // Datos Fijos
        const CONTRATISTAS_DATA = {
            "Seleccione una Empresa": { "Apellido y Nombre del Responsable": "", "Rif": "" },
            "Contratista A C.A.": { "Apellido y Nombre del Responsable": "P√©rez Juan", "Rif": "J-12345678-0" },
            "Servicios B, S.A.": { "Apellido y Nombre del Responsable": "G√≥mez Mar√≠a", "Rif": "G-98765432-1" },
            "Construcciones Zulia C.L.": { "Apellido y Nombre del Responsable": "L√≥pez Carlos", "Rif": "C-11223344-5" }
        };

        const DEFAULT_FORM_STRUCTURE = [
            { title: "I. Informaci√≥n General", fields: [
                { id: "form_title", label: "T√≠tulo del Formulario", type: "static", value: "Orden de Trabajo", required: true },
                { id: "ot_number", label: "Orden de Trabajo", type: "ot_counter", required: true },
                { id: "user_auto_fill", label: "Usuario que Crea la Orden", type: "user-auto-fill", required: true },
                { id: "current_date", label: "Fecha Actual", type: "date-auto", required: true }
            ]},
            { title: "II. Informaci√≥n de la Contratista", fields: []},
            { title: "III. Informaci√≥n del Trabajo/Obra", fields: []}
        ];
        
        // Funci√≥n de utilidad para manejar la compatibilidad de nombres de campos antiguos y nuevos
        function getDataLabel(data, newLabel, oldLabel) {
            return data[newLabel] !== undefined ? data[newLabel] : (data[oldLabel] !== undefined ? data[oldLabel] : 'N/A (Etiqueta Antigua)');
        }

        // *** 2. L√ìGICA DE FIREBASE: CARGA Y GUARDADO ***

        async function loadInitialData() {
            try {
                const configDoc = await CONFIG_COLLECTION.doc("systemConfig").get();
                if (configDoc.exists) {
                    const data = configDoc.data();
                    formStructure = data.formStructure || DEFAULT_FORM_STRUCTURE;
                    
                    // L√≥gica de Migraci√≥n (Asegurar campos fijos nuevos)
                    const infoGeneralFields = formStructure[0].fields;
                    const hasUserField = infoGeneralFields.some(f => f.id === 'user_auto_fill');
                    if (!hasUserField) {
                         const dateIndex = infoGeneralFields.findIndex(f => f.id === 'current_date');
                         if (dateIndex !== -1) {
                             infoGeneralFields.splice(dateIndex, 0, DEFAULT_FORM_STRUCTURE[0].fields[2]);
                         } else {
                             infoGeneralFields.push(DEFAULT_FORM_STRUCTURE[0].fields[2]);
                         }
                    }

                    if (formStructure.length >= 3) {
                         if (!formStructure[0].title.startsWith("I.")) formStructure[0].title = "I. Informaci√≥n General";
                         if (!formStructure[1].title.startsWith("II.")) formStructure[1].title = "II. Informaci√≥n de la Contratista";
                         if (!formStructure[2].title.startsWith("III.")) formStructure[2].title = "III. Informaci√≥n del Trabajo/Obra";
                    }

                    otCounter = data.otCounter || 1;
                } else {
                    formStructure = DEFAULT_FORM_STRUCTURE;
                    await saveFormStructure(true); 
                }
                
                // Cargar √ìrdenes de Trabajo y escuchar cambios en tiempo real
                ORDERS_COLLECTION.onSnapshot(snapshot => {
                    workOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    recalculateOtCounter();
                    renderAllTables();
                }, error => {
                    console.error("Error al escuchar √≥rdenes:", error);
                    alert("Error en la conexi√≥n a la base de datos en tiempo real.");
                });


            } catch (e) {
                console.error("Error cargando datos iniciales: ", e);
                alert("Error al conectar con la base de datos. Verifique su conexi√≥n y las reglas de seguridad de Firestore. Detalles: " + e.message);
            }
        }
        
        async function saveFormStructure(initial = false) {
            try {
                await CONFIG_COLLECTION.doc("systemConfig").set({
                    formStructure: formStructure,
                    otCounter: otCounter
                }, { merge: true });

                if (!initial) {
                     alert('üéâ Estructura del formulario y contador guardados exitosamente en la nube.');
                     renderWorkOrderForm();
                }
            } catch (e) {
                console.error("Error al guardar la estructura:", e);
                alert("Error al guardar la estructura en Firebase.");
            }
        }
        
        // L√≥gica de Roles
        function getRoleFromEmail(email) {
            if (ADMIN_EMAILS.includes(email)) return 'admin';
            if (VIEWER_EMAILS.includes(email)) return 'viewer'; 
            return 'normal'; 
        }

        // L√≥gica de Autenticaci√≥n
        async function login() {
            // ... (L√≥gica de login sin cambios) ...
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            const errorElement = document.getElementById('login-error');
            errorElement.textContent = '';
            
            try {
                const userCredential = await firebase.auth().signInWithEmailAndPassword(email, pass);
                const user = userCredential.user;
                
                let role = getRoleFromEmail(user.email); 
                currentRole = role;
                
                document.getElementById('login-view').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                initializeApp(role);
                
            } catch (error) {
                console.error("Error de autenticaci√≥n:", error.code, error.message);
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    errorElement.textContent = 'Credenciales incorrectas o usuario no encontrado.';
                } else if (error.code === 'auth/invalid-email') {
                    errorElement.textContent = 'El formato del correo es inv√°lido.';
                } else if (error.code === 'auth/api-key-not-valid') {
                    errorElement.textContent = 'ERROR DE CONFIGURACI√ìN: La Clave API de Firebase no es v√°lida. Por favor, verifique la configuraci√≥n de Firebase en el c√≥digo.';
                } else {
                    errorElement.textContent = 'Error de conexi√≥n. Intente de nuevo.';
                }
            }
        }

        function logout() {
            firebase.auth().signOut().then(() => {
                document.getElementById('email').value = '';
                document.getElementById('password').value = '';
                alert('Sesi√≥n cerrada correctamente.');
            }).catch((error) => {
                console.error("Error al cerrar sesi√≥n:", error);
                alert('Error al cerrar sesi√≥n.');
            });
        }

        async function initializeApp(role) {
            const isCreator = (role === 'admin' || role === 'normal');

            document.getElementById('edit-tab-button').style.display = (role === 'admin') ? 'inline-block' : 'none';
            document.getElementById('admin-status-tab-button').style.display = (role === 'admin') ? 'inline-block' : 'none';
            document.getElementById('new-order-tab-button').style.display = isCreator ? 'inline-block' : 'none';
            
            await loadInitialData(); 
            
            if (role === 'admin') {
                renderFormEditor();
                openTab(null, 'edit-form');
            } else if (role === 'normal') {
                openTab(null, 'new-order');
            } else if (role === 'viewer') {
                openTab(null, 'view-orders'); 
            }
            
            renderWorkOrderForm();
            renderAllTables();
        }

        window.onload = function() {
            firebase.auth().onAuthStateChanged(user => {
                if (user) {
                    let role = getRoleFromEmail(user.email); 
                    currentRole = role;
                    
                    document.getElementById('login-view').style.display = 'none';
                    document.getElementById('main-app').style.display = 'block';
                    initializeApp(role);
                } else {
                    currentRole = null;
                    document.getElementById('main-app').style.display = 'none';
                    document.getElementById('login-view').style.display = 'block';
                }
            });
        }
        
        function openTab(evt, tabName) {
            let i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            if (evt) evt.currentTarget.className += " active";

            if (tabName === 'new-order' && formStructure) renderWorkOrderForm();
            else if (tabName === 'view-orders') renderOrdersTable('view-orders');
            else if (tabName === 'finalize-orders') renderOrdersTable('finalize-orders');
            else if (tabName === 'finished-orders') renderOrdersTable('finished-orders');
            else if (tabName === 'cancel-orders') renderOrdersTable('cancel-orders');
            else if (tabName === 'cancelled-orders') renderOrdersTable('cancelled-orders');
            else if (tabName === 'admin-status-change') renderOrdersTable('admin-status-change');
            else if (tabName === 'edit-form' && currentRole === 'admin' && formStructure) renderFormEditor();
        }
        
        // ... (Funciones de Edici√≥n de Formulario sin cambios mayores) ...
        function renderFormEditor() {
            const editorDiv = document.getElementById('form-editor');
            editorDiv.innerHTML = '';

            formStructure.forEach((section, secIndex) => {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'form-section';
                sectionDiv.innerHTML = `
                    <h4>Secci√≥n ${secIndex + 1}: <input type="text" value="${section.title}" oninput="updateSectionTitle(${secIndex}, this.value)" style="width: 70%; display: inline;"></h4>
                    <button onclick="addField(${secIndex}, 'text')">‚ûï Agregar Campo de Texto</button>
                    <button onclick="addField(${secIndex}, 'select')">‚ûï Agregar Lista (Select)</button>
                    <button onclick="addField(${secIndex}, 'date-input')">üìÖ Agregar Campo de Fecha</button>
                    <hr>
                    <div id="fields-container-${secIndex}"></div>
                `;
                editorDiv.appendChild(sectionDiv);

                const fieldsContainer = document.getElementById(`fields-container-${secIndex}`);
                section.fields.forEach((field, fieldIndex) => {
                    if (field.type === 'static' || field.type === 'ot_counter' || field.type === 'date-auto' || field.type === 'user-auto-fill') {
                        fieldsContainer.innerHTML += `<p class="required-fixed-field"><strong>${field.label}</strong> (Campo fijo obligatorio)</p>`;
                        return;
                    }

                    const fieldDiv = document.createElement('div');
                    fieldDiv.className = 'field-editor-item';
                    fieldDiv.innerHTML = `
                        <label>Etiqueta:</label>
                        <input type="text" value="${field.label}" oninput="updateFieldProperty(${secIndex}, ${fieldIndex}, 'label', this.value)">
                        <label>Tipo:</label>
                        <select onchange="updateFieldProperty(${secIndex}, ${fieldIndex}, 'type', this.value)">
                            <option value="text" ${field.type === 'text' ? 'selected' : ''}>Texto (Corto)</option>
                            <option value="number" ${field.type === 'number' ? 'selected' : ''}>N√∫mero</option>
                            <option value="textarea" ${field.type === 'textarea' ? 'selected' : ''}>√Årea de Texto (Largo)</option>
                            <option value="select" ${field.type === 'select' ? 'selected' : ''}>Lista Desplegable (Simple)</option>
                            <option value="autofill-select" ${field.type === 'autofill-select' ? 'selected' : ''}>Lista (Autollenado Contratista) üìù</option>
                            <option value="date-input" ${field.type === 'date-input' ? 'selected' : ''}>Fecha (Calendario) üìÖ</option>
                        </select>
                        <label>Clasificaci√≥n:</label>
                        <input type="checkbox" id="req-${secIndex}-${fieldIndex}" ${field.required ? 'checked' : ''} onchange="updateFieldProperty(${secIndex}, ${fieldIndex}, 'required', this.checked)"> 
                        <label for="req-${secIndex}-${fieldIndex}" style="display: inline-block; font-weight: normal;">Obligatorio</label>
                        
                        <div id="select-options-${secIndex}-${fieldIndex}" style="margin-top: 10px; ${field.type !== 'select' && field.type !== 'autofill-select' ? 'display: none;' : ''}">
                            <strong>Opciones de Lista (solo visible si es 'Select' o 'Autofill-Select'). </strong>
                            ${field.type === 'autofill-select' ? 
                                '<p style="color: var(--color-error);">‚ö†Ô∏è **Autollenado:** Las opciones se toman de `CONTRATISTAS_DATA` y anulan esta lista.</p>' : ''
                            }
                            <input type="text" value="${(field.options || []).join(', ')}" oninput="updateSelectOptions(${secIndex}, ${fieldIndex}, this.value)">
                        </div>
                        <button onclick="removeField(${secIndex}, ${fieldIndex})" style="background-color: var(--color-error); color: var(--color-white);">üóëÔ∏è Eliminar Campo</button>
                    `;
                    fieldsContainer.appendChild(fieldDiv);
                });
            });
        }
        
        function updateSectionTitle(secIndex, newTitle) { formStructure[secIndex].title = newTitle; }
        function updateFieldProperty(secIndex, fieldIndex, prop, value) {
            formStructure[secIndex].fields[fieldIndex][prop] = value;
            if (prop === 'type') {
                if ((value === 'select' || value === 'autofill-select') && !formStructure[secIndex].fields[fieldIndex].options) {
                    formStructure[secIndex].fields[fieldIndex].options = ['Opci√≥n A', 'Opci√≥n B'];
                }
                renderFormEditor();
            }
        }
        function updateSelectOptions(secIndex, fieldIndex, value) {
            formStructure[secIndex].fields[fieldIndex].options = value.split(',').map(s => s.trim()).filter(s => s.length > 0);
        }
        function addField(secIndex, type) {
            const newField = {
                id: `dynamic_field_${Date.now()}`,
                label: `Nuevo Campo ${type === 'select' || type === 'autofill-select' ? 'Lista' : (type === 'date-input' ? 'Fecha' : 'Texto')}`,
                type: type,
                required: false
            };
            if (type === 'select' || type === 'autofill-select') newField.options = ['Opci√≥n A', 'Opci√≥n B'];
            formStructure[secIndex].fields.push(newField);
            renderFormEditor();
        }
        function removeField(secIndex, fieldIndex) {
            const isFixed = formStructure[secIndex].fields[fieldIndex].type === 'static' || 
                            formStructure[secIndex].fields[fieldIndex].type === 'ot_counter' ||
                            formStructure[secIndex].fields[fieldIndex].type === 'date-auto' ||
                            formStructure[secIndex].fields[fieldIndex].type === 'user-auto-fill';
            
            if (secIndex === 0 && isFixed) {
                alert("üö´ No se pueden eliminar los campos fijos y obligatorios de la primera secci√≥n.");
                return;
            }
            if (confirm('¬øEst√°s seguro de que quieres eliminar este campo?')) {
                formStructure[secIndex].fields.splice(fieldIndex, 1);
                renderFormEditor();
            }
        }


        // *** 3. L√ìGICA DE CREACI√ìN DE ORDEN DE TRABAJO ***
        
        function formatDateToDDMMYYYY(dateString) {
            if (!dateString) return 'N/A';
            if (dateString.match(/^\d{2}\/\d{2}\/\d{4}$/)) return dateString;
            const parts = dateString.split('-');
            if (parts.length === 3) {
                const [year, month, day] = parts;
                return `${day}/${month}/${year}`;
            }
            return dateString;
        }

        function getCurrentCaracasDate() {
            const now = new Date();
            return now.toLocaleDateString('es-ES', { 
                timeZone: 'America/Caracas',
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }
        
        function autofillContratistaData(selectElement) {
            const selectedCompanyName = selectElement.value;
            const data = CONTRATISTAS_DATA[selectedCompanyName];
            
            if (!data) {
                document.getElementById('Apellido y Nombre del Responsable').value = '';
                document.getElementById('Rif').value = '';
                return;
            }

            const responsibleField = document.getElementById('Apellido y Nombre del Responsable');
            const rifField = document.getElementById('Rif');

            if (responsibleField && data["Apellido y Nombre del Responsable"] !== undefined) {
                responsibleField.value = data["Apellido y Nombre del Responsable"];
            }
            if (rifField && data["Rif"] !== undefined) {
                rifField.value = data["Rif"];
            }
        }

        function calculateNewTotal(prefix) {
            const precioUnitario = parseFloat(document.getElementById(`${prefix}_precio_unitario`).value.replace(',', '.')) || 0;
            const puntos = parseFloat(document.getElementById(`${prefix}_puntos`).value.replace(',', '.')) || 0;
            const total = precioUnitario * puntos;
            
            document.getElementById(`${prefix}_total_display`).textContent = total.toFixed(2);
            document.getElementById(`${prefix}_total_hidden`).value = total.toFixed(2);
        }

        function toggleConditionalSection(type) {
            const nodeAccessSection = document.getElementById('conditional_node_acceso_section');
            const ispSection = document.getElementById('conditional_isp_section');
            const nodeAccessButton = document.getElementById('check_node_acceso');
            const ispButton = document.getElementById('check_isp');

            nodeAccessSection.style.display = 'none';
            ispSection.style.display = 'none';
            nodeAccessButton.classList.remove('active');
            ispButton.classList.remove('active');
            
            const fieldsToReset = ['costo_proyectado', 'precio_unitario', 'puntos', 'descripcion', 'abono_mensual'];
            const selectsToReset = ['pago_por_realizado'];

            ['node_acceso', 'isp'].forEach(prefix => {
                fieldsToReset.forEach(field => {
                    const el = document.getElementById(`${prefix}_${field}`);
                    if (el) el.value = '';
                });
                selectsToReset.forEach(field => {
                    const el = document.getElementById(`${prefix}_${field}`);
                    if (el) el.value = 'Inter';
                });
                
                document.getElementById(`${prefix}_total_display`).textContent = '0.00';
                document.getElementById(`${prefix}_total_hidden`).value = '0.00';
            });


            if (type === 'node_acceso') {
                nodeAccessSection.style.display = 'block';
                nodeAccessButton.classList.add('active');
            } else if (type === 'isp') {
                ispSection.style.display = 'block';
                ispButton.classList.add('active');
            }
        }


        function renderWorkOrderForm() {
            const formElement = document.getElementById('work-order-form');
            formElement.innerHTML = '';
            const todayCaracas = getCurrentCaracasDate(); 
            const currentUserEmail = firebase.auth().currentUser ? firebase.auth().currentUser.email : 'USUARIO NO LOGUEADO';

            if (!formStructure) {
                 formElement.innerHTML = '<p>Cargando estructura del formulario...</p>';
                 return;
            }
            
            formStructure.forEach(section => {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'form-section';
                sectionDiv.innerHTML = `<h4>${section.title}</h4>`;

                section.fields.forEach(field => {
                    const requiredStar = field.required ? '<span style="color: var(--color-error); margin-left: 5px;">*</span>' : '';
                    let inputHTML = '';
                    let value = '';
                    let isDisabled = '';
                    let onChangeEvent = '';
                    let isAutofillField = false;

                    if (section.title.includes('II. Informaci√≥n de la Contratista')) {
                        const autofillKeys = ["Apellido y Nombre del Responsable", "Rif"];
                        if (autofillKeys.includes(field.label)) {
                            isDisabled = 'disabled';
                            isAutofillField = true;
                        } else if (field.type === 'autofill-select') {
                            onChangeEvent = `onchange="autofillContratistaData(this)"`;
                        }
                    }

                    const fieldId = isAutofillField ? field.label : field.id; 
                    
                    const isFixedField = field.type === 'static' || field.type === 'ot_counter' || field.type === 'date-auto' || field.type === 'user-auto-fill';
                    const requiredAttribute = field.required && !isFixedField ? 'required' : '';


                    switch (field.type) {
                        case 'static': value = field.value; inputHTML = `<input type="text" value="${value}" disabled>`; break;
                        case 'ot_counter': value = otCounter.toString(); inputHTML = `<input type="text" value="${value}" disabled>`; break;
                        case 'user-auto-fill': value = currentUserEmail; inputHTML = `<input type="text" value="${value}" disabled>`; break;
                        case 'date-auto': value = todayCaracas; inputHTML = `<input type="text" value="${value}" disabled>`; break;
                        case 'date-input': inputHTML = `<input type="date" id="${fieldId}" name="${fieldId}" ${requiredAttribute} ${isDisabled}>`; break;
                        case 'text': case 'number': inputHTML = `<input type="${field.type}" id="${fieldId}" name="${fieldId}" ${requiredAttribute} ${isDisabled}>`; break;
                        case 'textarea': inputHTML = `<textarea id="${fieldId}" name="${fieldId}" ${requiredAttribute} ${isDisabled}></textarea>`; break;
                        case 'select':
                            inputHTML = `<select id="${fieldId}" name="${fieldId}" ${requiredAttribute} ${isDisabled} ${onChangeEvent}>
                                ${field.options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                            </select>`;
                            break;
                        case 'autofill-select': 
                            const optionsHTML = Object.keys(CONTRATISTAS_DATA).map(key => `<option value="${key}">${key}</option>`).join('');
                            inputHTML = `<select id="${fieldId}" name="${fieldId}" ${requiredAttribute} ${isDisabled} ${onChangeEvent}>
                                ${optionsHTML}
                            </select>`;
                            break;
                    }

                    sectionDiv.innerHTML += `<p><label for="${fieldId}">${field.label}${requiredStar}:</label>${inputHTML}</p>`;
                });
                formElement.appendChild(sectionDiv);
            });
            
            formElement.innerHTML += `
                <h4>Tipo de Construcci√≥n (Selecci√≥n √önica)</h4>
                <button type="button" class="conditional-check" id="check_node_acceso" onclick="toggleConditionalSection('node_acceso')">La Construcci√≥n es de un Nodo de Acceso</button>
                <button type="button" class="conditional-check" id="check_isp" onclick="toggleConditionalSection('isp')">La Construcci√≥n es de un ISP</button>
                <button type="button" style="background-color: var(--color-error); color: var(--color-white); margin-top: 15px;" onclick="toggleConditionalSection(null)">‚ùå Eliminar / Desmarcar Selecci√≥n</button>
            `;
            
            formElement.innerHTML += renderConditionalSection('node_acceso', 'Datos Condicionales: La Construcci√≥n es de Nodo de Acceso');
            formElement.innerHTML += renderConditionalSection('isp', 'Datos Condicionales: La Construcci√≥n es de un ISP');
            
            toggleConditionalSection(null);
            
            const autofillSelects = document.querySelectorAll('select[onchange="autofillContratistaData(this)"]');
            autofillSelects.forEach(select => autofillContratistaData(select));
        }

        function renderConditionalSection(prefix, title) {
            const onChangeFunc = `calculateNewTotal('${prefix}')`;
            const totalDisplayLabel = "Pago x VGT a cargo de Inter (*):"; 

            return `
                <div class="form-section" id="conditional_${prefix}_section" style="display: none;">
                    <h4>${title}</h4>
                    
                    <p><label for="${prefix}_costo_proyectado">Costo Proyectado de la Obra (*):</label>
                        <input type="text" id="${prefix}_costo_proyectado" name="${prefix}_costo_proyectado" required></p>
                    
                    <p><label for="${prefix}_pago_por_realizado">Pago por realizado por (*):</label>
                        <select id="${prefix}_pago_por_realizado" name="${prefix}_pago_por_realizado" required>
                            <option value="Inter">Inter</option>
                            <option value="Cliente">Cliente</option>
                        </select></p>
                        
                    <hr>
                    <div class="calculation-group">
                        <label for="${prefix}_precio_unitario">Precio Unitario (*):</label>
                        <input type="number" step="0.01" min="0" id="${prefix}_precio_unitario" name="${prefix}_precio_unitario" placeholder="0.00" oninput="${onChangeFunc}" class="calculation-input" required>
                        
                        <span class="formula-symbol">X</span>
                        
                        <label for="${prefix}_puntos">Puntos (*):</label>
                        <input type="number" step="1" min="0" id="${prefix}_puntos" name="${prefix}_puntos" placeholder="0" oninput="${onChangeFunc}" class="calculation-input" required>
                        
                        <span class="formula-symbol">=</span>
                        
                        <div class="calculation-total-section">
                            <label style="flex-basis: auto;">${totalDisplayLabel}</label>
                            <div id="${prefix}_total_display" class="total-display">0.00</div>
                            <input type="hidden" id="${prefix}_total_hidden" name="${prefix}_total_hidden" value="0.00">
                        </div>
                    </div>
                    <hr>
                    <p><label for="${prefix}_descripcion">Descripci√≥n (*):</label>
                        <textarea id="${prefix}_descripcion" name="${prefix}_descripcion" required></textarea></p>
                    
                    <p><label for="${prefix}_abono_mensual">Abono Mensual a Recibir por el cliente (*):</label>
                        <input type="text" id="${prefix}_abono_mensual" name="${prefix}_abono_mensual" required></p>
                </div>
            `;
        }

        function sanitizeInput(str) {
            if (typeof str !== 'string' || !str) return str;
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
        }
        
        async function generateWorkOrder() {
            const form = document.getElementById('work-order-form');
            const selectedType = document.querySelector('.conditional-check.active');
            let firstInvalidField = null;

            // ... (L√≥gica de validaci√≥n sin cambios) ...
            for (const section of formStructure) {
                for (const field of section.fields) {
                    const isFixed = field.type === 'static' || field.type === 'ot_counter' || field.type === 'date-auto' || field.type === 'user-auto-fill';
                    
                    if (!field.required || isFixed) continue;

                    let fieldId = (section.title.includes('II. Informaci√≥n de la Contratista') && (field.label === 'Apellido y Nombre del Responsable' || field.label === 'Rif')) 
                                ? field.label 
                                : field.id;
                    
                    const inputElement = document.getElementById(fieldId);

                    if (inputElement && !inputElement.disabled && !inputElement.checkValidity()) {
                        firstInvalidField = inputElement;
                        break; 
                    }
                }
                if (firstInvalidField) break; 
            }

            if (!firstInvalidField && selectedType) {
                const prefix = selectedType.id.replace('check_', '');
                const camposCondicionales = [
                    document.getElementById(`${prefix}_costo_proyectado`),
                    document.getElementById(`${prefix}_pago_por_realizado`),
                    document.getElementById(`${prefix}_precio_unitario`),
                    document.getElementById(`${prefix}_puntos`),
                    document.getElementById(`${prefix}_descripcion`),
                    document.getElementById(`${prefix}_abono_mensual`)
                ];

                for (const campo of camposCondicionales) {
                    if (campo.type === 'text' || campo.type === 'select' || campo.tagName === 'TEXTAREA' || campo.type === 'date') {
                        if (!campo.value.trim()) {
                            firstInvalidField = campo;
                            break;
                        }
                    } 
                    else if (campo.type === 'number') {
                        const numericValue = parseFloat(campo.value.replace(',', '.'));
                        if (isNaN(numericValue) || numericValue < 0) {
                            firstInvalidField = campo;
                            break;
                        }
                    }
                }
            }

            if (firstInvalidField) {
                alert('‚ö†Ô∏è Atenci√≥n: Debe completar los campos obligatorios faltantes marcados con (*). El sistema lo llevar√° al primer error.');
                firstInvalidField.reportValidity();
                firstInvalidField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                firstInvalidField.focus();
                return;
            }


            const formData = new FormData(form);
            const orderData = {};
            
            const caracasDate = getCurrentCaracasDate(); 
            const currentUserEmail = firebase.auth().currentUser ? firebase.auth().currentUser.email : 'ERROR';

            formStructure.forEach(section => {
                section.fields.forEach(field => {
                    let value;
                    let fieldId = (section.title.includes('II. Informaci√≥n de la Contratista') && (field.label === 'Apellido y Nombre del Responsable' || field.label === 'Rif')) 
                                ? field.label 
                                : field.id;

                    if (field.type === 'ot_counter') value = otCounter.toString();
                    else if (field.type === 'user-auto-fill') value = currentUserEmail; 
                    else if (field.type === 'date-auto') value = caracasDate;
                    else if (field.type === 'static') value = field.value;
                    else {
                        const inputElement = document.getElementById(fieldId);
                        value = inputElement ? inputElement.value : formData.get(fieldId);
                    }
                    
                    if (field.type === 'date-input' && value) {
                        orderData[field.label] = formatDateToDDMMYYYY(value);
                    } else {
                        orderData[field.label] = sanitizeInput(value) || 'N/A';
                    }
                });
            });
            
            orderData['Tipo de Construcci√≥n Seleccionada'] = selectedType ? selectedType.textContent.trim() : 'Ninguno';

            if (selectedType) {
                const prefix = selectedType.id.replace('check_', '');
                calculateNewTotal(prefix); 
                
                const NEW_VGT_LABEL = 'Pago x VGT a cargo de Inter';
                const OLD_CALC_LABEL = 'C√°lculo: Precio Unitario x Puntos = Total'; 
                
                orderData[`${prefix} | Costo Proyectado de la Obra`] = sanitizeInput(document.getElementById(`${prefix}_costo_proyectado`).value);
                orderData[`${prefix} | Pago por realizado por`] = sanitizeInput(document.getElementById(`${prefix}_pago_por_realizado`).value);
                
                // Guardar valor total con etiquetas nuevas y antiguas para compatibilidad
                orderData[`${prefix} | ${NEW_VGT_LABEL}`] = formData.get(`${prefix}_total_hidden`);
                orderData[`${prefix} | ${OLD_CALC_LABEL}`] = formData.get(`${prefix}_total_hidden`);

                orderData[`${prefix} | Precio Unitario`] = parseFloat(document.getElementById(`${prefix}_precio_unitario`).value.replace(',', '.')).toFixed(2);
                orderData[`${prefix} | Puntos`] = parseFloat(document.getElementById(`${prefix}_puntos`).value.replace(',', '.')).toFixed(0); 
                
                orderData[`${prefix} | Descripci√≥n`] = sanitizeInput(document.getElementById(`${prefix}_descripcion`).value);
                orderData[`${prefix} | Abono Mensual a Recibir por el cliente`] = sanitizeInput(document.getElementById(`${prefix}_abono_mensual`).value);
            }
            
            // *** CAMBIO CR√çTICO: AGREGAR ESTADO INICIAL ***
            orderData.status = 'En Progreso'; 

            try {
                const docRef = await ORDERS_COLLECTION.add(orderData); 
                
                orderData.id = docRef.id; 
                otCounter++;
                
                await saveFormStructure(true); 

                generatePDF(orderData);

                form.reset();
                renderWorkOrderForm(); 
                
                // Las tablas se actualizar√°n solas gracias al onSnapshot

            } catch (e) {
                console.error("Error al crear la orden:", e);
                alert("Error al guardar la orden de trabajo en Firebase. Verifique sus reglas de seguridad. Detalles: " + e.message);
            }
        }

        // *** 4. MODAL DE CAMBIO DE ESTADO ***

        function openStatusModal(orderId, actionType) {
            currentOrderToModify = workOrders.find(o => o.id === orderId);
            if (!currentOrderToModify) return;

            const title = actionType === 'finalize' ? "Informaci√≥n Detallada de Finalizaci√≥n" : "Informaci√≥n Detallada de Cancelaci√≥n";
            const buttonText = actionType === 'finalize' ? "Aceptar (Finalizar)" : "Aceptar (Cancelar)";
            const otNumber = currentOrderToModify['Orden de Trabajo'];

            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-order-info').innerHTML = `Se cambiar√° el estado de la OT Nro. <strong>${otNumber}</strong> a <strong>${actionType === 'finalize' ? 'Finalizada' : 'Cancelada'}</strong>.`;
            document.getElementById('modal-action-button').textContent = buttonText;
            document.getElementById('modal-action-button').setAttribute('onclick', `executeStatusAction('${orderId}', '${actionType}')`);
            document.getElementById('detail-info').value = ''; 
            
            document.getElementById('status-modal-overlay').style.display = 'flex';
            document.getElementById('detail-info').focus();
        }

        function closeStatusModal() {
            document.getElementById('status-modal-overlay').style.display = 'none';
            currentOrderToModify = null;
        }

        async function executeStatusAction(orderId, actionType) {
            const detailInfo = document.getElementById('detail-info').value.trim();
            if (!detailInfo) {
                alert("La Informaci√≥n Detallada es obligatoria para continuar.");
                return;
            }
            
            closeStatusModal(); 

            const order = workOrders.find(o => o.id === orderId);
            const currentUserEmail = firebase.auth().currentUser ? firebase.auth().currentUser.email : 'USUARIO DESCONOCIDO';
            const caracasDate = getCurrentCaracasDate();
            const newStatus = actionType === 'finalize' ? 'Finalizada' : 'Cancelada';

            try {
                const updateData = {
                    status: newStatus,
                    [`${newStatus} | Fecha`]: caracasDate,
                    [`${newStatus} | Usuario`]: currentUserEmail,
                    [`${newStatus} | Detalle`]: sanitizeInput(detailInfo)
                };

                await ORDERS_COLLECTION.doc(orderId).update(updateData);
                alert(`‚úÖ Orden de Trabajo Nro. ${order['Orden de Trabajo']} cambiada a estado "${newStatus}".`);

                // Generar el PDF de Constancia/Cancelaci√≥n
                if (actionType === 'finalize') {
                    generateFinalizationPDF(order, currentUserEmail, caracasDate, detailInfo);
                } else if (actionType === 'cancel') {
                    generateCancellationPDF(order, currentUserEmail, caracasDate, detailInfo);
                }
                
                // Las tablas se actualizan autom√°ticamente

            } catch (e) {
                console.error(`Error al cambiar estado a ${newStatus}:`, e);
                alert(`Error al actualizar el estado en Firebase: ${e.message}`);
            }
        }
        
        // Funci√≥n para Administrador: Revertir a En Progreso
        async function revertStatusToInProgress(orderId, otNumber) {
             if (currentRole !== 'admin') {
                alert('üö´ Permiso denegado. Solo un administrador puede revertir estados.');
                return;
            }
            if (!confirm(`¬øEst√° seguro de que desea revertir la Orden Nro. ${otNumber} al estado "En Progreso"?`)) {
                return;
            }
            
            try {
                await ORDERS_COLLECTION.doc(orderId).update({
                    status: 'En Progreso',
                    'Finalizada | Fecha': firebase.firestore.FieldValue.delete(),
                    'Finalizada | Usuario': firebase.firestore.FieldValue.delete(),
                    'Finalizada | Detalle': firebase.firestore.FieldValue.delete(),
                    'Cancelada | Fecha': firebase.firestore.FieldValue.delete(),
                    'Cancelada | Usuario': firebase.firestore.FieldValue.delete(),
                    'Cancelada | Detalle': firebase.firestore.FieldValue.delete()
                });
                alert(`‚úÖ Orden Nro. ${otNumber} revertida exitosamente a "En Progreso".`);
                // Las tablas se actualizan autom√°ticamente
            } catch (e) {
                console.error("Error al revertir estado:", e);
                alert(`Error al revertir el estado: ${e.message}`);
            }
        }

        // *** 5. GENERACI√ìN DE PDFS DE CONSTANCIA/CANCELACI√ìN ***
        
        function generateFinalizationPDF(order, user, date, detail) {
            const otNumber = order['Orden de Trabajo'];
            const fileName = `Constancia_Finalizacion_OT_${otNumber}_${date.replace(/\//g, '-')}.pdf`;
            
            const content = `
                <div style="font-family: sans-serif; padding: 20px; color: #36454F;">
                    <h1 style="color: var(--color-status-completed); text-align: center; border-bottom: 3px solid var(--color-status-completed); padding-bottom: 15px;">
                        Constancia de Finalizaci√≥n de la Orden de Trabajo Nro. ${otNumber}
                    </h1>
                    <table style="width: 100%; margin-top: 30px; font-size: 1.1em;">
                        <tr><td style="width: 30%; font-weight: bold;">Usuario de finalizaci√≥n:</td><td style="width: 70%;">${user}</td></tr>
                        <tr><td style="width: 30%; font-weight: bold;">Fecha Actual:</td><td style="width: 70%;">${date}</td></tr>
                    </table>
                    
                    <h3 style="color: #4682B4; margin-top: 40px; border-bottom: 1px solid #B0C4DE;">Informaci√≥n Detallada de Finalizaci√≥n</h3>
                    <p style="white-space: pre-wrap; background-color: #f7fbff; padding: 15px; border-radius: 8px;">${detail}</p>
                    
                    <div class="pdf-signatures" style="margin-top: 100px;"> 
                        <span>
                            Firma Contratista:<hr>
                        </span>
                        <span>
                            Firma Responsable:<hr>
                        </span>
                    </div>
                </div>
            `;
            generateDocument(content, fileName);
        }

        function generateCancellationPDF(order, user, date, detail) {
            const otNumber = order['Orden de Trabajo'];
            const fileName = `Constancia_Cancelacion_OT_${otNumber}_${date.replace(/\//g, '-')}.pdf`;
            
            const content = `
                <div style="font-family: sans-serif; padding: 20px; color: #36454F;">
                    <h1 style="color: var(--color-status-cancelled); text-align: center; border-bottom: 3px solid var(--color-status-cancelled); padding-bottom: 15px;">
                        Cancelaci√≥n de la Orden de Trabajo Nro. ${otNumber}
                    </h1>
                    <table style="width: 100%; margin-top: 30px; font-size: 1.1em;">
                        <tr><td style="width: 30%; font-weight: bold;">Usuario de cancelaci√≥n:</td><td style="width: 70%;">${user}</td></tr>
                        <tr><td style="width: 30%; font-weight: bold;">Fecha Actual:</td><td style="width: 70%;">${date}</td></tr>
                    </table>
                    
                    <h3 style="color: #4682B4; margin-top: 40px; border-bottom: 1px solid #B0C4DE;">Informaci√≥n Detallada de Cancelaci√≥n</h3>
                    <p style="white-space: pre-wrap; background-color: #f7fbff; padding: 15px; border-radius: 8px;">${detail}</p>
                    
                    <div class="pdf-signatures" style="margin-top: 100px; justify-content: center;"> 
                        <span style="width: 60%; text-align: center;">
                            Firma Responsable:<hr>
                        </span>
                    </div>
                </div>
            `;
            generateDocument(content, fileName);
        }
        
        // Funci√≥n gen√©rica de generaci√≥n de PDF para Constancias
        function generateDocument(contentHTML, fileName) {
             const element = document.createElement('div');
             element.innerHTML = contentHTML;
            
             const opt = {
                margin: 20, 
                filename: fileName,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'letter', orientation: 'portrait' }
             };
             
             html2pdf().from(element).set(opt).save();
        }

        // *** 6. VISUALIZACI√ìN DE √ìRDENES Y UTILER√çA ***
        
        function renderStatusBadge(status) {
             return `<span class="status-badge status-${status.replace(/\s/g, '')}">${status}</span>`;
        }

        function recalculateOtCounter() {
            if (workOrders.length === 0) {
                otCounter = 1;
                return;
            }

            const maxOt = workOrders.reduce((max, order) => {
                const currentOt = parseInt(order['Orden de Trabajo'], 10); 
                return currentOt > max ? currentOt : max;
            }, 0); 
            
            otCounter = maxOt + 1;
        }

        async function deleteWorkOrder(orderId, otNumber) {
            if (currentRole !== 'admin') {
                alert('üö´ Permiso denegado. Solo un administrador puede eliminar √≥rdenes.');
                return;
            }

            if (!confirm(`¬øEst√° seguro de que desea eliminar la Orden de Trabajo Nro. ${otNumber}? Esta acci√≥n es irreversible y ajustar√° el contador.`)) {
                return;
            }
            
            try {
                await ORDERS_COLLECTION.doc(orderId).delete();
                // El onSnapshot actualizar√° la UI
                alert(`‚úÖ Orden de Trabajo Nro. ${otNumber} eliminada.`);

            } catch (e) {
                console.error("Error al eliminar la orden:", e);
                alert("Error al eliminar la Orden de Trabajo de Firebase. Detalles: " + e.message);
            }
        }
        
        function downloadOrder(orderId) {
            const order = workOrders.find(o => o.id === orderId);
            if (order) {
                // Funci√≥n original para el PDF de la OT
                generatePDF(order); 
            } else {
                alert('No se encontr√≥ la Orden de Trabajo para descargar.');
            }
        }
        
        function downloadStatusDocument(orderId, type) {
            const order = workOrders.find(o => o.id === orderId);
            if (!order) return;
            
            const user = order[`${type} | Usuario`] || 'N/A';
            const date = order[`${type} | Fecha`] || 'N/A';
            const detail = order[`${type} | Detalle`] || 'Sin detalles.';

            if (type === 'Finalizada') {
                generateFinalizationPDF(order, user, date, detail);
            } else if (type === 'Cancelada') {
                generateCancellationPDF(order, user, date, detail);
            }
        }

        function renderAllTables() {
            renderOrdersTable('view-orders');
            renderOrdersTable('finalize-orders');
            renderOrdersTable('finished-orders');
            renderOrdersTable('cancel-orders');
            renderOrdersTable('cancelled-orders');
            if (currentRole === 'admin') {
                 renderOrdersTable('admin-status-change');
            }
        }

        function renderOrdersTable(tabId) {
            let filteredOrders = [];
            let tableId = '';
            let actionText = '';
            let actionFunc = '';

            switch (tabId) {
                case 'view-orders':
                    filteredOrders = workOrders;
                    tableId = 'orders-table';
                    break;
                case 'finalize-orders':
                    filteredOrders = workOrders.filter(o => o.status === 'En Progreso');
                    tableId = 'finalize-table';
                    actionText = 'Finalizar';
                    actionFunc = 'openStatusModal(order.id, \'finalize\')';
                    break;
                case 'finished-orders':
                    filteredOrders = workOrders.filter(o => o.status === 'Finalizada');
                    tableId = 'finished-table';
                    break;
                case 'cancel-orders':
                    filteredOrders = workOrders.filter(o => o.status === 'En Progreso');
                    tableId = 'cancel-table';
                    actionText = 'Cancelar';
                    actionFunc = 'openStatusModal(order.id, \'cancel\')';
                    break;
                case 'cancelled-orders':
                    filteredOrders = workOrders.filter(o => o.status === 'Cancelada');
                    tableId = 'cancelled-table';
                    break;
                case 'admin-status-change':
                    if (currentRole !== 'admin') return;
                    filteredOrders = workOrders.filter(o => o.status !== 'En Progreso');
                    tableId = 'admin-status-table';
                    actionText = 'Revertir a En Progreso';
                    actionFunc = 'revertStatusToInProgress(order.id, order[\'Orden de Trabajo\'])';
                    break;
                default:
                    return;
            }

            const tbody = document.getElementById(tableId).querySelector('tbody');
            tbody.innerHTML = '';
            
            filteredOrders.sort((a, b) => parseInt(b['Orden de Trabajo']) - parseInt(a['Orden de Trabajo'])); // Ordenar descendente por OT

            filteredOrders.forEach(order => {
                const row = tbody.insertRow();
                row.insertCell().textContent = order['Orden de Trabajo'];
                row.insertCell().textContent = order['T√≠tulo del Formulario'];
                
                const actionCell = row.insertCell();
                actionCell.style.whiteSpace = 'nowrap';


                if (tabId === 'view-orders') {
                     // Columna extra para el estado
                    row.insertCell().innerHTML = renderStatusBadge(order.status || 'En Progreso'); 
                    // Columna de fecha
                    row.insertCell().textContent = order['Fecha Actual'] || 'N/A';
                    
                    const downloadBtn = document.createElement('button');
                    downloadBtn.textContent = '‚¨áÔ∏è OT PDF';
                    downloadBtn.style.backgroundColor = 'var(--color-accent)'; 
                    downloadBtn.style.color = 'white';
                    downloadBtn.onclick = () => downloadOrder(order.id);
                    actionCell.appendChild(downloadBtn);
                    
                    if (currentRole === 'admin') {
                        const deleteBtn = document.createElement('button');
                        deleteBtn.textContent = 'üóëÔ∏è Eliminar';
                        deleteBtn.style.backgroundColor = 'var(--color-error)';
                        deleteBtn.style.color = 'white';
                        deleteBtn.style.marginLeft = '5px';
                        deleteBtn.onclick = () => deleteWorkOrder(order.id, order['Orden de Trabajo']);
                        actionCell.appendChild(deleteBtn);
                    }
                }
                else if (tabId === 'finalize-orders' || tabId === 'cancel-orders' || tabId === 'admin-status-change') {
                    // Estas tablas son m√°s sencillas
                    row.insertCell().textContent = order['Fecha Actual'] || 'N/A';
                    
                    if (tabId === 'admin-status-change') {
                        // Columna de Estado Actual para la pesta√±a Admin
                        row.insertCell().innerHTML = renderStatusBadge(order.status);
                    }
                    
                    const actionBtn = document.createElement('button');
                    actionBtn.textContent = actionText;
                    actionBtn.style.backgroundColor = (tabId === 'finalize-orders') ? 'var(--color-success)' : 
                                                    (tabId === 'cancel-orders') ? 'var(--color-error)' : 'var(--color-warning)';
                    actionBtn.style.color = 'white';
                    actionBtn.setAttribute('onclick', actionFunc.replace(/order.id/g, `'${order.id}'`).replace(/order\['Orden de Trabajo'\]/g, `'${order['Orden de Trabajo']}'`));
                    actionCell.appendChild(actionBtn);

                } else if (tabId === 'finished-orders' || tabId === 'cancelled-orders') {
                    const statusType = tabId === 'finished-orders' ? 'Finalizada' : 'Cancelada';
                    
                    row.insertCell().textContent = order[`${statusType} | Fecha`] || 'N/A';
                    row.insertCell().textContent = order[`${statusType} | Usuario`] || 'N/A';
                    
                    const downloadBtn = document.createElement('button');
                    downloadBtn.textContent = `‚¨áÔ∏è Constancia ${statusType === 'Finalizada' ? 'F' : 'C'} PDF`;
                    downloadBtn.style.backgroundColor = 'var(--color-primary)'; 
                    downloadBtn.style.color = 'var(--color-text)';
                    downloadBtn.onclick = () => downloadStatusDocument(order.id, statusType);
                    actionCell.appendChild(downloadBtn);
                }
            });
        }


        // GENERACI√ìN DE PDF DE ORDEN DE TRABAJO (Sin cambios mayores, solo la utiler√≠a)
        function generatePDF(data) {
            const otNumber = data['Orden de Trabajo'];
            const creationDate = data['Fecha Actual'] || 'N/A';
            const fileName = `Orden_Trabajo_${otNumber}_${creationDate.replace(/\//g, '-')}.pdf`;
            
            const secondaryHeader = `Orden de Trabajo Nro. ${otNumber}`;
            
            const NEW_VGT_LABEL = 'Pago x VGT a cargo de Inter';
            const OLD_CALC_LABEL = 'C√°lculo: Precio Unitario x Puntos = Total';

            let formContentHTML = `
                <div style="font-family: sans-serif; padding: 20px; color: #36454F;">
                    <h1 style="color: #4682B4; text-align: center; border-bottom: 2px solid #4682B4; padding-bottom: 10px;">${data['T√≠tulo del Formulario']} Nro. ${otNumber}</h1>
            `;
            
             formContentHTML += `
                 <div style="text-align: right; margin-top: -10px; margin-bottom: 20px; font-weight: bold; color: #555;">
                    Fecha de Emisi√≥n: ${data['Fecha Actual']}
                 </div>
             `;


            formStructure.forEach((section, secIndex) => {
                
                const breakAvoidStyle = (secIndex >= 2) ? 'style="page-break-inside: avoid;"' : ''; 
                
                formContentHTML += `<div ${breakAvoidStyle}>`; 

                formContentHTML += `<h3 style="color: #4682B4; margin-top: 25px;">${section.title}</h3><table style="width: 100%; border-collapse: collapse;">`;
                section.fields.forEach(field => {
                    const label = field.label;
                    let value = data[label] || 'N/A';
                    
                    if (label === 'T√≠tulo del Formulario' || label === 'Orden de Trabajo' || label === 'Fecha Actual' || label === 'Fecha Creaci√≥n Orden Trabajo') return;
                    
                    const fieldDefinition = section.fields.find(f => f.label === label);
                    if (fieldDefinition && fieldDefinition.type === 'date-input' && value !== 'N/A') {
                        value = formatDateToDDMMYYYY(value);
                    }


                    formContentHTML += `
                        <tr style="border-bottom: 1px solid #B0C4DE;">
                            <td style="width: 35%; padding: 8px; font-weight: bold; background-color: #F0F8FF;">${label}:</td>
                            <td style="width: 65%; padding: 8px;">${value}</td>
                        </tr>
                    `;
                });
                formContentHTML += '</table>';
                formContentHTML += `</div>`; 
            });
            
            const type = data['Tipo de Construcci√≥n Seleccionada'];
            if (type && type !== 'Ninguno') {
                const prefix = type.includes('Nodo') ? 'node_acceso' : 'isp';
                
                const totalCalculado = getDataLabel(data, 
                    `${prefix} | ${NEW_VGT_LABEL}`, 
                    `${prefix} | ${OLD_CALC_LABEL}` 
                ) || '0.00'; 
                
                const costoProyectado = data[`${prefix} | Costo Proyectado de la Obra`] || 'N/A';
                const pagoPorRealizado = data[`${prefix} | Pago por realizado por`] || 'N/A';
                const precioUnitario = data[`${prefix} | Precio Unitario`] || 'N/A';
                const puntos = data[`${prefix} | Puntos`] || 'N/A';
                const descripcion = data[`${prefix} | Descripci√≥n`] || 'N/A';
                const abonoMensual = data[`${prefix} | Abono Mensual a Recibir por el cliente`] || 'N/A';


                formContentHTML += `<div style="page-break-inside: avoid;">`; 
                formContentHTML += `<h3 style="color: #4682B4; margin-top: 25px;">${type}</h3><table style="width: 100%; border-collapse: collapse;">`;

                formContentHTML += `
                    <tr><td style="width: 35%; padding: 8px; font-weight: bold; background-color: #F0F8FF;">Costo Proyectado de la Obra:</td><td style="width: 65%; padding: 8px;">${costoProyectado}</td></tr>
                    <tr><td style="width: 35%; padding: 8px; font-weight: bold; background-color: #F0F8FF;">Pago por realizado por:</td><td style="width: 65%; padding: 8px;">${pagoPorRealizado}</td></tr>
                    
                    <tr style="background-color: #e0f7fa;">
                        <td style="font-weight: bold; padding: 10px;">${NEW_VGT_LABEL}: (P. Unitario ${precioUnitario} x Puntos ${puntos})</td>
                        <td style="font-weight: bold; padding: 10px; background-color: #ADD8E6;">${totalCalculado}</td> 
                    </tr>
                    
                    <tr><td style="width: 35%; padding: 8px; font-weight: bold; background-color: #F0F8FF;">Descripci√≥n:</td><td style="width: 65%; padding: 8px;">${descripcion}</td></tr>
                    <tr><td style="width: 35%; padding: 8px; font-weight: bold; background-color: #F0F8FF;">Abono Mensual a Recibir por el cliente:</td><td style="width: 65%; padding: 8px;">${abonoMensual}</td></tr>
                `;

                formContentHTML += '</table>';
                formContentHTML += `</div>`; 
            }


             formContentHTML += `
                <div class="pdf-signatures" style="page-break-inside: avoid; page-break-before: auto;"> 
                    <span>
                        Firma Contratista:<hr>
                    </span>
                    <span>
                        Firma Responsable:<hr>
                    </span>
                </div>
             `;

            formContentHTML += '</div>';
            
            const element = document.createElement('div');
            element.innerHTML = formContentHTML;
            
            const opt = {
                margin:       20, 
                filename:     fileName,
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2 },
                jsPDF:        { unit: 'mm', format: 'letter', orientation: 'portrait' }
            };

            html2pdf().from(element).set(opt).toPdf().get('pdf').then(function (pdf) {
                const totalPages = pdf.internal.getNumberOfPages();
                
                for (let i = 2; i <= totalPages; i++) {
                    pdf.setPage(i);
                    pdf.setFontSize(14); 
                    pdf.setTextColor(85, 85, 85); 

                    const x = pdf.internal.pageSize.getWidth() - 20; 
                    const y = 15; 

                    pdf.text(secondaryHeader, x, y, { 
                        align: 'right' 
                    });
                }
            }).save();
        }

    </script>

</body>
</html>
