<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Órdenes de Trabajo Atómicas</title>
    <!-- Carga de Tailwind CSS para un estilo moderno y responsivo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#1e40af',
                        'primary-light': '#eff6ff',
                        'accent-orange': '#f97316',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 1.5rem;
        }
        /* Estilo para los botones */
        .btn-primary {
            transition: all 0.2s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }
        .loader {
            border-top-color: #3498db;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        @-webkit-keyframes spinner {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

<div class="container">
    <header class="text-center py-6 bg-white rounded-xl shadow-lg mb-6">
        <h1 class="text-3xl font-bold text-primary-blue">Sistema de Generación de Órdenes de Trabajo</h1>
        <p class="text-gray-600 mt-2">Uso de Transacciones Atómicas para Numeración Segura</p>
        <p class="text-sm text-accent-orange mt-1">El ID de usuario es esencial para el almacenamiento privado: <span id="current-user-id" class="font-mono bg-primary-light px-2 py-1 rounded">Cargando...</span></p>
    </header>

    <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <!-- Panel de Creación -->
        <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">Crear Nueva Orden de Trabajo</h2>
            
            <div class="mb-4">
                <label for="work-description" class="block text-sm font-medium text-gray-700 mb-1">Descripción del Trabajo</label>
                <textarea id="work-description" rows="3" class="w-full border-2 border-gray-300 rounded-lg p-3 focus:ring-primary-blue focus:border-primary-blue transition duration-150" placeholder="Construcción Nodo de Acceso, Altamira, Torre A..."></textarea>
            </div>
            
            <button id="create-order-btn" class="w-full flex items-center justify-center bg-primary-blue text-white font-bold py-3 px-4 rounded-lg btn-primary hover:bg-blue-800 focus:outline-none focus:ring-4 focus:ring-primary-blue focus:ring-opacity-50" onclick="createWorkOrder()">
                <span id="btn-text">Generar Orden de Trabajo (Usando Transacción)</span>
                <div id="btn-loader" class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-6 w-6 ml-2 hidden"></div>
            </button>
            
            <div id="message-box" class="mt-4 p-3 rounded-lg text-center font-medium hidden"></div>
        </div>

        <!-- Panel de Historial (Tiempo Real) -->
        <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">Historial de Órdenes</h2>
            <div id="work-orders-list" class="space-y-3 max-h-96 overflow-y-auto">
                <p class="text-gray-500 text-sm italic">Cargando órdenes...</p>
            </div>
        </div>

    </main>
</div>

<!-- Firebase SDKs -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, collection, onSnapshot, setDoc, runTransaction, query, orderBy, limit, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- Variables Globales Proporcionadas por el Entorno ---
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    
    if (!firebaseConfig) {
        console.error("Firebase config not available.");
        document.getElementById('message-box').classList.add('bg-red-100', 'text-red-700');
        document.getElementById('message-box').innerText = "ERROR: Configuración de Firebase no disponible.";
        document.getElementById('message-box').classList.remove('hidden');
    }

    // --- Inicialización y Autenticación ---
    let app, db, auth, userId = null;
    let isAuthReady = false;

    // Inicializa la aplicación Firebase
    if (firebaseConfig) {
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        setLogLevel('debug'); // Para ver logs en la consola
        window.db = db; // Hacer db accesible globalmente para createWorkOrder
    }
    
    // Función para manejar la autenticación
    async function handleAuthentication() {
        try {
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }
        } catch (error) {
            console.error("Error de autenticación:", error);
        }
    }

    // Listener del estado de autenticación
    onAuthStateChanged(auth, (user) => {
        if (user) {
            userId = user.uid;
            document.getElementById('current-user-id').textContent = userId;
            isAuthReady = true;
            console.log("Usuario autenticado. UID:", userId);
            setupRealtimeListener();
        } else {
            // Esto solo pasa si signInAnonymously falla, pero se intenta asegurar
            userId = crypto.randomUUID();
            document.getElementById('current-user-id').textContent = userId + " (Anónimo)";
            isAuthReady = true;
            console.log("Autenticación no completada, usando ID aleatorio:", userId);
            setupRealtimeListener();
        }
    });

    handleAuthentication();

    // --- Lógica de la Base de Datos ---

    // La colección de Órdenes de Trabajo y el contador están en la ruta pública para que todas las vean.
    const WORK_ORDERS_PATH = `artifacts/${appId}/public/data/workOrders`;
    const COUNTER_DOC_PATH = `artifacts/${appId}/public/data/counters/workOrderCounter`;

    /**
     * Usa una transacción atómica para obtener el siguiente número de orden.
     * Esto PREVIENE que dos usuarios obtengan el mismo número (race condition)
     * y es la solución para números saltados por errores de concurrencia.
     * @returns {Promise<number>} El número de orden de trabajo incrementado.
     */
    async function getNextWorkOrderNumber() {
        if (!db) throw new Error("Firestore no está inicializado.");
        
        const counterRef = doc(db, COUNTER_DOC_PATH);
        let nextNumber;

        try {
            // La transacción garantiza que todas las operaciones se completen
            // antes de que otra transacción pueda modificarlas.
            await runTransaction(db, async (transaction) => {
                const counterDoc = await transaction.get(counterRef);

                if (!counterDoc.exists()) {
                    // Inicializar el contador si no existe (la primera Orden será la 1)
                    nextNumber = 1;
                    transaction.set(counterRef, { currentValue: nextNumber });
                    console.log("Contador inicializado a 1.");
                } else {
                    // Si existe, lo incrementamos
                    const current = counterDoc.data().currentValue;
                    nextNumber = current + 1;
                    transaction.update(counterRef, { currentValue: nextNumber });
                    console.log("Contador incrementado de", current, "a", nextNumber);
                }
            });
            return nextNumber;
        } catch (e) {
            console.error("Error en la transacción del contador:", e);
            throw new Error("Fallo al obtener el número de orden de forma segura. Intente de nuevo.");
        }
    }

    /**
     * Crea una Orden de Trabajo completa.
     */
    async function createWorkOrder() {
        const descriptionInput = document.getElementById('work-description');
        const description = descriptionInput.value.trim();
        const btn = document.getElementById('create-order-btn');
        const btnText = document.getElementById('btn-text');
        const btnLoader = document.getElementById('btn-loader');
        const msgBox = document.getElementById('message-box');

        if (!description) {
            showToast(msgBox, 'Por favor, ingrese una descripción para la orden.', 'red');
            return;
        }
        if (!isAuthReady) {
            showToast(msgBox, 'Esperando autenticación...', 'yellow');
            return;
        }

        // Mostrar carga y deshabilitar botón
        btnText.textContent = 'Generando...';
        btn.disabled = true;
        btnLoader.classList.remove('hidden');
        msgBox.classList.add('hidden');

        try {
            // 1. Obtener el número de orden de forma atómica
            const orderNumber = await getNextWorkOrderNumber();

            // 2. Crear el documento de la Orden de Trabajo
            const orderData = {
                orderNumber: orderNumber,
                description: description,
                status: 'Pendiente',
                creatorId: userId,
                createdAt: serverTimestamp()
            };

            const newOrderRef = doc(collection(db, WORK_ORDERS_PATH));
            await setDoc(newOrderRef, orderData);

            showToast(msgBox, `¡Orden de Trabajo Nro. ${orderNumber} creada con éxito!`, 'green');
            descriptionInput.value = ''; // Limpiar campo
            
        } catch (error) {
            console.error("Error al crear la Orden de Trabajo:", error);
            showToast(msgBox, `Error al crear la Orden: ${error.message}.`, 'red');
        } finally {
            // Restaurar botón
            btnText.textContent = 'Generar Orden de Trabajo (Usando Transacción)';
            btn.disabled = false;
            btnLoader.classList.add('hidden');
        }
    }

    window.createWorkOrder = createWorkOrder; // Hacer la función accesible globalmente

    /**
     * Configura el listener en tiempo real para mostrar las órdenes.
     */
    function setupRealtimeListener() {
        if (!db) return;

        // Diagnóstico: Confirma que estamos listos para la consulta.
        // El error de permisos suele ser por problemas de autenticación o reglas de seguridad.
        if (!userId) {
            console.error("Error de diagnóstico: userId es nulo al intentar configurar el listener. Retrasando...");
            return; // En teoría, esto no debería ocurrir aquí debido a onAuthStateChanged.
        }
        
        console.log("Intentando conectar listener en WORK_ORDERS_PATH:", WORK_ORDERS_PATH);
        console.log("Usuario actual ID (para referencia de reglas):", userId);


        const q = query(collection(db, WORK_ORDERS_PATH), orderBy('orderNumber', 'desc'), limit(10));
        
        onSnapshot(q, (snapshot) => {
            const list = document.getElementById('work-orders-list');
            list.innerHTML = '';
            
            if (snapshot.empty) {
                list.innerHTML = '<p class="text-gray-500 text-sm italic">Aún no hay órdenes de trabajo creadas.</p>';
                return;
            }

            snapshot.forEach((doc) => {
                const data = doc.data();
                const time = data.createdAt ? new Date(data.createdAt.toDate()).toLocaleTimeString('es-ES') : 'N/A';
                
                const item = document.createElement('div');
                item.className = 'p-3 bg-primary-light border border-primary-blue rounded-lg';
                item.innerHTML = `
                    <p class="font-bold text-lg text-primary-blue">Nro. ${data.orderNumber}</p>
                    <p class="text-sm text-gray-700 truncate">${data.description}</p>
                    <p class="text-xs text-gray-500 mt-1">Creada por: <span class="font-mono text-xs">${data.creatorId.substring(0, 8)}...</span> a las ${time}</p>
                `;
                list.appendChild(item);
            });
        }, (error) => {
            console.error("Error al escuchar las Órdenes de Trabajo:", error);
            // Mostrar mensaje de error más claro en la UI.
            const list = document.getElementById('work-orders-list');
            list.innerHTML = `<p class="text-red-600 font-medium p-4 bg-red-50 rounded-lg">Error de Permisos: No se pudo cargar el historial. Asegúrese de que el usuario esté autenticado correctamente y que las reglas de seguridad de Firestore permitan la lectura pública de la ruta: ${WORK_ORDERS_PATH}</p>`;
        });
    }

    /**
     * Muestra un mensaje temporal en la caja de notificaciones.
     */
    function showToast(element, message, type) {
        element.textContent = message;
        element.className = 'mt-4 p-3 rounded-lg text-center font-medium';
        element.classList.remove('hidden');

        switch (type) {
            case 'green':
                element.classList.add('bg-green-100', 'text-green-700');
                break;
            case 'red':
                element.classList.add('bg-red-100', 'text-red-700');
                break;
            case 'yellow':
                element.classList.add('bg-yellow-100', 'text-yellow-700');
                break;
