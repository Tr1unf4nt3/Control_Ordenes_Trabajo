<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de √ìrdenes de Trabajo | Firebase Cloud Edition</title>
    <!-- Librer√≠a para generar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
    
    <!-- LIBRER√çAS DE FIREBASE (Versi√≥n Modular, compatible con Canvas) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, orderBy, limit, addDoc, deleteDoc, runTransaction, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- INICIO: REEMPLAZO DE CONFIGURACI√ìN DEL USUARIO ---
        const firebaseConfig = {
            apiKey: "AIzaSyBHgF18eLwdZbl1g4OkDu-_NWkBnfLh3EA",
            authDomain: "ordenestrabajo-39eab.firebaseapp.com",
            projectId: "ordenestrabajo-39eab",
            storageBucket: "ordenestrabajo-39eab.firebasestorage.app",
            messagingSenderId: "561184772303",
            appId: "1:561184772303:web:765f5859b4b3a332e827ba"
        };
        // --- FIN: REEMPLAZO DE CONFIGURACI√ìN DEL USUARIO ---

        // Inicializar Firebase y exponer las variables necesarias al √°mbito global
        window.app = initializeApp(firebaseConfig);
        window.auth = getAuth(window.app);
        window.db = getFirestore(window.app);

        // Variables Globales de Firestore
        window.ORDERS_COLLECTION = collection(window.db, "workOrders");
        window.CONFIG_COLLECTION = collection(window.db, "config");
        window.COUNTER_DOC = doc(window.db, "config", "otCounter");
        window.CONFIG_DOC = doc(window.db, "config", "systemConfig"); 
        window.serverTimestamp = serverTimestamp;

        // Declaraci√≥n de variables globales que ser√°n inicializadas en la funci√≥n initApp
        window.otCounter = 0;
        window.formStructure = []; 
        window.workOrders = []; 
        window.currentRole = null;
        window.currentUserEmail = null;

        // Roles y Permisos (LISTA DE CORREOS HARDCODEADA)
        const ROLE_MAP = {
            'admin': ['admin@ejemplo.com', 'otroadmin@ejemplo.com'], 
            'normal': ['usuario1@ejemplo.com', 'usuario2@ejemplo.com'], 
            'viewer': ['visor@ejemplo.com', 'otrovisor@ejemplo.com'] 
        };
        
        // Estructura de Formulario por defecto (Si no existe en Firebase)
        const DEFAULT_FORM_STRUCTURE = [
            {
                id: "section_i",
                title: "I. Informaci√≥n General",
                fields: [
                    { id: "ot_title", label: "T√≠tulo del Formulario (*):", type: "text", required: true },
                    { id: "ot_fecha", label: "Fecha Actual (*):", type: "date", required: true },
                    { id: "ot_site", label: "Site/Ubicaci√≥n:", type: "text", required: false },
                ]
            },
            {
                id: "section_ii",
                title: "II. Contratista",
                fields: [
                    // El campo de Contratista se mantiene como texto simple para este ejemplo
                    { id: "ot_empresa", label: "Empresa Contratista (*):", type: "text", required: true }, 
                    { id: "ot_responsable", label: "Apellido y Nombre del Responsable (*):", type: "text", required: true },
                    { id: "ot_rif", label: "Rif (*):", type: "text", required: true },
                ]
            },
            {
                id: "section_iii",
                title: "III. Informaci√≥n del Trabajo/Obra",
                fields: [
                    { id: "ot_descripcion", label: "Descripci√≥n del Trabajo (*):", type: "textarea", required: true },
                    { id: "ot_tipo", label: "Tipo de Trabajo:", type: "select", options: ["Obra Nueva", "Mantenimiento", "Correcci√≥n"], required: true },
                    
                    // --- CAMPOS MODIFICADOS POR SOLICITUD ---
                    { id: "pago_vgt_cantv", label: "Pago x VGT CANTV a cargo de Inter (*):", type: "number", required: true },
                    { id: "pago_vgt_edc", label: "Pago x VGT EDC a cargo de Inter (*):", type: "number", required: true },
                    // --- FIN DE CAMPOS MODIFICADOS ---
                    
                    { id: "ot_observaciones", label: "Observaciones/Notas:", type: "textarea", required: false },
                ]
            }
        ];

        // --- [2. L√ìGICA DE AUTENTICACI√ìN Y ROLES] ---

        function determineRole(email) {
            if (ROLE_MAP.admin.includes(email)) return 'admin';
            if (ROLE_MAP.normal.includes(email)) return 'normal';
            if (ROLE_MAP.viewer.includes(email)) return 'viewer';
            return null; // Usuario no autorizado
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorElement = document.getElementById('login-error');
            errorElement.textContent = '';

            try {
                // Usando la funci√≥n del SDK modular
                await signInWithEmailAndPassword(window.auth, email, password);
            } catch (error) {
                console.error("Error de autenticaci√≥n:", error.code, error.message);
                errorElement.textContent = `Error de inicio de sesi√≥n: ${error.message}`;
            }
        }

        function handleLogout() {
            signOut(window.auth);
            // Limpiar variables de estado al cerrar sesi√≥n
            window.formStructure = [];
            window.workOrders = [];
            window.currentRole = null;
        }

        // --- [3. L√ìGICA DE FIREBASE: Carga de Datos y Migraci√≥n] ---

        /**
         * Aplica la migraci√≥n de campos VGT: renombra el campo original y lo duplica.
         * @param {Array} structure - La estructura del formulario actual.
         * @returns {boolean} - true si la estructura fue modificada.
         */
        function applyVGTMigration(structure) {
            const originalLabel = "Pago x VGT a cargo de Inter (*):";
            const newLabelCANTV = "Pago x VGT CANTV a cargo de Inter (*):";
            const newLabelEDC = "Pago x VGT EDC a cargo de Inter (*):";
            let originalFieldIndex = -1;
            let originalSectionIndex = -1;
            let structureModified = false;

            // 1. Buscar el campo original por su etiqueta
            for (let sIndex = 0; sIndex < structure.length; sIndex++) {
                const section = structure[sIndex];
                originalFieldIndex = section.fields.findIndex(f => f.label === originalLabel);
                if (originalFieldIndex !== -1) {
                    originalSectionIndex = sIndex;
                    break;
                }
            }

            if (originalFieldIndex !== -1) {
                // 2. Renombrar el campo original a CANTV
                const originalField = structure[originalSectionIndex].fields[originalFieldIndex];
                originalField.label = newLabelCANTV;
                originalField.id = "pago_vgt_cantv"; 

                // 3. Crear y duplicar el campo (EDC)
                const edcField = {
                    ...originalField, // Copiar todas las propiedades del campo original
                    label: newLabelEDC,
                    id: "pago_vgt_edc" 
                };
                
                // 4. Insertar el nuevo campo (EDC) inmediatamente despu√©s del original (CANTV)
                structure[originalSectionIndex].fields.splice(originalFieldIndex + 1, 0, edcField);
                structureModified = true;
                
                console.log("Migraci√≥n de campos VGT aplicada: Renombrado y Duplicado.");
            }
            
            return structureModified;
        }


        async function loadInitialData() {
            try {
                // Cargar Contador OT
                const counterSnapshot = await getDoc(window.COUNTER_DOC);
                if (counterSnapshot.exists()) {
                    window.otCounter = counterSnapshot.data().currentValue || 0;
                }
                document.getElementById('ot-counter-display').textContent = `Pr√≥ximo Nro. OT: ${window.otCounter + 1}`;
                
                // Cargar Estructura del Formulario
                const configSnapshot = await getDoc(window.CONFIG_DOC);
                if (configSnapshot.exists()) {
                    const data = configSnapshot.data();
                    window.formStructure = data.formStructure || DEFAULT_FORM_STRUCTURE;
                    
                    // APLICAR LA MIGRACI√ìN DE CAMPOS VGT
                    const wasMigrated = applyVGTMigration(window.formStructure);
                    if (wasMigrated) {
                        // Si hubo cambios, los guardamos de vuelta para que persistan en Firestore
                        await saveFormStructure(true); // Guarda de forma silenciosa
                    }
                    
                } else {
                    window.formStructure = DEFAULT_FORM_STRUCTURE;
                    // Si no existe, lo creamos con la estructura por defecto
                    await saveFormStructure(true); 
                }

                // Cargar √ìrdenes de Trabajo (solo 100 m√°s recientes)
                const q = query(window.ORDERS_COLLECTION, orderBy('Orden de Trabajo', 'desc'), limit(100));
                const ordersSnapshot = await getDocs(q); // Usar getDocs para queries
                window.workOrders = ordersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Renderizar la UI despu√©s de cargar todos los datos
                renderWorkOrderForm();
                renderWorkOrdersTable(window.workOrders);
                if (window.currentRole === 'admin') {
                    renderFormEditor();
                }

            } catch (e) {
                console.error("Error al cargar datos iniciales:", e);
                // Si el error es de clave API, se maneja en el listener de auth
                if (e.message.includes("API key")) {
                    document.getElementById('login-error').textContent = `Error de configuraci√≥n: ${e.message}`;
                } else {
                    console.error("Error al cargar datos iniciales:", e);
                }
            }
        }

        // Funci√≥n de inicializaci√≥n principal
        function initApp() {
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('logout-button').addEventListener('click', handleLogout);
            document.getElementById('work-order-form').addEventListener('submit', handleGenerateOT);
            
            // Listener de estado de autenticaci√≥n - AHORA DENTRO DEL BLOQUE MODULE
            onAuthStateChanged(window.auth, (user) => {
                if (user) {
                    window.currentUserEmail = user.email;
                    window.currentRole = determineRole(window.currentUserEmail);

                    if (window.currentRole) {
                        document.getElementById('login-container').classList.add('hidden');
                        document.getElementById('app').classList.remove('hidden');
                        document.getElementById('welcome-message').textContent = `¬°Bienvenido, ${window.currentUserEmail}!`;
                        document.getElementById('role-display').textContent = `Rol: ${window.currentRole.toUpperCase()}`;
                        
                        // Control de Permisos de Pesta√±as
                        document.getElementById('admin-tab').classList.add('hidden');
                        if (window.currentRole === 'admin') {
                            document.getElementById('admin-tab').classList.remove('hidden');
                        }
                        
                        loadInitialData();
                        window.openTab(null, 'new-order'); 
                    } else {
                        // Usar una funci√≥n personalizada en lugar de alert()
                        displayMessage("Su correo electr√≥nico no est√° autorizado para acceder al sistema.", 'error');
                        signOut(window.auth);
                    }
                } else {
                    document.getElementById('login-container').classList.remove('hidden');
                    document.getElementById('app').classList.add('hidden');
                }
            });
        }
        
        // Exponer la funci√≥n initApp para que window.onload pueda llamarla
        window.initApp = initApp; 
        
        // --- Otras Funciones necesarias ---

        function displayMessage(message, type) {
            // Placeholder para una futura caja de mensajes modal
            console.log(`[${type.toUpperCase()}] ${message}`);
            alert(message); // Temporalmente usa alert() para notificaciones, aunque se recomienda un modal personalizado.
        }

        // Exponer funciones necesarias al scope global para que el HTML pueda llamarlas
        window.openTab = (evt, tabName) => {
            let i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            if (evt) {
                evt.currentTarget.className += " active";
            } else {
                document.getElementById('defaultOpen').className += " active";
            }
        };

        window.renderWorkOrderForm = () => {
            const container = document.getElementById('dynamic-form-container');
            container.innerHTML = ''; 

            window.formStructure.forEach(section => {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'form-section';
                sectionDiv.innerHTML = `<h3>${section.title}</h3>`;

                section.fields.forEach(field => {
                    const fieldId = field.id;
                    const requiredAttribute = field.required ? 'required' : '';
                    let inputHTML = '';
                    
                    switch (field.type) {
                        case 'text':
                        case 'date':
                        case 'number':
                            inputHTML = `<input type="${field.type}" id="${fieldId}" name="${fieldId}" ${requiredAttribute}>`;
                            break;
                        case 'textarea':
                            inputHTML = `<textarea id="${fieldId}" name="${fieldId}" ${requiredAttribute} rows="4"></textarea>`;
                            break;
                        case 'select':
                            const optionsHTML = (field.options || []).map(option => 
                                `<option value="${option}">${option}</option>`
                            ).join('');
                            inputHTML = `<select id="${fieldId}" name="${fieldId}" ${requiredAttribute}><option value="">Seleccione...</option>${optionsHTML}</select>`;
                            break;
                        default:
                            inputHTML = `<input type="text" id="${fieldId}" name="${fieldId}" ${requiredAttribute}>`;
                            break;
                    }

                    const fieldDiv = document.createElement('div');
                    fieldDiv.className = 'form-field';
                    fieldDiv.innerHTML = `
                        <label for="${fieldId}">${field.label}</label>
                        ${inputHTML}
                    `;
                    sectionDiv.appendChild(fieldDiv);
                });

                container.appendChild(sectionDiv);
            });
            
            // Establecer la fecha actual por defecto en el campo de fecha si existe
            const dateField = document.getElementById('ot_fecha');
            if (dateField) {
                dateField.valueAsDate = new Date();
            }
        };

        window.handleGenerateOT = async (e) => {
            e.preventDefault();
            if (window.currentRole !== 'admin' && window.currentRole !== 'normal') {
                displayMessage("Su rol no tiene permisos para crear √ìrdenes de Trabajo.", 'error');
                return;
            }

            const workOrderData = {
                'Orden de Trabajo': window.otCounter + 1,
                'Autor': window.currentUserEmail,
                'Timestamp': window.serverTimestamp() // Usando el timestamp del servidor
            };

            // Recoger datos del formulario din√°mico
            let isValid = true;
            window.formStructure.forEach(section => {
                section.fields.forEach(field => {
                    const input = document.getElementById(field.id);
                    if (input) {
                        workOrderData[field.label] = input.value;
                        if (field.required && !input.value) {
                            isValid = false;
                        }
                    }
                });
            });

            if (!isValid) {
                displayMessage("Por favor, complete todos los campos obligatorios (*).", 'error');
                return;
            }

            // Confirmaci√≥n antes de guardar
            if (!confirm(`¬øConfirma la generaci√≥n de la OT Nro. ${workOrderData['Orden de Trabajo']}?`)) {
                return;
            }

            try {
                // 1. Guardar la nueva OT en Firestore
                const newOrderRef = await addDoc(window.ORDERS_COLLECTION, workOrderData);

                // 2. Incrementar el contador de OT (usando una transacci√≥n para seguridad)
                await runTransaction(window.db, async (transaction) => {
                    const counterDoc = await transaction.get(window.COUNTER_DOC);
                    const newCounter = (counterDoc.exists() ? counterDoc.data().currentValue : 0) + 1;
                    transaction.set(window.COUNTER_DOC, { currentValue: newCounter });
                });
                
                // Actualizar estado local
                window.otCounter = window.otCounter + 1;
                document.getElementById('ot-counter-display').textContent = `Pr√≥ximo Nro. OT: ${window.otCounter + 1}`;
                
                // Opcional: Agregar la nueva orden al historial local para evitar recarga completa
                window.workOrders.unshift({ id: newOrderRef.id, ...workOrderData });
                renderWorkOrdersTable(window.workOrders);
                
                displayMessage(`Orden de Trabajo Nro. ${workOrderData['Orden de Trabajo']} generada y guardada exitosamente.`, 'success');
                
                // 3. Generar y Descargar PDF
                await printWorkOrder(workOrderData);

                // 4. Resetear formulario
                document.getElementById('work-order-form').reset();
                window.renderWorkOrderForm(); 

            } catch (e) {
                console.error("Error al guardar la Orden de Trabajo:", e);
                displayMessage("Error al guardar la Orden de Trabajo: " + e.message, 'error');
            }
        };

        window.downloadOrder = async (docId) => {
            try {
                const docSnap = await getDoc(doc(window.ORDERS_COLLECTION, docId));
                if (docSnap.exists()) {
                    await printWorkOrder(docSnap.data());
                } else {
                    displayMessage("Documento no encontrado.", 'error');
                }
            } catch (e) {
                console.error("Error al descargar la OT:", e);
                displayMessage("Error al descargar la OT.", 'error');
            }
        };

        window.printWorkOrder = async (workOrderData) => {
            const pdfContainer = document.getElementById('pdf-content-container');
            pdfContainer.innerHTML = ''; 

            let htmlContent = `
                <div class="pdf-content">
                    <h1>ORDEN DE TRABAJO - Nro. ${workOrderData['Orden de Trabajo']}</h1>
                    <p style="text-align: center; font-style: italic;">Generado por: ${workOrderData['Autor']}</p>
            `;
            
            // 1. Recorrer la estructura del formulario para generar el PDF
            window.formStructure.forEach(section => {
                htmlContent += `<h2>${section.title}</h2><div class="pdf-grid">`;
                
                section.fields.forEach(field => {
                    const label = field.label;
                    const value = workOrderData[label] || 'N/A';
                    
                    // Asegurar que el campo de descripci√≥n use una fila completa
                    const fullRowClass = (field.type === 'textarea' || field.label.includes('Observaciones')) ? 'pdf-full-row' : '';

                    htmlContent += `
                        <div class="pdf-field ${fullRowClass}">
                            <strong>${label}</strong>
                            <span>${value}</span>
                        </div>
                    `;
                });
                
                htmlContent += `</div>`; // Cierra pdf-grid
            });

            // 2. √Årea de Firmas (Fija)
            htmlContent += `
                    <div class="pdf-signature-area">
                        <div class="pdf-signature">
                            <br><br>
                            ___________________________________<br>
                            Firma del Responsable (Empresa Contratista)
                        </div>
                        <div class="pdf-signature">
                            <br><br>
                            ___________________________________<br>
                            Firma de Inter (Supervisor/Coordinador)
                        </div>
                    </div>
                </div>
            `;
            
            pdfContainer.innerHTML = htmlContent;
            
            // 3. Generar PDF con html2pdf
            const fileName = `OT-${workOrderData['Orden de Trabajo']}_${workOrderData['T√≠tulo del Formulario'] || 'Sin_T√≠tulo'}.pdf`;

            const opt = {
                margin: 10,
                filename: fileName.replace(/ /g, '_').replace(/[:\/\\*?"]/g, ''),
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'letter', orientation: 'portrait' }
            };

            await html2pdf().set(opt).from(pdfContainer).save();
        };

        window.renderWorkOrdersTable = (orders) => {
            const tbody = document.getElementById('work-orders-tbody');
            tbody.innerHTML = ''; 

            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">No hay √ìrdenes de Trabajo registradas o que coincidan con la b√∫squeda.</td></tr>';
                return;
            }

            orders.forEach(order => {
                const row = tbody.insertRow();
                row.insertCell().textContent = order['Orden de Trabajo'];
                row.insertCell().textContent = order['T√≠tulo del Formulario'] || 'Sin T√≠tulo';
                
                // Formatear la fecha
                let creationDate = order['Fecha Actual'] || 'N/A';
                if (order.Timestamp && order.Timestamp.toDate) {
                    creationDate = new Date(order.Timestamp.toDate()).toLocaleDateString('es-VE');
                }
                row.insertCell().textContent = creationDate;
                
                const actionCell = row.insertCell();
                
                // Bot√≥n de Descarga PDF
                const downloadBtn = document.createElement('button');
                downloadBtn.textContent = '‚¨áÔ∏è PDF';
                downloadBtn.style.backgroundColor = '#77DD77'; 
                downloadBtn.style.color = 'white';
                downloadBtn.onclick = () => window.downloadOrder(order.id);
                actionCell.appendChild(downloadBtn);
                
                // Bot√≥n de Eliminar (Solo para Admin)
                if (window.currentRole === 'admin') {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'üóëÔ∏è Eliminar';
                    deleteBtn.style.backgroundColor = 'var(--color-error)';
                    deleteBtn.style.color = 'white';
                    deleteBtn.style.marginLeft = '5px';
                    deleteBtn.onclick = () => window.deleteWorkOrder(order.id, order['Orden de Trabajo']);
                    actionCell.appendChild(deleteBtn);
                }
            });
        };

        window.filterWorkOrders = () => {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const filtered = window.workOrders.filter(order => {
                const otNumber = String(order['Orden de Trabajo']);
                const otTitle = (order['T√≠tulo del Formulario'] || '').toLowerCase();
                return otNumber.includes(searchTerm) || otTitle.includes(searchTerm);
            });
            window.renderWorkOrdersTable(filtered);
        };

        window.deleteWorkOrder = async (docId, otNumber) => {
            if (window.currentRole !== 'admin' || !confirm(`¬øEst√° seguro de eliminar la OT Nro. ${otNumber}? Esta acci√≥n es irreversible.`)) {
                return;
            }

            try {
                await deleteDoc(doc(window.ORDERS_COLLECTION, docId));
                
                // Eliminar del array local y re-renderizar
                window.workOrders = window.workOrders.filter(order => order.id !== docId);
                window.renderWorkOrdersTable(window.workOrders);
                
                displayMessage(`OT Nro. ${otNumber} eliminada exitosamente.`, 'success');
            } catch (e) {
                console.error("Error al eliminar la OT:", e);
                displayMessage("Error al eliminar la Orden de Trabajo.", 'error');
            }
        };

        window.saveFormStructure = async (initial = false) => {
            if (window.currentRole !== 'admin' && !initial) {
                displayMessage("Solo los administradores pueden guardar la estructura del formulario.", 'error');
                return;
            }
            
            try {
                const structureToSave = JSON.parse(JSON.stringify(window.formStructure)); 
                await setDoc(window.CONFIG_DOC, { formStructure: structureToSave }, { merge: true });
                if (!initial) {
                    displayMessage("Estructura de formulario guardada y actualizada exitosamente.", 'success');
                    window.renderWorkOrderForm(); 
                }
            } catch (e) {
                console.error("Error al guardar la estructura:", e);
                displayMessage("Error al guardar la estructura del formulario.", 'error');
            }
        };

        window.resetOtCounter = async () => {
            if (window.currentRole !== 'admin' || !confirm("ADVERTENCIA: ¬øEst√° seguro de REINICIAR el contador de √ìrdenes de Trabajo a 0? Esto puede causar duplicados.")) {
                return;
            }

            try {
                await setDoc(window.COUNTER_DOC, { currentValue: 0 });
                window.otCounter = 0;
                document.getElementById('ot-counter-display').textContent = `Pr√≥ximo Nro. OT: ${window.otCounter + 1}`;
                displayMessage("Contador de OT reiniciado a 0.", 'success');
            } catch (e) {
                console.error("Error al reiniciar el contador:", e);
                displayMessage("Error al reiniciar el contador de OT.", 'error');
            }
        };

        window.renderFormEditor = () => {
            if (window.currentRole !== 'admin') return;
            
            const editorDiv = document.getElementById('form-editor');
            editorDiv.innerHTML = '<h4>Editor de Campos del Formulario</h4><p>Arrastre, edite o elimine campos y secciones.</p><div id="form-structure-editor"></div><button onclick="window.saveFormStructure(false)">üíæ Guardar Estructura del Formulario</button>';
            
            const structureEditor = document.getElementById('form-structure-editor');
            structureEditor.innerHTML = '';
            
            window.formStructure.forEach((section, sIndex) => {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'section-editor-item';
                sectionDiv.innerHTML = `<h4>Secci√≥n ${sIndex + 1}: <input type="text" value="${section.title}" onchange="window.formStructure[${sIndex}].title = this.value"></h4>`;
                
                section.fields.forEach((field, fIndex) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'field-editor-item';
                    itemDiv.innerHTML = `
                        <input type="text" value="${field.label}" onchange="window.formStructure[${sIndex}].fields[${fIndex}].label = this.value" placeholder="Etiqueta">
                        <input type="text" value="${field.id}" onchange="window.formStructure[${sIndex}].fields[${fIndex}].id = this.value" placeholder="ID (√önico)">
                        <select onchange="window.formStructure[${sIndex}].fields[${fIndex}].type = this.value">
                            <option value="text" ${field.type === 'text' ? 'selected' : ''}>Texto</option>
                            <option value="number" ${field.type === 'number' ? 'selected' : ''}>N√∫mero</option>
                            <option value="date" ${field.type === 'date' ? 'selected' : ''}>Fecha</option>
                            <option value="textarea" ${field.type === 'textarea' ? 'selected' : ''}>√Årea de Texto</option>
                            <option value="select" ${field.type === 'select' ? 'selected' : ''}>Lista (Select)</option>
                        </select>
                        <button onclick="window.removeField(${sIndex}, ${fIndex})" style="background-color: var(--color-error);">üóëÔ∏è</button>
                    `;
                    sectionDiv.appendChild(itemDiv);
                });
                
                const addFieldBtn = document.createElement('button');
                addFieldBtn.textContent = '‚ûï A√±adir Campo';
                addFieldBtn.onclick = () => window.addFieldToSection(sIndex);
                sectionDiv.appendChild(addFieldBtn);
                
                structureEditor.appendChild(sectionDiv);
            });
        };

        window.addFieldToSection = (sIndex) => {
            window.formStructure[sIndex].fields.push({
                id: `new_field_${Date.now()}`, 
                label: `Nuevo Campo`, 
                type: 'text', 
                required: false
            });
            window.renderFormEditor();
        };

        window.removeField = (sIndex, fIndex) => {
            if (confirm("¬øSeguro que desea eliminar este campo?")) {
                window.formStructure[sIndex].fields.splice(fIndex, 1);
                window.renderFormEditor();
            }
        };

        // Iniciar la aplicaci√≥n despu√©s de cargar Firebase (window.initApp se expone arriba)
        window.onload = () => window.initApp();

    </script>
    
    <style>
        /* Paleta de colores Pastel Azul/Gris */
        :root {
            --color-bg: #F0F8FF;         /* Azul muy claro (Alice Blue) */
            --color-primary: #ADD8E6;    /* Azul claro (Light Blue) */
            --color-secondary: #B0C4DE;  /* Azul gris√°ceo (Light Steel Blue) */
            --color-accent: #87CEFA;     /* Azul cielo claro (Light Sky Blue) */
            --color-text: #36454F;       /* Gris carb√≥n (Charcoal) */
            --color-button: #4682B4;     /* Azul Acero (Steel Blue) */
            --color-button-hover: #5F9EA0; /* Azul Gris√°ceo (Cadet Blue) */
            --color-error: #F08080;      /* Coral claro (Light Coral) */
            --color-success: #90EE90;    /* Verde claro (Light Green) */
            --color-border: #C0C0C0;     /* Plata (Silver) */
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--color-bg);
            color: var(--color-text);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 20px;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }

        h1, h2, h3 {
            color: var(--color-button);
            border-bottom: 2px solid var(--color-primary);
            padding-bottom: 5px;
            margin-top: 20px;
        }

        /* --- Estilos de Login --- */
        #login-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-width: 350px;
            margin: 50px auto;
            padding: 30px;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }
        
        #login-form input[type="email"], #login-form input[type="password"] {
            padding: 10px;
            border: 1px solid var(--color-border);
            border-radius: 5px;
            font-size: 16px;
        }
        
        #login-form button {
            background-color: var(--color-button);
            color: white;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        
        #login-form button:hover {
            background-color: var(--color-button-hover);
        }

        /* Responsive para Login */
        @media (max-width: 600px) {
            #login-form {
                margin: 20px;
                max-width: 90%;
            }
        }

        /* --- Estilos del Header/Navegaci√≥n --- */
        #header {
            display: flex;
            flex-wrap: wrap; /* A√±adir wrap para m√≥vil */
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background-color: var(--color-secondary);
            color: white;
            border-radius: 8px 8px 0 0;
            margin: -20px -20px 20px -20px;
        }

        #header button {
            background-color: var(--color-error);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 5px; /* Ajuste m√≥vil */
        }
        
        #header button:hover {
            background-color: #CD5C5C; 
        }

        /* --- Estilos de Pesta√±as (Tabs) --- */
        .tab {
            overflow: hidden;
            border-bottom: 1px solid var(--color-border);
            background-color: var(--color-bg);
            display: flex;
            flex-wrap: wrap;
        }

        .tab button {
            background-color: inherit;
            flex-grow: 1; /* Para que ocupen espacio en m√≥vil */
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
            font-size: 16px;
            color: var(--color-text);
            min-width: 0;
            white-space: nowrap;
        }
        
        @media (max-width: 600px) {
            .tab button {
                font-size: 14px;
                padding: 10px 10px;
            }
        }

        .tab button:hover {
            background-color: var(--color-primary);
        }

        .tab button.active {
            background-color: var(--color-accent);
            color: white;
        }

        .tabcontent {
            padding: 20px 0;
            border-top: none;
            display: none;
        }

        /* --- Estilos de Formulario Din√°mico --- */
        .form-section {
            border: 1px solid var(--color-border);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            background-color: #F8F8FF; /* Ghost White */
        }

        .form-field {
            margin-bottom: 15px;
        }

        .form-field label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-field input[type="text"],
        .form-field input[type="email"],
        .form-field input[type="number"],
        .form-field input[type="date"],
        .form-field textarea,
        .form-field select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--color-border);
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 16px;
        }

        .form-field textarea {
            resize: vertical;
        }

        /* --- Estilos de Tabla (Historial) --- */
        #work-orders-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        #work-orders-table th, #work-orders-table td {
            border: 1px solid var(--color-border);
            padding: 12px;
            text-align: left;
        }

        #work-orders-table th {
            background-color: var(--color-secondary);
            color: white;
            font-weight: bold;
        }

        #work-orders-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        #work-orders-table button {
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            transition: opacity 0.3s;
        }
        
        /* Responsive para Tabla */
        .history-wrapper {
            overflow-x: auto;
        }
        
        @media (max-width: 600px) {
            #work-orders-table {
                font-size: 14px;
            }
        }

        /* --- Estilos de PDF (Contenido) --- */
        .pdf-content {
            font-family: Arial, sans-serif;
            padding: 20px;
            box-sizing: border-box;
            background-color: white;
            width: 100%;
        }

        /* Estilos de tabla PDF */
        .pdf-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }

        .pdf-field {
            font-size: 14px;
            padding: 5px;
            border-bottom: 1px dotted #ccc;
        }

        .pdf-field strong {
            display: block;
            color: #000;
        }

        .pdf-full-row {
            grid-column: 1 / -1;
        }
        
        .pdf-signature-area {
            margin-top: 50px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
        }

        .pdf-signature {
            border-top: 1px solid #333;
            text-align: center;
            padding-top: 5px;
            font-size: 12px;
        }
        
        .hidden {
            display: none !important;
        }

        /* --- Estilos del Editor de Administrador --- */
        #form-structure-editor h4 {
            color: var(--color-text);
            border-bottom: 1px dotted var(--color-border);
            padding-bottom: 5px;
        }
        .field-editor-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #fff;
        }
        .field-editor-item input, .field-editor-item select {
            flex-grow: 1;
            padding: 6px;
            border: 1px solid var(--color-border);
            border-radius: 4px;
        }
    </style>
</head>
<body>

    <div id="app" class="hidden">
        <div class="container">
            <div id="header">
                <span id="welcome-message" style="flex-grow: 1;"></span>
                <div style="display: flex; align-items: center; flex-wrap: wrap;">
                    <span id="role-display" style="margin-right: 15px; font-weight: bold; padding: 5px 10px; background-color: var(--color-accent); border-radius: 5px; margin-top: 5px;"></span>
                    <button id="logout-button">Cerrar Sesi√≥n</button>
                </div>
            </div>

            <div class="tab">
                <button class="tablinks" onclick="window.openTab(event, 'new-order')" id="defaultOpen">‚ûï Nueva Orden de Trabajo</button>
                <button class="tablinks" onclick="window.openTab(event, 'history')">üìú Historial de √ìrdenes</button>
                <button class="tablinks hidden" id="admin-tab" onclick="window.openTab(event, 'admin-tools')">üõ†Ô∏è Herramientas de Admin</button>
            </div>

            <!-- Contenido de Pesta√±as -->

            <div id="new-order" class="tabcontent">
                <h2>Generar Nueva Orden de Trabajo</h2>
                <form id="work-order-form">
                    <p id="ot-counter-display" style="font-size: 1.2em; font-weight: bold; color: var(--color-button);"></p>
                    <div id="dynamic-form-container">
                        <!-- El formulario din√°mico se renderizar√° aqu√≠ -->
                    </div>
                    
                    <button type="submit" style="background-color: var(--color-success); color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin-top: 20px;">
                        Generar y Guardar Orden de Trabajo
                    </button>
                </form>
            </div>

            <div id="history" class="tabcontent">
                <h2>Historial de √ìrdenes de Trabajo</h2>
                <div style="margin-bottom: 15px;">
                    <input type="text" id="search-input" placeholder="Buscar por T√≠tulo o Nro. OT" style="padding: 8px; width: calc(100% - 100px); max-width: 300px; border: 1px solid var(--color-border); border-radius: 5px;">
                    <button onclick="window.filterWorkOrders()" style="background-color: var(--color-button); color: white; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer;">Buscar</button>
                </div>
                <div class="history-wrapper">
                    <table id="work-orders-table">
                        <thead>
                            <tr>
                                <th>Nro. OT</th>
                                <th>T√≠tulo</th>
                                <th>Fecha de Creaci√≥n</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="work-orders-tbody">
                            <!-- Las √≥rdenes se cargar√°n aqu√≠ -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="admin-tools" class="tabcontent hidden">
                <h2>Herramientas de Administraci√≥n</h2>
                <p>‚ö†Ô∏è **Advertencia:** Modificar estos ajustes afecta la estructura de todas las nuevas √ìrdenes de Trabajo.</p>
                <div id="form-editor">
                    <!-- El editor de formulario se renderizar√° aqu√≠ -->
                </div>
                <button onclick="window.resetOtCounter()" style="background-color: var(--color-error); color: white; padding: 10px; border: none; border-radius: 5px; cursor: pointer; margin-top: 20px;">
                    Reiniciar Contador de OT
                </button>
            </div>
            
            <!-- Contenido oculto para generar el PDF (Requerido por html2pdf) -->
            <div id="pdf-content-container" class="hidden">
                <!-- El HTML para el PDF se generar√° aqu√≠ antes de la descarga -->
            </div>

        </div>
    </div>
    
    <!-- Formulario de Login -->
    <div id="login-container">
        <form id="login-form">
            <h2>Inicio de Sesi√≥n</h2>
            <p id="login-error" style="color: var(--color-error);"></p>
            <input type="email" id="login-email" placeholder="Correo Electr√≥nico" required>
            <input type="password" id="login-password" placeholder="Contrase√±a" required>
            <button type="submit">Iniciar Sesi√≥n</button>
        </form>
    </div>

    <script>
        // Todas las funciones y variables est√°n ahora declaradas y expuestas
        // dentro del script type="module" para evitar errores de ReferenceError.
        // Solo incluimos llamadas a las funciones expuestas a window aqu√≠.
    </script>

</body>
</html>
