<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de √ìrdenes de Trabajo | Gesti√≥n de Estados</title>
    <!-- Librer√≠a para generar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
    
    <!-- LIBRER√çAS DE FIREBASE (Versi√≥n de Compatibilidad) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <!-- Se requiere una versi√≥n 9.6.0 para usar FieldValue.increment en compat-mode -->
    <script src="https://www.gstatic.com/firebasejs/9.9.0/firebase-firestore-compat.js"></script> 
    
    <style>
        /* Paleta de colores Pastel Azul/Gris */
        :root {
            --color-bg: #F0F8FF;      /* Azul muy claro (Alice Blue) */
            --color-primary: #ADD8E6;  /* Azul claro (Light Blue) */
            --color-secondary: #B0C4DE; /* Azul gris√°ceo (Light Steel Blue) */
            --color-accent: #87CEFA;   /* Azul cielo claro (Light Sky Blue) */
            --color-text: #36454F;     /* Gris carb√≥n (Charcoal) */
            --color-white: #ffffff;
            --color-error: #FF6961;    /* Rojo pastel para errores */
            --color-success: #77DD77;  /* Verde pastel para √©xito */
            --color-warning: #FFD700;  /* Amarillo/Oro para advertencias */
            --color-status-progress: #87CEFA;
            --color-status-completed: #77DD77;
            --color-status-cancelled: #FF6961;
        }

        /* Estilos Generales (Dise√±o Pastel) */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text);
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1300px;
            margin: 0 auto;
            background-color: var(--color-white);
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }

        h2, h3, h4 {
            color: var(--color-text);
            border-bottom: 2px solid var(--color-primary);
            padding-bottom: 5px;
            margin-top: 25px;
        }

        input[type="text"], input[type="password"], input[type="number"], input[type="date"], input[type="email"], select, textarea {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            display: inline-block;
            border: 1px solid var(--color-secondary);
            border-radius: 6px;
            box-sizing: border-box;
            background-color: var(--color-white);
        }

        input:disabled { background-color: #f0f0f0; border: 1px dashed var(--color-secondary); }
        input:invalid:not(:placeholder-shown), select:invalid:not(:placeholder-shown), textarea:invalid:not(:placeholder-shown) { border: 2px solid var(--color-error); }
        .form-section { border: 1px solid var(--color-secondary); border-radius: 8px; padding: 20px; margin-bottom: 25px; background-color: #f7fbff; }
        .calculation-group { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; border: 1px solid var(--color-secondary); border-radius: 6px; padding: 15px; margin-top: 15px; background-color: #e0f7fa; }
        .calculation-total-section { display: flex; align-items: center; width: 100%; margin-top: 10px; }
        .calculation-total-section label { font-weight: bold; flex-basis: auto; margin-right: 15px; white-space: nowrap; }
        .total-display { background-color: var(--color-white); font-weight: bold; text-align: right; border: 1px dashed var(--color-accent); padding: 10px; border-radius: 6px; flex-grow: 1; }
        .calculation-input { flex-basis: calc(45% - 20px); } 
        .calculation-group .formula-symbol { font-size: 1.5em; font-weight: bold; margin-left: 5px; margin-right: 5px; }

        button {
            background-color: var(--color-accent);
            color: var(--color-text);
            padding: 10px 20px;
            margin: 8px 5px 8px 0;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
            white-space: nowrap; /* Evita que los botones del tab se rompan */
        }
        button:hover { background-color: var(--color-primary); }
        .conditional-check { background-color: var(--color-secondary); color: var(--color-white); font-weight: bold; padding: 15px; margin-bottom: 10px; display: block; text-align: left; }
        .conditional-check.active { background-color: var(--color-success); }


        /* Layout de Pesta√±as */
        .tab { overflow-x: auto; white-space: nowrap; border-bottom: 1px solid var(--color-secondary); margin-bottom: 20px; padding-bottom: 5px;}
        .tablinks { background-color: var(--color-bg); color: var(--color-text); display: inline-block; border: none; outline: none; cursor: pointer; padding: 14px 20px; transition: 0.3s; border-top-left-radius: 8px; border-top-right-radius: 8px; }
        .tablinks:hover { background-color: var(--color-primary); }
        .tablinks.active { background-color: var(--color-primary); border-bottom: 3px solid var(--color-accent); margin-bottom: -1px; }
        .tabcontent { display: none; padding: 30px 0; }
        .field-editor-item { border: 1px dashed var(--color-secondary); border-radius: 6px; padding: 15px; margin-bottom: 10px; background-color: var(--color-white); }
        .required-fixed-field { padding: 10px; background-color: var(--color-secondary); color: var(--color-white); border-radius: 4px; margin-bottom: 10px; }
        
        /* Estilos para la tabla */
        #orders-table, .status-table { width: 100%; border-collapse: collapse; }
        #orders-table th, #orders-table td, .status-table th, .status-table td { border: 1px solid var(--color-secondary); padding: 12px; text-align: left; }
        #orders-table th, .status-table th { background-color: var(--color-primary); color: var(--color-text); }
        #orders-table tr:nth-child(even), .status-table tr:nth-child(even) { background-color: var(--color-bg); }
        #orders-table tr:hover, .status-table tr:hover { background-color: var(--color-accent); color: var(--color-white); }

        /* Etiqueta de Estado */
        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 50px;
            font-weight: bold;
            color: var(--color-white);
            font-size: 0.85em;
        }
        .status-EnProgreso { background-color: var(--color-status-progress); }
        .status-Finalizada { background-color: var(--color-status-completed); }
        .status-Cancelada { background-color: var(--color-status-cancelled); }

        /* Login View */
        #login-view { width: 350px; padding: 40px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: var(--color-white); border-radius: 10px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); text-align: center; }
        #login-error { color: var(--color-error); font-weight: bold; }
        
        /* Estilos para Modales (Ventanas Flotantes NO transparentes) */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7); /* Oscurece el fondo */
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: var(--color-white);
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        .modal-content h3 {
            border-bottom: 2px solid var(--color-accent);
        }

        /* Estilos espec√≠ficos para el PDF de constancia */
        .pdf-signatures {
            margin-top: 60px;
            padding-top: 30px;
            border-top: 1px dashed #B0C4DE;
            display: flex;
            justify-content: space-between;
            width: 100%;
            font-size: 1.1em;
            font-weight: bold;
        }
        .pdf-signatures span {
            display: inline-block;
            width: 45%;
        }
        .pdf-signatures hr {
            border: none;
            border-top: 1px solid #36454F;
            margin: 5px 0 0 0;
        }
        .pdf-header-secondary {
            position: fixed;
            top: 10px;
            right: 20px;
            font-size: 14px;
            color: #555;
            font-weight: bold;
            z-index: 1000;
        }

    </style>
</head>
<body>

    <!-- MODAL DE INFORMACI√ìN DETALLADA (Finalizaci√≥n/Cancelaci√≥n) -->
    <div id="status-modal-overlay" class="modal-overlay" onclick="closeStatusModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 id="modal-title">Informaci√≥n Detallada</h3>
            <p id="modal-order-info"></p>
            
            <label for="detail-info">Informaci√≥n Detallada:</label>
            <textarea id="detail-info" rows="6" required placeholder="Escriba aqu√≠ los detalles de la finalizaci√≥n o cancelaci√≥n."></textarea>
            
            <div style="text-align: right; margin-top: 20px;">
                <button onclick="closeStatusModal()" style="background-color: var(--color-secondary);">Retroceder</button>
                <button id="modal-action-button" onclick="executeStatusAction()" style="background-color: var(--color-success);">Aceptar</button>
            </div>
        </div>
    </div>
    
    <!-- MODAL DE MENSAJE PERSONALIZADO (Reemplaza a alert/confirm) -->
    <div id="message-modal-overlay" class="modal-overlay" onclick="closeMessageModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 id="message-modal-title">Mensaje del Sistema</h3>
            <p id="message-modal-text"></p>
            <div style="text-align: right; margin-top: 20px;">
                <button id="message-modal-confirm" onclick="closeMessageModal(true)" style="background-color: var(--color-success); display: none;">Aceptar</button>
                <button id="message-modal-cancel" onclick="closeMessageModal(false)" style="background-color: var(--color-error); display: none;">Cancelar</button>
                <button id="message-modal-ok" onclick="closeMessageModal(true)" style="background-color: var(--color-accent);">De Acuerdo</button>
            </div>
        </div>
    </div>
    
    <div id="login-view">
        <h2>üîí Iniciar Sesi√≥n</h2>
        <input type="email" id="email" placeholder="Correo Electr√≥nico" required><br>
        <input type="password" id="password" placeholder="Contrase√±a" required><br>
        <button onclick="login()">Acceder</button>
        <p id="login-error"></p>
    </div>

    <div id="main-app" class="container" style="display: none;">
        
        <!-- Pesta√±as de Navegaci√≥n -->
        <div class="tab">
            <!-- Pesta√±as de Creaci√≥n y Visualizaci√≥n -->
            <button class="tablinks" id="new-order-tab-button" onclick="openTab(event, 'new-order')">üìã Nueva OT</button>
            <button class="tablinks" onclick="openTab(event, 'view-orders')">üìÇ √ìrdenes Creadas</button>
            
            <!-- Pesta√±as de Flujo de Estados (Comunes) -->
            <button class="tablinks" onclick="openTab(event, 'finalize-orders')">‚úÖ Finalizaci√≥n de √ìrdenes</button>
            <button class="tablinks" onclick="openTab(event, 'finished-orders')">üü¢ √ìrdenes Finalizadas</button>
            <button class="tablinks" onclick="openTab(event, 'cancel-orders')">‚ùå Cancelaci√≥n de √ìrdenes</button>
            <button class="tablinks" onclick="openTab(event, 'cancelled-orders')">üî¥ √ìrdenes Canceladas</button>

            <!-- Pesta√±as de Administraci√≥n (Solo Admin) -->
            <button class="tablinks" id="admin-status-tab-button" onclick="openTab(event, 'admin-status-change')" style="display: none;">üîÑ Cambio de Estado (Admin)</button>
            <button class="tablinks" id="edit-tab-button" onclick="openTab(event, 'edit-form')" style="display: none;">‚öôÔ∏è Edici√≥n de Formulario</button>
            
            <button onclick="logout()" style="float: right;">üö™ Cerrar Sesi√≥n</button>
        </div>

        <!-- Contenido de las Pesta√±as -->

        <!-- Pesta√±a 1: Creaci√≥n de Orden de Trabajo -->
        <div id="new-order" class="tabcontent">
            <h3>Nueva Orden de Trabajo</h3>
            <form id="work-order-form"></form>
            <button onclick="generateWorkOrder()">‚úÖ Crear Orden y Generar PDF</button>
        </div>

        <!-- Pesta√±a 2: Visualizaci√≥n de √ìrdenes de Trabajo (Todas las OT) -->
        <div id="view-orders" class="tabcontent">
            <h3>Registro Hist√≥rico de √ìrdenes (Todas)</h3>
            <table id="orders-table">
                <thead>
                    <tr><th>Nro. OT</th><th>T√≠tulo</th><th>Estado</th><th>Fecha Creaci√≥n</th><th>Acciones</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        
        <!-- Pesta√±a 3: Finalizaci√≥n de √ìrdenes (Solo En Progreso) -->
        <div id="finalize-orders" class="tabcontent">
            <h3>Finalizaci√≥n de √ìrdenes: <span class="status-badge status-EnProgreso">En Progreso</span></h3>
            <table class="status-table" id="finalize-table">
                <thead>
                    <tr><th>Nro. OT</th><th>T√≠tulo</th><th>Fecha Creaci√≥n</th><th>Acci√≥n</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        
        <!-- Pesta√±a 4: √ìrdenes Finalizadas -->
        <div id="finished-orders" class="tabcontent">
            <h3>Registro de √ìrdenes <span class="status-badge status-Finalizada">Finalizadas</span></h3>
            <table class="status-table" id="finished-table">
                <thead>
                    <tr><th>Nro. OT</th><th>T√≠tulo</th><th>Fecha Finalizaci√≥n</th><th>Usuario</th><th>Acciones</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        
        <!-- Pesta√±a 5: Cancelaci√≥n de √ìrdenes (Solo En Progreso) -->
        <div id="cancel-orders" class="tabcontent">
            <h3>Cancelaci√≥n de √ìrdenes: <span class="status-badge status-EnProgreso">En Progreso</span></h3>
            <table class="status-table" id="cancel-table">
                <thead>
                    <tr><th>Nro. OT</th><th>T√≠tulo</th><th>Fecha Creaci√≥n</th><th>Acci√≥n</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Pesta√±a 6: √ìrdenes Canceladas -->
        <div id="cancelled-orders" class="tabcontent">
            <h3>Registro de √ìrdenes <span class="status-badge status-Cancelada">Canceladas</span></h3>
            <table class="status-table" id="cancelled-table">
                <thead>
                    <tr><th>Nro. OT</th><th>T√≠tulo</th><th>Fecha Cancelaci√≥n</th><th>Usuario</th><th>Acciones</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        
        <!-- Pesta√±a 7: Cambio de Estado (Solo Admin) -->
        <div id="admin-status-change" class="tabcontent">
            <h3>Cambio de Estado <span class="status-badge status-Finalizada">Finalizada</span> / <span class="status-badge status-Cancelada">Cancelada</span> (Administrador)</h3>
            <p>Seleccione una orden para revertir su estado a <span class="status-badge status-EnProgreso">En Progreso</span>.</p>
            <table class="status-table" id="admin-status-table">
                <thead>
                    <tr><th>Nro. OT</th><th>T√≠tulo</th><th>Estado Actual</th><th>Acci√≥n</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        
        <!-- Pesta√±a 8: Edici√≥n de Formulario (Solo Administrador) -->
        <div id="edit-form" class="tabcontent">
            <h3>Edici√≥n de Formulario</h3>
            <div id="form-editor"></div>
            <button onclick="saveFormStructure(false)">üíæ Guardar Estructura del Formulario</button>
        </div>
    </div>
    
    <script>
        // *** 1. CONFIGURACI√ìN FIREBASE Y VARIABLES GLOBALES ***
        
        // Uso de variables globales proporcionadas por el entorno de Canvas (aunque el user peg√≥ la config directa)
        // Mantenemos la estructura de inicializaci√≥n usando compat-mode de Firebase v9.
        const providedAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const providedFirebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { /* Fallback config */ };

        // El usuario ha pegado una configuraci√≥n espec√≠fica; la usaremos directamente por si no est√° en el entorno.
        const firebaseConfig = {
             apiKey: "AIzaSyBHgF18eLwdZbl1g4OkDu-_NWkBnfLh3EA", 
             authDomain: "ordenestrabajo-39eab.firebaseapp.com",
             projectId: "ordenestrabajo-39eab",
             storageBucket: "ordenestrabajo-39eab.firebasestorage.app",
             messagingSenderId: "561184772303",
             appId: "1:561184772303:web:765f5859b4b3a332e827ba"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        const ORDERS_COLLECTION = db.collection("workOrders");
        const CONFIG_COLLECTION = db.collection("config"); 
        
        let formStructure = null; 
        let workOrders = []; 
        let otCounter = 1; // El valor actual para la siguiente OT
        let currentRole = null; 
        let currentOrderToModify = null; // Para guardar la OT seleccionada en el modal
        let currentResolve = null; // Para manejar la promesa del modal de mensaje

        // Roles
        const ADMIN_EMAILS = ['labortradingsg@gmail.com', 'admin.secundario@tudominio.com']; 
        const VIEWER_EMAILS = ['visualizador1@empresa.com', 'visualizador2@empresa.com', 'solo.ver@tudominio.com']; 
        
        // Datos Fijos
        const CONTRATISTAS_DATA = {
            "Seleccione una Empresa": { "Apellido y Nombre del Responsable": "", "Rif": "" },
            "Contratista A C.A.": { "Apellido y Nombre del Responsable": "P√©rez Juan", "Rif": "J-12345678-0" },
            "Servicios B, S.A.": { "Apellido y Nombre del Responsable": "G√≥mez Mar√≠a", "Rif": "G-98765432-1" },
            "Construcciones Zulia C.L.": { "Apellido y Nombre del Responsable": "L√≥pez Carlos", "Rif": "C-11223344-5" }
        };

        const DEFAULT_FORM_STRUCTURE = [
            { title: "I. Informaci√≥n General", fields: [
                { id: "form_title", label: "T√≠tulo del Formulario", type: "static", value: "Orden de Trabajo", required: true },
                { id: "ot_number", label: "Orden de Trabajo Nro.", type: "ot_counter", required: true },
                { id: "user_auto_fill", label: "Usuario que Crea la Orden", type: "user-auto-fill", required: true },
                { id: "current_date", label: "Fecha Actual", type: "date-auto", required: true }
            ]},
            { title: "II. Informaci√≥n de la Contratista", fields: []},
            { title: "III. Informaci√≥n del Trabajo/Obra", fields: []}
        ];
        
        function getDataLabel(data, newLabel, oldLabel) {
            return data[newLabel] !== undefined ? data[newLabel] : (data[oldLabel] !== undefined ? data[oldLabel] : 'N/A (Etiqueta Antigua)');
        }

        // *** 2. L√ìGICA DE FIREBASE: CARGA Y GUARDADO ***

        async function loadInitialData() {
            try {
                const configDoc = await CONFIG_COLLECTION.doc("systemConfig").get();
                if (configDoc.exists) {
                    const data = configDoc.data();
                    formStructure = data.formStructure || DEFAULT_FORM_STRUCTURE;
                    
                    // FIX PRINCIPAL: Cargar el contador del DB, este es la √öNICA fuente de verdad
                    otCounter = data.otCounter || 1; 
                    
                    // L√≥gica de Migraci√≥n (Asegurar campos fijos nuevos)
                    const infoGeneralFields = formStructure[0].fields;
                    const hasUserField = infoGeneralFields.some(f => f.id === 'user_auto_fill');
                    if (!hasUserField) {
                         const dateIndex = infoGeneralFields.findIndex(f => f.id === 'current_date');
                         if (dateIndex !== -1) {
                             infoGeneralFields.splice(dateIndex, 0, DEFAULT_FORM_STRUCTURE[0].fields[2]);
                         } else {
                             infoGeneralFields.push(DEFAULT_FORM_STRUCTURE[0].fields[2]);
                         }
                    }

                    if (formStructure.length >= 3) {
                         if (!formStructure[0].title.startsWith("I.")) formStructure[0].title = "I. Informaci√≥n General";
                         if (!formStructure[1].title.startsWith("II.")) formStructure[1].title = "II. Informaci√≥n de la Contratista";
                         if (!formStructure[2].title.startsWith("III.")) formStructure[2].title = "III. Informaci√≥n del Trabajo/Obra";
                    }

                } else {
                    formStructure = DEFAULT_FORM_STRUCTURE;
                    await saveFormStructure(true); 
                }
                
                // Cargar √ìrdenes de Trabajo y escuchar cambios en tiempo real
                ORDERS_COLLECTION.onSnapshot(snapshot => {
                    workOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    // REMOVIDO: recalculateOtCounter(); <-- ELIMINADO para evitar conflictos
                    renderAllTables();
                    renderWorkOrderForm(); // Re-renderizar el formulario para asegurar que el otCounter se muestre correctamente.
                }, error => {
                    console.error("Error al escuchar √≥rdenes:", error);
                    showErrorMessage("Error en la conexi√≥n a la base de datos en tiempo real.", error.message);
                });


            } catch (e) {
                console.error("Error cargando datos iniciales: ", e);
                showErrorMessage("Error al conectar con la base de datos.", "Verifique su conexi√≥n y las reglas de seguridad de Firestore. Detalles: " + e.message);
            }
        }
        
        async function saveFormStructure(initial = false) {
            try {
                // Solo guardar la estructura del formulario, el contador se maneja AT√ìMICAMENTE
                await CONFIG_COLLECTION.doc("systemConfig").set({
                    formStructure: formStructure,
                    otCounter: otCounter // Guardamos el valor actual, si es la inicializaci√≥n ser√° 1.
                }, { merge: true });

                if (!initial) {
                    showSuccessMessage('üéâ Estructura del formulario y contador guardados exitosamente en la nube.');
                    renderWorkOrderForm();
                }
            } catch (e) {
                console.error("Error al guardar la estructura:", e);
                showErrorMessage("Error al guardar la estructura en Firebase.", e.message);
            }
        }
        
        // L√≥gica de Roles
        function getRoleFromEmail(email) {
            if (ADMIN_EMAILS.includes(email)) return 'admin';
            if (VIEWER_EMAILS.includes(email)) return 'viewer'; 
            return 'normal'; 
        }

        // L√≥gica de Autenticaci√≥n
        async function login() {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            const errorElement = document.getElementById('login-error');
            errorElement.textContent = '';
            
            try {
                const userCredential = await firebase.auth().signInWithEmailAndPassword(email, pass);
                const user = userCredential.user;
                
                let role = getRoleFromEmail(user.email); 
                currentRole = role;
                
                document.getElementById('login-view').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                await initializeApp(role);
                
            } catch (error) {
                console.error("Error de autenticaci√≥n:", error.code, error.message);
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    errorElement.textContent = 'Credenciales incorrectas o usuario no encontrado.';
                } else if (error.code === 'auth/invalid-email') {
                    errorElement.textContent = 'El formato del correo es inv√°lido.';
                } else if (error.code === 'auth/api-key-not-valid') {
                    errorElement.textContent = 'ERROR DE CONFIGURACI√ìN: La Clave API de Firebase no es v√°lida.';
                } else {
                    errorElement.textContent = 'Error de conexi√≥n. Intente de nuevo.';
                }
            }
        }

        function logout() {
            firebase.auth().signOut().then(() => {
                document.getElementById('email').value = '';
                document.getElementById('password').value = '';
                showSuccessMessage('Sesi√≥n cerrada correctamente.');
            }).catch((error) => {
                console.error("Error al cerrar sesi√≥n:", error);
                showErrorMessage('Error al cerrar sesi√≥n.', error.message);
            });
        }

        async function initializeApp(role) {
            const isCreator = (role === 'admin' || role === 'normal');

            document.getElementById('edit-tab-button').style.display = (role === 'admin') ? 'inline-block' : 'none';
            document.getElementById('admin-status-tab-button').style.display = (role === 'admin') ? 'inline-block' : 'none';
            document.getElementById('new-order-tab-button').style.display = isCreator ? 'inline-block' : 'none';
            
            await loadInitialData(); 
            
            if (role === 'admin') {
                renderFormEditor();
                openTab(null, 'edit-form');
            } else if (role === 'normal') {
                openTab(null, 'new-order');
            } else if (role === 'viewer') {
                openTab(null, 'view-orders'); 
            }
            
            renderWorkOrderForm();
            renderAllTables();
        }

        window.onload = function() {
            firebase.auth().onAuthStateChanged(user => {
                if (user) {
                    let role = getRoleFromEmail(user.email); 
                    currentRole = role;
                    
                    document.getElementById('login-view').style.display = 'none';
                    document.getElementById('main-app').style.display = 'block';
                    initializeApp(role);
                } else {
                    currentRole = null;
                    document.getElementById('main-app').style.display = 'none';
                    document.getElementById('login-view').style.display = 'block';
                }
            });
        }
        
        function openTab(evt, tabName) {
            let i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            if (evt) evt.currentTarget.className += " active";

            if (tabName === 'new-order' && formStructure) renderWorkOrderForm();
            else if (tabName === 'view-orders') renderOrdersTable('view-orders');
            else if (tabName === 'finalize-orders') renderOrdersTable('finalize-orders');
            else if (tabName === 'finished-orders') renderOrdersTable('finished-orders');
            else if (tabName === 'cancel-orders') renderOrdersTable('cancel-orders');
            else if (tabName === 'cancelled-orders') renderOrdersTable('cancelled-orders');
            else if (tabName === 'admin-status-change') renderOrdersTable('admin-status-change');
            else if (tabName === 'edit-form' && currentRole === 'admin' && formStructure) renderFormEditor();
        }
        
        // *** 3. L√ìGICA DEL EDITOR DE FORMULARIO ***
        
        function renderFormEditor() {
            const editorDiv = document.getElementById('form-editor');
            editorDiv.innerHTML = '';

            formStructure.forEach((section, secIndex) => {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'form-section';
                sectionDiv.innerHTML = `
                    <h4>Secci√≥n ${secIndex + 1}: <input type="text" value="${section.title}" oninput="updateSectionTitle(${secIndex}, this.value)" style="width: 70%; display: inline;"></h4>
                    <button onclick="addField(${secIndex}, 'text')">‚ûï Agregar Campo de Texto</button>
                    <button onclick="addField(${secIndex}, 'select')">‚ûï Agregar Lista (Select)</button>
                    <button onclick="addField(${secIndex}, 'date-input')">üìÖ Agregar Campo de Fecha</button>
                    <hr>
                    <div id="fields-container-${secIndex}"></div>
                `;
                editorDiv.appendChild(sectionDiv);

                const fieldsContainer = document.getElementById(`fields-container-${secIndex}`);
                section.fields.forEach((field, fieldIndex) => {
                    if (field.type === 'static' || field.type === 'ot_counter' || field.type === 'date-auto' || field.type === 'user-auto-fill') {
                        fieldsContainer.innerHTML += `<p class="required-fixed-field"><strong>${field.label}</strong> (Campo fijo obligatorio)</p>`;
                        return;
                    }

                    const fieldDiv = document.createElement('div');
                    fieldDiv.className = 'field-editor-item';
                    fieldDiv.innerHTML = `
                        <label>Etiqueta:</label>
                        <input type="text" value="${field.label}" oninput="updateFieldProperty(${secIndex}, ${fieldIndex}, 'label', this.value)">
                        <label>Tipo:</label>
                        <select onchange="updateFieldProperty(${secIndex}, ${fieldIndex}, 'type', this.value)">
                            <option value="text" ${field.type === 'text' ? 'selected' : ''}>Texto (Corto)</option>
                            <option value="number" ${field.type === 'number' ? 'selected' : ''}>N√∫mero</option>
                            <option value="textarea" ${field.type === 'textarea' ? 'selected' : ''}>√Årea de Texto (Largo)</option>
                            <option value="select" ${field.type === 'select' ? 'selected' : ''}>Lista Desplegable (Simple)</option>
                            <option value="autofill-select" ${field.type === 'autofill-select' ? 'selected' : ''}>Lista (Autollenado Contratista) üìù</option>
                            <option value="date-input" ${field.type === 'date-input' ? 'selected' : ''}>Fecha (Calendario) üìÖ</option>
                        </select>
                        <label>Clasificaci√≥n:</label>
                        <input type="checkbox" id="req-${secIndex}-${fieldIndex}" ${field.required ? 'checked' : ''} onchange="updateFieldProperty(${secIndex}, ${fieldIndex}, 'required', this.checked)"> 
                        <label for="req-${secIndex}-${fieldIndex}" style="display: inline-block; font-weight: normal;">Obligatorio</label>
                        
                        <div id="select-options-${secIndex}-${fieldIndex}" style="margin-top: 10px; ${field.type !== 'select' && field.type !== 'autofill-select' ? 'display: none;' : ''}">
                            <strong>Opciones de Lista (solo visible si es 'Select' o 'Autofill-Select'). </strong>
                            ${field.type === 'autofill-select' ? 
                                '<p style="color: var(--color-error);">‚ö†Ô∏è **Autollenado:** Las opciones se toman de `CONTRATISTAS_DATA` y anulan esta lista.</p>' : ''
                            }
                            <input type="text" value="${(field.options || []).join(', ')}" oninput="updateSelectOptions(${secIndex}, ${fieldIndex}, this.value)">
                        </div>
                        <button onclick="removeField(${secIndex}, ${fieldIndex})" style="background-color: var(--color-error); color: var(--color-white);">üóëÔ∏è Eliminar Campo</button>
                    `;
                    fieldsContainer.appendChild(fieldDiv);
                });
            });
        }
        
        function updateSectionTitle(secIndex, newTitle) { formStructure[secIndex].title = newTitle; }

        function updateFieldProperty(secIndex, fieldIndex, prop, value) {
            formStructure[secIndex].fields[fieldIndex][prop] = value;
            if (prop === 'type') {
                const selectDiv = document.getElementById(`select-options-${secIndex}-${fieldIndex}`);
                if (value === 'select' || value === 'autofill-select') {
                    selectDiv.style.display = 'block';
                } else {
                    selectDiv.style.display = 'none';
                }
            }
        }

        function updateSelectOptions(secIndex, fieldIndex, value) {
            formStructure[secIndex].fields[fieldIndex].options = value.split(',').map(s => s.trim()).filter(s => s.length > 0);
        }

        function addField(secIndex, type) {
            const newField = { 
                id: `custom_field_${secIndex}_${Date.now()}`, 
                label: `Nuevo Campo ${formStructure[secIndex].fields.length + 1}`, 
                type: type, 
                required: false 
            };
            if (type === 'select') {
                newField.options = ["Opci√≥n 1", "Opci√≥n 2"];
            }
            formStructure[secIndex].fields.push(newField);
            renderFormEditor();
        }

        function removeField(secIndex, fieldIndex) {
            formStructure[secIndex].fields.splice(fieldIndex, 1);
            renderFormEditor();
        }

        // *** 4. RENDERIZADO DEL FORMULARIO DE ORDEN DE TRABAJO ***

        function renderWorkOrderForm() {
            if (!formStructure) return;

            const formDiv = document.getElementById('work-order-form');
            let html = '';
            const userEmail = firebase.auth().currentUser ? firebase.auth().currentUser.email : 'Usuario Desconocido';
            
            formStructure.forEach((section) => {
                html += `<div class="form-section"><h4>${section.title}</h4>`;
                
                section.fields.forEach(field => {
                    let inputHtml = '';
                    const isRequired = field.required ? 'required' : '';
                    const fieldId = field.id;
                    const fieldLabel = field.label;

                    switch (field.type) {
                        case 'static':
                        case 'ot_counter':
                            const otValue = field.type === 'ot_counter' ? otCounter : field.value;
                            inputHtml = `<input type="text" id="${fieldId}" value="${otValue}" disabled ${isRequired}>`;
                            break;
                        case 'date-auto':
                            inputHtml = `<input type="date" id="${fieldId}" value="${new Date().toISOString().slice(0, 10)}" disabled ${isRequired}>`;
                            break;
                        case 'user-auto-fill':
                            inputHtml = `<input type="email" id="${fieldId}" value="${userEmail}" disabled ${isRequired}>`;
                            break;
                        case 'text':
                            inputHtml = `<input type="text" id="${fieldId}" placeholder="${fieldLabel}" ${isRequired}>`;
                            break;
                        case 'number':
                            inputHtml = `<input type="number" id="${fieldId}" placeholder="${fieldLabel}" ${isRequired}>`;
                            break;
                        case 'textarea':
                            inputHtml = `<textarea id="${fieldId}" rows="4" placeholder="${fieldLabel}" ${isRequired}></textarea>`;
                            break;
                        case 'date-input':
                            inputHtml = `<input type="date" id="${fieldId}" ${isRequired}>`;
                            break;
                        case 'select':
                            inputHtml = `<select id="${fieldId}" ${isRequired}>`;
                            inputHtml += `<option value="">-- Seleccione ${fieldLabel} --</option>`;
                            (field.options || []).forEach(option => {
                                inputHtml += `<option value="${option}">${option}</option>`;
                            });
                            inputHtml += `</select>`;
                            break;
                        case 'autofill-select':
                            inputHtml = `<select id="${fieldId}" onchange="autofillContratista(this.value)" ${isRequired}>`;
                            Object.keys(CONTRATISTAS_DATA).forEach(empresa => {
                                inputHtml += `<option value="${empresa}">${empresa}</option>`;
                            });
                            inputHtml += `</select>`;
                            break;
                    }
                    
                    html += `<label for="${fieldId}">${fieldLabel}:</label>${inputHtml}`;
                });
                html += `</div>`; // Fin de form-section
            });

            formDiv.innerHTML = html;
        }

        function autofillContratista(empresa) {
            const data = CONTRATISTAS_DATA[empresa];
            if (!data) return;

            // Intenta encontrar los campos de Nombre y Rif por su etiqueta
            for (const key in data) {
                // Buscamos un campo en la estructura del formulario cuya etiqueta coincida con la key
                for (const section of formStructure) {
                    const field = section.fields.find(f => f.label === key);
                    if (field) {
                        const input = document.getElementById(field.id);
                        if (input) {
                            input.value = data[key];
                        }
                    }
                }
            }
        }
        
        // *** 5. CREACI√ìN DE ORDEN DE TRABAJO Y L√ìGICA DE CONTADOR (FIX) ***

        async function generateWorkOrder() {
            const form = document.getElementById('work-order-form');
            if (!form.checkValidity()) {
                form.reportValidity();
                showErrorMessage('Error de Formulario', 'Por favor, rellene todos los campos obligatorios.');
                return;
            }

            const otData = {};
            
            // 1. Recolectar datos del formulario
            formStructure.forEach(section => {
                section.fields.forEach(field => {
                    const input = document.getElementById(field.id);
                    if (input) {
                        otData[field.label] = input.value;
                    } else if (field.type === 'ot_counter') {
                        // Asegurar que el ot_counter usa el valor correcto (otCounter global)
                        otData[field.label] = otCounter; 
                    }
                });
            });

            otData.ot_number = otCounter; // Almacenamos el n√∫mero de OT por separado para facilitar la b√∫squeda
            otData.status = 'En Progreso';
            otData.createdAt = new Date().toISOString();
            otData.createdBy = firebase.auth().currentUser.email;

            try {
                // 2. Guardar la nueva Orden de Trabajo
                await ORDERS_COLLECTION.add(otData);

                // 3. FIX: Incrementar at√≥micamente el contador en la base de datos
                await CONFIG_COLLECTION.doc("systemConfig").update({
                    otCounter: firebase.firestore.FieldValue.increment(1)
                });
                
                // 4. Actualizar el contador local solo despu√©s del √©xito en DB
                otCounter++; 

                showSuccessMessage('¬°Orden de Trabajo Creada!', `La Orden de Trabajo Nro. ${otData.ot_number} ha sido guardada y est√° "En Progreso".`);
                
                // 5. Generar PDF (siempre despu√©s de guardar)
                generatePDF(otData);
                
                // 6. Limpiar formulario y renderizar para el siguiente n√∫mero
                form.reset();
                renderWorkOrderForm(); 

            } catch (e) {
                console.error("Error al crear la OT o incrementar contador:", e);
                showErrorMessage('Error al Guardar la OT', 'Ocurri√≥ un error al guardar la orden o al actualizar el contador en Firebase. ' + e.message);
            }
        }

        // *** 6. L√ìGICA DE VISUALIZACI√ìN Y CAMBIO DE ESTADO ***
        
        function renderAllTables() {
            renderOrdersTable('view-orders');
            renderOrdersTable('finalize-orders');
            renderOrdersTable('finished-orders');
            renderOrdersTable('cancel-orders');
            renderOrdersTable('cancelled-orders');
            renderOrdersTable('admin-status-change');
        }

        function renderOrdersTable(tabName) {
            let filteredOrders = [];
            let tableBody;

            switch(tabName) {
                case 'view-orders':
                    filteredOrders = workOrders;
                    tableBody = document.querySelector('#orders-table tbody');
                    break;
                case 'finalize-orders':
                    filteredOrders = workOrders.filter(ot => ot.status === 'En Progreso');
                    tableBody = document.querySelector('#finalize-table tbody');
                    break;
                case 'finished-orders':
                    filteredOrders = workOrders.filter(ot => ot.status === 'Finalizada');
                    tableBody = document.querySelector('#finished-table tbody');
                    break;
                case 'cancel-orders':
                    filteredOrders = workOrders.filter(ot => ot.status === 'En Progreso');
                    tableBody = document.querySelector('#cancel-table tbody');
                    break;
                case 'cancelled-orders':
                    filteredOrders = workOrders.filter(ot => ot.status === 'Cancelada');
                    tableBody = document.querySelector('#cancelled-table tbody');
                    break;
                case 'admin-status-change':
                    filteredOrders = workOrders.filter(ot => ot.status !== 'En Progreso');
                    tableBody = document.querySelector('#admin-status-table tbody');
                    break;
                default:
                    return;
            }

            if (!tableBody) return;
            tableBody.innerHTML = '';
            
            // Ordenar por n√∫mero de OT descendente
            filteredOrders.sort((a, b) => b.ot_number - a.ot_number);

            filteredOrders.forEach(ot => {
                const tr = document.createElement('tr');
                let actionsHtml = '';

                switch(tabName) {
                    case 'view-orders':
                        actionsHtml = `<button onclick="viewOrderDetails('${ot.id}')" style="background-color: var(--color-secondary);">Detalles</button>`;
                        if (currentRole === 'admin') {
                             actionsHtml += `<button onclick="confirmDeletion('${ot.id}', ${ot.ot_number})" style="background-color: var(--color-error); margin-left: 5px;">Eliminar</button>`;
                        }
                        tr.innerHTML = `
                            <td>${ot.ot_number}</td>
                            <td>${getDataLabel(ot, 'T√≠tulo del Formulario', 'T√≠tulo')}</td>
                            <td><span class="status-badge status-${ot.status.replace(/\s/g, '')}">${ot.status}</span></td>
                            <td>${new Date(ot.createdAt).toLocaleDateString()}</td>
                            <td>${actionsHtml}</td>
                        `;
                        break;

                    case 'finalize-orders':
                        tr.innerHTML = `
                            <td>${ot.ot_number}</td>
                            <td>${getDataLabel(ot, 'T√≠tulo del Formulario', 'T√≠tulo')}</td>
                            <td>${new Date(ot.createdAt).toLocaleDateString()}</td>
                            <td><button onclick="openStatusModal('${ot.id}', 'Finalizada')" style="background-color: var(--color-success);">Finalizar</button></td>
                        `;
                        break;
                    
                    case 'finished-orders':
                        tr.innerHTML = `
                            <td>${ot.ot_number}</td>
                            <td>${getDataLabel(ot, 'T√≠tulo del Formulario', 'T√≠tulo')}</td>
                            <td>${ot.statusChangeDate ? new Date(ot.statusChangeDate).toLocaleDateString() : 'N/A'}</td>
                            <td>${ot.statusChangeBy || 'N/A'}</td>
                            <td><button onclick="viewStatusDetails('${ot.id}', '${ot.status}')" style="background-color: var(--color-secondary);">Ver Detalle</button></td>
                        `;
                        break;

                    case 'cancel-orders':
                        tr.innerHTML = `
                            <td>${ot.ot_number}</td>
                            <td>${getDataLabel(ot, 'T√≠tulo del Formulario', 'T√≠tulo')}</td>
                            <td>${new Date(ot.createdAt).toLocaleDateString()}</td>
                            <td><button onclick="openStatusModal('${ot.id}', 'Cancelada')" style="background-color: var(--color-error);">Cancelar</button></td>
                        `;
                        break;

                    case 'cancelled-orders':
                        tr.innerHTML = `
                            <td>${ot.ot_number}</td>
                            <td>${getDataLabel(ot, 'T√≠tulo del Formulario', 'T√≠tulo')}</td>
                            <td>${ot.statusChangeDate ? new Date(ot.statusChangeDate).toLocaleDateString() : 'N/A'}</td>
                            <td>${ot.statusChangeBy || 'N/A'}</td>
                            <td><button onclick="viewStatusDetails('${ot.id}', '${ot.status}')" style="background-color: var(--color-secondary);">Ver Detalle</button></td>
                        `;
                        break;
                    
                    case 'admin-status-change':
                        tr.innerHTML = `
                            <td>${ot.ot_number}</td>
                            <td>${getDataLabel(ot, 'T√≠tulo del Formulario', 'T√≠tulo')}</td>
                            <td><span class="status-badge status-${ot.status.replace(/\s/g, '')}">${ot.status}</span></td>
                            <td><button onclick="confirmReversion('${ot.id}', ${ot.ot_number})" style="background-color: var(--color-warning);">Revertir a En Progreso</button></td>
                        `;
                        break;
                }
                tableBody.appendChild(tr);
            });
        }
        
        function viewOrderDetails(orderId) {
             const ot = workOrders.find(o => o.id === orderId);
             if (!ot) return;
             let details = `<h4>Detalles de la Orden #${ot.ot_number}</h4>`;
             details += `<strong>Estado:</strong> <span class="status-badge status-${ot.status.replace(/\s/g, '')}">${ot.status}</span><br><br>`;
             
             // Recorrer las propiedades de la OT para mostrarlas
             for (const key in ot) {
                 if (key !== 'id' && key !== 'status' && key !== 'createdAt' && key !== 'createdBy' && key !== 'ot_number') {
                     details += `<strong>${key}:</strong> ${ot[key]}<br>`;
                 }
             }
             
             details += `<br><strong>Creada por:</strong> ${ot.createdBy} el ${new Date(ot.createdAt).toLocaleDateString()}`;

             if (ot.statusDetail) {
                 details += `<br><br><strong>Detalle de Estado (${ot.status}):</strong> ${ot.statusDetail}`;
             }
             
             showMessageModal('Detalles de la Orden', details);
        }

        function viewStatusDetails(orderId, status) {
            const ot = workOrders.find(o => o.id === orderId);
            if (!ot || !ot.statusDetail) {
                showMessageModal('Detalle de Estado', `La Orden #${ot.ot_number} no tiene un detalle espec√≠fico de ${status}.`);
                return;
            }
            showMessageModal(`Detalle de ${status} - OT #${ot.ot_number}`, ot.statusDetail);
        }

        async function updateOrderStatus(orderId, newStatus, detail = null) {
            try {
                const user = firebase.auth().currentUser.email;
                const updateData = {
                    status: newStatus,
                    statusChangeDate: new Date().toISOString(),
                    statusChangeBy: user,
                    statusDetail: detail
                };

                await ORDERS_COLLECTION.doc(orderId).update(updateData);
                showSuccessMessage('Estado Actualizado', `La Orden #${workOrders.find(o => o.id === orderId).ot_number} ha sido marcada como **${newStatus}** por ${user}.`);
                closeStatusModal();

            } catch (e) {
                console.error("Error al actualizar el estado:", e);
                showErrorMessage('Error de Actualizaci√≥n', 'No se pudo actualizar el estado de la orden. ' + e.message);
            }
        }
        
        function openStatusModal(orderId, action) {
            const ot = workOrders.find(o => o.id === orderId);
            if (!ot) return;

            currentOrderToModify = { id: orderId, action: action, ot_number: ot.ot_number };
            const modalTitle = action === 'Finalizada' ? 'Finalizar Orden de Trabajo' : 'Cancelar Orden de Trabajo';
            const buttonColor = action === 'Finalizada' ? 'var(--color-success)' : 'var(--color-error)';
            const buttonText = action === 'Finalizada' ? 'Finalizar OT' : 'Cancelar OT';

            document.getElementById('modal-title').textContent = modalTitle;
            document.getElementById('modal-order-info').innerHTML = `Se cambiar√° el estado de la Orden de Trabajo **Nro. ${ot.ot_number}** a **${action}**.`;
            document.getElementById('modal-action-button').style.backgroundColor = buttonColor;
            document.getElementById('modal-action-button').textContent = buttonText;
            document.getElementById('detail-info').value = '';
            
            document.getElementById('status-modal-overlay').style.display = 'flex';
        }

        function closeStatusModal() {
            document.getElementById('status-modal-overlay').style.display = 'none';
            currentOrderToModify = null;
        }

        function executeStatusAction() {
            if (!currentOrderToModify) return;

            const detail = document.getElementById('detail-info').value.trim();
            const action = currentOrderToModify.action;
            const orderId = currentOrderToModify.id;
            
            if (detail.length < 10) {
                 showErrorMessage('Detalle Requerido', `Por favor, escriba al menos 10 caracteres de detalle para la ${action}.`);
                 return;
            }

            updateOrderStatus(orderId, action, detail);
        }

        async function confirmDeletion(orderId, otNumber) {
            const result = await showConfirmModal('Confirmar Eliminaci√≥n', `¬øEst√° seguro de que desea **ELIMINAR PERMANENTEMENTE** la Orden de Trabajo Nro. ${otNumber}? Esta acci√≥n es irreversible.`);
            
            if (result) {
                try {
                    await ORDERS_COLLECTION.doc(orderId).delete();
                    showSuccessMessage('Orden Eliminada', `La Orden #${otNumber} ha sido eliminada permanentemente.`);
                } catch (e) {
                    console.error("Error al eliminar la OT:", e);
                    showErrorMessage('Error de Eliminaci√≥n', 'No se pudo eliminar la orden de Firebase. ' + e.message);
                }
            }
        }

        async function confirmReversion(orderId, otNumber) {
             const result = await showConfirmModal('Confirmar Reversi√≥n de Estado', `¬øEst√° seguro de que desea **REVERTIR** la Orden de Trabajo Nro. ${otNumber} al estado **"En Progreso"**?`);

             if (result) {
                 await updateOrderStatus(orderId, 'En Progreso', `Revertido por Administrador ${firebase.auth().currentUser.email}`);
             }
        }

        // *** 7. L√ìGICA DE MODALES DE MENSAJES (Reemplazo de Alert/Confirm) ***

        // Muestra un modal de informaci√≥n simple
        function showMessageModal(title, text) {
            document.getElementById('message-modal-title').textContent = title;
            document.getElementById('message-modal-text').innerHTML = text;
            document.getElementById('message-modal-confirm').style.display = 'none';
            document.getElementById('message-modal-cancel').style.display = 'none';
            document.getElementById('message-modal-ok').style.display = 'inline-block';
            document.getElementById('message-modal-overlay').style.display = 'flex';
        }

        // Muestra un modal de confirmaci√≥n (devuelve una promesa)
        function showConfirmModal(title, text) {
             return new Promise(resolve => {
                currentResolve = resolve;
                document.getElementById('message-modal-title').textContent = title;
                document.getElementById('message-modal-text').innerHTML = text;
                document.getElementById('message-modal-confirm').style.display = 'inline-block';
                document.getElementById('message-modal-cancel').style.display = 'inline-block';
                document.getElementById('message-modal-ok').style.display = 'none';
                document.getElementById('message-modal-overlay').style.display = 'flex';
             });
        }
        
        function showSuccessMessage(title, text) {
             showMessageModal(title, `<span style="color: var(--color-success); font-weight: bold;">${text}</span>`);
        }
        
        function showErrorMessage(title, text) {
             showMessageModal(title, `<span style="color: var(--color-error); font-weight: bold;">${text}</span>`);
        }

        function closeMessageModal(result) {
             document.getElementById('message-modal-overlay').style.display = 'none';
             if (currentResolve) {
                 currentResolve(result);
                 currentResolve = null;
             }
        }
        
        // *** 8. GENERACI√ìN DE PDF ***

        function generatePDF(otData) {
            const user = firebase.auth().currentUser.email;
            const pdfContainer = document.createElement('div');
            pdfContainer.style.padding = '20px';
            pdfContainer.style.fontFamily = 'Arial, sans-serif';
            pdfContainer.style.fontSize = '10pt';
            pdfContainer.style.color = '#333';
            pdfContainer.style.backgroundColor = 'white';
            pdfContainer.style.maxWidth = '800px';

            let pdfHtml = `
                <div style="text-align: center; margin-bottom: 20px; border-bottom: 2px solid #ddd; padding-bottom: 10px;">
                    <h1 style="color: var(--color-text); margin: 0;">ORDEN DE TRABAJO</h1>
                    <h2 style="color: var(--color-accent); margin: 5px 0;">Nro. ${otData.ot_number}</h2>
                </div>
                <div style="float: right; text-align: right; font-size: 0.8em; margin-bottom: 20px;">
                    <strong>Creado por:</strong> ${otData.createdBy || user}<br>
                    <strong>Fecha de Emisi√≥n:</strong> ${new Date().toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' })}
                </div>
                <div style="clear: both;"></div>
            `;

            formStructure.forEach((section) => {
                pdfHtml += `
                    <div style="margin-top: 20px; border-top: 1px solid #ddd; padding-top: 10px;">
                        <h3 style="color: var(--color-secondary); margin: 5px 0; font-size: 1.1em;">${section.title}</h3>
                        <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                `;

                section.fields.forEach(field => {
                    const value = otData[field.label] || 'N/A';
                    if (field.type === 'static' || field.type === 'ot_counter' || field.type === 'date-auto' || field.type === 'user-auto-fill') return;

                    pdfHtml += `
                        <tr>
                            <td style="width: 40%; padding: 5px; border: 1px solid #eee; background-color: #f7f7f7;"><strong>${field.label}:</strong></td>
                            <td style="width: 60%; padding: 5px; border: 1px solid #eee;">${value}</td>
                        </tr>
                    `;
                });

                pdfHtml += `</table></div>`;
            });
            
            // Secci√≥n de Firmas
            pdfHtml += `
                <div class="pdf-signatures" style="margin-top: 80px;">
                    <span style="text-align: center; border-top: 1px solid #36454F; padding-top: 5px;">Firma del Responsable que Autoriza</span>
                    <span style="text-align: center; border-top: 1px solid #36454F; padding-top: 5px;">Firma y Sello del Contratista</span>
                </div>
            `;

            pdfContainer.innerHTML = pdfHtml;

            html2pdf().from(pdfContainer).set({
                margin: 10,
                filename: `Orden_de_Trabajo_Nro_${otData.ot_number}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, logging: false, dpi: 192, letterRendering: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            }).save();
        }

    </script>
</body>
</html>
