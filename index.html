<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Sistema de √ìrdenes de Trabajo | Firebase Cloud Edition (Seguro)</title>
    <!-- Librer√≠a para generar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
    
    <!-- LIBRER√çAS DE FIREBASE (Versi√≥n de Compatibilidad) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.9.0/firebase-firestore-compat.js"></script>
    
    <style>
        /* Paleta de colores Pastel Azul/Gris */
        :root {
            --color-bg: #F0F8FF;         /* Azul muy claro (Alice Blue) */
            --color-primary: #ADD8E6;    /* Azul claro (Light Blue) */
            --color-secondary: #B0C4DE;  /* Azul gris√°ceo (Light Steel Blue) */
            --color-accent: #87CEFA;     /* Azul cielo claro (Light Sky Blue) */
            --color-text: #36454F;       /* Gris carb√≥n (Charcoal) */
            --color-white: #ffffff;
            --color-error: #FF6961;      /* Rojo pastel para errores */
            --color-success: #77DD77;    /* Verde pastel para √©xito */
        }

        /* Estilos Generales (Dise√±o Pastel) */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text);
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: var(--color-white);
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }

        h2, h3, h4 {
            color: var(--color-text);
            border-bottom: 2px solid var(--color-primary);
            padding-bottom: 5px;
            margin-top: 25px;
        }

        input[type="text"], input[type="password"], input[type="number"], input[type="date"], input[type="email"], select, textarea {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            display: inline-block;
            border: 1px solid var(--color-secondary);
            border-radius: 6px;
            box-sizing: border-box;
            background-color: var(--color-white);
        }

        /* Estilo para campos autollenados/deshabilitados */
        input:disabled {
            background-color: #f0f0f0; 
            border: 1px dashed var(--color-secondary);
        }

        /* Estilo de validaci√≥n (el navegador se encarga de lo b√°sico, pero esto ayuda) */
        input:invalid:not(:placeholder-shown), select:invalid:not(:placeholder-shown), textarea:invalid:not(:placeholder-shown) {
            border: 2px solid var(--color-error);
        }

        .form-section {
            border: 1px solid var(--color-secondary);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
            background-color: #f7fbff;
        }

        /* Contenedor Flex para Campos de C√°lculo */
        .calculation-group {
            display: flex;
            align-items: center;
            gap: 10px;
            /* Flex vertical para etiquetas y horizontal para inputs/resultados */
            flex-wrap: wrap; 
            border: 1px solid var(--color-secondary);
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            background-color: #e0f7fa; /* Fondo azul claro para destacar el c√°lculo */
        }

        /* Estilo para la etiqueta y el input del Total calculado */
        .calculation-total-section {
            display: flex;
            align-items: center;
            width: 100%;
            margin-top: 10px;
        }

        .calculation-total-section label {
            font-weight: bold;
            flex-basis: auto; 
            margin-right: 15px;
            white-space: nowrap;
        }

        .total-display {
            background-color: var(--color-white);
            font-weight: bold;
            text-align: right;
            border: 1px dashed var(--color-accent);
            padding: 10px;
            border-radius: 6px;
            flex-grow: 1;
        }

        .calculation-input { 
            flex-basis: calc(45% - 20px); 
        } 
        .calculation-group .formula-symbol {
            font-size: 1.5em; 
            font-weight: bold; 
            margin-left: 5px; 
            margin-right: 5px;
        }

        button {
            background-color: var(--color-accent);
            color: var(--color-text);
            padding: 10px 20px;
            margin: 8px 5px 8px 0;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s, transform: 0.1s;
        }

        button:hover {
            background-color: var(--color-primary);
        }
        
        /* Botones de Check Condicional */
        .conditional-check {
            background-color: var(--color-secondary);
            color: var(--color-white);
            font-weight: bold;
            padding: 15px;
            margin-bottom: 10px;
            display: block;
            text-align: left;
        }
        .conditional-check.active {
            background-color: var(--color-success);
        }


        /* Layout de Pesta√±as */
        .tab { overflow: hidden; border-bottom: 1px solid var(--color-secondary); margin-bottom: 20px; }
        .tablinks { background-color: var(--color-bg); color: var(--color-text); float: left; border: none; outline: none; cursor: pointer; padding: 14px 20px; transition: 0.3s; border-top-left-radius: 8px; border-top-right-radius: 8px; }
        .tablinks:hover { background-color: var(--color-primary); }
        .tablinks.active { background-color: var(--color-primary); border-bottom: 3px solid var(--color-accent); margin-bottom: -1px; }
        .tabcontent { display: none; padding: 30px 0; }

        /* Estilos de Edici√≥n */
        .field-editor-item { border: 1px dashed var(--color-secondary); border-radius: 6px; padding: 15px; margin-bottom: 10px; background-color: var(--color-white); }
        .required-fixed-field { padding: 10px; background-color: var(--color-secondary); color: var(--color-white); border-radius: 4px; margin-bottom: 10px; }
        
        /* Estilos para la tabla */
        #orders-table { width: 100%; border-collapse: collapse; }
        #orders-table th, #orders-table td { border: 1px solid var(--color-secondary); padding: 12px; text-align: left; }
        #orders-table th { background-color: var(--color-primary); color: var(--color-text); }
        #orders-table tr:nth-child(even) { background-color: var(--color-bg); }
        #orders-table tr:hover { background-color: var(--color-accent); color: var(--color-white); }

        /* Login View */
        #login-view { width: 350px; padding: 40px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: var(--color-white); border-radius: 10px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); text-align: center; }
        #login-error { color: var(--color-error); font-weight: bold; }
        
        /* Estilo para las firmas en el PDF */
        .pdf-signatures {
            margin-top: 60px; /* 1cm m√°s abajo */
            padding-top: 30px;
            border-top: 1px dashed #B0C4DE;
            display: flex;
            justify-content: space-between;
            width: 100%;
            font-size: 1.1em;
            font-weight: bold;
        }
        .pdf-signatures span {
            display: inline-block;
            width: 45%; /* Ajuste para espacio entre firmas */
        }
        .pdf-signatures hr {
            border: none;
            border-top: 1px solid #36454F;
            margin: 5px 0 0 0;
        }
        
        /* Estilos espec√≠ficos para el encabezado en p√°ginas > 1 del PDF */
        .pdf-header-secondary {
            position: fixed; /* Fijo en la parte superior */
            top: 10px; /* Posici√≥n ajustada para evitar margen */
            right: 20px; /* Posici√≥n ajustada para el lado derecho */
            font-size: 14px; /* Tama√±o similar al de las secciones */
            color: #555;
            font-weight: bold;
            z-index: 1000;
        }

    </style>
</head>
<body>

    <div id="login-view">
        <h2>üîí Iniciar Sesi√≥n</h2>
        <input type="email" id="email" placeholder="Correo Electr√≥nico" required><br>
        <input type="password" id="password" placeholder="Contrase√±a" required><br>
        <button onclick="login()">Acceder</button>
        <p id="login-error"></p>
    </div>

    <div id="main-app" class="container" style="display: none;">
        
        <!-- Pesta√±as de Navegaci√≥n -->
        <div class="tab">
            <!-- ID A√ëADIDO: new-order-tab-button -->
            <button class="tablinks" id="new-order-tab-button" onclick="openTab(event, 'new-order')">üìã Nueva Orden de Trabajo</button>
            <button class="tablinks" onclick="openTab(event, 'view-orders')">üìÇ √ìrdenes Creadas</button>
            <button class="tablinks" id="edit-tab-button" onclick="openTab(event, 'edit-form')" style="display: none;">‚öôÔ∏è Edici√≥n de Formulario</button>
            <button onclick="logout()" style="float: right;">üö™ Cerrar Sesi√≥n</button>
        </div>

        <!-- Contenido de las Pesta√±as -->

        <!-- Pesta√±a 1: Creaci√≥n de Orden de Trabajo -->
        <div id="new-order" class="tabcontent">
            <h3>Nueva Orden de Trabajo</h3>
            <form id="work-order-form"></form>
            <button onclick="generateWorkOrder()">‚úÖ Crear Orden y Generar PDF</button>
        </div>

        <!-- Pesta√±a 2: Visualizaci√≥n de √ìrdenes de Trabajo -->
        <div id="view-orders" class="tabcontent">
            <h3>Registro Hist√≥rico de √ìrdenes</h3>
            <table id="orders-table">
                <thead>
                    <tr><th>Nro. OT</th><th>T√≠tulo</th><th>Fecha Creaci√≥n</th><th>Acciones</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Pesta√±a 3: Edici√≥n de Formulario (Solo Administrador) -->
        <div id="edit-form" class="tabcontent">
            <h3>Edici√≥n de Formulario</h3>
            <div id="form-editor"></div>
            <button onclick="saveFormStructure(false)">üíæ Guardar Estructura del Formulario</button>
        </div>
    </div>

    <script>
        // *** 1. CONFIGURACI√ìN FIREBASE Y VARIABLES GLOBALES ***
        
        // ** CONFIGURACI√ìN DE FIREBASE **
        const firebaseConfig = {
          // *** CLAVE API ACTUALIZADA CON EL VALOR PROPORCIONADO POR EL USUARIO ***
          apiKey: "AIzaSyBHgF18eLwdZbl1g4OkDu-_NWkBnfLh3EA", 
          authDomain: "ordenestrabajo-39eab.firebaseapp.com",
          projectId: "ordenestrabajo-39eab",
          storageBucket: "ordenestrabajo-39eab.firebasestorage.app",
          messagingSenderId: "561184772303",
          appId: "1:561184772303:web:765f5859b4b3a332e827ba"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // Referencias a las "colecciones" de la base de datos
        const ORDERS_COLLECTION = db.collection("workOrders");
        const CONFIG_COLLECTION = db.collection("config"); 
        
        // Variables de estado
        let formStructure = null; 
        let workOrders = []; 
        let otCounter = 1; 
        let currentRole = null; 

        // ----------------------------------------------------------------------------------
        // *** CONFIGURACI√ìN DE ROLES CON M√öLTIPLES CORREOS (LISTAS/ARRAYS) ***
        // ----------------------------------------------------------------------------------

        // Coloque aqu√≠ todos los correos electr√≥nicos con acceso de administrador
        const ADMIN_EMAILS = [
            'labortradingsg@gmail.com', // El correo que usted configur√≥
            '' // Otro administrador de ejemplo
        ]; 

        // Coloque aqu√≠ todos los correos electr√≥nicos con acceso de solo visualizaci√≥n
        const VIEWER_EMAILS = [
            'visualizador1@empresa.com',
            'visualizador2@empresa.com',
            'solo.ver@tudominio.com' // Visualizador de ejemplo
        ]; 

        // ----------------------------------------------------------------------------------
        // *** FIN CONFIGURACI√ìN DE ROLES ***
        // ----------------------------------------------------------------------------------
        
        // *** DATOS FIJOS PARA AUTOLENADO DE CONTRATISTAS ***
        const CONTRATISTAS_DATA = {
            "Seleccione una Empresa": {
                "Apellido y Nombre del Responsable": "",
                "Rif": ""
            },
            " JERM TELECOMTRONICS TECHNOLOGY MULTISERVICES  C.A": {
                "Apellido y Nombre del Responsable": "JOHN RIVAS",
                "Rif": "J-50507058-4"
            },
            "CHASSERAL  C.A": {
                "Apellido y Nombre del Responsable": "YORKFRAN PERAZA",
                "Rif": "J-29510646-7"
            },
            "CONSERVI AJ C.A": {
                "Apellido y Nombre del Responsable": "ALFONZO BASTARDO",
                "Rif": "J-29548400-3"
            },
            "CORPORACION ACEL  C.A": {
                "Apellido y Nombre del Responsable": "DANIEL GONCALVES",
                "Rif": "J-30860621-9"
            },
            "CORPORACI√ìN TORRA NET 2022  C.A": {
                "Apellido y Nombre del Responsable": "JESUS TORRADO",
                "Rif": "J-50308479-0"
            },
            "DISTRIBUIDORA TODO EN REDES G.S.R  C.A": {
                "Apellido y Nombre del Responsable": "GASTON BUIZA",
                "Rif": "J-40424835-8"
            },
            "FIBRA INTEGRA  C.A": {
                "Apellido y Nombre del Responsable": "MARIE ANTONIETTE DAHDAH",
                "Rif": "J-50265450-0"
            },
            "G&D INTEGRAL RED 2023": {
                "Apellido y Nombre del Responsable": "RAFAEL GOMEZ",
                "Rif": "J-50298686-3"
            },
            "GLOBAL FIX C.A": {
                "Apellido y Nombre del Responsable": "CECILIA CASTRO - JEAN PIERRE LAPARROUSAZ",
                "Rif": "J-31189038-6"
            },
            "INT.TV  C.A": {
                "Apellido y Nombre del Responsable": "RAFAEL BERNAEZ",
                "Rif": "J-50301107-6"
            },
            "INVERSIONES ELECTROMTEC 2020  C.A": {
                "Apellido y Nombre del Responsable": "IGOR REGALADO",
                "Rif": "J-50082533-1"
            },
            "INVERSIONES PROYECTOS LG 721  C.A": {
                "Apellido y Nombre del Responsable": "DOMENICO LOLLI",
                "Rif": "J-29831930-5"
            },
            "INVERSIONES TELE MATIK 321 C.A": {
                "Apellido y Nombre del Responsable": "EDICSON TORRES - KATIUSKA",
                "Rif": "J-29867936-0"
            },
            "JR TECH SUPPORT  C.A": {
                "Apellido y Nombre del Responsable": "YENSY MARTINEZ",
                "Rif": "J-50032575-4"
            },
            "LG ALPHA SOLUCIONES  C.A": {
                "Apellido y Nombre del Responsable": "GILBERTO BERNAEZ",
                "Rif": "J-50319061-2"
            },
            "MULTI INVERSIONES LA LOVERE√ëA C.A": {
                "Apellido y Nombre del Responsable": "CARLOS TOLEDO",
                "Rif": "J-40492572-4"
            },
            "MULTISERVICIOS DAYRA-TEC  C.A": {
                "Apellido y Nombre del Responsable": "MARINES GOMEZ",
                "Rif": "J-50331914-3"
            },
            "PHONE MARKET STAR C.A": {
                "Apellido y Nombre del Responsable": "NELSON MORA",
                "Rif": "J-30919375-9"
            },
            "PROMOCIONES Y MERCADEO J FRANCHI C.A": {
                "Apellido y Nombre del Responsable": "JOSE FRANCHI",
                "Rif": "J-31574714-6"
            },
            "ROM-AR SERVICIOS Y MANTENIMIENTO  C.A": {
                "Apellido y Nombre del Responsable": "ELENA RUIZ",
                "Rif": "J-31128189-4"
            },
            "SERVICIOS DE TECNOLOGIA E INNOVACION (SERVITECH)  C.A": {
                "Apellido y Nombre del Responsable": "JHOAN CELIS",
                "Rif": "J-50028078-5"
            },
            "SERVICIOS INTEGRALES RFCF  C.A": {
                "Apellido y Nombre del Responsable": "CESAR",
                "Rif": "J-40387720-3"
            },
            "SERVICIOS J&G SOLUTION  C.A": {
                "Apellido y Nombre del Responsable": "JESUS BERNAEZ",
                "Rif": "J-50201745-3"
            },
            "SERVICIOS R G C.A": {
                "Apellido y Nombre del Responsable": "NELSON PORRA",
                "Rif": "J-29624230-5"
            },
            "SERVICIOS TEALCA C.A": {
                "Apellido y Nombre del Responsable": "FRANKLYN MENDOZA",
                "Rif": "J-31521527-6"
            },
            "SERVINDRECO C.A": {
                "Apellido y Nombre del Responsable": "OSCAR GUERRERO",
                "Rif": "J-31347293-0"
            },
            "SUMINISTROS INDUSTRIALES JAMIG C.A": {
                "Apellido y Nombre del Responsable": "MIGUEL PEREZ",
                "Rif": "J-40990643-4"
            },
            "SYCO 73  C.A": {
                "Apellido y Nombre del Responsable": "JUAN SIVIRA",
                "Rif": "J-31762306-1"
            },
            "TELECOMUNICACIONES JD SISTEM  C.A": {
                "Apellido y Nombre del Responsable": "FLAVIA GOMEZ",
                "Rif": "J-50126527-5"
            },
            "TELEIBARRA CA&EC  C.A": {
                "Apellido y Nombre del Responsable": "CARLOS IBARRA",
                "Rif": "J-50481799-6"
            },
            "W&S TECNOMARKET C.A": {
                "Apellido y Nombre del Responsable": "YERWILL SILVA",
                "Rif": "J-30993225-0"
            },
            "WV SOLUCIONES TECNO-EMPRESARIALES  C.A": {
                "Apellido y Nombre del Responsable": "WILLIAN VALERO",
                "Rif": "J-40973178-2"
            }
        };

        // Estructura inicial por defecto 
        const DEFAULT_FORM_STRUCTURE = [
            { title: "I. Informaci√≥n General", fields: [
                { id: "form_title", label: "T√≠tulo del Formulario", type: "static", value: "Orden de Trabajo", required: true },
                { id: "ot_number", label: "Orden de Trabajo", type: "ot_counter", required: true },
                // CAMPO NUEVO: Autocompletar con el usuario logueado (user-auto-fill)
                { id: "user_auto_fill", label: "Usuario que Crea la Orden", type: "user-auto-fill", required: true },
                { id: "current_date", label: "Fecha Actual", type: "date-auto", required: true }
            ]},
            { title: "II. Informaci√≥n de la Contratista", fields: []},
            { title: "III. Informaci√≥n del Trabajo/Obra", fields: []}
        ];
        
        // *** 2. L√ìGICA DE FIREBASE: CARGA Y GUARDADO ***

        async function loadInitialData() {
            try {
                // Cargar Estructura del Formulario y Contador
                const configDoc = await CONFIG_COLLECTION.doc("systemConfig").get();
                if (configDoc.exists) {
                    const data = configDoc.data();
                    formStructure = data.formStructure || DEFAULT_FORM_STRUCTURE;
                    
                    // L√≥gica de Migraci√≥n: si faltan campos fijos (como el nuevo de usuario), los agregamos.
                    const infoGeneralFields = formStructure[0].fields;
                    const hasUserField = infoGeneralFields.some(f => f.id === 'user_auto_fill');
                    if (!hasUserField) {
                         // Insertar el campo de usuario en la posici√≥n correcta (antes de la fecha)
                         const dateIndex = infoGeneralFields.findIndex(f => f.id === 'current_date');
                         if (dateIndex !== -1) {
                             infoGeneralFields.splice(dateIndex, 0, DEFAULT_FORM_STRUCTURE[0].fields[2]);
                         } else {
                             // Si no encuentra la fecha, lo pone al final de la secci√≥n I
                             infoGeneralFields.push(DEFAULT_FORM_STRUCTURE[0].fields[2]);
                         }
                    }

                    // L√≥gica de Migraci√≥n de t√≠tulos (siempre los mantenemos con el romano)
                    if (formStructure.length >= 3) {
                         if (formStructure[0].title === "Informaci√≥n General" || formStructure[0].title === "I. Informaci√≥n General") formStructure[0].title = "I. Informaci√≥n General";
                         if (formStructure[1].title === "Informaci√≥n de la Contratista" || formStructure[1].title === "II. Informaci√≥n de la Contratista") formStructure[1].title = "II. Informaci√≥n de la Contratista";
                         if (formStructure[2].title === "Informaci√≥n del Trabajo/Obra" || formStructure[2].title === "III. Informaci√≥n del Trabajo/Obra") formStructure[2].title = "III. Informaci√≥n del Trabajo/Obra";
                    }

                    otCounter = data.otCounter || 1;
                } else {
                    // Primera vez: usa el valor por defecto y gu√°rdalo
                    formStructure = DEFAULT_FORM_STRUCTURE;
                    await saveFormStructure(true); 
                }
                
                // Cargar √ìrdenes de Trabajo
                const ordersSnapshot = await ORDERS_COLLECTION.get();
                workOrders = ordersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Asegurar que el contador est√© correcto al inicio
                recalculateOtCounter();

            } catch (e) {
                console.error("Error cargando datos iniciales: ", e);
                alert("Error al conectar con la base de datos. Verifique su conexi√≥n y las reglas de seguridad de Firestore. Detalles: " + e.message);
            }
        }
        
        async function saveFormStructure(initial = false) {
            try {
                await CONFIG_COLLECTION.doc("systemConfig").set({
                    formStructure: formStructure,
                    otCounter: otCounter
                }, { merge: true });

                if (!initial) {
                     alert('üéâ Estructura del formulario y contador guardados exitosamente en la nube.');
                     renderWorkOrderForm();
                }
            } catch (e) {
                console.error("Error al guardar la estructura:", e);
                alert("Error al guardar la estructura en Firebase.");
            }
        }
        
        // MODIFICADA: L√≥gica de Roles
        function getRoleFromEmail(email) {
            if (ADMIN_EMAILS.includes(email)) {
                return 'admin';
            } 
            else if (VIEWER_EMAILS.includes(email)) { 
                return 'viewer'; 
            } 
            else {
                return 'normal'; 
            }
        }

        // SIN CAMBIOS MAYORES
        async function login() {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            const errorElement = document.getElementById('login-error');
            errorElement.textContent = '';
            
            try {
                const userCredential = await firebase.auth().signInWithEmailAndPassword(email, pass);
                const user = userCredential.user;
                
                let role = getRoleFromEmail(user.email); 
                
                currentRole = role;
                
                document.getElementById('login-view').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                initializeApp(role);
                
            } catch (error) {
                console.error("Error de autenticaci√≥n:", error.code, error.message);
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    errorElement.textContent = 'Credenciales incorrectas o usuario no encontrado.';
                } else if (error.code === 'auth/invalid-email') {
                    errorElement.textContent = 'El formato del correo es inv√°lido.';
                } else if (error.code === 'auth/api-key-not-valid') {
                    errorElement.textContent = 'ERROR DE CONFIGURACI√ìN: La Clave API de Firebase no es v√°lida. Por favor, verifique la configuraci√≥n de Firebase en el c√≥digo.';
                } else {
                    errorElement.textContent = 'Error de conexi√≥n. Intente de nuevo.';
                }
            }
        }

        // SIN CAMBIOS
        function logout() {
            firebase.auth().signOut().then(() => {
                document.getElementById('email').value = '';
                document.getElementById('password').value = '';
                alert('Sesi√≥n cerrada correctamente.');
            }).catch((error) => {
                console.error("Error al cerrar sesi√≥n:", error);
                alert('Error al cerrar sesi√≥n.');
            });
        }

        // MODIFICADA: Control de visibilidad de pesta√±as para los 3 roles
        async function initializeApp(role) {
            const isCreator = (role === 'admin' || role === 'normal');

            document.getElementById('edit-tab-button').style.display = (role === 'admin') ? 'inline-block' : 'none';
            document.getElementById('new-order-tab-button').style.display = isCreator ? 'inline-block' : 'none';
            
            await loadInitialData(); 
            
            if (role === 'admin') {
                renderFormEditor();
                openTab(null, 'edit-form');
            } else if (role === 'normal') {
                openTab(null, 'new-order');
            } else if (role === 'viewer') {
                openTab(null, 'view-orders'); 
            }
            
            renderWorkOrderForm();
            renderOrdersTable();
        }

        // MODIFICADA: Usa getRoleFromEmail() para los 3 roles
        window.onload = function() {
            firebase.auth().onAuthStateChanged(user => {
                if (user) {
                    let role = getRoleFromEmail(user.email); 
                    currentRole = role;
                    
                    document.getElementById('login-view').style.display = 'none';
                    document.getElementById('main-app').style.display = 'block';
                    initializeApp(role);
                } else {
                    currentRole = null;
                    document.getElementById('main-app').style.display = 'none';
                    document.getElementById('login-view').style.display = 'block';
                }
            });
        }
        
        function openTab(evt, tabName) {
            let i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            if (evt) evt.currentTarget.className += " active";

            if (tabName === 'new-order' && formStructure) renderWorkOrderForm();
            else if (tabName === 'view-orders') renderOrdersTable();
            else if (tabName === 'edit-form' && currentRole === 'admin' && formStructure) renderFormEditor();
        }
        
        // *** 4. L√ìGICA DE EDICI√ìN DE FORMULARIO (ADMIN) ***

        function renderFormEditor() {
            const editorDiv = document.getElementById('form-editor');
            editorDiv.innerHTML = '';

            formStructure.forEach((section, secIndex) => {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'form-section';
                sectionDiv.innerHTML = `
                    <h4>Secci√≥n ${secIndex + 1}: <input type="text" value="${section.title}" oninput="updateSectionTitle(${secIndex}, this.value)" style="width: 70%; display: inline;"></h4>
                    <button onclick="addField(${secIndex}, 'text')">‚ûï Agregar Campo de Texto</button>
                    <button onclick="addField(${secIndex}, 'select')">‚ûï Agregar Lista (Select)</button>
                    <button onclick="addField(${secIndex}, 'date-input')">üìÖ Agregar Campo de Fecha</button>
                    <hr>
                    <div id="fields-container-${secIndex}"></div>
                `;
                editorDiv.appendChild(sectionDiv);

                const fieldsContainer = document.getElementById(`fields-container-${secIndex}`);
                section.fields.forEach((field, fieldIndex) => {
                    // user-auto-fill al listado de campos fijos
                    if (field.type === 'static' || field.type === 'ot_counter' || field.type === 'date-auto' || field.type === 'user-auto-fill') {
                        fieldsContainer.innerHTML += `<p class="required-fixed-field"><strong>${field.label}</strong> (Campo fijo obligatorio)</p>`;
                        return;
                    }

                    const fieldDiv = document.createElement('div');
                    fieldDiv.className = 'field-editor-item';
                    fieldDiv.innerHTML = `
                        <label>Etiqueta:</label>
                        <input type="text" value="${field.label}" oninput="updateFieldProperty(${secIndex}, ${fieldIndex}, 'label', this.value)">
                        <label>Tipo:</label>
                        <select onchange="updateFieldProperty(${secIndex}, ${fieldIndex}, 'type', this.value)">
                            <option value="text" ${field.type === 'text' ? 'selected' : ''}>Texto (Corto)</option>
                            <option value="number" ${field.type === 'number' ? 'selected' : ''}>N√∫mero</option>
                            <option value="textarea" ${field.type === 'textarea' ? 'selected' : ''}>√Årea de Texto (Largo)</option>
                            <option value="select" ${field.type === 'select' ? 'selected' : ''}>Lista Desplegable (Simple)</option>
                            <option value="autofill-select" ${field.type === 'autofill-select' ? 'selected' : ''}>Lista (Autollenado Contratista) üìù</option>
                            <option value="date-input" ${field.type === 'date-input' ? 'selected' : ''}>Fecha (Calendario) üìÖ</option>
                        </select>
                        <label>Clasificaci√≥n:</label>
                        <input type="checkbox" id="req-${secIndex}-${fieldIndex}" ${field.required ? 'checked' : ''} onchange="updateFieldProperty(${secIndex}, ${fieldIndex}, 'required', this.checked)"> 
                        <label for="req-${secIndex}-${fieldIndex}" style="display: inline-block; font-weight: normal;">Obligatorio</label>
                        
                        <div id="select-options-${secIndex}-${fieldIndex}" style="margin-top: 10px; ${field.type !== 'select' && field.type !== 'autofill-select' ? 'display: none;' : ''}">
                            <strong>Opciones de Lista (solo visible si es 'Select' o 'Autofill-Select'). </strong>
                            ${field.type === 'autofill-select' ? 
                                '<p style="color: var(--color-error);">‚ö†Ô∏è **Autollenado:** Las opciones se toman de `CONTRATISTAS_DATA` y anulan esta lista.</p>' : ''
                            }
                            <input type="text" value="${(field.options || []).join(', ')}" oninput="updateSelectOptions(${secIndex}, ${fieldIndex}, this.value)">
                        </div>
                        <button onclick="removeField(${secIndex}, ${fieldIndex})" style="background-color: var(--color-error); color: var(--color-white);">üóëÔ∏è Eliminar Campo</button>
                    `;
                    fieldsContainer.appendChild(fieldDiv);
                });
            });
        }
        
        function updateSectionTitle(secIndex, newTitle) { formStructure[secIndex].title = newTitle; }

        function updateFieldProperty(secIndex, fieldIndex, prop, value) {
            formStructure[secIndex].fields[fieldIndex][prop] = value;
            if (prop ===
