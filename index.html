<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Sistema de √ìrdenes de Trabajo | Firebase Cloud Edition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    
    <style>
        /* Paleta de colores Pastel Azul/Gris */
        :root {
            --color-bg: #F0F8FF;         /* Azul muy claro (Alice Blue) */
            --color-primary: #ADD8E6;    /* Azul claro (Light Blue) */
            --color-secondary: #B0C4DE;  /* Azul gris√°ceo (Light Steel Blue) */
            --color-accent: #87CEFA;     /* Azul cielo claro (Light Sky Blue) */
            --color-text: #36454F;       /* Gris carb√≥n (Charcoal) */
            --color-white: #ffffff;
            --color-error: #FF6961;      /* Rojo pastel para errores */
            --color-success: #77DD77;    /* Verde pastel para √©xito */
        }

        /* Estilos Generales (Dise√±o Pastel) */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text);
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: var(--color-white);
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }

        h2, h3, h4 {
            color: var(--color-text);
            border-bottom: 2px solid var(--color-primary);
            padding-bottom: 5px;
            margin-top: 25px;
        }

        input[type="text"], input[type="password"], input[type="number"], input[type="date"], select, textarea {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            display: inline-block;
            border: 1px solid var(--color-secondary);
            border-radius: 6px;
            box-sizing: border-box;
            background-color: var(--color-white);
        }

        /* Estilo para campos autollenados/deshabilitados */
        input:disabled {
            background-color: #f0f0f0; 
            border: 1px dashed var(--color-secondary);
        }

        /* Estilo de validaci√≥n (el navegador se encarga de lo b√°sico, pero esto ayuda) */
        input:invalid:not(:placeholder-shown), select:invalid:not(:placeholder-shown), textarea:invalid:not(:placeholder-shown) {
            border: 2px solid var(--color-error);
        }

        .form-section {
            border: 1px solid var(--color-secondary);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
            background-color: #f7fbff;
        }

        /* Contenedor Flex para Campos de C√°lculo */
        .calculation-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .calculation-group label { width: 100%; }

        /* Estilo para el campo Total calculado */
        .total-display {
            background-color: #e0f7fa; /* Un color distinto para el total */
            font-weight: bold;
            text-align: right;
            border: 1px dashed var(--color-accent);
            padding: 10px;
            border-radius: 6px;
        }

        button {
            background-color: var(--color-accent);
            color: var(--color-text);
            padding: 10px 20px;
            margin: 8px 5px 8px 0;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
        }

        button:hover {
            background-color: var(--color-primary);
        }
        
        /* Botones de Check Condicional */
        .conditional-check {
            background-color: var(--color-secondary);
            color: var(--color-white);
            font-weight: bold;
            padding: 15px;
            margin-bottom: 10px;
            display: block;
            text-align: left;
        }
        .conditional-check.active {
            background-color: var(--color-success);
        }


        /* Layout de Pesta√±as */
        .tab { overflow: hidden; border-bottom: 1px solid var(--color-secondary); margin-bottom: 20px; }
        .tablinks { background-color: var(--color-bg); color: var(--color-text); float: left; border: none; outline: none; cursor: pointer; padding: 14px 20px; transition: 0.3s; border-top-left-radius: 8px; border-top-right-radius: 8px; }
        .tablinks:hover { background-color: var(--color-primary); }
        .tablinks.active { background-color: var(--color-primary); border-bottom: 3px solid var(--color-accent); margin-bottom: -1px; }
        .tabcontent { display: none; padding: 30px 0; }

        /* Estilos de Edici√≥n */
        .field-editor-item { border: 1px dashed var(--color-secondary); border-radius: 6px; padding: 15px; margin-bottom: 10px; background-color: var(--color-white); }
        .required-fixed-field { padding: 10px; background-color: var(--color-secondary); color: var(--color-white); border-radius: 4px; margin-bottom: 10px; }
        
        /* Estilos para la tabla */
        #orders-table { width: 100%; border-collapse: collapse; }
        #orders-table th, #orders-table td { border: 1px solid var(--color-secondary); padding: 12px; text-align: left; }
        #orders-table th { background-color: var(--color-primary); color: var(--color-text); }
        #orders-table tr:nth-child(even) { background-color: var(--color-bg); }
        #orders-table tr:hover { background-color: var(--color-accent); color: var(--color-white); }

        /* Login View */
        #login-view { width: 350px; padding: 40px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: var(--color-white); border-radius: 10px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); text-align: center; }
        #login-error { color: var(--color-error); font-weight: bold; }
        
        /* Estilo para las firmas en el PDF */
        .pdf-signatures {
            margin-top: 50px;
            padding-top: 30px;
            border-top: 1px dashed #B0C4DE;
            display: flex;
            justify-content: space-between;
            width: 100%;
            font-size: 1.1em;
            font-weight: bold;
        }
        .pdf-signatures span {
            display: inline-block;
            width: 45%; /* Ajuste para espacio entre firmas */
        }
        .pdf-signatures hr {
            border: none;
            border-top: 1px solid #36454F;
            margin: 5px 0 0 0;
        }

    </style>
</head>
<body>

    <div id="login-view">
        <h2>üîí Iniciar Sesi√≥n</h2>
        <input type="text" id="username" placeholder="Usuario"><br>
        <input type="password" id="password" placeholder="Contrase√±a"><br>
        <button onclick="login()">Acceder</button>
        <p id="login-error"></p>
    </div>

    <div id="main-app" class="container" style="display: none;">
        
        <div class="tab">
            <button class="tablinks" onclick="openTab(event, 'new-order')">üìã Nueva Orden de Trabajo</button>
            <button class="tablinks" onclick="openTab(event, 'view-orders')">üìÇ √ìrdenes Creadas</button>
            <button class="tablinks" id="edit-tab-button" onclick="openTab(event, 'edit-form')" style="display: none;">‚öôÔ∏è Edici√≥n de Formulario</button>
            <button onclick="logout()" style="float: right;">üö™ Cerrar Sesi√≥n</button>
        </div>

        <div id="new-order" class="tabcontent">
            <h3>Nueva Orden de Trabajo</h3>
            <form id="work-order-form"></form>
            <button onclick="generateWorkOrder()">‚úÖ Crear Orden y Generar PDF</button>
        </div>

        <div id="view-orders" class="tabcontent">
            <h3>Registro Hist√≥rico de √ìrdenes</h3>
            <table id="orders-table">
                <thead>
                    <tr><th>Nro. OT</th><th>T√≠tulo</th><th>Fecha Creaci√≥n</th><th>Acciones</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="edit-form" class="tabcontent">
            <h3>Edici√≥n de Formulario</h3>
            <div id="form-editor"></div>
            <button onclick="saveFormStructure(false)">üíæ Guardar Estructura del Formulario</button>
        </div>
    </div>

    <script>
        // *** 1. CONFIGURACI√ìN FIREBASE Y VARIABLES GLOBALES ***
        
        // ** CONFIGURACI√ìN DE FIREBASE **
        const firebaseConfig = {
          apiKey: "AIzaSyBHgF18eLwdZbl1g4OkDu-_NWkBnfLh3EA",
          authDomain: "ordenestrabajo-39eab.firebaseapp.com",
          projectId: "ordenestrabajo-39eab",
          storageBucket: "ordenestrabajo-39eab.firebasestorage.app",
          messagingSenderId: "561184772303",
          appId: "1:561184772303:web:765f5859b4b3a332e8277ba"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Referencias a las "colecciones" de la base de datos
        const ORDERS_COLLECTION = db.collection("workOrders");
        const CONFIG_COLLECTION = db.collection("config"); 

        // Variables de estado (ahora sincronizadas con Firebase)
        let formStructure = null; 
        let workOrders = []; 
        let otCounter = 1; 
        let currentRole = null; 

        // Usuarios y Contrase√±as
        const ADMIN_USER = 'admin';
        const ADMIN_PASS = '4dm1n**';
        const NORMAL_USER = 'gerente';
        const NORMAL_PASS = '1nt3r**';

        // *** DATOS FIJOS PARA AUTOLENADO DE CONTRATISTAS ***
        const CONTRATISTAS_DATA = {
            // El administrador puede agregar, modificar o eliminar contratistas aqu√≠
            "Seleccione una Empresa": {
                "Apellido y Nombre del Responsable": "",
                "Rif": ""
            },
            "Contratista A C.A.": {
                "Apellido y Nombre del Responsable": "P√©rez Juan",
                "Rif": "J-12345678-0"
            },
            "Servicios B, S.A.": {
                "Apellido y Nombre del Responsable": "G√≥mez Mar√≠a",
                "Rif": "G-98765432-1"
            },
            "Construcciones Zulia C.L.": {
                "Apellido y Nombre del Responsable": "L√≥pez Carlos",
                "Rif": "C-11223344-5"
            }
        };

        // Estructura inicial por defecto
        const DEFAULT_FORM_STRUCTURE = [
            { title: "Informaci√≥n General", fields: [
                { id: "form_title", label: "T√≠tulo del Formulario", type: "static", value: "Orden de Trabajo", required: true },
                { id: "ot_number", label: "Orden de Trabajo", type: "ot_counter", required: true },
                { id: "current_date", label: "Fecha Actual", type: "date-auto", required: true }
            ]},
            { title: "Informaci√≥n de la Contratista", fields: []},
            { title: "Informaci√≥n del Trabajo/Obra", fields: []}
        ];
        
        // *** 2. L√ìGICA DE FIREBASE: CARGA Y GUARDADO ***

        async function loadInitialData() {
            try {
                // Cargar Estructura del Formulario y Contador
                const configDoc = await CONFIG_COLLECTION.doc("systemConfig").get();
                if (configDoc.exists) {
                    const data = configDoc.data();
                    formStructure = data.formStructure || DEFAULT_FORM_STRUCTURE;
                    otCounter = data.otCounter || 1;
                } else {
                    // Primera vez: usa el valor por defecto y gu√°rdalo
                    formStructure = DEFAULT_FORM_STRUCTURE;
                    await saveFormStructure(true); 
                }
                
                // Cargar √ìrdenes de Trabajo
                const ordersSnapshot = await ORDERS_COLLECTION.get();
                workOrders = ordersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            } catch (e) {
                console.error("Error cargando datos iniciales: ", e);
                alert("Error al conectar con la base de datos. Verifique su conexi√≥n y las reglas de seguridad de Firestore. Detalles: " + e.message);
            }
        }
        
        async function saveFormStructure(initial = false) {
            try {
                await CONFIG_COLLECTION.doc("systemConfig").set({
                    formStructure: formStructure,
                    otCounter: otCounter
                }, { merge: true });

                if (!initial) {
                     alert('üéâ Estructura del formulario y contador guardados exitosamente en la nube.');
                     renderWorkOrderForm();
                }
            } catch (e) {
                console.error("Error al guardar la estructura:", e);
                alert("Error al guardar la estructura en Firebase.");
            }
        }
        
        // *** 3. L√ìGICA DE LOGIN Y PESTA√ëAS ***
        
        function login() {
            const user = document.getElementById('username').value;
            const pass = document.getElementById('password').value;
            const errorElement = document.getElementById('login-error');
            errorElement.textContent = '';

            let role = null;
            if (user === ADMIN_USER && pass === ADMIN_PASS) {
                role = 'admin';
            } else if (user === NORMAL_USER && pass === NORMAL_PASS) {
                role = 'normal';
            }

            if (role) {
                currentRole = role; // Almacena el rol globalmente
                sessionStorage.setItem('userRole', role);
                document.getElementById('login-view').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                initializeApp(role);
            } else {
                errorElement.textContent = 'Usuario o contrase√±a incorrectos.';
            }
        }

        function logout() {
            sessionStorage.removeItem('userRole');
            currentRole = null;
            document.getElementById('main-app').style.display = 'none';
            document.getElementById('login-view').style.display = 'block';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        async function initializeApp(role) {
            document.getElementById('edit-tab-button').style.display = (role === 'admin') ? 'inline-block' : 'none';

            await loadInitialData(); 
            
            if (role === 'admin') {
                renderFormEditor();
                openTab(null, 'edit-form');
            } else {
                openTab(null, 'new-order');
            }
            renderWorkOrderForm();
            renderOrdersTable();
        }

        window.onload = function() {
            const role = sessionStorage.getItem('userRole');
            if (role) {
                document.getElementById('login-view').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                initializeApp(role);
            }
        }
        
        function openTab(evt, tabName) {
            let i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            if (evt) evt.currentTarget.className += " active";

            if (tabName === 'new-order' && formStructure) renderWorkOrderForm();
            else if (tabName === 'view-orders') renderOrdersTable();
            else if (tabName === 'edit-form' && currentRole === 'admin' && formStructure) renderFormEditor();
        }
        
        // *** 4. L√ìGICA DE EDICI√ìN DE FORMULARIO (ADMIN) ***

        function renderFormEditor() {
            const editorDiv = document.getElementById('form-editor');
            editorDiv.innerHTML = '';

            formStructure.forEach((section, secIndex) => {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'form-section';
                sectionDiv.innerHTML = `
                    <h4>Secci√≥n ${secIndex + 1}: <input type="text" value="${section.title}" oninput="updateSectionTitle(${secIndex}, this.value)" style="width: 70%; display: inline;"></h4>
                    <button onclick="addField(${secIndex}, 'text')">‚ûï Agregar Campo de Texto</button>
                    <button onclick="addField(${secIndex}, 'select')">‚ûï Agregar Lista (Select)</button>
                    <button onclick="addField(${secIndex}, 'date-input')">üìÖ Agregar Campo de Fecha</button>
                    <hr>
                    <div id="fields-container-${secIndex}"></div>
                `;
                editorDiv.appendChild(sectionDiv);

                const fieldsContainer = document.getElementById(`fields-container-${secIndex}`);
                section.fields.forEach((field, fieldIndex) => {
                    if (field.type === 'static' || field.type === 'ot_counter' || field.type === 'date-auto') {
                        fieldsContainer.innerHTML += `<p class="required-fixed-field"><strong>${field.label}</strong> (Campo fijo obligatorio)</p>`;
                        return;
                    }

                    const fieldDiv = document.createElement('div');
                    fieldDiv.className = 'field-editor-item';
                    fieldDiv.innerHTML = `
                        <label>Etiqueta:</label>
                        <input type="text" value="${field.label}" oninput="updateFieldProperty(${secIndex}, ${fieldIndex}, 'label', this.value)">
                        <label>Tipo:</label>
                        <select onchange="updateFieldProperty(${secIndex}, ${fieldIndex}, 'type', this.value)">
                            <option value="text" ${field.type === 'text' ? 'selected' : ''}>Texto (Corto)</option>
                            <option value="number" ${field.type === 'number' ? 'selected' : ''}>N√∫mero</option>
                            <option value="textarea" ${field.type === 'textarea' ? 'selected' : ''}>√Årea de Texto (Largo)</option>
                            <option value="select" ${field.type === 'select' ? 'selected' : ''}>Lista Desplegable (Simple)</option>
                            <option value="autofill-select" ${field.type === 'autofill-select' ? 'selected' : ''}>Lista (Autollenado Contratista) üìù</option>
                            <option value="date-input" ${field.type === 'date-input' ? 'selected' : ''}>Fecha (Calendario) üìÖ</option>
                        </select>
                        <label>Clasificaci√≥n:</label>
                        <input type="checkbox" id="req-${secIndex}-${fieldIndex}" ${field.required ? 'checked' : ''} onchange="updateFieldProperty(${secIndex}, ${fieldIndex}, 'required', this.checked)"> 
                        <label for="req-${secIndex}-${fieldIndex}" style="display: inline-block; font-weight: normal;">Obligatorio</label>
                        
                        <div id="select-options-${secIndex}-${fieldIndex}" style="margin-top: 10px; ${field.type !== 'select' && field.type !== 'autofill-select' ? 'display: none;' : ''}">
                            <strong>Opciones de Lista (solo visible si es 'Select' o 'Autofill-Select'). </strong>
                            ${field.type === 'autofill-select' ? 
                                '<p style="color: var(--color-error);">‚ö†Ô∏è **Autollenado:** Las opciones se toman de `CONTRATISTAS_DATA` y anulan esta lista.</p>' : ''
                            }
                            <input type="text" value="${(field.options || []).join(', ')}" oninput="updateSelectOptions(${secIndex}, ${fieldIndex}, this.value)">
                        </div>
                        <button onclick="removeField(${secIndex}, ${fieldIndex})" style="background-color: var(--color-error); color: var(--color-white);">üóëÔ∏è Eliminar Campo</button>
                    `;
                    fieldsContainer.appendChild(fieldDiv);
                });
            });
        }
        
        function updateSectionTitle(secIndex, newTitle) { formStructure[secIndex].title = newTitle; }

        function updateFieldProperty(secIndex, fieldIndex, prop, value) {
            formStructure[secIndex].fields[fieldIndex][prop] = value;
            if (prop === 'type') {
                if ((value === 'select' || value === 'autofill-select') && !formStructure[secIndex].fields[fieldIndex].options) {
                    formStructure[secIndex].fields[fieldIndex].options = ['Opci√≥n A', 'Opci√≥n B'];
                }
                renderFormEditor();
            }
        }

        function updateSelectOptions(secIndex, fieldIndex, value) {
            formStructure[secIndex].fields[fieldIndex].options = value.split(',').map(s => s.trim()).filter(s => s.length > 0);
        }

        function addField(secIndex, type) {
            const newField = {
                id: `dynamic_field_${Date.now()}`,
                label: `Nuevo Campo ${type === 'select' || type === 'autofill-select' ? 'Lista' : (type === 'date-input' ? 'Fecha' : 'Texto')}`,
                type: type,
                required: false
            };
            if (type === 'select' || type === 'autofill-select') newField.options = ['Opci√≥n A', 'Opci√≥n B'];
            formStructure[secIndex].fields.push(newField);
            renderFormEditor();
        }

        function removeField(secIndex, fieldIndex) {
            if (secIndex === 0 && fieldIndex < 3) {
                alert("üö´ No se pueden eliminar los campos obligatorios y fijos de la primera secci√≥n.");
                return;
            }
            if (confirm('¬øEst√°s seguro de que quieres eliminar este campo?')) {
                formStructure[secIndex].fields.splice(fieldIndex, 1);
                renderFormEditor();
            }
        }


        // *** 5. L√ìGICA DE CREACI√ìN DE ORDEN DE TRABAJO (INCLUYE C√ÅLCULOS Y CONDICIONALES) ***

        /**
         * Funci√≥n que autocompleta los campos de Responsable y Rif al cambiar la empresa.
         */
        function autofillContratistaData(selectElement) {
            const selectedCompanyName = selectElement.value;
            const data = CONTRATISTAS_DATA[selectedCompanyName];
            
            // Si no hay datos (ej. "Seleccione una Empresa"), limpia los campos
            if (!data) {
                document.getElementById('Apellido y Nombre del Responsable').value = '';
                document.getElementById('Rif').value = '';
                return;
            }

            // Asumiendo que los campos Responsable y Rif existen y sus IDs son sus propios labels (para simplicidad)
            const responsibleField = document.getElementById('Apellido y Nombre del Responsable');
            const rifField = document.getElementById('Rif');

            if (responsibleField && data["Apellido y Nombre del Responsable"] !== undefined) {
                responsibleField.value = data["Apellido y Nombre del Responsable"];
            }
            if (rifField && data["Rif"] !== undefined) {
                rifField.value = data["Rif"];
            }
        }


        function calculateTotal(prefix) {
            // Asegura que los valores sean n√∫meros, reemplazando comas por puntos si el usuario las us√≥
            const montoReal = parseFloat(document.getElementById(`${prefix}_monto_real`).value.replace(',', '.')) || 0;
            const incremento = parseFloat(document.getElementById(`${prefix}_incremento`).value.replace(',', '.')) || 0;
            const total = montoReal + incremento;
            
            // Actualiza el campo Total
            document.getElementById(`${prefix}_total_display`).textContent = total.toFixed(2) + ' $';
            
            // Almacena el valor Total real en un campo hidden para capturarlo al guardar
            document.getElementById(`${prefix}_total_hidden`).value = total.toFixed(2);
        }

        function toggleJustification(prefix) {
            const isChecked = document.getElementById(`${prefix}_no_cobro_check`).checked;
            const justificationDiv = document.getElementById(`${prefix}_justificacion_div`);
            
            if (isChecked) {
                justificationDiv.style.display = 'block';
                // Solo hacemos que el campo sea obligatorio si se marca el check
                document.getElementById(`${prefix}_justificacion`).required = true; 
            } else {
                justificationDiv.style.display = 'none';
                document.getElementById(`${prefix}_justificacion`).required = false;
            }
        }

        function toggleConditionalSection(type) {
            const nodeAccessSection = document.getElementById('conditional_node_acceso_section');
            const ispSection = document.getElementById('conditional_isp_section');
            const nodeAccessButton = document.getElementById('check_node_acceso');
            const ispButton = document.getElementById('check_isp');

            // 1. Limpiar y resetear ambas secciones
            nodeAccessSection.style.display = 'none';
            ispSection.style.display = 'none';
            nodeAccessButton.classList.remove('active');
            ispButton.classList.remove('active');
            
            // Resetear inputs y checks internos (Importante para evitar que se guarden datos ocultos)
            document.getElementById('node_acceso_no_cobro_check').checked = false;
            document.getElementById('isp_no_cobro_check').checked = false;
            
            // Resetear campos num√©ricos (usando '' en lugar de 0 para que no sean requeridos si est√°n ocultos)
            document.getElementById('node_acceso_monto_real').value = '';
            document.getElementById('node_acceso_incremento').value = '';
            document.getElementById('isp_monto_real').value = '';
            document.getElementById('isp_incremento').value = '';
            
            // Ocultar justificaciones
            toggleJustification('node_acceso');
            toggleJustification('isp');


            // 2. Mostrar la secci√≥n seleccionada
            if (type === 'node_acceso') {
                nodeAccessSection.style.display = 'block';
                nodeAccessButton.classList.add('active');
            } else if (type === 'isp') {
                ispSection.style.display = 'block';
                ispButton.classList.add('active');
            }
            
            // 3. Forzar el c√°lculo inicial (0.00) si se muestra la secci√≥n
            if (type) calculateTotal(type);
        }


        function renderWorkOrderForm() {
            const formElement = document.getElementById('work-order-form');
            formElement.innerHTML = '';
            const today = new Date().toISOString().substring(0, 10);

            if (!formStructure) {
                 formElement.innerHTML = '<p>Cargando estructura del formulario...</p>';
                 return;
            }
            
            // Renderizar secciones din√°micas
            formStructure.forEach(section => {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'form-section';
                sectionDiv.innerHTML = `<h4>${section.title}</h4>`;

                section.fields.forEach(field => {
                    const requiredStar = field.required ? '<span style="color: var(--color-error); margin-left: 5px;">*</span>' : '';
                    let inputHTML = '';
                    let value = '';
                    let isDisabled = '';
                    let onChangeEvent = '';
                    let isAutofillField = false;

                    // L√≥gica para deshabilitar campos de autollenado
                    if (section.title === 'Informaci√≥n de la Contratista') {
                        // Los campos autollenados deben usar su label como ID
                        const autofillKeys = ["Apellido y Nombre del Responsable", "Rif"];
                        if (autofillKeys.includes(field.label)) {
                            isDisabled = 'disabled';
                            isAutofillField = true;
                        } else if (field.type === 'autofill-select') {
                            // Este es el campo que activa el autollenado
                            onChangeEvent = `onchange="autofillContratistaData(this)"`;
                        }
                    }

                    // El ID se convierte en el LABEL para que la funci√≥n autofill pueda identificarlos.
                    const fieldId = isAutofillField ? field.label : field.id; 
                    
                    // Tratamiento de REQUIRED para los campos NO fijos/est√°ticos
                    const requiredAttribute = field.required && field.type !== 'static' && field.type !== 'ot_counter' && field.type !== 'date-auto' ? 'required' : '';


                    switch (field.type) {
                        case 'static':
                            value = field.value;
                            inputHTML = `<input type="text" value="${value}" disabled>`;
                            break;
                        case 'ot_counter':
                            value = otCounter;
                            inputHTML = `<input type="text" value="${value}" disabled>`;
                            break;
                        case 'date-auto':
                            value = today;
                            inputHTML = `<input type="date" value="${value}" disabled>`;
                            break;
                        case 'date-input':
                            inputHTML = `<input type="date" id="${fieldId}" name="${fieldId}" ${requiredAttribute} ${isDisabled}>`;
                            break;
                        case 'text':
                        case 'number':
                            inputHTML = `<input type="${field.type}" id="${fieldId}" name="${fieldId}" ${requiredAttribute} ${isDisabled}>`;
                            break;
                        case 'textarea':
                            inputHTML = `<textarea id="${fieldId}" name="${fieldId}" ${requiredAttribute} ${isDisabled}></textarea>`;
                            break;
                        case 'select':
                            inputHTML = `<select id="${fieldId}" name="${fieldId}" ${requiredAttribute} ${isDisabled} ${onChangeEvent}>
                                ${field.options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                            </select>`;
                            break;
                        case 'autofill-select': // NUEVO TIPO DE LISTA
                            const optionsHTML = Object.keys(CONTRATISTAS_DATA).map(key => `<option value="${key}">${key}</option>`).join('');
                            inputHTML = `<select id="${fieldId}" name="${fieldId}" ${requiredAttribute} ${isDisabled} ${onChangeEvent}>
                                ${optionsHTML}
                            </select>`;
                            break;
                    }

                    sectionDiv.innerHTML += `<p><label for="${fieldId}">${field.label}${requiredStar}:</label>${inputHTML}</p>`;
                });
                formElement.appendChild(sectionDiv);
            });
            
            // A√ëADIR BOTONES DE CHECK CONDICIONAL AL FINAL
            formElement.innerHTML += `
                <h4>Tipo de Construcci√≥n (Selecci√≥n √önica)</h4>
                <button type="button" class="conditional-check" id="check_node_acceso" onclick="toggleConditionalSection('node_acceso')">
                    La Construcci√≥n es de un Nodo de Acceso
                </button>
                <button type="button" class="conditional-check" id="check_isp" onclick="toggleConditionalSection('isp')">
                    La Construcci√≥n es de un ISP
                </button>
                <button type="button" style="background-color: var(--color-error); color: var(--color-white); margin-top: 15px;" onclick="toggleConditionalSection(null)">
                    ‚ùå Eliminar / Desmarcar Selecci√≥n
                </button>
            `;
            
            // --- SECCI√ìN CONDICIONAL: CONSTRUCCI√ìN NODO DE ACCESO ---
            formElement.innerHTML += renderConditionalSection('node_acceso', 'Construcci√≥n Nodo de Acceso');

            // --- SECCI√ìN CONDICIONAL: CONSTRUCCI√ìN ISP ---
            formElement.innerHTML += renderConditionalSection('isp', 'Construcci√≥n ISP');
            
            // Inicializar las secciones ocultas
            toggleConditionalSection(null);
            
            // Inicializar autollenado con el valor por defecto
            const autofillSelects = document.querySelectorAll('select[onchange="autofillContratistaData(this)"]');
            autofillSelects.forEach(select => autofillContratistaData(select));
        }

        function renderConditionalSection(prefix, title) {
            // NOTA: Se ha eliminado el 'required' de los campos num√©ricos en las secciones condicionales.
            // La validaci√≥n de estos campos se realiza manualmente en generateWorkOrder() para que solo
            // sean obligatorios si la secci√≥n est√° ACTIVA.
            return `
                <div class="form-section" id="conditional_${prefix}_section" style="display: none;">
                    <h4>${title}</h4>
                    
                    <p><label for="${prefix}_monto_real">Monto Real de la Factibilidad (*):</label></p>
                    <div class="calculation-group">
                        <input type="number" step="0.01" min="0" id="${prefix}_monto_real" name="${prefix}_monto_real" placeholder="0.00" oninput="calculateTotal('${prefix}')">
                        <span style="font-size: 1.5em; font-weight: bold; margin-left: -30px;">$</span>
                    </div>

                    <p><label for="${prefix}_incremento">Incremento de Pagos VGT y Otros Servicios (*):</label></p>
                    <div class="calculation-group">
                        <input type="number" step="0.01" min="0" id="${prefix}_incremento" name="${prefix}_incremento" placeholder="0.00" oninput="calculateTotal('${prefix}')">
                        <span style="font-size: 1.5em; font-weight: bold; margin-left: -30px;">$</span>
                        
                        <label>Total:</label>
                        <div id="${prefix}_total_display" class="total-display" style="width: 150px;">0.00 $</div>
                        <input type="hidden" id="${prefix}_total_hidden" name="${prefix}_total_hidden" value="0.00">
                    </div>

                    <div style="margin-top: 20px;">
                        <input type="checkbox" id="${prefix}_no_cobro_check" name="${prefix}_no_cobro_check" onclick="toggleJustification('${prefix}')">
                        <label for="${prefix}_no_cobro_check" style="display: inline; font-weight: bold;">No se cobra el servicio</label>
                    </div>

                    <div id="${prefix}_justificacion_div" style="display: none; margin-top: 15px;">
                        <p><label for="${prefix}_justificacion">Justificaci√≥n (*):</label></p>
                        <textarea id="${prefix}_justificacion" name="${prefix}_justificacion" placeholder="Escriba la justificaci√≥n aqu√≠..."></textarea>
                    </div>
                </div>
            `;
        }

        async function generateWorkOrder() {
            const form = document.getElementById('work-order-form');
            const selectedType = document.querySelector('.conditional-check.active');
            let firstInvalidField = null;

            // 1. VALIDACI√ìN DE CAMPOS DIN√ÅMICOS Y AUTOLENADOS
            for (const section of formStructure) {
                for (const field of section.fields) {
                    // Los campos fijos y est√°ticos no requieren validaci√≥n manual
                    if (!field.required || field.type === 'static' || field.type === 'ot_counter' || field.type === 'date-auto') continue;

                    let fieldId = (section.title === 'Informaci√≥n de la Contratista' && (field.label === 'Apellido y Nombre del Responsable' || field.label === 'Rif')) 
                                ? field.label 
                                : field.id;
                    
                    const inputElement = document.getElementById(fieldId);

                    // La validaci√≥n de HTML5 se encarga de la mayor√≠a, pero la llamamos expl√≠citamente.
                    // Los campos deshabilitados (autollenados) tienen su valor, as√≠ que solo validamos los que no lo est√©n.
                    if (inputElement && !inputElement.disabled && !inputElement.checkValidity()) {
                        firstInvalidField = inputElement;
                        break; 
                    }
                }
                if (firstInvalidField) break; 
            }

            // 2. VALIDACI√ìN DE SECCI√ìN CONDICIONAL (solo si est√° ACTIVA)
            if (!firstInvalidField && selectedType) {
                const prefix = selectedType.id.replace('check_', '');
                const montoReal = document.getElementById(`${prefix}_monto_real`);
                const incremento = document.getElementById(`${prefix}_incremento`);
                const justificacion = document.getElementById(`${prefix}_justificacion`);

                // Validar Monto Real
                if (!montoReal.value || parseFloat(montoReal.value.replace(',', '.')) < 0) {
                    firstInvalidField = montoReal;
                }
                // Validar Incremento
                else if (!incremento.value || parseFloat(incremento.value.replace(',', '.')) < 0) {
                    firstInvalidField = incremento;
                }
                // Validar Justificaci√≥n si est√° marcada
                else if (justificacion.required && !justificacion.value.trim()) {
                    firstInvalidField = justificacion;
                }
            }

            // 3. MANEJO DEL ERROR
            if (firstInvalidField) {
                alert('‚ö†Ô∏è Atenci√≥n: Debe completar los campos obligatorios faltantes marcados con (*). El sistema lo llevar√° al primer error.');
                
                // Mostrar la burbuja de error nativa del navegador y hacer scroll
                firstInvalidField.reportValidity();
                firstInvalidField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                firstInvalidField.focus();
                return;
            }

            // Si pasa la validaci√≥n, procedemos a guardar y generar PDF

            const formData = new FormData(form);
            const orderData = {};
            
            // 4. Recopilar datos est√°ticos y din√°micos del formulario principal
            formStructure.forEach(section => {
                section.fields.forEach(field => {
                    let value;
                    let fieldId = (section.title === 'Informaci√≥n de la Contratista' && (field.label === 'Apellido y Nombre del Responsable' || field.label === 'Rif')) 
                                ? field.label 
                                : field.id;

                    if (field.type === 'ot_counter') value = otCounter.toString();
                    else if (field.type === 'date-auto') {
                        value = new Date().toLocaleDateString('es-ES');
                        orderData['Fecha Creaci√≥n Orden Trabajo'] = value; 
                    }
                    else if (field.type === 'static') value = field.value;
                    else {
                        const inputElement = document.getElementById(fieldId);
                        value = inputElement ? inputElement.value : formData.get(fieldId);
                    }
                    
                    orderData[field.label] = value || 'N/A';
                });
            });
            
            // 5. Recopilar datos de la secci√≥n condicional seleccionada
            orderData['Tipo de Construcci√≥n Seleccionada'] = selectedType ? selectedType.textContent.trim() : 'Ninguno';

            if (selectedType) {
                const prefix = selectedType.id.replace('check_', '');
                
                calculateTotal(prefix); 

                orderData[`${prefix} | Monto Real Factibilidad`] = parseFloat(document.getElementById(`${prefix}_monto_real`).value.replace(',', '.')).toFixed(2) + ' $';
                orderData[`${prefix} | Incremento VGT y Otros`] = parseFloat(document.getElementById(`${prefix}_incremento`).value.replace(',', '.')).toFixed(2) + ' $';
                orderData[`${prefix} | Total Calculado`] = formData.get(`${prefix}_total_hidden`) + ' $';
                orderData[`${prefix} | No se cobra el servicio`] = formData.get(`${prefix}_no_cobro_check`) === 'on' ? 'S√≠' : 'No';
                
                if (orderData[`${prefix} | No se cobra el servicio`] === 'S√≠') {
                    orderData[`${prefix} | Justificaci√≥n No Cobro`] = formData.get(`${prefix}_justificacion`);
                }
            }


            // 6. **GUARDAR EN FIREBASE**
            try {
                const docRef = await ORDERS_COLLECTION.add(orderData); 
                
                // 7. Actualizar array local y contador
                orderData.id = docRef.id; 
                workOrders.push(orderData);
                otCounter++;
                
                // 8. Guardar la nueva estructura/contador
                await saveFormStructure(false); 

                // 9. Generar PDF
                generatePDF(orderData);

                // 10. Reiniciar UI
                form.reset();
                renderWorkOrderForm(); // Vuelve a renderizar para limpiar estados
                renderOrdersTable(); 
                
            } catch (e) {
                console.error("Error al crear la orden:", e);
                alert("Error al guardar la orden de trabajo en Firebase. Verifique sus reglas de seguridad.");
            }
        }

        // *** 6. GENERACI√ìN DE PDF Y VISUALIZACI√ìN DE √ìRDENES ***

        function generatePDF(data) {
            const otNumber = data['Orden de Trabajo'];
            const creationDate = data['Fecha Creaci√≥n Orden Trabajo'] || data['Fecha Actual'] || 'N/A';
            const fileName = `Orden_Trabajo_${otNumber}_${creationDate.replace(/\//g, '-')}.pdf`;

            // --- Contenido del Formulario (P√°gina 1 y siguientes) ---
            let formContentHTML = `
                <div style="font-family: sans-serif; padding: 20px; color: #36454F;">
                    <h1 style="color: #4682B4; text-align: center; border-bottom: 2px solid #4682B4; padding-bottom: 10px;">${data['T√≠tulo del Formulario']} Nro. ${otNumber}</h1>
            `;
            
            // Campos de la cabecera (Fecha de Creaci√≥n)
             formContentHTML += `
                 <div style="text-align: right; margin-top: -10px; margin-bottom: 20px; font-weight: bold; color: #555;">
                    Fecha de Emisi√≥n: ${data['Fecha Creaci√≥n Orden Trabajo']}
                 </div>
             `;


            // Contenido del Formulario por Secciones (Din√°micas)
            formStructure.forEach(section => {
                formContentHTML += `<h3 style="color: #4682B4; margin-top: 25px;">${section.title}</h3><table style="width: 100%; border-collapse: collapse;">`;
                section.fields.forEach(field => {
                    const label = field.label;
                    const value = data[label] || 'N/A';
                    
                    // OMISI√ìN DE CAMPOS REQUERIDOS EN EL PUNTO 1
                    if (label === 'T√≠tulo del Formulario' || label === 'Orden de Trabajo' || label === 'Fecha Actual' || label === 'Fecha Creaci√≥n Orden Trabajo') return;


                    formContentHTML += `
                        <tr style="border-bottom: 1px solid #B0C4DE;">
                            <td style="width: 35%; padding: 8px; font-weight: bold; background-color: #F0F8FF;">${label}:</td>
                            <td style="width: 65%; padding: 8px;">${value}</td>
                        </tr>
                    `;
                });
                formContentHTML += '</table>';
            });
            
            // Contenido de las Secciones Condicionales (Fijas)
            const type = data['Tipo de Construcci√≥n Seleccionada'];
            if (type && type !== 'Ninguno') {
                const prefix = type.includes('Nodo') ? 'node_acceso' : 'isp';
                
                formContentHTML += `<h3 style="color: #4682B4; margin-top: 25px;">Datos Condicionales: ${type}</h3><table style="width: 100%; border-collapse: collapse;">`;

                formContentHTML += `
                    <tr><td style="width: 35%; padding: 8px; font-weight: bold; background-color: #F0F8FF;">Monto Real Factibilidad:</td><td style="width: 65%; padding: 8px;">${data[`${prefix} | Monto Real Factibilidad`]}</td></tr>
                    <tr><td style="width: 35%; padding: 8px; font-weight: bold; background-color: #F0F8FF;">Incremento VGT y Otros:</td><td style="width: 65%; padding: 8px;">${data[`${prefix} | Incremento VGT y Otros`]}</td></tr>
                    <tr style="font-weight: bold;"><td style="width: 35%; padding: 8px; background-color: #B0C4DE;">TOTAL CALCULADO:</td><td style="width: 65%; padding: 8px; background-color: #ADD8E6;">${data[`${prefix} | Total Calculado`]}</td></tr>
                    <tr><td style="width: 35%; padding: 8px; font-weight: bold; background-color: #F0F8FF;">No se cobra el servicio:</td><td style="width: 65%; padding: 8px;">${data[`${prefix} | No se cobra el servicio`]}</td></tr>
                `;
                if (data[`${prefix} | No se cobra el servicio`] === 'S√≠') {
                    formContentHTML += `
                        <tr><td style="width: 35%; padding: 8px; font-weight: bold; background-color: #F0F8FF;">Justificaci√≥n No Cobro:</td><td style="width: 65%; padding: 8px;">${data[`${prefix} | Justificaci√≥n No Cobro`]}</td></tr>
                    `;
                }

                formContentHTML += '</table>';
            }
            
            // --- NUEVA SECCI√ìN DE FIRMAS AL FINAL DEL CONTENIDO ---
             formContentHTML += `
                <div class="pdf-signatures">
                    <span>
                        Firma Contratista:<hr>
                    </span>
                    <span>
                        Firma Responsable:<hr>
                    </span>
                </div>
             `;

            formContentHTML += '</div>';
            
            const element = document.createElement('div');
            element.innerHTML = formContentHTML;
            
            // Configuraci√≥n de html2pdf para a√±adir m√°rgenes (1cm = 10mm)
            const opt = {
                margin:       10, // Margen en mil√≠metros (1cm)
                filename:     fileName,
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2 },
                jsPDF:        { unit: 'mm', format: 'letter', orientation: 'portrait' }
            };

            html2pdf().from(element).set(opt).save();
        }
        
        function downloadOrder(orderId) {
            const order = workOrders.find(o => o.id === orderId);
            if (order) {
                generatePDF(order);
            } else {
                alert('No se encontr√≥ la Orden de Trabajo para descargar.');
            }
        }
        

        function renderOrdersTable() {
            const tbody = document.getElementById('orders-table').querySelector('tbody');
            tbody.innerHTML = '';

            workOrders.forEach(order => {
                const row = tbody.insertRow();
                row.insertCell().textContent = order['Orden de Trabajo'];
                row.insertCell().textContent = order['T√≠tulo del Formulario'];
                const creationDate = order['Fecha Creaci√≥n Orden Trabajo'] || order['Fecha Actual'] || 'N/A';
                row.insertCell().textContent = creationDate;
                
                const actionCell = row.insertCell();
                const downloadBtn = document.createElement('button');
                downloadBtn.textContent = '‚¨áÔ∏è PDF';
                downloadBtn.style.backgroundColor = '#77DD77'; 
                downloadBtn.style.color = 'white';
                downloadBtn.onclick = () => downloadOrder(order.id);
                actionCell.appendChild(downloadBtn);
            });
        }

    </script>

</body>
</html>
