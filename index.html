<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Sistema de √ìrdenes de Trabajo | Firebase Cloud Edition (Seguro)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.9.0/firebase-firestore-compat.js"></script>
    
    <style>
        /* Paleta de colores Pastel Azul/Gris */
        :root {
            --color-bg: #F0F8FF;
            --color-primary: #ADD8E6;
            --color-secondary: #B0C4DE;
            --color-accent: #87CEFA;
            --color-text: #36454F;
            --color-success: #77DD77;
            --color-error: #FF6961;
            --color-warning: #FFD166;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--color-bg);
            color: var(--color-text);
        }

        header {
            background-color: var(--color-primary);
            color: var(--color-text);
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        main {
            padding: 20px;
            max-width: 1200px;
            margin: 20px auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.05);
        }

        nav {
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .tab-button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background-color: var(--color-secondary);
            color: white;
            transition: background-color 0.3s;
        }

        .tab-button.active, .tab-button:hover {
            background-color: var(--color-accent);
        }

        .tab-content {
            display: none;
            padding-top: 20px;
            border-top: 1px solid var(--color-secondary);
        }

        .tab-content.active {
            display: block;
        }

        /* --- Estilos de Formulario --- */
        .form-section {
            padding: 15px;
            border: 1px solid var(--color-secondary);
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .input-group input[type="text"],
        .input-group input[type="number"],
        .input-group input[type="date"],
        .input-group select,
        .input-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--color-secondary);
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        /* Estilo para el campo de Pago calculado */
        .read-only-display {
            display: inline-block;
            padding: 10px;
            border: 1px solid var(--color-secondary);
            border-radius: 4px;
            background-color: var(--color-primary);
            color: var(--color-text);
            font-weight: bold;
            min-width: 150px;
            text-align: right;
        }


        /* --- Botones --- */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: opacity 0.3s;
        }

        .btn-primary {
            background-color: var(--color-accent);
            color: white;
        }

        .btn-primary:hover {
            opacity: 0.9;
        }

        /* --- Estilos de Tabla --- */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        table th, table td {
            border: 1px solid var(--color-secondary);
            padding: 10px;
            text-align: left;
        }

        table th {
            background-color: var(--color-primary);
        }
        
        /* Estilos espec√≠ficos para botones de la tabla */
        table button {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

    </style>
</head>
<body>

    <header>
        <h1>Sistema de √ìrdenes de Trabajo</h1>
        <p id="user-info">Cargando usuario...</p>
    </header>

    <main>
        <nav>
            <button class="tab-button active" onclick="openTab(event, 'new-order-tab')">‚ûï Nueva Orden</button>
            <button class="tab-button" onclick="openTab(event, 'list-orders-tab')">üìù Ver √ìrdenes</button>
            <button class="tab-button" onclick="logout()">üö™ Cerrar Sesi√≥n</button>
        </nav>

        <div id="new-order-tab" class="tab-content active">
            <h2>Crear Nueva Orden de Trabajo</h2>
            <form id="work-order-form">
                
                <div class="form-section">
                    <h3>Informaci√≥n General</h3>
                    <div class="input-group">
                        <label for="orden-trabajo">Orden de Trabajo (*):</label>
                        <input type="text" id="orden-trabajo" required>
                    </div>
                    <div class="input-group">
                        <label for="titulo-formulario">T√≠tulo del Formulario (*):</label>
                        <input type="text" id="titulo-formulario" required>
                    </div>
                    <div class="input-group">
                        <label for="fecha-actual">Fecha Actual (*):</label>
                        <input type="date" id="fecha-actual" required>
                    </div>
                    <div class="input-group">
                        <label for="tecnico-asignado">T√©cnico Asignado (*):</label>
                        <select id="tecnico-asignado" required>
                            <option value="">Seleccione un T√©cnico</option>
                            <option value="Tecnico A">T√©cnico A</option>
                            <option value="Tecnico B">T√©cnico B</option>
                        </select>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Servicios y Pagos</h3>
                    
                    <button type="button" class="btn btn-warning" onclick="toggleIspSection()">
                        üì∂ Habilitar Cargo por VGT EDC/ISP (Inter)
                    </button>
                    
                    <hr style="margin: 15px 0;">

                    <div id="conditional_isp_section" style="display: none;">
                        <h4>Detalle de Pago VGT EDC Cargo de Inter (*)</h4>
                        <div class="input-group">
                            <label for="isp_precio_unitario">Precio Unitario (*):</label>
                            <input 
                                type="text" 
                                id="isp_precio_unitario" 
                                placeholder="0.00" 
                                oninput="calculateNewTotal('isp')" 
                                pattern="[0-9]+([\.,][0-9]{1,2})?"
                                title="Use punto o coma para decimales."
                                required
                            >
                        </div>
                        <div class="input-group">
                            <label for="isp_puntos">Puntos (*):</label>
                            <input 
                                type="text" 
                                id="isp_puntos" 
                                placeholder="0.00" 
                                oninput="calculateNewTotal('isp')" 
                                pattern="[0-9]+([\.,][0-9]{1,2})?"
                                title="Use punto o coma para decimales."
                                required
                            >
                        </div>
                        
                        <div class="input-group">
                            <label>Pago x VGT EDC cargo de Inter (*):</label>
                            <span class="read-only-display" id="isp_total_display">0.00</span>
                            <input type="hidden" id="isp_total_hidden" name="isp_total_hidden" value="0.00">
                        </div>
                        <div class="input-group">
                            <label for="isp_descripcion">Descripci√≥n Adicional (Opcional):</label>
                            <textarea id="isp_descripcion"></textarea>
                        </div>
                    </div>
                    </div>

                <button type="submit" class="btn btn-primary">Guardar Orden</button>
            </form>
            <p id="form-message" style="color: var(--color-text); margin-top: 10px;"></p>
        </div>

        <div id="list-orders-tab" class="tab-content">
            <h2>Lista de √ìrdenes de Trabajo</h2>
            <div id="orders-list">
                <table>
                    <thead>
                        <tr>
                            <th>Orden de Trabajo</th>
                            <th>T√≠tulo</th>
                            <th>Fecha</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="orders-table-body">
                        </tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        // --- C√ìDIGO DE INICIALIZACI√ìN DE FIREBASE Y AUTH AQU√ç ---
        // (Se asume que este c√≥digo ya existe y funciona)
        // ...
        // const firebaseConfig = { ... };
        // const app = firebase.initializeApp(firebaseConfig);
        // const db = firebase.firestore();
        // const auth = firebase.auth();
        // ...

        let currentRole = 'user'; // Asumir rol por defecto o cargar desde Firebase

        // --- L√ìGICA DE TABS ---
        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tab-button");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }
        
        // Funci√≥n para mostrar/ocultar la secci√≥n de Cargo de Inter√©s (ISP)
        function toggleIspSection() {
            const section = document.getElementById('conditional_isp_section');
            if (section.style.display === 'none') {
                section.style.display = 'block';
            } else {
                section.style.display = 'none';
            }
        }


        // =========================================================
        // === FUNCI√ìN DE C√ÅLCULO OPTIMIZADA PARA CORREGIR EL ERROR ===
        // =========================================================

        /**
         * Calcula el total multiplicando Precio Unitario por Puntos
         * y actualiza el campo de visualizaci√≥n (display) y el campo oculto (hidden).
         * @param {string} prefix - El prefijo del grupo de campos (ej. 'isp', 'vgt').
         */
        function calculateNewTotal(prefix) {
            
            // --- FUNCI√ìN DE LIMPIEZA Y PARSEO ---
            // Asegura que solo n√∫meros y un √∫nico punto decimal permanezcan en el valor.
            function cleanAndParse(id) {
                const inputElement = document.getElementById(id);
                if (!inputElement) return 0;

                // 1. Obtener el valor y limpiar espacios
                let value = inputElement.value.trim();

                // 2. Reemplazar la coma por punto (si el usuario usa formato espa√±ol)
                value = value.replace(',', '.');

                // 3. Eliminar cualquier caracter que no sea un d√≠gito o punto decimal (para robustez)
                // Se asegura de que solo el primer punto sea decimal y que no haya otros caracteres.
                value = value.replace(/[^\d.]/g, '');

                // 4. Parsear a float. Si no es un n√∫mero v√°lido o est√° vac√≠o, devuelve 0.
                return parseFloat(value) || 0;
            }
            // ------------------------------------

            // Obtener los valores limpios para el prefijo 'isp'
            const precioUnitario = cleanAndParse(`${prefix}_precio_unitario`);
            const puntos = cleanAndParse(`${prefix}_puntos`);

            // Realizar la multiplicaci√≥n
            const total = precioUnitario * puntos;

            // Actualizar los campos de visualizaci√≥n y oculto
            const totalDisplay = document.getElementById(`${prefix}_total_display`);
            const totalHidden = document.getElementById(`${prefix}_total_hidden`);

            // Asignar el resultado (si los elementos existen)
            if (totalDisplay) {
                // Asigna el valor con dos decimales para la visualizaci√≥n
                totalDisplay.textContent = total.toFixed(2);
            }
            if (totalHidden) {
                // Asigna el valor con dos decimales para el env√≠o del formulario
                totalHidden.value = total.toFixed(2);
            }
        }
        
        // =========================================================
        // === FIN DE FUNCI√ìN DE C√ÅLCULO OPTIMIZADA ===
        // =========================================================
        

        // --- OTRAS FUNCIONES (se asume que estas existen y funcionan) ---
        // function downloadOrder(orderId) { ... }
        // function deleteWorkOrder(orderId, orderTitle) { ... }
        // function logout() { ... }
        // function loadOrders() { ... }
        // ... (resto del c√≥digo JS para manejar formularios, guardado y lista de √≥rdenes)
        
        // C√≥digo para manejar la carga de √≥rdenes
        function loadOrders(orders) {
            const tbody = document.getElementById('orders-table-body');
            tbody.innerHTML = ''; // Limpiar la tabla

            orders.forEach(order => {
                const row = tbody.insertRow();
                row.insertCell().textContent = order['Orden de Trabajo'];
                row.insertCell().textContent = order['T√≠tulo del Formulario'];
                const creationDate = order['Fecha Actual'] || 'N/A';
                row.insertCell().textContent = creationDate;
                
                const actionCell = row.insertCell();
                
                // Bot√≥n de Descarga PDF
                const downloadBtn = document.createElement('button');
                downloadBtn.textContent = '‚¨áÔ∏è PDF';
                downloadBtn.style.backgroundColor = '#77DD77'; 
                downloadBtn.style.color = 'white';
                // downloadBtn.onclick = () => downloadOrder(order.id); // Funci√≥n real
                downloadBtn.onclick = () => console.log('Descargando PDF de: ' + order['Orden de Trabajo']); // Placeholder
                actionCell.appendChild(downloadBtn);
                
                // Bot√≥n de Eliminar (Solo para Admin)
                if (currentRole === 'admin') {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'üóëÔ∏è Eliminar';
                    deleteBtn.style.backgroundColor = 'var(--color-error)';
                    deleteBtn.style.color = 'white';
                    deleteBtn.style.marginLeft = '5px';
                    // deleteBtn.onclick = () => deleteWorkOrder(order.id, order['Orden de Trabajo']); // Funci√≥n real
                    deleteBtn.onclick = () => console.log('Eliminando orden: ' + order['Orden de Trabajo']); // Placeholder
                    actionCell.appendChild(deleteBtn);
                }
            });
        }
        
        // Cargar un ejemplo de √≥rdenes al inicio para que la tabla no est√© vac√≠a.
        const exampleOrders = [
            { id: '1', 'Orden de Trabajo': 'OT-001', 'T√≠tulo del Formulario': 'Instalaci√≥n B√°sica', 'Fecha Actual': '2024-05-20' },
            { id: '2', 'Orden de Trabajo': 'OT-002', 'T√≠tulo del Formulario': 'Mantenimiento Preventivo', 'Fecha Actual': '2024-05-21' }
        ];
        document.addEventListener('DOMContentLoaded', () => {
            loadOrders(exampleOrders);
            // Mostrar info del usuario (ejemplo)
            document.getElementById('user-info').textContent = 'Usuario: [Nombre de Usuario] | Rol: ' + currentRole.toUpperCase();
        });


    </script>

</body>
</html>
